# B07：指令組合入門 - 第一次 Agent + MCP 協作

## 🎯 學習目標

**知識目標**：
- [ ] 理解指令組合的基本概念
- [ ] 掌握 Agent + MCP 協作模式
- [ ] 了解工作流程設計思維

**技能目標**：
- [ ] 能設計簡單的多步驟工作流程
- [ ] 能組合 Agent 和 MCP 解決實際問題
- [ ] 能識別組合使用的時機

**時間估計**：35-40 分鐘

---

## 📋 情境描述

### 背景故事
你剛接手一個 Python 專案，需要快速了解專案架構、修復發現的問題，並生成更新報告。這個任務涉及多個步驟：程式碼分析、問題修復、文檔更新、報告生成。如果一步步手動執行會很耗時，你想嘗試設計一個整合的工作流程。

### 問題陳述
你需要完成以下完整流程：
1. 分析專案結構和程式碼品質
2. 識別並修復安全和效能問題
3. 更新專案文檔
4. 生成改進報告
5. 將結果保存到檔案

傳統方式需要：
- 手動程式碼審查
- 逐一修復問題
- 分別更新文檔
- 手動撰寫報告
- 手動整理檔案

### 任務要求
1. 設計整合的工作流程
2. 組合多個 Agent 和 MCP
3. 確保步驟間的連貫性
4. 生成完整的專案改進報告

---

## 🛠️ 實作步驟

### 步驟 1：準備測試專案
```bash
# 1. 創建測試專案
mkdir integration_test_project
cd integration_test_project

# 2. 創建有問題的 Python 程式碼
```

**範例程式碼**（保存為 `web_app.py`）：
```python
# web_app.py - 有多種問題的範例程式碼
import sqlite3
from flask import Flask, request, jsonify

app = Flask(__name__)
app.secret_key = "123456"  # 弱密鑰

# 全域資料庫連接（不好的做法）
conn = sqlite3.connect('users.db', check_same_thread=False)

@app.route('/user/<user_id>')
def get_user(user_id):
    # SQL 注入漏洞
    query = f"SELECT * FROM users WHERE id = {user_id}"
    result = conn.execute(query).fetchone()

    # 效能問題：每次都查詢
    all_users = conn.execute("SELECT * FROM users").fetchall()

    if result:
        return jsonify({
            'user': result,
            'total_users': len(all_users)
        })
    return jsonify({'error': 'User not found'}), 404

@app.route('/users', methods=['POST'])
def create_user():
    data = request.get_json()
    name = data['name']  # 缺少驗證
    email = data['email']

    # 明文密碼
    password = data['password']

    # 又是 SQL 注入
    query = f"INSERT INTO users (name, email, password) VALUES ('{name}', '{email}', '{password}')"
    conn.execute(query)
    conn.commit()

    return jsonify({'message': 'User created'})

if __name__ == '__main__':
    app.run(debug=True)  # 生產環境不應該開啟 debug
```

**創建 requirements.txt**：
```
Flask==2.3.0
sqlite3
```

### 步驟 2：設計整合工作流程

**提示詞**：
```
我要設計一個完整的程式碼改進工作流程，請幫我規劃：

[階段1：分析階段]
- 使用 code-reviewer agent 分析程式碼品質
- 使用 security-auditor 檢查安全問題
- 使用 performance-analyzer 找出效能瓶頸

[階段2：修復階段]
- 根據分析結果修復所有問題
- 確保修復後程式碼的一致性

[階段3：文檔階段]
- 使用 documentation-writer 生成 API 文檔
- 更新 README.md

[階段4：報告階段]
- 生成詳細的改進報告
- 使用檔案系統 MCP 保存所有產出

請設計這個工作流程的執行步驟。
```

### 步驟 3：執行整合工作流程

**階段 1：綜合分析**
```bash
claude --add-file web_app.py --add-file requirements.txt
```

**提示詞**：
```
開始執行程式碼改進工作流程：

[第1步：程式碼品質分析]
/agents:code-reviewer

請分析 web_app.py 的程式碼品質問題，包括：
- 程式碼結構和組織
- 命名和風格
- 錯誤處理
- 最佳實踐遵循

[第2步：安全性分析]
/agents:security-auditor

請檢查相同程式碼的安全漏洞：
- 注入攻擊風險
- 認證和授權問題
- 敏感資料處理
- 配置安全性

[第3步：效能分析]
/agents:performance-analyzer

請分析效能問題：
- 資料庫操作效率
- 記憶體使用
- 併發處理能力
- 資源管理

請依序執行這三個分析，每個分析完成後等我確認再繼續。
```

**階段 2：程式碼修復**
**提示詞**：
```
基於剛才的三重分析結果，請提供完整的修復版本：

[修復要求]
1. 解決所有安全漏洞（參數化查詢、輸入驗證、密碼雜湊）
2. 優化效能問題（連接池、查詢優化、快取）
3. 改善程式碼品質（錯誤處理、結構化、註解）
4. 遵循最佳實踐（配置管理、日誌記錄）

[產出]
- 修復後的 web_app.py
- 更新的 requirements.txt（如果需要新依賴）
- 簡要的修復說明

請確保修復後的程式碼既安全又高效。
```

**階段 3：文檔生成**
**提示詞**：
```
/agents:documentation-writer
/output-style:api-documentation

現在為修復後的程式碼生成完整文檔：

[API 文檔]
請生成標準的 API 文檔，包含：
- 每個端點的說明
- 請求/回應格式
- 錯誤碼說明
- 使用範例

[README.md]
請生成專案 README，包含：
- 專案簡介
- 安裝指南
- 使用說明
- 安全注意事項
- 改進歷史
```

**階段 4：報告生成與儲存**
**提示詞**：
```
現在請使用檔案系統 MCP 完成最後的整理工作：

[檔案組織]
請創建以下結構並保存所有產出：
```
improved_project/
├── src/
│   ├── web_app.py          # 修復後的程式碼
│   └── requirements.txt    # 更新的依賴
├── docs/
│   ├── API.md             # API 文檔
│   └── README.md          # 專案說明
└── reports/
    ├── analysis_report.md  # 分析報告
    ├── security_fixes.md   # 安全修復說明
    └── performance_improvements.md  # 效能改善報告
```

[綜合報告]
請生成一份 `improvement_summary.md`，包含：
- 原始問題統計
- 修復措施總結
- 改善效果預估
- 後續建議

請實際創建這些檔案並保存內容。
```

---

## ✅ 成功檢查點

完成此情境後，你應該能夠：

**理解檢查點**：
- [ ] 我理解指令組合的價值和原理
- [ ] 我明白如何設計多階段工作流程
- [ ] 我知道何時需要組合使用不同 Agent

**技能檢查點**：
- [ ] 我成功執行了多階段的組合工作流程
- [ ] 我能協調 Agent 和 MCP 的配合
- [ ] 我能維持工作流程的連貫性

**成果檢查點**：
- [ ] 我得到了完整的程式碼改進方案
- [ ] 我生成了專業的項目文檔
- [ ] 我創建了結構化的報告

---

## 🎓 學習收穫

### 核心概念
1. **工作流程思維**：將複雜任務分解為有序步驟
2. **Agent 協作**：不同專家在不同階段發揮作用
3. **上下文連貫**：前一步的輸出成為下一步的輸入

### 組合模式
```
分析 → 修復 → 文檔 → 報告
 ↓      ↓      ↓      ↓
不同    結果    專業   檔案
Agent   整合    格式   系統
```

### 實際價值
**傳統方式 vs 組合方式**：

| 階段 | 傳統方式耗時 | 組合方式耗時 | 節省 |
|------|------------|------------|------|
| 分析 | 2-3 小時 | 10 分鐘 | 95% |
| 修復 | 4-6 小時 | 20 分鐘 | 90% |
| 文檔 | 2-3 小時 | 5 分鐘 | 95% |
| 報告 | 1-2 小時 | 5 分鐘 | 95% |
| **總計** | **9-14 小時** | **40 分鐘** | **93%** |

---

## 🚀 進階挑戰

### 挑戰 1：條件式工作流程
**提示詞**：
```
設計一個智能工作流程，根據分析結果自動決定後續步驟：

[條件邏輯]
- 如果發現 Critical 安全問題 → 優先修復 + 生成安全報告
- 如果效能問題嚴重 → 重點優化 + 效能測試
- 如果程式碼品質良好 → 跳過重構，直接生成文檔

展示條件式的指令組合。
```

### 挑戰 2：平行處理工作流程
**提示詞**：
```
設計平行處理工作流程：

[同時執行]
- Thread 1: 安全分析 + 修復
- Thread 2: 效能分析 + 優化
- Thread 3: 文檔分析 + 更新

[最終整合]
合併所有結果，生成統一報告

展示如何協調平行任務。
```

### 挑戰 3：循環改進工作流程
**提示詞**：
```
設計持續改進的循環工作流程：

1. 分析 → 2. 修復 → 3. 測試 → 4. 評估
                              ↓
5. 報告 ← 4. 文檔 ← 3. 驗證 ← 2. 再次分析

如果問題未完全解決，自動進入下一輪改進。
```

---

## 📚 相關資源

**工作流程設計**：
- [Workflow Automation Best Practices](https://zapier.com/blog/workflow-automation/)
- [DevOps Pipeline Design](https://docs.microsoft.com/en-us/azure/devops/pipelines/)

**組合模式**：
- [Command Pattern](https://refactoring.guru/design-patterns/command)
- [Pipeline Pattern](https://martinfowler.com/articles/collection-pipeline/)

**後續學習**：
- B08：複雜工作流程設計
- C06：企業級工作流程自動化

---

## 💭 反思問題

1. **效率對比**：組合工作流程 vs 單獨執行，差異在哪裡？
2. **品質影響**：多 Agent 協作是否比單一 Agent 品質更好？
3. **設計思維**：如何識別哪些任務適合組合處理？
4. **實際應用**：你會如何將這種方法應用到日常工作中？

---

## 🔗 與前面情境的累積效應

**技能堆疊**：
- B01-B05：掌握各種專業 Agent
- B06：學會 MCP 整合
- **B07**：學會 Agent + MCP 組合

**思維演進**：
```
單一工具 → 專業工具 → 工具整合 → 工作流程設計
```

**下一步預告**：
- B08：更複雜的組合模式
- B09：團隊協作工作流程
- B10：個人效率系統設計

---

## 🔄 工作流程模板

**基本組合模板**：
```bash
# 1. 分析階段
/agents:[分析專家]
[具體分析要求]

# 2. 處理階段
/agents:[處理專家]
[基於分析結果的處理要求]

# 3. 輸出階段
/output-style:[專業格式]
[格式化輸出要求]

# 4. 保存階段
[使用 MCP 保存結果]
```

---

**完成時間記錄**：___ 分鐘
**工作流程步驟數**：___
**最有價值的組合**：___
**筆記區域**：
```
記錄你對指令組合的理解和工作流程設計心得...
```

---

*本情境是從單一 Agent 使用到複雜工作流程設計的重要轉折點。掌握組合思維是高效使用 Claude Code 的關鍵。*