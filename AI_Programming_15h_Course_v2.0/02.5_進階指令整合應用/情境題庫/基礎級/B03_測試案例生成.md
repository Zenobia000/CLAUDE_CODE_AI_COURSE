# B03：測試案例生成（基礎級）

## 情境資訊

**編號**：B03
**難度**：⭐⭐☆☆☆（基礎級）
**預計時間**：20 分鐘
**學習目標**：
- 掌握 test-generator agent 的使用
- 理解如何生成完整的測試案例
- 學會測試覆蓋的思考方式

**適用對象**：
- 完成模組 2 基礎操作
- 理解 TDD 的基本概念
- 想學習如何快速生成測試

---

## 情境描述

### 背景

你的團隊正在開發一個電子商務系統，你負責實作「購物車」功能。根據 TDD 原則，你需要先寫測試，但你對如何設計完整的測試案例不太有把握。

### 已有的程式碼

```python
# src/shopping_cart.py

class ShoppingCart:
    """購物車類別"""

    def __init__(self):
        self.items = []
        self.discount_code = None

    def add_item(self, product_id: str, name: str, price: float, quantity: int = 1):
        """
        添加商品到購物車

        Args:
            product_id: 商品 ID
            name: 商品名稱
            price: 商品單價
            quantity: 數量（預設 1）

        Raises:
            ValueError: 如果 price < 0 或 quantity < 1
        """
        if price < 0:
            raise ValueError("價格不能為負數")
        if quantity < 1:
            raise ValueError("數量至少為 1")

        # 檢查是否已存在相同商品
        for item in self.items:
            if item['product_id'] == product_id:
                item['quantity'] += quantity
                return

        # 添加新商品
        self.items.append({
            'product_id': product_id,
            'name': name,
            'price': price,
            'quantity': quantity
        })

    def remove_item(self, product_id: str):
        """移除商品"""
        self.items = [item for item in self.items if item['product_id'] != product_id]

    def update_quantity(self, product_id: str, quantity: int):
        """更新商品數量"""
        if quantity < 1:
            raise ValueError("數量至少為 1")

        for item in self.items:
            if item['product_id'] == product_id:
                item['quantity'] = quantity
                return

        raise KeyError(f"找不到商品: {product_id}")

    def apply_discount(self, code: str) -> bool:
        """
        套用折扣碼

        Returns:
            True if 成功套用, False otherwise
        """
        valid_codes = {
            'SAVE10': 0.10,  # 9 折
            'SAVE20': 0.20,  # 8 折
            'SAVE50': 0.50   # 5 折
        }

        if code in valid_codes:
            self.discount_code = code
            return True
        return False

    def get_total(self) -> float:
        """計算總金額（含折扣）"""
        subtotal = sum(item['price'] * item['quantity'] for item in self.items)

        if self.discount_code:
            discount_rate = {
                'SAVE10': 0.10,
                'SAVE20': 0.20,
                'SAVE50': 0.50
            }[self.discount_code]
            subtotal *= (1 - discount_rate)

        return round(subtotal, 2)

    def get_item_count(self) -> int:
        """取得商品總數"""
        return sum(item['quantity'] for item in self.items)

    def clear(self):
        """清空購物車"""
        self.items = []
        self.discount_code = None
```

### 你的任務

使用 Claude Code 的 `test-generator` agent，為這個購物車類別生成完整的測試案例。

---

## 學習重點

### 目標 1：使用 test-generator agent
理解如何切換到專業測試生成模式

### 目標 2：測試覆蓋思維
- 正常情況（Happy Path）
- 邊界情況（Edge Cases）
- 錯誤處理（Error Handling）
- 狀態變化（State Changes）

### 目標 3：測試組織
- 合理的測試分組
- 清晰的測試命名
- 完整的測試文檔

---

## 實作步驟

### 步驟 1：啟動 Claude Code 並切換 Agent

```bash
cd /path/to/your/project
claude

# 切換到測試生成專家模式
> /agents:test-generator
```

**期待輸出**：
```
已切換到 test-generator agent 模式。
我現在會專注於：
- 設計完整的測試案例
- 考慮各種邊界情況
- 遵循測試最佳實踐
- 使用適當的測試框架
```

### 步驟 2：提供測試生成指令

```
提示詞：
請為 src/shopping_cart.py 中的 ShoppingCart 類別生成完整的測試案例。

要求：
1. 使用 pytest 框架
2. 測試應該涵蓋：
   - 所有公開方法
   - 正常使用情境
   - 邊界情況（空購物車、大量商品等）
   - 錯誤處理（無效輸入、不存在的商品）
   - 狀態變化（添加、移除、更新）
3. 使用 pytest fixtures 來建立測試資料
4. 每個測試應該有清晰的文檔字串
5. 測試命名應該描述測試的內容

請生成測試檔案。
```

### 步驟 3：審查生成的測試

Claude 會生成類似這樣的測試：

```python
# tests/test_shopping_cart.py

import pytest
from src.shopping_cart import ShoppingCart


class TestShoppingCartInitialization:
    """測試購物車初始化"""

    def test_new_cart_is_empty(self):
        """新建的購物車應該是空的"""
        cart = ShoppingCart()
        assert len(cart.items) == 0
        assert cart.get_item_count() == 0
        assert cart.get_total() == 0.0

    def test_new_cart_has_no_discount(self):
        """新建的購物車應該沒有折扣碼"""
        cart = ShoppingCart()
        assert cart.discount_code is None


class TestAddItem:
    """測試添加商品功能"""

    @pytest.fixture
    def cart(self):
        """提供一個空購物車"""
        return ShoppingCart()

    def test_add_single_item(self, cart):
        """添加單一商品"""
        cart.add_item('P001', 'MacBook Pro', 50000.0, 1)

        assert cart.get_item_count() == 1
        assert len(cart.items) == 1
        assert cart.items[0]['product_id'] == 'P001'
        assert cart.items[0]['name'] == 'MacBook Pro'
        assert cart.items[0]['price'] == 50000.0
        assert cart.items[0]['quantity'] == 1

    def test_add_multiple_items(self, cart):
        """添加多個不同商品"""
        cart.add_item('P001', 'MacBook Pro', 50000.0, 1)
        cart.add_item('P002', 'iPhone', 30000.0, 2)

        assert cart.get_item_count() == 3  # 1 + 2
        assert len(cart.items) == 2

    def test_add_same_item_twice_increases_quantity(self, cart):
        """添加相同商品兩次應該增加數量"""
        cart.add_item('P001', 'MacBook Pro', 50000.0, 1)
        cart.add_item('P001', 'MacBook Pro', 50000.0, 2)

        assert len(cart.items) == 1  # 不應該有重複商品
        assert cart.items[0]['quantity'] == 3  # 數量應該累加

    def test_add_item_with_negative_price_raises_error(self, cart):
        """添加負價格商品應該拋出錯誤"""
        with pytest.raises(ValueError, match="價格不能為負數"):
            cart.add_item('P001', 'Invalid', -100.0, 1)

    def test_add_item_with_zero_quantity_raises_error(self, cart):
        """數量為 0 應該拋出錯誤"""
        with pytest.raises(ValueError, match="數量至少為 1"):
            cart.add_item('P001', 'Product', 100.0, 0)

    def test_add_item_with_default_quantity(self, cart):
        """不指定數量時應該預設為 1"""
        cart.add_item('P001', 'Product', 100.0)
        assert cart.items[0]['quantity'] == 1


class TestRemoveItem:
    """測試移除商品功能"""

    @pytest.fixture
    def cart_with_items(self):
        """提供一個有商品的購物車"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product A', 100.0, 2)
        cart.add_item('P002', 'Product B', 200.0, 1)
        return cart

    def test_remove_existing_item(self, cart_with_items):
        """移除存在的商品"""
        cart_with_items.remove_item('P001')

        assert len(cart_with_items.items) == 1
        assert cart_with_items.items[0]['product_id'] == 'P002'

    def test_remove_nonexistent_item_does_nothing(self, cart_with_items):
        """移除不存在的商品不應該報錯"""
        cart_with_items.remove_item('P999')
        assert len(cart_with_items.items) == 2  # 數量不變

    def test_remove_all_items(self, cart_with_items):
        """移除所有商品"""
        cart_with_items.remove_item('P001')
        cart_with_items.remove_item('P002')

        assert len(cart_with_items.items) == 0
        assert cart_with_items.get_total() == 0.0


class TestUpdateQuantity:
    """測試更新數量功能"""

    @pytest.fixture
    def cart_with_items(self):
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 100.0, 2)
        return cart

    def test_update_quantity_to_higher_value(self, cart_with_items):
        """增加商品數量"""
        cart_with_items.update_quantity('P001', 5)
        assert cart_with_items.items[0]['quantity'] == 5

    def test_update_quantity_to_lower_value(self, cart_with_items):
        """減少商品數量"""
        cart_with_items.update_quantity('P001', 1)
        assert cart_with_items.items[0]['quantity'] == 1

    def test_update_quantity_to_zero_raises_error(self, cart_with_items):
        """數量不能為 0"""
        with pytest.raises(ValueError, match="數量至少為 1"):
            cart_with_items.update_quantity('P001', 0)

    def test_update_nonexistent_item_raises_error(self, cart_with_items):
        """更新不存在的商品應該拋出錯誤"""
        with pytest.raises(KeyError, match="找不到商品"):
            cart_with_items.update_quantity('P999', 5)


class TestDiscount:
    """測試折扣功能"""

    @pytest.fixture
    def cart_with_items(self):
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 1000.0, 1)
        return cart

    def test_apply_valid_discount_code_10(self, cart_with_items):
        """套用有效的 10% 折扣碼"""
        result = cart_with_items.apply_discount('SAVE10')

        assert result is True
        assert cart_with_items.discount_code == 'SAVE10'
        assert cart_with_items.get_total() == 900.0  # 1000 * 0.9

    def test_apply_valid_discount_code_20(self, cart_with_items):
        """套用有效的 20% 折扣碼"""
        result = cart_with_items.apply_discount('SAVE20')

        assert result is True
        assert cart_with_items.get_total() == 800.0  # 1000 * 0.8

    def test_apply_valid_discount_code_50(self, cart_with_items):
        """套用有效的 50% 折扣碼"""
        result = cart_with_items.apply_discount('SAVE50')

        assert result is True
        assert cart_with_items.get_total() == 500.0  # 1000 * 0.5

    def test_apply_invalid_discount_code(self, cart_with_items):
        """套用無效的折扣碼"""
        result = cart_with_items.apply_discount('INVALID')

        assert result is False
        assert cart_with_items.discount_code is None
        assert cart_with_items.get_total() == 1000.0  # 原價


class TestGetTotal:
    """測試計算總金額功能"""

    def test_empty_cart_total_is_zero(self):
        """空購物車總金額為 0"""
        cart = ShoppingCart()
        assert cart.get_total() == 0.0

    def test_single_item_total(self):
        """單一商品總金額"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 100.0, 3)
        assert cart.get_total() == 300.0

    def test_multiple_items_total(self):
        """多個商品總金額"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product A', 100.0, 2)  # 200
        cart.add_item('P002', 'Product B', 150.0, 1)  # 150
        assert cart.get_total() == 350.0

    def test_total_with_discount(self):
        """有折扣的總金額"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 1000.0, 1)
        cart.apply_discount('SAVE20')
        assert cart.get_total() == 800.0

    def test_total_rounds_to_two_decimals(self):
        """總金額應該四捨五入到兩位小數"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 33.33, 3)
        total = cart.get_total()
        assert total == 99.99
        assert len(str(total).split('.')[-1]) <= 2


class TestGetItemCount:
    """測試取得商品總數功能"""

    def test_empty_cart_item_count(self):
        """空購物車商品數為 0"""
        cart = ShoppingCart()
        assert cart.get_item_count() == 0

    def test_single_item_count(self):
        """單一商品的數量"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 100.0, 5)
        assert cart.get_item_count() == 5

    def test_multiple_items_count(self):
        """多個商品的總數量"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product A', 100.0, 2)
        cart.add_item('P002', 'Product B', 200.0, 3)
        assert cart.get_item_count() == 5


class TestClear:
    """測試清空購物車功能"""

    def test_clear_removes_all_items(self):
        """清空後應該移除所有商品"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product A', 100.0, 2)
        cart.add_item('P002', 'Product B', 200.0, 1)
        cart.apply_discount('SAVE10')

        cart.clear()

        assert len(cart.items) == 0
        assert cart.get_item_count() == 0
        assert cart.get_total() == 0.0
        assert cart.discount_code is None


class TestIntegrationScenarios:
    """測試整合場景"""

    def test_complete_shopping_flow(self):
        """完整的購物流程"""
        cart = ShoppingCart()

        # 添加商品
        cart.add_item('P001', 'MacBook Pro', 50000.0, 1)
        cart.add_item('P002', 'iPhone', 30000.0, 2)
        cart.add_item('P003', 'AirPods', 5000.0, 1)

        assert cart.get_item_count() == 4
        assert cart.get_total() == 115000.0

        # 更新數量
        cart.update_quantity('P002', 1)
        assert cart.get_item_count() == 3
        assert cart.get_total() == 85000.0

        # 套用折扣
        cart.apply_discount('SAVE20')
        assert cart.get_total() == 68000.0  # 85000 * 0.8

        # 移除商品
        cart.remove_item('P003')
        assert cart.get_item_count() == 2
        assert cart.get_total() == 64000.0  # 80000 * 0.8

    def test_edge_case_large_quantity(self):
        """邊界情況：大量商品"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Product', 1.0, 1000000)

        assert cart.get_item_count() == 1000000
        assert cart.get_total() == 1000000.0

    def test_edge_case_high_price(self):
        """邊界情況：高價商品"""
        cart = ShoppingCart()
        cart.add_item('P001', 'Luxury Item', 999999.99, 1)

        assert cart.get_total() == 999999.99
```

### 步驟 4：執行測試

```bash
# 安裝 pytest（如果尚未安裝）
pip install pytest pytest-cov

# 執行測試
pytest tests/test_shopping_cart.py -v

# 檢查測試覆蓋率
pytest tests/test_shopping_cart.py --cov=src/shopping_cart --cov-report=html
```

---

## 驗證標準

### ✅ 必須達成

- [ ] 成功切換到 `test-generator` agent
- [ ] 生成的測試可以執行
- [ ] 測試覆蓋率 > 90%
- [ ] 所有測試都通過

### ⭐ 額外成就

- [ ] 測試覆蓋率 = 100%
- [ ] 識別並修正程式碼中的 bug（如果有）
- [ ] 添加效能測試（大量資料情況）

---

## 學習反思

### 反思問題

1. **測試設計**：
   - test-generator 生成的測試是否涵蓋所有情況？
   - 有沒有缺少的邊界情況？

2. **測試組織**：
   - 測試的分組是否合理？
   - 測試命名是否清晰？

3. **Agent 體驗**：
   - test-generator agent 跟一般模式有什麼不同？
   - 什麼時候應該使用這個 agent？

### 延伸練習

1. **測試驅動開發（TDD）**：
   - 先生成測試（紅燈）
   - 再實作功能（綠燈）
   - 最後重構

2. **修改需求**：
   - 如果要添加「庫存檢查」功能，測試應該如何調整？

3. **整合測試**：
   - 如果購物車需要連接資料庫，測試應該如何設計？

---

## 相關資源

### 下一步學習

- **B05**：程式碼重構建議 - 學習 code-reviewer 和 refactoring-specialist
- **C01**：完整功能開發（TDD 流程）- 實踐完整的測試驅動開發
- **C03**：開源專案貢獻 - 在實際專案中應用測試生成

### 參考文件

- pytest 官方文檔：https://docs.pytest.org/
- TDD 原則：Red-Green-Refactor
- 測試金字塔：Unit → Integration → E2E

---

**建議完成時間**：20-30 分鐘
**難度評估**：2/5
**重要度**：5/5（測試是程式品質的基礎）
