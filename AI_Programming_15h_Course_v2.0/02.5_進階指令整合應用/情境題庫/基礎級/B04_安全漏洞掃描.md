# B04：安全漏洞掃描 - Security Agent 的專業領域

## 🎯 學習目標

**知識目標**：
- [ ] 理解 `security-auditor` agent 的專業能力
- [ ] 掌握常見的安全漏洞類型
- [ ] 了解安全審查的系統化方法

**技能目標**：
- [ ] 能使用安全專家 agent 進行程式碼審計
- [ ] 能識別和理解不同類型的安全風險
- [ ] 能獲得可執行的安全修復建議

**時間估計**：30-35 分鐘

---

## 📋 情境描述

### 背景故事
你負責一個用戶管理系統的安全審查。這個系統處理敏感的用戶資料，包括個人資訊和支付資訊。在正式上線前，你需要進行完整的安全檢查，確保沒有常見的安全漏洞。

### 問題陳述
以下是用戶管理系統的核心程式碼，需要進行安全審查：

```python
# user_auth.py
import hashlib
import sqlite3
from flask import Flask, request, session, jsonify

app = Flask(__name__)
app.secret_key = "my-secret-key"  # 固定密鑰

def get_db_connection():
    return sqlite3.connect('users.db')

@app.route('/login', methods=['POST'])
def login():
    username = request.form['username']
    password = request.form['password']

    # 直接將用戶輸入拼接到 SQL 查詢中
    conn = get_db_connection()
    query = f"SELECT * FROM users WHERE username='{username}' AND password='{password}'"
    result = conn.execute(query).fetchone()

    if result:
        session['user_id'] = result[0]
        session['is_admin'] = result[4]  # 假設第5列是admin權限
        return jsonify({"status": "success", "message": "Login successful"})
    else:
        return jsonify({"status": "error", "message": "Invalid credentials"})

@app.route('/admin/users', methods=['GET'])
def get_all_users():
    # 沒有權限檢查
    conn = get_db_connection()
    users = conn.execute("SELECT id, username, email, phone FROM users").fetchall()
    return jsonify({"users": users})

@app.route('/user/profile', methods=['GET'])
def get_profile():
    user_id = request.args.get('user_id')  # 從 URL 參數獲取

    conn = get_db_connection()
    # 又是字符串拼接
    query = f"SELECT username, email, phone, credit_card FROM users WHERE id={user_id}"
    user = conn.execute(query).fetchone()

    return jsonify({
        "username": user[0],
        "email": user[1],
        "phone": user[2],
        "credit_card": user[3]  # 直接返回信用卡資訊
    })

@app.route('/upload_avatar', methods=['POST'])
def upload_avatar():
    uploaded_file = request.files['avatar']
    filename = uploaded_file.filename

    # 直接使用用戶提供的檔名
    file_path = f"./uploads/{filename}"
    uploaded_file.save(file_path)

    return jsonify({"message": "Avatar uploaded", "path": file_path})

def hash_password(password):
    # 使用不安全的雜湊方法
    return hashlib.md5(password.encode()).hexdigest()

if __name__ == '__main__':
    app.run(debug=True)  # 生產環境開啟 debug 模式
```

### 任務要求
1. 使用 `security-auditor` agent 進行全面安全檢查
2. 識別所有安全漏洞並理解其風險等級
3. 獲得具體的修復建議
4. 理解如何建立安全的開發實踐

---

## 🛠️ 實作步驟

### 步驟 1：準備安全審查環境
```bash
# 1. 創建安全審查專案
mkdir security_audit
cd security_audit

# 2. 保存程式碼
# 將上述程式碼保存為 user_auth.py
```

### 步驟 2：一般審查（基線對比）
```bash
claude --add-file user_auth.py
```

**提示詞**：
```
請檢查這個程式碼的問題。
```

**觀察重點**：一般模式能發現哪些安全問題？

### 步驟 3：專業安全審查
```bash
# 切換到安全專家模式
/agents:security-auditor
```

**提示詞**：
```
請對這個用戶認證系統進行全面的安全審計，重點檢查：

1. 注入攻擊風險（SQL注入、命令注入等）
2. 認證和授權漏洞
3. 敏感資料處理問題
4. 輸入驗證不足
5. 安全配置問題
6. 檔案操作安全性

請：
- 按風險等級分類（Critical/High/Medium/Low）
- 提供具體的攻擊範例
- 給出修復建議
- 評估整體安全成熟度
```

### 步驟 4：深入分析特定漏洞

**提示詞**：
```
針對你發現的 SQL 注入漏洞，請提供：

1. 具體的攻擊載荷（payload）範例
2. 攻擊可能造成的影響
3. 在這個特定程式碼中的利用方式
4. 詳細的修復代碼範例

請用技術細節說明，就像你在培訓開發團隊一樣。
```

### 步驟 5：獲得安全修復版本

**提示詞**：
```
請提供這個程式碼的安全修復版本，解決所有發現的安全問題。

修復要求：
1. 使用參數化查詢防止 SQL 注入
2. 實施適當的認證和授權檢查
3. 安全地處理敏感資料
4. 添加輸入驗證
5. 修復檔案上傳安全問題
6. 改善安全配置

請在每個修復處添加註解說明。
```

---

## ✅ 成功檢查點

完成此情境後，你應該能夠：

**理解檢查點**：
- [ ] 我理解常見的 Web 應用安全漏洞
- [ ] 我知道 `security-auditor` 比一般模式更專業的原因
- [ ] 我能評估安全風險的嚴重程度

**技能檢查點**：
- [ ] 我能使用專業安全審查指令
- [ ] 我能解讀安全審計報告
- [ ] 我能理解並應用安全修復建議

**安全意識檢查點**：
- [ ] 我能識別 SQL 注入漏洞
- [ ] 我理解權限控制的重要性
- [ ] 我知道如何安全處理敏感資料

---

## 🔍 預期發現的安全問題

### 🔴 Critical 級別
1. **SQL 注入漏洞**
   ```python
   # 問題代碼
   query = f"SELECT * FROM users WHERE username='{username}'"

   # 攻擊範例
   username = "admin' OR '1'='1' --"
   ```

2. **敏感資料洩露**
   ```python
   # 直接返回信用卡資訊
   "credit_card": user[3]
   ```

### 🟠 High 級別
3. **檔案上傳漏洞**
   ```python
   # 可能的路徑遍歷攻擊
   filename = "../../../etc/passwd"
   ```

4. **權限控制缺失**
   ```python
   # 任何人都可以訪問管理員端點
   @app.route('/admin/users')
   ```

### 🟡 Medium 級別
5. **弱密碼雜湊**
   ```python
   # MD5 已被認為不安全
   hashlib.md5(password.encode())
   ```

6. **調試模式開啟**
   ```python
   app.run(debug=True)  # 生產環境風險
   ```

---

## 🎓 學習收穫

### 核心概念
1. **安全審查的系統性**：不是查找明顯錯誤，而是系統性地檢查各種攻擊向量
2. **專業 Agent 的價值**：安全專家有特定的知識庫和檢查模式
3. **風險分級的重要性**：不同漏洞有不同的緊急程度

### OWASP Top 10 對應
- **A03 - Injection**: SQL 注入
- **A01 - Broken Access Control**: 權限檢查缺失
- **A02 - Cryptographic Failures**: 弱密碼雜湊
- **A05 - Security Misconfiguration**: 調試模式

### 安全開發實踐
1. **輸入驗證**：永遠不信任用戶輸入
2. **最小權限原則**：只給必要的權限
3. **深度防禦**：多層安全措施
4. **安全配置**：移除調試資訊

---

## 🚀 進階挑戰

### 挑戰 1：滲透測試思維
**提示詞**：
```
請站在攻擊者的角度，設計針對這個系統的完整攻擊鏈：

1. 資訊收集階段
2. 漏洞發現階段
3. 漏洞利用階段
4. 權限提升階段
5. 資料竊取階段

提供每個階段的具體步驟和工具。
```

### 挑戰 2：安全檢查清單
**提示詞**：
```
基於這次審查，創建一個「Web 應用安全檢查清單」，
包含：
1. 程式碼審查項目
2. 配置檢查項目
3. 部署前檢查項目
4. 運行時監控項目

格式化為團隊可用的檢查表。
```

### 挑戰 3：自動化安全測試
**提示詞**：
```
設計一個自動化安全測試流程，包含：
1. 靜態程式碼分析
2. 動態安全測試
3. 依賴漏洞掃描
4. 安全配置檢查

提供具體的工具推薦和實施步驟。
```

---

## 📚 相關資源

**安全學習資源**：
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [SQL Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [Secure Coding Practices](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/)

**安全工具**：
- [Bandit](https://bandit.readthedocs.io/) - Python 安全掃描
- [SQLMap](http://sqlmap.org/) - SQL 注入檢測
- [OWASP ZAP](https://www.zaproxy.org/) - Web 應用安全掃描

**後續學習**：
- B05：效能瓶頸分析 - 學習 `performance-analyzer`
- C02：完整安全審查流程 - 複合級安全工作流程

---

## 💭 反思問題

1. **專業差異**：安全專家 vs 一般程式碼審查，發現問題的差異有多大？
2. **安全意識**：這次審查對你的安全開發意識有什麼影響？
3. **實際應用**：你會如何將安全審查整合到開發流程中？
4. **團隊推廣**：如何讓團隊養成安全編程習慣？

---

## 🔗 與前面情境的連結

**技能遞進**：
- B01：基本 Agent 使用（`code-reviewer`）
- B02：Agent + 輸出風格組合
- B03：測試生成（`test-generator`）
- **B04**：安全專業領域（`security-auditor`）

**知識累積**：
```
程式碼品質 → 文檔品質 → 測試品質 → 安全品質
```

---

**完成時間記錄**：___ 分鐘
**發現的安全問題數量**：___
**最震驚的發現**：___
**筆記區域**：
```
記錄你對安全問題的理解和感想...
```

---

*本情境重點是建立安全意識，體驗專業安全 Agent 的能力。安全是每個開發者都應該重視的領域。*