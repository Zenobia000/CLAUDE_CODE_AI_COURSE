# C02：Legacy 程式碼重構工作流程

## 🎯 情境描述

你接手了一個 5 年前的 Node.js 專案，程式碼混亂、沒有測試、架構不清。產品經理要求新增功能，但現有程式碼難以維護。你需要建立一套系統性的重構工作流程。

## 📊 情境參數

- **難度**：組合級
- **預計時間**：2-2.5 小時
- **技能需求**：程式設計 + 架構規劃
- **工具組合**：3+ Agents + 2+ MCP + 自訂輸出風格

## 🎯 學習目標

完成此情境後，你將能夠：
- [ ] 設計系統性的 Legacy 程式碼分析流程
- [ ] 建立風險評估與重構優先序機制
- [ ] 整合多個 Agent 進行協作分析
- [ ] 產出專業的重構計畫報告
- [ ] 建立可重複使用的重構工作流程

## 🚀 任務目標

建立一套完整的 Legacy 程式碼重構工作流程，包含：
1. 程式碼品質全面分析
2. 架構問題識別與分類
3. 重構風險評估與優先序排列
4. 漸進式重構計畫
5. 進度追蹤與品質監控機制

## 📋 前置準備

### 環境要求
- Claude Code 已安裝並配置
- Git 專案環境
- Node.js 專案（或準備範例專案）

### 專案設定
```bash
# 如果沒有現成專案，可以建立模擬 Legacy 專案
mkdir legacy-project-demo
cd legacy-project-demo
npm init -y
# 建立一些混亂的範例程式碼（稍後在流程中建立）
```

## 🎮 實戰流程

### 第一階段：深度分析與診斷（45 分鐘）

#### 步驟 1：載入專案並建立上下文
```bash
claude --add-dir ./src
claude --add-dir ./test
claude /context
```

檢查上下文使用情況，如果超載則進行優化：
```bash
claude /compact
```

#### 步驟 2：啟動程式碼分析專家群組
```bash
claude /agents:code-reviewer
```

**提示詞**：
```
我需要對這個 Legacy Node.js 專案進行全面的程式碼品質分析。請以資深架構師的角度，對以下面向進行深度分析：

1. 程式碼架構問題
2. 技術債務識別
3. 安全性問題
4. 效能瓶頸
5. 可維護性評估

請使用結構化的分析方法，並提供具體的檔案位置和程式碼片段。
```

#### 步驟 3：切換到安全審計專家
```bash
claude /agents:security-auditor
```

**提示詞**：
```
接續剛才的程式碼分析，請專注於安全性問題的深度審計：

1. 依賴套件的安全漏洞
2. 程式碼中的安全風險點
3. 資料驗證和輸入處理問題
4. 認證和授權機制檢查
5. 敏感資料處理問題

請提供具體的修復建議和優先序排列。
```

#### 步驟 4：效能分析專家評估
```bash
claude /agents:performance-analyzer
```

**提示詞**：
```
請對這個專案進行效能瓶頸分析：

1. 資料庫查詢優化機會
2. 記憶體使用模式分析
3. 非同步處理改善點
4. 快取機制改善建議
5. 打包和載入優化

請提供量化的改善預期和實作優先序。
```

### 第二階段：重構計畫設計（40 分鐘）

#### 步驟 5：建立專用輸出風格
```bash
claude /output-style:legacy-refactor-plan
```

如果沒有這個風格，建立一個：
```bash
claude
```

**提示詞**：
```
請幫我建立一個名為 "legacy-refactor-plan" 的輸出風格，用於產出 Legacy 程式碼重構計畫報告。格式應包含：

1. 執行摘要（Executive Summary）
2. 當前狀態評估（Current State Assessment）
3. 問題分類與優先序（Issue Categorization & Priority）
4. 重構路線圖（Refactoring Roadmap）
5. 風險評估與緩解策略（Risk Assessment & Mitigation）
6. 資源需求與時程規劃（Resource & Timeline Planning）
7. 成功指標與里程碑（Success Metrics & Milestones）

請產出具體的範本格式。
```

#### 步驟 6：整合分析結果並產出重構計畫
```bash
claude /output-style:legacy-refactor-plan
```

**提示詞**：
```
基於前面三位專家（程式碼審查、安全審計、效能分析）的分析結果，請產出一份完整的 Legacy 程式碼重構計畫。

重點考量：
1. 風險控制：每個重構步驟的風險評估
2. 漸進式方法：避免大爆炸式重構
3. 業務連續性：確保功能不受影響
4. 團隊能力：符合團隊技術水準
5. 時程規劃：合理的里程碑設定

請提供具體的行動項目和時程安排。
```

### 第三階段：實作指引與監控機制（35 分鐘）

#### 步驟 7：建立測試策略
```bash
claude /agents:test-generator
```

**提示詞**：
```
針對剛才的重構計畫，請設計一套完整的測試策略：

1. 現有功能的回歸測試設計
2. 重構過程中的安全網測試
3. 效能基準測試建立
4. 整合測試規劃
5. 自動化測試腳本範例

請提供具體的測試程式碼範例和執行方式。
```

#### 步驟 8：建立監控與追蹤機制
```bash
claude /agents:code-reviewer
```

**提示詞**：
```
請設計一套重構進度監控與品質追蹤機制：

1. 程式碼品質指標追蹤（複雜度、重複度等）
2. 技術債務減少指標
3. 重構進度里程碑檢查
4. 品質門檻設定
5. 自動化報告機制

請提供具體的工具建議和實作方式。
```

#### 步驟 9：產出最終工作流程文件
```bash
claude /output-style:workflow-documentation
```

**提示詞**：
```
請將整個 Legacy 程式碼重構流程標準化為可重複使用的工作流程文件：

1. 標準作業程序（SOP）
2. 檢查清單（Checklist）
3. 決策樹（Decision Tree）
4. 工具使用指南
5. 常見問題與解決方案

格式要求：
- 清晰的步驟說明
- 具體的指令範例
- 判斷標準和決策點
- 可客製化的範本

這個文件應該能讓其他開發者直接使用。
```

#### 步驟 10：記錄經驗與改善
```bash
claude /memory
```

**提示詞**：
```
請記錄這次 Legacy 程式碼重構工作流程設計的關鍵學習：

1. 最有效的 Agent 組合方式
2. 分析順序的重要性
3. 風險控制的關鍵點
4. 輸出風格的最佳實踐
5. 可改善的流程環節

請總結為未來參考的最佳實踐指南。
```

## ✅ 成果檢核

### 必備產出
- [ ] **程式碼品質分析報告**（來自 code-reviewer）
- [ ] **安全審計報告**（來自 security-auditor）
- [ ] **效能分析報告**（來自 performance-analyzer）
- [ ] **綜合重構計畫**（使用專用輸出風格）
- [ ] **測試策略文件**（來自 test-generator）
- [ ] **監控機制設計**
- [ ] **標準化工作流程文件**

### 品質標準
- [ ] 分析涵蓋程式碼、安全、效能三個面向
- [ ] 重構計畫具備風險評估和優先序
- [ ] 測試策略確保重構安全性
- [ ] 工作流程文件可重複使用
- [ ] 整個流程在 2.5 小時內完成

### 學習驗證
請回答以下問題驗證學習成果：

1. **Agent 協作**：你如何安排不同專家 Agent 的分析順序？為什麼？
2. **風險控制**：在 Legacy 程式碼重構中，最大的風險是什麼？如何控制？
3. **輸出格式**：為什麼需要建立專用的輸出風格？有什麼好處？
4. **流程標準化**：這套工作流程如何適用於不同類型的 Legacy 專案？

## 🚀 進階挑戰

### 挑戰 1：真實專案應用
將這套流程應用到你實際的專案中，記錄：
- 流程的適用性
- 需要調整的部分
- 實際效果評估

### 挑戰 2：團隊協作版本
設計團隊協作版本的重構工作流程：
- 多人協作機制
- 責任分工設計
- 進度同步方式

### 挑戰 3：不同技術棧適配
將工作流程適配到其他技術棧：
- Python/Django 專案
- Java/Spring 專案
- React/Vue 前端專案

## 💡 實戰技巧

### Agent 使用技巧
1. **分析順序很重要**：程式碼 → 安全 → 效能，每個階段基於前一階段結果
2. **上下文管理**：大型專案要善用 /compact 避免上下文超載
3. **專家切換**：不同 Agent 有不同專長，善用他們的優勢

### 輸出風格技巧
1. **標準化格式**：建立專用輸出風格確保報告一致性
2. **結構化資訊**：使用清晰的標題和分類便於後續處理
3. **可執行建議**：要求具體的行動項目而非抽象建議

### 工作流程技巧
1. **文件化思維**：每個步驟都要可重複、可交接
2. **檢查點設計**：重要決策點要有明確的判斷標準
3. **風險預案**：預想可能的問題並準備對應方案

## 🔗 相關學習

### 前置技能
- **B01-B10**：基礎級情境（特別是 B01, B04, B05）
- **模組 2**：CLI 基礎操作熟練

### 後續發展
- **C04**：全棧功能開發（在重構基礎上開發新功能）
- **C08**：程式碼品質審計（深化品質管控）
- **E02**：AI 程式碼審查系統（建立自動化系統）

---

**情境設計者**：AI 編程課程開發團隊
**最後更新**：2025年1月
**預估完成時間**：2-2.5 小時
**適用對象**：有程式設計經驗，想學習系統性重構方法的開發者