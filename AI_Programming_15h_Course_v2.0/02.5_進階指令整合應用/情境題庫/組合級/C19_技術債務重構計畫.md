# C19ï¼šæŠ€è¡“å‚µå‹™é‡æ§‹è¨ˆç•«ï¼ˆçµ„åˆç´šï¼‰

## æƒ…å¢ƒè³‡è¨Š

**ç·¨è™Ÿ**ï¼šC19
**é›£åº¦**ï¼šâ­â­â­â­â˜†ï¼ˆçµ„åˆç´šåé›£ï¼‰
**é è¨ˆæ™‚é–“**ï¼š2.5 å°æ™‚
**å­¸ç¿’ç›®æ¨™**ï¼š
- æŒæ¡ä½¿ç”¨ AI ç³»çµ±åŒ–è­˜åˆ¥æŠ€è¡“å‚µå‹™
- å­¸æœƒè¨­è¨ˆå¤§è¦æ¨¡é‡æ§‹è¨ˆç•«
- ç†è§£é¢¨éšªè©•ä¼°èˆ‡å„ªå…ˆç´šæ’åº
- å»ºç«‹å¯è¿½è¹¤çš„é‡æ§‹åŸ·è¡Œæµç¨‹

**é©ç”¨å°è±¡**ï¼š
- æŠ€è¡“ä¸»ç®¡æˆ–æ¶æ§‹å¸«
- è² è²¬ç¶­è­· legacy ç³»çµ±çš„é–‹ç™¼è€…
- éœ€è¦è¦åŠƒé‡æ§‹å°ˆæ¡ˆçš„åœ˜éšŠ

---

## æƒ…å¢ƒæè¿°

### èƒŒæ™¯

ä½ æ¥æ‰‹äº†ä¸€å€‹é‹è¡Œ 3 å¹´çš„é›»å•†å¾Œå°ç³»çµ±ã€‚ç³»çµ±é›–ç„¶åŠŸèƒ½æ­£å¸¸ï¼Œä½†æŠ€è¡“å‚µå‹™åš´é‡ï¼šä»£ç¢¼æ··äº‚ã€æ¸¬è©¦ä¸è¶³ã€æ•ˆèƒ½å•é¡Œé »ç¹ã€‚ç®¡ç†å±¤çµ¦ä½  3 å€‹æœˆæ™‚é–“é€²è¡Œé‡æ§‹ï¼Œä½†ä¸èƒ½å½±éŸ¿æ¥­å‹™é‹ä½œã€‚

### ç³»çµ±ç¾æ³

**å°ˆæ¡ˆè¦æ¨¡**ï¼š
- ä»£ç¢¼é‡ï¼šç´„ 50,000 è¡Œ Python
- æ ¸å¿ƒæ¨¡çµ„ï¼š10 å€‹ï¼ˆç”¨æˆ¶ã€å•†å“ã€è¨‚å–®ã€æ”¯ä»˜ã€ç‰©æµ...ï¼‰
- ä¾è³´å¥—ä»¶ï¼š68 å€‹ï¼ˆéƒ¨åˆ†å·²éæ™‚ï¼‰
- æ¸¬è©¦è¦†è“‹ç‡ï¼š< 30%
- æ—¥æ´»èºç”¨æˆ¶ï¼š10,000+

**å·²çŸ¥å•é¡Œ**ï¼ˆä¾†è‡ªåœ˜éšŠåé¥‹ï¼‰ï¼š
- ç¨‹å¼ç¢¼é‡è¤‡ç‡é«˜ï¼ˆç´„ 40%ï¼‰
- God Object æ¨¡å¼ï¼ˆå–®ä¸€é¡åˆ¥ > 2000 è¡Œï¼‰
- ç¼ºä¹æŠ½è±¡å±¤ï¼ˆç›´æ¥æ“ä½œè³‡æ–™åº«ï¼‰
- éŒ¯èª¤è™•ç†ä¸å®Œæ•´
- æ–‡æª”å¹¾ä¹æ²’æœ‰
- æ•ˆèƒ½ç“¶é ¸ï¼ˆæŸäº› API å›æ‡‰ > 3 ç§’ï¼‰
- å®‰å…¨éš±æ‚£ï¼ˆSQL Injection å¯èƒ½æ€§ï¼‰

### ä»£ç¢¼ç¯„ä¾‹ï¼ˆéƒ¨åˆ†ï¼‰

```python
# app/services/order_manager.pyï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›æ›´æ··äº‚ï¼‰

class OrderManager:
    """è¨‚å–®ç®¡ç†å™¨ï¼ˆGod Object - æ‰€æœ‰åŠŸèƒ½éƒ½å¡åœ¨é€™è£¡ï¼‰"""

    def __init__(self):
        self.db = MySQLdb.connect(
            host="localhost",
            user="root",
            passwd="password123",  # âŒ ç¡¬ç·¨ç¢¼å¯†ç¢¼
            db="ecommerce"
        )

    def create_order(self, user_id, items, address, payment_method):
        """å»ºç«‹è¨‚å–®ï¼ˆæ··é›œå¤ªå¤šè·è²¬ï¼‰"""
        cursor = self.db.cursor()

        # 1. é©—è­‰ä½¿ç”¨è€…ï¼ˆæ‡‰è©²æ˜¯ç¨ç«‹çš„ serviceï¼‰
        query = f"SELECT * FROM users WHERE id = {user_id}"  # âŒ SQL Injection
        cursor.execute(query)
        user = cursor.fetchone()
        if not user:
            return {"error": "User not found"}

        # 2. æª¢æŸ¥å•†å“åº«å­˜ï¼ˆæ‡‰è©²æ˜¯ ProductServiceï¼‰
        total_price = 0
        for item in items:
            query = f"SELECT price, stock FROM products WHERE id = {item['product_id']}"
            cursor.execute(query)
            product = cursor.fetchone()

            if product[1] < item['quantity']:  # âŒ é­”è¡“æ•¸å­—
                return {"error": f"Insufficient stock for {item['product_id']}"}

            total_price += product[0] * item['quantity']

        # 3. è¨ˆç®—é‹è²»ï¼ˆç¡¬ç·¨ç¢¼æ¥­å‹™é‚è¼¯ï¼‰
        if address['city'] == 'Taipei':
            shipping_fee = 60
        elif address['city'] == 'Kaohsiung':
            shipping_fee = 80
        else:
            shipping_fee = 100  # âŒ æ‡‰è©²å¾è¨­å®šæª”è®€å–

        total_price += shipping_fee

        # 4. è™•ç†æŠ˜æ‰£ï¼ˆè¤‡é›œé‚è¼¯æ··åœ¨ä¸€èµ·ï¼‰
        if user[5] == 'VIP':  # âŒ é­”è¡“æ•¸å­—
            total_price *= 0.9
        if total_price > 1000:
            total_price *= 0.95

        # 5. å»ºç«‹è¨‚å–®ï¼ˆæ‡‰è©²ç”¨ ORMï¼‰
        query = f"""
            INSERT INTO orders (user_id, total_price, address, status, created_at)
            VALUES ({user_id}, {total_price}, '{address}', 'pending', NOW())
        """  # âŒ SQL Injection + æ²’æœ‰ transaction
        cursor.execute(query)
        order_id = cursor.lastrowid

        # 6. å»ºç«‹è¨‚å–®é …ç›®
        for item in items:
            query = f"""
                INSERT INTO order_items (order_id, product_id, quantity, price)
                VALUES ({order_id}, {item['product_id']}, {item['quantity']}, {item['price']})
            """
            cursor.execute(query)  # âŒ æ²’æœ‰éŒ¯èª¤è™•ç†

            # 7. æ‰£æ¸›åº«å­˜
            query = f"""
                UPDATE products SET stock = stock - {item['quantity']}
                WHERE id = {item['product_id']}
            """
            cursor.execute(query)

        # 8. å‘¼å«æ”¯ä»˜ï¼ˆæ‡‰è©²æ˜¯ PaymentServiceï¼‰
        if payment_method == 'credit_card':
            # TODO: å¯¦ä½œä¿¡ç”¨å¡æ”¯ä»˜
            pass
        elif payment_method == 'cash':
            pass

        # 9. ç™¼é€é€šçŸ¥ï¼ˆæ‡‰è©²æ˜¯ NotificationServiceï¼‰
        # TODO: ç™¼é€ email

        self.db.commit()
        return {"order_id": order_id, "total": total_price}

    def get_order_details(self, order_id):
        """å–å¾—è¨‚å–®è©³æƒ…ï¼ˆåˆæ˜¯ä¸€å¤§å¨ SQLï¼‰"""
        cursor = self.db.cursor()
        query = f"""
            SELECT o.*, u.name, u.email
            FROM orders o
            JOIN users u ON o.user_id = u.id
            WHERE o.id = {order_id}
        """  # âŒ SQL Injection
        cursor.execute(query)
        order = cursor.fetchone()

        if not order:
            return None

        # å–å¾—è¨‚å–®é …ç›®
        query = f"SELECT * FROM order_items WHERE order_id = {order_id}"
        cursor.execute(query)
        items = cursor.fetchall()

        # âŒ æ‰‹å‹•çµ„åˆè³‡æ–™ï¼ˆæ‡‰è©²ç”¨ ORMï¼‰
        return {
            'id': order[0],
            'user_id': order[1],
            'total_price': order[2],
            'status': order[3],
            'created_at': order[4],
            'user_name': order[10],
            'items': items
        }

    def cancel_order(self, order_id, user_id):
        """å–æ¶ˆè¨‚å–®"""
        cursor = self.db.cursor()

        # âŒ æ²’æœ‰é©—è­‰æ¬Šé™
        # âŒ æ²’æœ‰æª¢æŸ¥è¨‚å–®ç‹€æ…‹
        query = f"UPDATE orders SET status = 'cancelled' WHERE id = {order_id}"
        cursor.execute(query)

        # âŒ å¿˜è¨˜æ¢å¾©åº«å­˜
        # âŒ å¿˜è¨˜é€€æ¬¾

        self.db.commit()
        return True

    # ... é‚„æœ‰ 30 å€‹é¡ä¼¼çš„æ–¹æ³•
```

```python
# app/utils/helpers.pyï¼ˆå„ç¨®é›œä¸ƒé›œå…«çš„å‡½æ•¸ï¼‰

def calculate_discount(user_type, total):
    """è¨ˆç®—æŠ˜æ‰£ï¼ˆæ¥­å‹™é‚è¼¯æ•£è½å„è™•ï¼‰"""
    if user_type == 'VIP':
        return total * 0.9
    elif user_type == 'SVIP':
        return total * 0.8
    else:
        return total

def validate_email(email):
    """Email é©—è­‰ï¼ˆæ‡‰è©²ç”¨ libraryï¼‰"""
    if '@' in email and '.' in email:
        return True
    return False

def generate_order_number():
    """ç”Ÿæˆè¨‚å–®ç·¨è™Ÿï¼ˆä¸å¤ å”¯ä¸€ï¼‰"""
    import random
    return f"ORD{random.randint(10000, 99999)}"  # âŒ å¯èƒ½é‡è¤‡

# ... é‚„æœ‰ 50 å€‹é€™ç¨®å‡½æ•¸
```

### ä½ çš„ä»»å‹™

ä½¿ç”¨ Claude Code AI Agent å¹³å°ï¼Œåˆ¶å®šä¸€ä»½å®Œæ•´çš„æŠ€è¡“å‚µå‹™é‡æ§‹è¨ˆç•«ï¼ŒåŒ…å«ï¼š

1. **æŠ€è¡“å‚µå‹™è­˜åˆ¥**ï¼šç³»çµ±åŒ–æƒææ‰€æœ‰å•é¡Œ
2. **é¢¨éšªè©•ä¼°**ï¼šè©•ä¼°æ¯å€‹å•é¡Œçš„å½±éŸ¿èˆ‡ä¿®å¾©æˆæœ¬
3. **å„ªå…ˆç´šæ’åº**ï¼šæ±ºå®šé‡æ§‹é †åº
4. **é‡æ§‹æ–¹æ¡ˆè¨­è¨ˆ**ï¼šæä¾›å…·é«”çš„æ”¹é€²æ–¹æ¡ˆ
5. **åŸ·è¡Œè¨ˆç•«**ï¼šåˆ†éšæ®µã€å¯è¿½è¹¤çš„åŸ·è¡Œè·¯ç·šåœ–
6. **é©—è­‰æ©Ÿåˆ¶**ï¼šå¦‚ä½•ç¢ºä¿é‡æ§‹ä¸ç ´å£ç¾æœ‰åŠŸèƒ½

---

## å­¸ç¿’é‡é»

### ç›®æ¨™ 1ï¼šå¤šç¶­åº¦å‚µå‹™åˆ†æ

å­¸æœƒå¾ä¸åŒè§’åº¦è­˜åˆ¥æŠ€è¡“å‚µå‹™ï¼š
- **å®‰å…¨æ€§**ï¼šSQL Injection, ç¡¬ç·¨ç¢¼å¯†ç¢¼
- **æ¶æ§‹**ï¼šGod Object, ç¼ºä¹åˆ†å±¤
- **ç¨‹å¼ç¢¼å“è³ª**ï¼šé‡è¤‡ä»£ç¢¼ã€é­”è¡“æ•¸å­—ã€ç¼ºä¹éŒ¯èª¤è™•ç†
- **æ•ˆèƒ½**ï¼šN+1 æŸ¥è©¢ã€ç¼ºä¹å¿«å–
- **å¯ç¶­è­·æ€§**ï¼šæ–‡æª”ä¸è¶³ã€æ¸¬è©¦è¦†è“‹ç‡ä½

### ç›®æ¨™ 2ï¼šAI Agent å”ä½œæ¨¡å¼

ç†è§£ä¸åŒ Agent åœ¨é‡æ§‹è¨ˆç•«ä¸­çš„è§’è‰²ï¼š
- **code-reviewer**: è­˜åˆ¥ä»£ç¢¼ç•°å‘³
- **security-auditor**: ç™¼ç¾å®‰å…¨æ¼æ´
- **architect**: è¨­è¨ˆæ–°æ¶æ§‹
- **refactoring-specialist**: æä¾›é‡æ§‹æ­¥é©Ÿ

### ç›®æ¨™ 3ï¼šé¢¨éšªç®¡ç†

æŒæ¡å¦‚ä½•åœ¨ä¸åœæ©Ÿçš„æƒ…æ³ä¸‹é‡æ§‹ï¼š
- Strangler Fig Patternï¼ˆçµæ®ºè€…æ¨¡å¼ï¼‰
- Feature Flag æ§åˆ¶æ–°èˆŠåˆ‡æ›
- ä¸¦è¡Œé‹ä½œé©—è­‰
- Rollback æ©Ÿåˆ¶

### ç›®æ¨™ 4ï¼šå¯åŸ·è¡Œçš„è¨ˆç•«

ç”¢å‡ºçš„è¨ˆç•«å¿…é ˆåŒ…å«ï¼š
- å…·é«”çš„å·¥ä½œé …ç›®ï¼ˆå¯åˆ†é…çµ¦åœ˜éšŠï¼‰
- æ™‚é–“ä¼°ç®—ï¼ˆrealisticï¼‰
- æª¢æŸ¥é»ï¼ˆmilestonesï¼‰
- æˆåŠŸæ¨™æº–ï¼ˆå¦‚ä½•é©—è­‰ï¼‰

---

## å»ºè­°è§£æ±ºæµç¨‹

### éšæ®µä¸€ï¼šæŠ€è¡“å‚µå‹™å…¨é¢æƒæï¼ˆ40 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šç³»çµ±åŒ–è­˜åˆ¥æ‰€æœ‰å•é¡Œ

#### æ­¥é©Ÿ 1ï¼šè‡ªå‹•åŒ–ä»£ç¢¼æƒæ

```bash
# ä½¿ç”¨ /grep æ‰¾å‡ºæ‰€æœ‰æ½›åœ¨å•é¡Œ

# 1. SQL Injection é¢¨éšª
/grep "f\".*SELECT.*FROM" --type py -n

# 2. ç¡¬ç·¨ç¢¼å¯†ç¢¼/API Key
/grep "password.*=.*['\"]" --type py -n
/grep "api_key.*=.*['\"]" --type py -n

# 3. God Objectï¼ˆè¶…å¤§é¡åˆ¥ï¼‰
/bash wc -l app/**/*.py | sort -rn | head -20

# 4. é‡è¤‡ä»£ç¢¼
/bash find app -name "*.py" -exec grep -l "calculate_discount" {} \;

# 5. é­”è¡“æ•¸å­—
/grep "\b(0\.9|0\.8|100|60|80)\b" --type py app/services/
```

**é æœŸç™¼ç¾**ï¼š

```
SQL Injection é¢¨éšªï¼š27 è™•
ç¡¬ç·¨ç¢¼æ©Ÿæ•è³‡æ–™ï¼š12 è™•
è¶…é 500 è¡Œçš„é¡åˆ¥ï¼š8 å€‹
é‡è¤‡ä»£ç¢¼æ¨¡å¼ï¼š45+ è™•
é­”è¡“æ•¸å­—ï¼š200+ å€‹
```

#### æ­¥é©Ÿ 2ï¼šä½¿ç”¨ code-reviewer æ·±åº¦åˆ†æ

```bash
# åˆ‡æ›åˆ°ä»£ç¢¼å¯©æŸ¥å°ˆå®¶
/agents:code-reviewer

# æä¾›åˆ†æä»»å‹™
è«‹å° app/services/order_manager.py é€²è¡Œå…¨é¢å¯©æŸ¥ã€‚

é—œæ³¨é»ï¼š
1. è¨­è¨ˆæ¨¡å¼å•é¡Œï¼ˆGod Object, è·è²¬æ··äº‚ï¼‰
2. ä»£ç¢¼ç•°å‘³ï¼ˆé‡è¤‡ä»£ç¢¼ã€é•·æ–¹æ³•ã€é­”è¡“æ•¸å­—ï¼‰
3. éŒ¯èª¤è™•ç†ï¼ˆç¼ºå¤±ã€ä¸å®Œæ•´ï¼‰
4. å¯æ¸¬è©¦æ€§ï¼ˆä¾è³´æ³¨å…¥ã€è€¦åˆåº¦ï¼‰
5. æ•ˆèƒ½å•é¡Œï¼ˆN+1 æŸ¥è©¢ã€ç¼ºä¹å¿«å–ï¼‰

è«‹åˆ†é¡å•é¡Œåš´é‡ç¨‹åº¦ï¼š
- Criticalï¼ˆå¿…é ˆç«‹å³ä¿®å¾©ï¼‰
- Highï¼ˆçŸ­æœŸå…§ä¿®å¾©ï¼‰
- Mediumï¼ˆä¸­æœŸè¨ˆç•«ï¼‰
- Lowï¼ˆæœ‰æ™‚é–“å†è™•ç†ï¼‰

ç”¢å‡ºæ ¼å¼ï¼šMarkdown è¡¨æ ¼
```

**é æœŸè¼¸å‡º**ï¼š

```markdown
# ä»£ç¢¼å¯©æŸ¥å ±å‘Šï¼šOrderManager

## ç¸½é«”è©•ç´šï¼šğŸ”´ éœ€è¦é‡å¤§é‡æ§‹ï¼ˆ3/10ï¼‰

### å•é¡Œåˆ†é¡çµ±è¨ˆ

| åš´é‡ç¨‹åº¦ | å•é¡Œæ•¸é‡ | ä¸»è¦é¡å‹ |
|---------|---------|---------|
| Critical | 8 | SQL Injection, ç¡¬ç·¨ç¢¼å¯†ç¢¼, ç¼ºä¹ Transaction |
| High | 15 | God Object, ç¼ºä¹æŠ½è±¡, éŒ¯èª¤è™•ç†ä¸è¶³ |
| Medium | 23 | é‡è¤‡ä»£ç¢¼, é­”è¡“æ•¸å­—, æ–‡æª”ä¸è¶³ |
| Low | 12 | å‘½åä¸ä½³, è¨»è§£éå°‘ |

---

## Critical å•é¡Œæ¸…å–®

### C-1: SQL Injection æ¼æ´ï¼ˆ8 è™•ï¼‰

**ä½ç½®**ï¼š
- Line 18: `create_order()` - user_id æœªåƒæ•¸åŒ–
- Line 28: `create_order()` - product_id æœªåƒæ•¸åŒ–
- Line 72: `get_order_details()` - order_id æœªåƒæ•¸åŒ–
- ...

**é¢¨éšª**ï¼š
- æ”»æ“Šè€…å¯ç«Šå–æ‰€æœ‰è¨‚å–®è³‡æ–™
- å¯èƒ½åˆªé™¤æˆ–ä¿®æ”¹è³‡æ–™åº«
- é•å OWASP Top 10

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
```python
# âŒ ç¾æ³
query = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(query)

# âœ… ä¿®å¾©
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
```

**å½±éŸ¿ç¯„åœ**ï¼š8 å€‹æ–¹æ³•
**é ä¼°ä¿®å¾©æ™‚é–“**ï¼š4 å°æ™‚
**å„ªå…ˆç´š**ï¼šğŸ”´ P0ï¼ˆç«‹å³ä¿®å¾©ï¼‰

---

### C-2: ç¡¬ç·¨ç¢¼è³‡æ–™åº«å¯†ç¢¼

**ä½ç½®**ï¼šLine 8
**å•é¡Œ**ï¼š
```python
self.db = MySQLdb.connect(
    host="localhost",
    user="root",
    passwd="password123",  # âŒ æ˜æ–‡å¯†ç¢¼
    db="ecommerce"
)
```

**é¢¨éšª**ï¼š
- å¯†ç¢¼å¯èƒ½è¢«æ¨é€åˆ° Git
- ç„¡æ³•åœ¨ä¸åŒç’°å¢ƒä½¿ç”¨ä¸åŒå¯†ç¢¼
- é•å 12-Factor App åŸå‰‡

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
```python
import os
from urllib.parse import urlparse

DATABASE_URL = os.getenv('DATABASE_URL')
db_config = urlparse(DATABASE_URL)

self.db = MySQLdb.connect(
    host=db_config.hostname,
    user=db_config.username,
    passwd=db_config.password,
    db=db_config.path[1:]
)
```

**é ä¼°ä¿®å¾©æ™‚é–“**ï¼š2 å°æ™‚
**å„ªå…ˆç´š**ï¼šğŸ”´ P0

---

## High å•é¡Œæ¸…å–®

### H-1: God Object åæ¨¡å¼

**å•é¡Œ**ï¼šOrderManager é¡åˆ¥æ‰¿æ“”éå¤šè·è²¬

**ç•¶å‰è·è²¬**ï¼ˆæ‡‰è©²åˆ†é›¢ï¼‰ï¼š
1. ä½¿ç”¨è€…é©—è­‰ â†’ æ‡‰è©²æ˜¯ AuthService
2. å•†å“ç®¡ç† â†’ æ‡‰è©²æ˜¯ ProductService
3. è¨‚å–®å»ºç«‹ â†’ OrderService
4. æ”¯ä»˜è™•ç† â†’ PaymentService
5. åº«å­˜ç®¡ç† â†’ InventoryService
6. é€šçŸ¥ç™¼é€ â†’ NotificationService
7. è³‡æ–™åº«æ“ä½œ â†’ Repository Layer

**é‡æ§‹æ–¹æ¡ˆ**ï¼ˆåˆ†å±¤æ¶æ§‹ï¼‰ï¼š

```python
# æ–°æ¶æ§‹

# Domain Layer
class Order:
    """è¨‚å–®é ˜åŸŸæ¨¡å‹"""
    def __init__(self, user_id, items, address):
        self.user_id = user_id
        self.items = items
        self.address = address
        self.status = 'pending'

    def calculate_total(self, pricing_service):
        """è¨ˆç®—ç¸½é‡‘é¡ï¼ˆä¾è³´æ³¨å…¥ï¼‰"""
        return pricing_service.calculate(self.items, self.address)

    def can_cancel(self):
        """æ¥­å‹™è¦å‰‡ï¼šå“ªäº›ç‹€æ…‹å¯ä»¥å–æ¶ˆ"""
        return self.status in ['pending', 'confirmed']

# Service Layer
class OrderService:
    """è¨‚å–®æ‡‰ç”¨æœå‹™ï¼ˆå”èª¿å„ç¨® servicesï¼‰"""

    def __init__(
        self,
        order_repo: OrderRepository,
        product_service: ProductService,
        payment_service: PaymentService,
        inventory_service: InventoryService
    ):
        self.order_repo = order_repo
        self.product_service = product_service
        self.payment_service = payment_service
        self.inventory_service = inventory_service

    def create_order(self, user_id, items, address, payment_method):
        """å»ºç«‹è¨‚å–®ï¼ˆè·è²¬æ¸…æ™°ï¼‰"""
        # 1. é©—è­‰å•†å“å­˜åœ¨ä¸”æœ‰åº«å­˜
        self.product_service.validate_items(items)

        # 2. å»ºç«‹è¨‚å–®ç‰©ä»¶
        order = Order(user_id, items, address)

        # 3. ä¿ç•™åº«å­˜ï¼ˆé‚„æœªæ‰£æ¸›ï¼‰
        reservation = self.inventory_service.reserve(items)

        try:
            # 4. è™•ç†æ”¯ä»˜
            payment = self.payment_service.charge(
                amount=order.total,
                method=payment_method
            )

            # 5. ç¢ºèªè¨‚å–®ä¸¦æ‰£æ¸›åº«å­˜
            order.confirm(payment.transaction_id)
            self.inventory_service.commit(reservation)

            # 6. å„²å­˜è¨‚å–®
            saved_order = self.order_repo.save(order)

            return Result.success(saved_order)

        except PaymentError as e:
            # é‡‹æ”¾åº«å­˜ä¿ç•™
            self.inventory_service.release(reservation)
            return Result.failure(f"Payment failed: {e}")

# Repository Layer
class OrderRepository:
    """è³‡æ–™å­˜å–å±¤ï¼ˆä½¿ç”¨ ORMï¼‰"""

    def save(self, order: Order) -> Order:
        """å„²å­˜è¨‚å–®ï¼ˆä½¿ç”¨ SQLAlchemyï¼‰"""
        order_model = OrderModel(
            user_id=order.user_id,
            total_price=order.total,
            status=order.status
        )
        db.session.add(order_model)
        db.session.commit()
        return order
```

**é ä¼°é‡æ§‹æ™‚é–“**ï¼š40 å°æ™‚ï¼ˆåˆ† 4 é€±åŸ·è¡Œï¼‰
**å„ªå…ˆç´š**ï¼šğŸŸ  P1

---

### H-2: ç¼ºä¹ Transaction ç®¡ç†

**å•é¡Œ**ï¼šè¨‚å–®å»ºç«‹éç¨‹æ²’æœ‰ä½¿ç”¨ transactionï¼Œå¯èƒ½å°è‡´è³‡æ–™ä¸ä¸€è‡´

**é¢¨éšªå ´æ™¯**ï¼š
```
1. å»ºç«‹è¨‚å–®è¨˜éŒ„ âœ…
2. å»ºç«‹è¨‚å–®é …ç›® âœ…
3. æ‰£æ¸›åº«å­˜ âœ…
4. å‘¼å«æ”¯ä»˜ âŒ å¤±æ•—ï¼

çµæœï¼šè¨‚å–®å·²å»ºç«‹ã€åº«å­˜å·²æ‰£æ¸›ï¼Œä½†æ”¯ä»˜å¤±æ•—
â†’ è³‡æ–™ä¸ä¸€è‡´ï¼
```

**ä¿®å¾©æ–¹æ¡ˆ**ï¼ˆä½¿ç”¨ SQLAlchemyï¼‰ï¼š
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

def create_order_with_transaction(self, ...):
    session = Session()
    try:
        # æ‰€æœ‰æ“ä½œåœ¨åŒä¸€ transaction
        order = Order(...)
        session.add(order)

        for item in items:
            order_item = OrderItem(...)
            session.add(order_item)

            # æ‰£æ¸›åº«å­˜
            product = session.query(Product).get(item.product_id)
            product.stock -= item.quantity

        # å…¨éƒ¨æˆåŠŸæ‰ commit
        session.commit()
        return order

    except Exception as e:
        # ä»»ä½•éŒ¯èª¤éƒ½ rollback
        session.rollback()
        raise
    finally:
        session.close()
```

**é ä¼°ä¿®å¾©æ™‚é–“**ï¼š8 å°æ™‚
**å„ªå…ˆç´š**ï¼šğŸŸ  P1

---

ï¼ˆç¹¼çºŒåˆ—å‡ºå…¶ä»– High/Medium/Low å•é¡Œ...ï¼‰
```

**è¨˜æ†¶æ²‰æ¾±**ï¼š
```bash
/memory save

ä¸»é¡Œï¼šæŠ€è¡“å‚µå‹™ç³»çµ±åŒ–è­˜åˆ¥æµç¨‹

Step 1: è‡ªå‹•åŒ–æƒæï¼ˆä½¿ç”¨ grep + bashï¼‰
- SQL Injection: /grep "f\".*SELECT.*FROM"
- æ©Ÿæ•è³‡æ–™: /grep "password.*=.*['\"]"
- è¶…å¤§é¡åˆ¥: wc -l *.py | sort -rn
- é‡è¤‡ä»£ç¢¼: grep -r "ç›¸åŒæ¨¡å¼"
- é­”è¡“æ•¸å­—: /grep "\b(0\.9|100)\b"

Step 2: AI Agent æ·±åº¦åˆ†æ
- code-reviewer: è­˜åˆ¥è¨­è¨ˆå•é¡Œã€ä»£ç¢¼ç•°å‘³
- security-auditor: ç™¼ç¾å®‰å…¨æ¼æ´
- architect: è©•ä¼°æ¶æ§‹å•é¡Œ

Step 3: å•é¡Œåˆ†é¡
- Critical: å®‰å…¨æ¼æ´ã€è³‡æ–™ä¸€è‡´æ€§
- High: God Objectã€ç¼ºä¹æŠ½è±¡
- Medium: é‡è¤‡ä»£ç¢¼ã€é­”è¡“æ•¸å­—
- Low: å‘½åã€è¨»è§£

Step 4: é‡åŒ–è©•ä¼°
- å•é¡Œæ•¸é‡çµ±è¨ˆ
- å½±éŸ¿ç¯„åœåˆ†æ
- ä¿®å¾©æ™‚é–“ä¼°ç®—
- é¢¨éšªè©•ç´š

è¼¸å‡ºï¼šçµæ§‹åŒ–çš„å•é¡Œæ¸…å–®ï¼ˆMarkdown è¡¨æ ¼ï¼‰

ç›¸é—œ Agent: code-reviewer, security-auditor, architect
```

---

### éšæ®µäºŒï¼šæ¶æ§‹é‡æ§‹è¨­è¨ˆï¼ˆ40 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šè¨­è¨ˆæ–°çš„ç³»çµ±æ¶æ§‹

```bash
# åˆ‡æ›åˆ°æ¶æ§‹å¸«
/agents:architect

# æä¾›é‡æ§‹éœ€æ±‚
åŸºæ–¼ä»¥ä¸Šè­˜åˆ¥çš„å•é¡Œï¼Œè«‹è¨­è¨ˆæ”¹é€²å¾Œçš„ç³»çµ±æ¶æ§‹ã€‚

## ç¾æœ‰å•é¡Œ
- God Objectï¼ˆOrderManager 2000+ è¡Œï¼‰
- ç¼ºä¹åˆ†å±¤ï¼ˆæ¥­å‹™é‚è¼¯èˆ‡è³‡æ–™åº«æ“ä½œæ··é›œï¼‰
- ç›´æ¥ä½¿ç”¨ MySQLdbï¼ˆæ‡‰è©²ç”¨ ORMï¼‰
- ç¼ºä¹ä¾è³´æ³¨å…¥ï¼ˆé›£ä»¥æ¸¬è©¦ï¼‰
- ç¼ºä¹ Transaction ç®¡ç†

## è¨­è¨ˆç›®æ¨™
1. æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹ï¼ˆDomain, Service, Repositoryï¼‰
2. ä½¿ç”¨ SQLAlchemy ORM
3. ä¾è³´æ³¨å…¥ï¼ˆæ–¹ä¾¿æ¸¬è©¦ï¼‰
4. å®Œæ•´çš„éŒ¯èª¤è™•ç†
5. Transaction ç®¡ç†
6. å¯æ“´å±•æ€§ï¼ˆæœªä¾†æ”¯æ´å¤šç¨®æ”¯ä»˜æ–¹å¼ï¼‰

## éœ€æ±‚
1. é‡æ§‹å¾Œçš„æ¶æ§‹åœ–ï¼ˆMermaidï¼‰
2. æ ¸å¿ƒé¡åˆ¥è¨­è¨ˆï¼ˆPython ç¨‹å¼ç¢¼ï¼‰
3. å¾èˆŠæ¶æ§‹é·ç§»åˆ°æ–°æ¶æ§‹çš„ç­–ç•¥ï¼ˆStrangler Fig Patternï¼‰
4. é©—è­‰æ–¹æ¡ˆï¼ˆå¦‚ä½•ç¢ºä¿é‡æ§‹ä¸ç ´å£åŠŸèƒ½ï¼‰

ç”¢å‡ºæ ¼å¼ï¼šMarkdown + Mermaid + Python code
```

**é æœŸè¼¸å‡º**ï¼š

````markdown
# è¨‚å–®ç³»çµ±é‡æ§‹æ¶æ§‹è¨­è¨ˆ

## 1. æ–°æ¶æ§‹ç¸½è¦½

### 1.1 åˆ†å±¤æ¶æ§‹

```mermaid
graph TB
    subgraph "API Layer"
        Routes[Flask Routes<br/>è¨‚å–®ç«¯é»]
    end

    subgraph "Service Layerï¼ˆæ¥­å‹™é‚è¼¯ï¼‰"
        OrderService[OrderService<br/>è¨‚å–®å”èª¿]
        ProductService[ProductService<br/>å•†å“ç®¡ç†]
        PaymentService[PaymentService<br/>æ”¯ä»˜è™•ç†]
        InventoryService[InventoryService<br/>åº«å­˜ç®¡ç†]
        NotificationService[NotificationService<br/>é€šçŸ¥]
    end

    subgraph "Domain Layerï¼ˆé ˜åŸŸæ¨¡å‹ï¼‰"
        Order[Order<br/>è¨‚å–®å¯¦é«”]
        OrderItem[OrderItem<br/>è¨‚å–®é …ç›®]
        Payment[Payment<br/>æ”¯ä»˜]
    end

    subgraph "Repository Layerï¼ˆè³‡æ–™å­˜å–ï¼‰"
        OrderRepo[OrderRepository]
        ProductRepo[ProductRepository]
    end

    subgraph "Infrastructure"
        DB[(PostgreSQL<br/>ORM: SQLAlchemy)]
        Redis[(Redis<br/>å¿«å–)]
        Queue[RabbitMQ<br/>éåŒæ­¥ä»»å‹™]
    end

    Routes --> OrderService
    OrderService --> ProductService
    OrderService --> PaymentService
    OrderService --> InventoryService
    OrderService --> NotificationService

    OrderService --> Order
    OrderService --> OrderRepo

    OrderRepo --> DB
    ProductService --> ProductRepo
    ProductRepo --> DB

    NotificationService --> Queue

    style Routes fill:#e1f5ff
    style OrderService fill:#fff9c4
    style Order fill:#c8e6c9
    style OrderRepo fill:#f8bbd0
```

**è·è²¬æ¸…æ™°**ï¼š
- API Layer: HTTP è™•ç†ã€é©—è­‰ã€åºåˆ—åŒ–
- Service Layer: æ¥­å‹™é‚è¼¯ã€æµç¨‹å”èª¿
- Domain Layer: æ¥­å‹™è¦å‰‡ã€å¯¦é«”
- Repository Layer: è³‡æ–™åº«æ“ä½œï¼ˆæŠ½è±¡åŒ–ï¼‰
- Infrastructure: æŠ€è¡“ç´°ç¯€

### 1.2 ä¾è³´é—œä¿‚

```mermaid
graph LR
    API[API Layer] --> Service[Service Layer]
    Service --> Domain[Domain Layer]
    Service --> Repo[Repository Layer]
    Repo --> Infra[Infrastructure]

    Domain -.ç¨ç«‹æ–¼.-> Repo
    Domain -.ç¨ç«‹æ–¼.-> Infra

    style Domain fill:#c8e6c9
```

**é—œéµåŸå‰‡**ï¼š
- Domain Layer ä¸ä¾è³´ä»»ä½•å¤–éƒ¨å±¤ï¼ˆPure Pythonï¼‰
- Service Layer ä¾è³´ Domain å’Œ Repository ä»‹é¢
- Repository å¯¦ä½œä¾è³´ Infrastructure

## 2. æ ¸å¿ƒé¡åˆ¥è¨­è¨ˆ

### 2.1 Domain Layerï¼ˆé ˜åŸŸæ¨¡å‹ï¼‰

```python
# domain/models.py

from dataclasses import dataclass
from decimal import Decimal
from datetime import datetime
from typing import List, Optional

@dataclass
class OrderItem:
    """è¨‚å–®é …ç›®ï¼ˆå€¼ç‰©ä»¶ï¼‰"""
    product_id: int
    product_name: str
    price: Decimal
    quantity: int

    @property
    def subtotal(self) -> Decimal:
        """å°è¨ˆ"""
        return self.price * self.quantity

    def validate(self):
        """é©—è­‰"""
        if self.quantity < 1:
            raise ValueError("Quantity must be positive")
        if self.price < 0:
            raise ValueError("Price cannot be negative")

@dataclass
class Address:
    """åœ°å€ï¼ˆå€¼ç‰©ä»¶ï¼‰"""
    city: str
    district: str
    street: str
    postal_code: str

    def __str__(self):
        return f"{self.postal_code} {self.city}{self.district}{self.street}"

class Order:
    """è¨‚å–®å¯¦é«”ï¼ˆèšåˆæ ¹ï¼‰"""

    def __init__(
        self,
        user_id: int,
        items: List[OrderItem],
        shipping_address: Address
    ):
        self.id: Optional[int] = None
        self.user_id = user_id
        self.items = items
        self.shipping_address = shipping_address
        self.status = OrderStatus.PENDING
        self.payment_id: Optional[str] = None
        self.created_at = datetime.utcnow()
        self.updated_at = datetime.utcnow()

        # é©—è­‰
        self._validate()

    def _validate(self):
        """é©—è­‰è¨‚å–®"""
        if not self.items:
            raise ValueError("Order must have at least one item")

        for item in self.items:
            item.validate()

    @property
    def total(self) -> Decimal:
        """è¨‚å–®ç¸½é‡‘é¡"""
        return sum(item.subtotal for item in self.items)

    def confirm(self, payment_id: str):
        """ç¢ºèªè¨‚å–®ï¼ˆæ¥­å‹™è¦å‰‡ï¼‰"""
        if self.status != OrderStatus.PENDING:
            raise InvalidOrderStateError(
                f"Cannot confirm order in {self.status} status"
            )

        self.status = OrderStatus.CONFIRMED
        self.payment_id = payment_id
        self.updated_at = datetime.utcnow()

    def cancel(self):
        """å–æ¶ˆè¨‚å–®ï¼ˆæ¥­å‹™è¦å‰‡ï¼‰"""
        if not self.can_cancel():
            raise InvalidOrderStateError(
                f"Cannot cancel order in {self.status} status"
            )

        self.status = OrderStatus.CANCELLED
        self.updated_at = datetime.utcnow()

    def can_cancel(self) -> bool:
        """æ¥­å‹™è¦å‰‡ï¼šå“ªäº›ç‹€æ…‹å¯ä»¥å–æ¶ˆ"""
        return self.status in [OrderStatus.PENDING, OrderStatus.CONFIRMED]

class OrderStatus:
    """è¨‚å–®ç‹€æ…‹ï¼ˆæšèˆ‰ï¼‰"""
    PENDING = 'pending'
    CONFIRMED = 'confirmed'
    SHIPPING = 'shipping'
    DELIVERED = 'delivered'
    CANCELLED = 'cancelled'
```

### 2.2 Repository Layerï¼ˆè³‡æ–™å­˜å–æŠ½è±¡ï¼‰

```python
# repositories/interfaces.py

from abc import ABC, abstractmethod
from typing import Optional, List
from domain.models import Order

class OrderRepository(ABC):
    """è¨‚å–®å€‰å„²ä»‹é¢ï¼ˆæŠ½è±¡ï¼‰"""

    @abstractmethod
    def save(self, order: Order) -> Order:
        """å„²å­˜è¨‚å–®"""
        pass

    @abstractmethod
    def find_by_id(self, order_id: int) -> Optional[Order]:
        """æ ¹æ“š ID æŸ¥è©¢"""
        pass

    @abstractmethod
    def find_by_user_id(self, user_id: int) -> List[Order]:
        """æ ¹æ“šä½¿ç”¨è€… ID æŸ¥è©¢"""
        pass

    @abstractmethod
    def update(self, order: Order) -> Order:
        """æ›´æ–°è¨‚å–®"""
        pass

# repositories/sqlalchemy_order_repository.py

from sqlalchemy.orm import Session
from domain.models import Order, OrderItem, Address
from .interfaces import OrderRepository
from .models import OrderModel, OrderItemModel  # SQLAlchemy models

class SQLAlchemyOrderRepository(OrderRepository):
    """ä½¿ç”¨ SQLAlchemy çš„è¨‚å–®å€‰å„²å¯¦ä½œ"""

    def __init__(self, session: Session):
        self.session = session

    def save(self, order: Order) -> Order:
        """å„²å­˜è¨‚å–®ï¼ˆORMï¼‰"""
        order_model = OrderModel(
            user_id=order.user_id,
            total_price=order.total,
            shipping_address=str(order.shipping_address),
            status=order.status,
            payment_id=order.payment_id
        )

        self.session.add(order_model)

        # å„²å­˜è¨‚å–®é …ç›®
        for item in order.items:
            item_model = OrderItemModel(
                order=order_model,
                product_id=item.product_id,
                product_name=item.product_name,
                price=item.price,
                quantity=item.quantity
            )
            self.session.add(item_model)

        self.session.commit()

        # æ›´æ–° domain ç‰©ä»¶çš„ ID
        order.id = order_model.id
        return order

    def find_by_id(self, order_id: int) -> Optional[Order]:
        """æŸ¥è©¢è¨‚å–®ï¼ˆè‡ªå‹• JOINï¼‰"""
        order_model = self.session.query(OrderModel).get(order_id)

        if not order_model:
            return None

        # å¾ ORM model è½‰æ›ç‚º domain model
        return self._to_domain(order_model)

    def _to_domain(self, order_model: OrderModel) -> Order:
        """ORM model â†’ Domain model"""
        items = [
            OrderItem(
                product_id=item.product_id,
                product_name=item.product_name,
                price=item.price,
                quantity=item.quantity
            )
            for item in order_model.items
        ]

        order = Order(
            user_id=order_model.user_id,
            items=items,
            shipping_address=Address.parse(order_model.shipping_address)
        )
        order.id = order_model.id
        order.status = order_model.status
        order.payment_id = order_model.payment_id
        order.created_at = order_model.created_at

        return order
```

### 2.3 Service Layerï¼ˆæ¥­å‹™é‚è¼¯ï¼‰

```python
# services/order_service.py

from typing import List
from domain.models import Order, OrderItem, Address
from repositories.interfaces import OrderRepository
from .product_service import ProductService
from .payment_service import PaymentService
from .inventory_service import InventoryService

class OrderService:
    """è¨‚å–®æ‡‰ç”¨æœå‹™ï¼ˆè·è²¬ï¼šå”èª¿å„ç¨® servicesï¼‰"""

    def __init__(
        self,
        order_repo: OrderRepository,
        product_service: ProductService,
        payment_service: PaymentService,
        inventory_service: InventoryService
    ):
        self.order_repo = order_repo
        self.product_service = product_service
        self.payment_service = payment_service
        self.inventory_service = inventory_service

    def create_order(
        self,
        user_id: int,
        items_data: List[dict],
        address_data: dict,
        payment_method: str
    ) -> Result[Order]:
        """å»ºç«‹è¨‚å–®ï¼ˆå®Œæ•´æµç¨‹ï¼‰"""

        try:
            # 1. é©—è­‰å•†å“å­˜åœ¨ä¸”æœ‰åº«å­˜
            items = self._build_order_items(items_data)
            self.product_service.validate_items(items)

            # 2. å»ºç«‹è¨‚å–®é ˜åŸŸç‰©ä»¶
            address = Address(**address_data)
            order = Order(user_id, items, address)

            # 3. ä¿ç•™åº«å­˜ï¼ˆæ¨‚è§€é–ï¼‰
            reservation_id = self.inventory_service.reserve(items)

            try:
                # 4. è™•ç†æ”¯ä»˜
                payment_result = self.payment_service.charge(
                    amount=order.total,
                    method=payment_method,
                    metadata={'order_items': items}
                )

                if not payment_result.success:
                    raise PaymentFailedError(payment_result.error)

                # 5. ç¢ºèªè¨‚å–®
                order.confirm(payment_result.transaction_id)

                # 6. ç¢ºèªæ‰£æ¸›åº«å­˜
                self.inventory_service.commit(reservation_id)

                # 7. å„²å­˜è¨‚å–®ï¼ˆä½¿ç”¨ repositoryï¼‰
                saved_order = self.order_repo.save(order)

                # 8. ç™¼é€é€šçŸ¥ï¼ˆéåŒæ­¥ï¼‰
                self._send_order_confirmation(saved_order)

                return Result.success(saved_order)

            except (PaymentFailedError, InventoryError) as e:
                # é‡‹æ”¾åº«å­˜ä¿ç•™
                self.inventory_service.release(reservation_id)
                return Result.failure(str(e))

        except ValidationError as e:
            return Result.failure(f"Validation error: {e}")
        except Exception as e:
            logger.error(f"Unexpected error in create_order: {e}")
            return Result.failure("Internal server error")

    def cancel_order(self, order_id: int, user_id: int) -> Result[Order]:
        """å–æ¶ˆè¨‚å–®"""
        # 1. æŸ¥è©¢è¨‚å–®
        order = self.order_repo.find_by_id(order_id)

        if not order:
            return Result.failure("Order not found")

        # 2. é©—è­‰æ¬Šé™
        if order.user_id != user_id:
            return Result.failure("Permission denied")

        # 3. åŸ·è¡Œæ¥­å‹™é‚è¼¯ï¼ˆåœ¨ domain model ä¸­ï¼‰
        try:
            order.cancel()
        except InvalidOrderStateError as e:
            return Result.failure(str(e))

        # 4. æ¢å¾©åº«å­˜
        self.inventory_service.restore(order.items)

        # 5. é€€æ¬¾
        if order.payment_id:
            self.payment_service.refund(order.payment_id)

        # 6. å„²å­˜è®Šæ›´
        updated_order = self.order_repo.update(order)

        return Result.success(updated_order)

    def _build_order_items(self, items_data: List[dict]) -> List[OrderItem]:
        """å¾è«‹æ±‚è³‡æ–™å»ºç«‹ OrderItem"""
        items = []
        for data in items_data:
            # å¾ ProductService å–å¾—åƒ¹æ ¼ï¼ˆä¸ä¿¡ä»»å®¢æˆ¶ç«¯ï¼‰
            product = self.product_service.get_product(data['product_id'])

            item = OrderItem(
                product_id=product.id,
                product_name=product.name,
                price=product.price,  # ä½¿ç”¨ä¼ºæœå™¨ç«¯åƒ¹æ ¼
                quantity=data['quantity']
            )
            items.append(item)

        return items

    def _send_order_confirmation(self, order: Order):
        """ç™¼é€è¨‚å–®ç¢ºèªé€šçŸ¥ï¼ˆéåŒæ­¥ï¼‰"""
        # ä½¿ç”¨è¨Šæ¯ä½‡åˆ—ï¼ˆCelery taskï¼‰
        from tasks import send_order_email
        send_order_email.delay(order.id)
```

## 3. é·ç§»ç­–ç•¥ï¼ˆStrangler Fig Patternï¼‰

### 3.1 ä¸¦è¡Œé‹ä½œéšæ®µ

```mermaid
graph TB
    API[API Route] --> Switch{Feature Flag}

    Switch -->|æ–°åŠŸèƒ½| New[æ–° OrderService]
    Switch -->|èˆŠåŠŸèƒ½| Old[èˆŠ OrderManager]

    New --> NewRepo[SQLAlchemy Repository]
    Old --> OldDB[ç›´æ¥ MySQLdb]

    NewRepo --> DB[(Database)]
    OldDB --> DB

    style New fill:#c8e6c9
    style Old fill:#ffcdd2
```

**å¯¦ä½œç¯„ä¾‹**ï¼š

```python
# routes/orders.py

from flask import Blueprint, request
from services.order_service import OrderService  # æ–°
from app.services.order_manager import OrderManager  # èˆŠ
from utils.feature_flags import is_enabled

orders_bp = Blueprint('orders', __name__)

@orders_bp.route('/orders', methods=['POST'])
@require_auth
def create_order():
    """å»ºç«‹è¨‚å–®ï¼ˆæ”¯æ´æ–°èˆŠå¯¦ä½œåˆ‡æ›ï¼‰"""
    data = request.get_json()
    user_id = request.user_id

    # Feature Flag æ§åˆ¶ä½¿ç”¨æ–°æˆ–èˆŠå¯¦ä½œ
    if is_enabled('new_order_service', user_id):
        # ä½¿ç”¨æ–°å¯¦ä½œ
        result = order_service.create_order(
            user_id=user_id,
            items_data=data['items'],
            address_data=data['address'],
            payment_method=data['payment_method']
        )

        if result.is_success:
            return jsonify(result.value.to_dict()), 201
        else:
            return jsonify({'error': result.error}), 400
    else:
        # ä½¿ç”¨èˆŠå¯¦ä½œ
        order_manager = OrderManager()
        order = order_manager.create_order(
            user_id, data['items'], data['address'], data['payment_method']
        )

        if 'error' in order:
            return jsonify(order), 400
        return jsonify(order), 201
```

### 3.2 é·ç§»éšæ®µ

**Week 1-2: å»ºç«‹æ–°æ¶æ§‹ï¼ˆä¸å½±éŸ¿ç¾æœ‰ç³»çµ±ï¼‰**
- å¯¦ä½œ Domain Models
- å¯¦ä½œ Repository ä»‹é¢èˆ‡ SQLAlchemy å¯¦ä½œ
- å¯¦ä½œ Service Layer
- å¯«å–®å…ƒæ¸¬è©¦ï¼ˆè¦†è“‹ç‡ > 90%ï¼‰

**Week 3-4: ä¸¦è¡Œé‹ä½œï¼ˆå°ç¯„åœæ¸¬è©¦ï¼‰**
- Feature Flag é–‹æ”¾çµ¦ 5% ä½¿ç”¨è€…
- ç›£æ§éŒ¯èª¤ç‡ã€æ•ˆèƒ½
- æ¯”å°æ–°èˆŠå¯¦ä½œçš„çµæœï¼ˆDual Write, Verifyï¼‰

**Week 5-6: é€æ­¥æ“´å¤§**
- æ“´å¤§åˆ° 25% ä½¿ç”¨è€…
- æ“´å¤§åˆ° 50% ä½¿ç”¨è€…
- æ“´å¤§åˆ° 100% ä½¿ç”¨è€…

**Week 7-8: ç§»é™¤èˆŠç¨‹å¼ç¢¼**
- ç¢ºèªæ–°å¯¦ä½œç©©å®š
- ç§»é™¤ Feature Flag
- åˆªé™¤èˆŠ OrderManager ç¨‹å¼ç¢¼

### 3.3 é©—è­‰æ©Ÿåˆ¶

**Dual Write & Verify Pattern**:

```python
def create_order_with_verification(user_id, items, address, payment_method):
    """åŒæ™‚åŸ·è¡Œæ–°èˆŠå¯¦ä½œï¼Œæ¯”å°çµæœ"""

    # åŸ·è¡ŒèˆŠå¯¦ä½œ
    old_result = old_order_manager.create_order(...)

    # åŸ·è¡Œæ–°å¯¦ä½œ
    new_result = new_order_service.create_order(...)

    # æ¯”å°çµæœ
    if old_result['order_id'] != new_result.value.id:
        logger.warning("Mismatch detected!", extra={
            'old': old_result,
            'new': new_result.value.to_dict()
        })

        # é€šçŸ¥é–‹ç™¼åœ˜éšŠ
        alert_team("Order creation mismatch")

    # å›å‚³èˆŠå¯¦ä½œçš„çµæœï¼ˆå®‰å…¨ï¼‰
    return old_result
```

## 4. æ¸¬è©¦ç­–ç•¥

### 4.1 å–®å…ƒæ¸¬è©¦ï¼ˆDomain Layerï¼‰

```python
# tests/domain/test_order.py

import pytest
from domain.models import Order, OrderItem, Address

def test_order_total_calculation():
    """æ¸¬è©¦è¨‚å–®ç¸½é‡‘é¡è¨ˆç®—"""
    items = [
        OrderItem(1, "Product A", Decimal("100"), 2),  # 200
        OrderItem(2, "Product B", Decimal("50"), 1),   # 50
    ]
    address = Address("Taipei", "Xinyi", "Road", "110")

    order = Order(user_id=123, items=items, shipping_address=address)

    assert order.total == Decimal("250")

def test_cannot_cancel_delivered_order():
    """æ¸¬è©¦æ¥­å‹™è¦å‰‡ï¼šå·²é€é”çš„è¨‚å–®ä¸èƒ½å–æ¶ˆ"""
    order = Order(...)
    order.status = OrderStatus.DELIVERED

    with pytest.raises(InvalidOrderStateError):
        order.cancel()
```

### 4.2 æ•´åˆæ¸¬è©¦ï¼ˆService Layerï¼‰

```python
# tests/services/test_order_service.py

import pytest
from services.order_service import OrderService

@pytest.fixture
def order_service(db_session):
    """æº–å‚™æ¸¬è©¦ç”¨çš„ serviceï¼ˆä½¿ç”¨æ¸¬è©¦è³‡æ–™åº«ï¼‰"""
    order_repo = SQLAlchemyOrderRepository(db_session)
    product_service = MockProductService()
    payment_service = MockPaymentService()
    inventory_service = MockInventoryService()

    return OrderService(
        order_repo, product_service, payment_service, inventory_service
    )

def test_create_order_success(order_service):
    """æ¸¬è©¦æˆåŠŸå»ºç«‹è¨‚å–®"""
    result = order_service.create_order(
        user_id=123,
        items_data=[{'product_id': 1, 'quantity': 2}],
        address_data={'city': 'Taipei', ...},
        payment_method='credit_card'
    )

    assert result.is_success
    assert result.value.id is not None
    assert result.value.status == OrderStatus.CONFIRMED

def test_create_order_payment_failed(order_service):
    """æ¸¬è©¦æ”¯ä»˜å¤±æ•—æ™‚çš„è™•ç†"""
    # è¨­å®š mock ä½¿æ”¯ä»˜å¤±æ•—
    order_service.payment_service.set_fail(True)

    result = order_service.create_order(...)

    assert result.is_failure
    assert "Payment failed" in result.error

    # é©—è­‰åº«å­˜å·²é‡‹æ”¾
    assert order_service.inventory_service.reservations == []
```

---

**é‡æ§‹å®Œæˆæ¨™æº–**ï¼š
1. âœ… æ‰€æœ‰å–®å…ƒæ¸¬è©¦é€šéï¼ˆè¦†è“‹ç‡ > 90%ï¼‰
2. âœ… æ•´åˆæ¸¬è©¦é€šé
3. âœ… æ•ˆèƒ½æ¸¬è©¦ï¼ˆå›æ‡‰æ™‚é–“ < 200msï¼‰
4. âœ… å£“åŠ›æ¸¬è©¦ï¼ˆ1000 req/sï¼‰
5. âœ… 100% ä½¿ç”¨è€…ä½¿ç”¨æ–°å¯¦ä½œ 7 å¤©ç„¡é‡å¤§å•é¡Œ
````

**è¨˜æ†¶æ²‰æ¾±**ï¼š
```bash
/memory save

ä¸»é¡Œï¼šå¤§è¦æ¨¡é‡æ§‹çš„æ¶æ§‹è¨­è¨ˆæ¨¡å¼

åˆ†å±¤æ¶æ§‹ï¼ˆClean Architectureï¼‰:
1. Domain Layer: æ¥­å‹™è¦å‰‡ã€å¯¦é«”ï¼ˆç´” Pythonï¼‰
2. Service Layer: æµç¨‹å”èª¿ã€æ‡‰ç”¨é‚è¼¯
3. Repository Layer: è³‡æ–™å­˜å–æŠ½è±¡
4. Infrastructure: æŠ€è¡“å¯¦ä½œï¼ˆSQLAlchemy, Redisï¼‰

é—œéµè¨­è¨ˆæ¨¡å¼ï¼š
- Repository Pattern: æŠ½è±¡è³‡æ–™å­˜å–
- Dependency Injection: æ³¨å…¥ä¾è³´ï¼ˆæ˜“æ¸¬è©¦ï¼‰
- Domain Model: å°‡æ¥­å‹™è¦å‰‡å°è£åœ¨å¯¦é«”ä¸­
- Result Pattern: æ˜ç¢ºçš„æˆåŠŸ/å¤±æ•—è™•ç†

é·ç§»ç­–ç•¥ï¼ˆStrangler Fig Patternï¼‰ï¼š
1. å»ºç«‹æ–°æ¶æ§‹ï¼ˆä¸å½±éŸ¿èˆŠç³»çµ±ï¼‰
2. Feature Flag æ§åˆ¶åˆ‡æ›
3. Dual Write & Verifyï¼ˆé©—è­‰æ­£ç¢ºæ€§ï¼‰
4. é€æ­¥æ“´å¤§ä½¿ç”¨ç¯„åœ
5. ç§»é™¤èˆŠç¨‹å¼ç¢¼

æ¸¬è©¦é‡‘å­—å¡”ï¼š
- å–®å…ƒæ¸¬è©¦ï¼ˆDomain Layerï¼‰: å¤§é‡ã€å¿«é€Ÿ
- æ•´åˆæ¸¬è©¦ï¼ˆService Layerï¼‰: ä¸­ç­‰
- E2E æ¸¬è©¦: å°‘é‡ã€é—œéµæµç¨‹

é‡æ§‹æˆåŠŸæŒ‡æ¨™ï¼š
- æ¸¬è©¦è¦†è“‹ç‡ > 90%
- æ•ˆèƒ½ä¸åŠ£åŒ–ï¼ˆç”šè‡³æ”¹å–„ï¼‰
- é›¶åœæ©Ÿé·ç§»
- ç¨‹å¼ç¢¼è¡Œæ•¸æ¸›å°‘ 30%+

ç›¸é—œ Agent: architect, refactoring-specialist
ç›¸é—œæ¨¡å¼: Clean Architecture, DDD, Strangler Fig
```

---

### éšæ®µä¸‰ï¼šåŸ·è¡Œè¨ˆç•«èˆ‡è¿½è¹¤ï¼ˆ30 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šç”¢å‡ºå¯åŸ·è¡Œçš„å°ˆæ¡ˆè¨ˆç•«

```bash
# ä½¿ç”¨ technical-writer + architect
è«‹åŸºæ–¼ä»¥ä¸Šåˆ†æèˆ‡è¨­è¨ˆï¼Œç”Ÿæˆï¼š

1. **é‡æ§‹åŸ·è¡Œè¨ˆç•«**ï¼ˆREFACTORING_PLAN.mdï¼‰
   - 3 å€‹æœˆçš„è©³ç´°æ™‚é–“è¡¨
   - æ¯é€±çš„å·¥ä½œé …ç›®
   - è²¬ä»»åˆ†é…å»ºè­°
   - é‡Œç¨‹ç¢‘èˆ‡æª¢æŸ¥é»

2. **é¢¨éšªç®¡ç†è¨ˆç•«**ï¼ˆRISK_MANAGEMENT.mdï¼‰
   - è­˜åˆ¥æ½›åœ¨é¢¨éšª
   - ç·©è§£æªæ–½
   - Rollback è¨ˆç•«

3. **é€²åº¦è¿½è¹¤æ¨¡æ¿**ï¼ˆPROGRESS_TRACKING.mdï¼‰
   - æ¯é€±é€²åº¦å ±å‘Šç¯„æœ¬
   - é—œéµæŒ‡æ¨™ï¼ˆæ¸¬è©¦è¦†è“‹ç‡ã€æ•ˆèƒ½ã€éŒ¯èª¤ç‡ï¼‰
   - æ±ºç­–è¨˜éŒ„ï¼ˆADRï¼‰

æ ¼å¼ï¼šMarkdownï¼ŒåŒ…å«æª¢æŸ¥æ¸…å–®
```

**é æœŸè¼¸å‡º**ï¼ˆåŸ·è¡Œè¨ˆç•«ç¯„ä¾‹ï¼‰ï¼š

```markdown
# é‡æ§‹åŸ·è¡Œè¨ˆç•«ï¼ˆ12 é€±ï¼‰

## ç¸½è¦½

**ç›®æ¨™**ï¼šå°‡ OrderManager God Object é‡æ§‹ç‚º Clean Architecture
**æ™‚é–“**ï¼š2025/02/01 - 2025/04/30ï¼ˆ12 é€±ï¼‰
**åœ˜éšŠ**ï¼š3 ä½å¾Œç«¯é–‹ç™¼è€… + 1 ä½ QA
**é¢¨éšªç­‰ç´š**ï¼šğŸŸ  ä¸­é«˜ï¼ˆæ¶‰åŠæ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼‰

---

## Phase 1: æº–å‚™èˆ‡è¨­è¨ˆï¼ˆWeek 1-2ï¼‰

### Week 1: æŠ€è¡“å‚µå‹™å…¨é¢æƒæ

**å·¥ä½œé …ç›®**ï¼š
- [ ] åŸ·è¡Œè‡ªå‹•åŒ–æƒæï¼ˆSQL Injection, ç¡¬ç·¨ç¢¼, God Objectï¼‰
- [ ] ä½¿ç”¨ AI Agent æ·±åº¦åˆ†æï¼ˆcode-reviewer, security-auditorï¼‰
- [ ] ç”¢å‡ºå®Œæ•´å•é¡Œæ¸…å–®ï¼ˆåˆ†é¡ï¼šCritical/High/Medium/Lowï¼‰
- [ ] é‡åŒ–è©•ä¼°ï¼ˆå•é¡Œæ•¸é‡ã€å½±éŸ¿ç¯„åœã€ä¿®å¾©æ™‚é–“ï¼‰

**ç”¢å‡º**ï¼š
- æŠ€è¡“å‚µå‹™å ±å‘Šï¼ˆ50+ é ï¼‰
- å•é¡Œå„ªå…ˆç´šæ¸…å–®

**è²¬ä»»äºº**ï¼šå…¨å“¡
**é©—æ”¶æ¨™æº–**ï¼šç®¡ç†å±¤æ‰¹å‡†é‡æ§‹è¨ˆç•«

---

### Week 2: æ¶æ§‹è¨­è¨ˆèˆ‡åŸå‹

**å·¥ä½œé …ç›®**ï¼š
- [ ] è¨­è¨ˆæ–°æ¶æ§‹ï¼ˆDomain, Service, Repositoryï¼‰
- [ ] å»ºç«‹ POCï¼ˆProof of Conceptï¼‰
- [ ] è¨­è¨ˆé·ç§»ç­–ç•¥ï¼ˆStrangler Fig Patternï¼‰
- [ ] è¨­å®šé–‹ç™¼ç’°å¢ƒï¼ˆæ¸¬è©¦è³‡æ–™åº«ã€Feature Flagï¼‰

**ç”¢å‡º**ï¼š
- æ¶æ§‹è¨­è¨ˆæ–‡æª”
- POC ç¨‹å¼ç¢¼ï¼ˆå¯é‹è¡Œçš„è¨‚å–®å»ºç«‹æµç¨‹ï¼‰

**è²¬ä»»äºº**ï¼šTech Lead + Senior Developer
**é©—æ”¶æ¨™æº–**ï¼šPOC æ¸¬è©¦é€šéã€åœ˜éšŠ code review é€šé

---

## Phase 2: å»ºç«‹æ–°æ¶æ§‹ï¼ˆWeek 3-6ï¼‰

### Week 3: Domain Layer

**å·¥ä½œé …ç›®**ï¼š
- [ ] å¯¦ä½œ Order, OrderItem, Address é ˜åŸŸæ¨¡å‹
- [ ] å¯¦ä½œæ¥­å‹™è¦å‰‡ï¼ˆcan_cancel, confirm ç­‰ï¼‰
- [ ] æ’°å¯«å–®å…ƒæ¸¬è©¦ï¼ˆè¦†è“‹ç‡ > 95%ï¼‰
- [ ] Code review

**ç”¢å‡º**ï¼š
- domain/models.pyï¼ˆ300 è¡Œï¼‰
- tests/domain/test_models.pyï¼ˆ500 è¡Œæ¸¬è©¦ï¼‰

**è²¬ä»»äºº**ï¼šDeveloper A
**æ™‚é–“ä¼°ç®—**ï¼š30 å°æ™‚
**é©—æ”¶æ¨™æº–**ï¼šæ‰€æœ‰æ¸¬è©¦é€šéã€coverage > 95%

---

### Week 4: Repository Layer

**å·¥ä½œé …ç›®**ï¼š
- [ ] å®šç¾© OrderRepository ä»‹é¢
- [ ] å¯¦ä½œ SQLAlchemy models
- [ ] å¯¦ä½œ SQLAlchemyOrderRepository
- [ ] æ’°å¯«æ•´åˆæ¸¬è©¦ï¼ˆä½¿ç”¨æ¸¬è©¦è³‡æ–™åº«ï¼‰

**ç”¢å‡º**ï¼š
- repositories/interfaces.py
- repositories/sqlalchemy_order_repository.py
- tests/repositories/test_order_repository.py

**è²¬ä»»äºº**ï¼šDeveloper B
**æ™‚é–“ä¼°ç®—**ï¼š35 å°æ™‚
**é©—æ”¶æ¨™æº–**ï¼šæ•´åˆæ¸¬è©¦é€šéã€å¯æ­£ç¢º CRUD

---

### Week 5: Service Layerï¼ˆPart 1 - OrderServiceï¼‰

**å·¥ä½œé …ç›®**ï¼š
- [ ] å¯¦ä½œ OrderService.create_order()
- [ ] æ•´åˆ ProductService, PaymentService, InventoryServiceï¼ˆä½¿ç”¨ Mockï¼‰
- [ ] å¯¦ä½œéŒ¯èª¤è™•ç†èˆ‡ Transaction ç®¡ç†
- [ ] æ’°å¯«æ¸¬è©¦

**ç”¢å‡º**ï¼š
- services/order_service.py
- tests/services/test_order_service.py

**è²¬ä»»äºº**ï¼šDeveloper A
**æ™‚é–“ä¼°ç®—**ï¼š40 å°æ™‚
**é©—æ”¶æ¨™æº–**ï¼šå–®å…ƒæ¸¬è©¦ + æ•´åˆæ¸¬è©¦é€šé

---

### Week 6: Service Layerï¼ˆPart 2 - å…¶ä»–æ–¹æ³•ï¼‰

**å·¥ä½œé …ç›®**ï¼š
- [ ] å¯¦ä½œ cancel_order, get_order_details, update_order
- [ ] æ•´åˆæ‰€æœ‰ services
- [ ] å®Œæ•´çš„æ¸¬è©¦å¥—ä»¶
- [ ] æ•ˆèƒ½æ¸¬è©¦ï¼ˆBenchmarkï¼‰

**ç”¢å‡º**ï¼š
- å®Œæ•´çš„ OrderService
- æ•ˆèƒ½æ¸¬è©¦å ±å‘Š

**è²¬ä»»äºº**ï¼šDeveloper B
**æ™‚é–“ä¼°ç®—**ï¼š35 å°æ™‚
**é©—æ”¶æ¨™æº–**ï¼š
- æ¸¬è©¦è¦†è“‹ç‡ > 90%
- è¨‚å–®å»ºç«‹ < 200ms
- ä½µç™¼æ¸¬è©¦é€šéï¼ˆ100 req/sï¼‰

---

## Phase 3: ä¸¦è¡Œé‹ä½œï¼ˆWeek 7-9ï¼‰

### Week 7: Feature Flag èˆ‡ç›£æ§

**å·¥ä½œé …ç›®**ï¼š
- [ ] å¯¦ä½œ Feature Flag ç³»çµ±ï¼ˆLaunchDarkly æˆ–è‡ªå»ºï¼‰
- [ ] æ•´åˆç›£æ§ï¼ˆSentry, Prometheusï¼‰
- [ ] å¯¦ä½œ Dual Write & Verifyï¼ˆæ–°èˆŠå¯¦ä½œæ¯”å°ï¼‰
- [ ] è¨­å®šå‘Šè­¦è¦å‰‡

**ç”¢å‡º**ï¼š
- Feature Flag ç³»çµ±
- ç›£æ§ Dashboard

**è²¬ä»»äºº**ï¼šTech Lead + DevOps
**é©—æ”¶æ¨™æº–**ï¼šå¯å‹•æ…‹åˆ‡æ›æ–°èˆŠå¯¦ä½œã€ç›£æ§æ­£å¸¸

---

### Week 8: ç°åº¦ç™¼å¸ƒï¼ˆ5% â†’ 25%ï¼‰

**å·¥ä½œé …ç›®**ï¼š
- [ ] é–‹æ”¾æ–°å¯¦ä½œçµ¦ 5% ä½¿ç”¨è€…ï¼ˆå…§éƒ¨æ¸¬è©¦å¸³è™Ÿï¼‰
- [ ] ç›£æ§éŒ¯èª¤ç‡ã€æ•ˆèƒ½ã€æ¥­å‹™æŒ‡æ¨™
- [ ] ä¿®å¾©ç™¼ç¾çš„ bug
- [ ] æ“´å¤§åˆ° 25% ä½¿ç”¨è€…

**é—œéµæŒ‡æ¨™**ï¼š
- éŒ¯èª¤ç‡ < 0.1%
- P95 å›æ‡‰æ™‚é–“ < 300ms
- æ–°èˆŠå¯¦ä½œçµæœä¸€è‡´æ€§ > 99.9%

**è²¬ä»»äºº**ï¼šå…¨å“¡
**é©—æ”¶æ¨™æº–**ï¼šæŒ‡æ¨™é”æ¨™ã€ç„¡é‡å¤§ bug

---

### Week 9: æ“´å¤§ç™¼å¸ƒï¼ˆ50% â†’ 100%ï¼‰

**å·¥ä½œé …ç›®**ï¼š
- [ ] æ“´å¤§åˆ° 50% ä½¿ç”¨è€…
- [ ] ç›£æ§ 3 å¤©ç„¡ç•°å¸¸
- [ ] æ“´å¤§åˆ° 100% ä½¿ç”¨è€…
- [ ] æŒçºŒç›£æ§ 7 å¤©

**é—œéµæŒ‡æ¨™**ï¼š
- è¨‚å–®æˆåŠŸç‡ > 99.5%
- å®¢è¨´æ•¸é‡ä¸å¢åŠ 
- æ•ˆèƒ½æ”¹å–„ 20%+

**è²¬ä»»äºº**ï¼šå…¨å“¡
**é©—æ”¶æ¨™æº–**ï¼š100% ä½¿ç”¨è€…åˆ‡æ›æˆåŠŸã€ç©©å®šé‹è¡Œ 7 å¤©

---

## Phase 4: æ¸…ç†èˆ‡å„ªåŒ–ï¼ˆWeek 10-12ï¼‰

### Week 10: ç§»é™¤èˆŠç¨‹å¼ç¢¼

**å·¥ä½œé …ç›®**ï¼š
- [ ] ç¢ºèª 100% ä½¿ç”¨è€…ä½¿ç”¨æ–°å¯¦ä½œ
- [ ] ç§»é™¤ Feature Flag
- [ ] åˆªé™¤èˆŠ OrderManager ç¨‹å¼ç¢¼
- [ ] æ›´æ–°æ–‡æª”

**ç”¢å‡º**ï¼š
- ä¹¾æ·¨çš„ç¨‹å¼ç¢¼åº«ï¼ˆæ¸›å°‘ 40% ç¨‹å¼ç¢¼ï¼‰

**è²¬ä»»äºº**ï¼šDeveloper A + B
**é©—æ”¶æ¨™æº–**ï¼šæ‰€æœ‰æ¸¬è©¦é€šéã€èˆŠç¨‹å¼ç¢¼å®Œå…¨ç§»é™¤

---

### Week 11: Critical å•é¡Œä¿®å¾©

**å·¥ä½œé …ç›®**ï¼š
- [ ] ä¿®å¾©æ‰€æœ‰ Critical å•é¡Œï¼ˆSQL Injection, ç¡¬ç·¨ç¢¼å¯†ç¢¼ï¼‰
- [ ] å®‰å…¨æƒæï¼ˆBandit, SQLMapï¼‰
- [ ] æ»²é€æ¸¬è©¦

**ç”¢å‡º**ï¼š
- å®‰å…¨å¯©è¨ˆå ±å‘Š

**è²¬ä»»äºº**ï¼šå…¨å“¡ + å®‰å…¨åœ˜éšŠ
**é©—æ”¶æ¨™æº–**ï¼šå®‰å…¨æƒæ 0 Critical issues

---

### Week 12: æ–‡æª”èˆ‡çŸ¥è­˜å‚³æ‰¿

**å·¥ä½œé …ç›®**ï¼š
- [ ] æ’°å¯«æ¶æ§‹æ–‡æª”
- [ ] æ’°å¯« API æ–‡æª”ï¼ˆOpenAPIï¼‰
- [ ] æ’°å¯«é–‹ç™¼è€…æŒ‡å—
- [ ] åœ˜éšŠåˆ†äº«æœƒï¼ˆKnowledge Sharingï¼‰

**ç”¢å‡º**ï¼š
- å®Œæ•´æ–‡æª”å¥—ä»¶
- åˆ†äº«æœƒéŒ„å½±

**è²¬ä»»äºº**ï¼šTech Lead
**é©—æ”¶æ¨™æº–**ï¼šæ–°äººå¯æ ¹æ“šæ–‡æª”å¿«é€Ÿä¸Šæ‰‹

---

## é‡Œç¨‹ç¢‘èˆ‡æª¢æŸ¥é»

| é‡Œç¨‹ç¢‘ | é€±æ¬¡ | æª¢æŸ¥é» | æˆåŠŸæ¨™æº– |
|-------|------|--------|---------|
| M1: è¨­è¨ˆå®Œæˆ | Week 2 | æ¶æ§‹è¨­è¨ˆ review | åœ˜éšŠä¸€è‡´é€šé |
| M2: Domain å®Œæˆ | Week 3 | å–®å…ƒæ¸¬è©¦ | Coverage > 95% |
| M3: åŸºç¤è¨­æ–½å®Œæˆ | Week 6 | æ•´åˆæ¸¬è©¦ | æ‰€æœ‰æ¸¬è©¦é€šé |
| M4: é¦–æ‰¹ä½¿ç”¨è€… | Week 8 | 5% ä½¿ç”¨è€… | éŒ¯èª¤ç‡ < 0.1% |
| M5: å…¨é¢åˆ‡æ› | Week 9 | 100% ä½¿ç”¨è€… | ç©©å®šé‹è¡Œ 7 å¤© |
| M6: å°ˆæ¡ˆå®Œæˆ | Week 12 | æ–‡æª”å®Œæˆ | ç®¡ç†å±¤é©—æ”¶ |

---

## è³‡æºéœ€æ±‚

### äººåŠ›
- Tech Lead: 50% æ™‚é–“ï¼ˆè¨­è¨ˆã€reviewï¼‰
- Senior Developer A: 100% æ™‚é–“ï¼ˆDomain, Serviceï¼‰
- Senior Developer B: 100% æ™‚é–“ï¼ˆRepository, Testingï¼‰
- QA Engineer: 50% æ™‚é–“ï¼ˆæ¸¬è©¦ã€é©—è­‰ï¼‰

### å·¥å…·
- Feature Flag: LaunchDarklyï¼ˆ$200/æœˆï¼‰
- ç›£æ§: Sentryï¼ˆ$29/æœˆï¼‰
- æ¸¬è©¦ç’°å¢ƒ: AWS t3.mediumï¼ˆ$30/æœˆï¼‰

**ç¸½æˆæœ¬ä¼°ç®—**ï¼šç´„ $5,000ï¼ˆäººåŠ›ä¸è¨ˆï¼‰

---

## é¢¨éšªèˆ‡ç·©è§£

| é¢¨éšª | æ©Ÿç‡ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|------|------|---------|
| æ–°å¯¦ä½œæœ‰ bug å°è‡´è¨‚å–®å¤±æ•— | Medium | High | Feature Flag å¿«é€Ÿ rollback |
| æ•ˆèƒ½åŠ£åŒ– | Low | High | æ•ˆèƒ½æ¸¬è©¦ã€ä½µç™¼æ¸¬è©¦ |
| åœ˜éšŠæˆå“¡é›¢è· | Low | High | çŸ¥è­˜æ–‡æª”åŒ–ã€Pair Programming |
| æ™‚é–“å»¶èª¤ | Medium | Medium | æ¯é€± reviewã€åŠæ™‚èª¿æ•´ |

---

## æ¯é€±é€²åº¦æœƒè­°

**æ™‚é–“**ï¼šæ¯é€±äº”ä¸‹åˆ 3:00
**åƒèˆ‡è€…**ï¼šTech Lead + é–‹ç™¼åœ˜éšŠ + PM
**è­°ç¨‹**ï¼š
1. æœ¬é€±å®Œæˆé …ç›®ï¼ˆDemoï¼‰
2. ä¸‹é€±è¨ˆç•«
3. é‡åˆ°çš„é˜»ç¤™
4. é¢¨éšªè­˜åˆ¥

**ç”¢å‡º**ï¼šé€²åº¦å ±å‘Šï¼ˆç™¼é€çµ¦ç®¡ç†å±¤ï¼‰

---

## æˆåŠŸæ¨™æº–

### æŠ€è¡“æŒ‡æ¨™
- âœ… æ¸¬è©¦è¦†è“‹ç‡ > 90%
- âœ… ä»£ç¢¼è¡Œæ•¸æ¸›å°‘ 30%
- âœ… æ•ˆèƒ½æ”¹å–„ 20%
- âœ… å®‰å…¨æƒæ 0 Critical issues

### æ¥­å‹™æŒ‡æ¨™
- âœ… è¨‚å–®æˆåŠŸç‡ > 99.5%
- âœ… å®¢è¨´æ•¸é‡ä¸å¢åŠ 
- âœ… é›¶åœæ©Ÿé·ç§»

### åœ˜éšŠæŒ‡æ¨™
- âœ… æ–°äºº onboarding æ™‚é–“ç¸®çŸ­ 50%
- âœ… Bug ä¿®å¾©æ™‚é–“ç¸®çŸ­ 40%
- âœ… æ–°åŠŸèƒ½é–‹ç™¼é€Ÿåº¦æå‡ 30%

---

**è¨ˆç•«ç‰ˆæœ¬**ï¼šv1.0
**æœ€å¾Œæ›´æ–°**ï¼š2025-01-15
**ä¸‹æ¬¡ review**ï¼šæ¯ 2 é€±
```

---

## é©—è­‰æ¨™æº–

### âœ… å¿…é ˆé”æˆ

- [ ] å®Œæ•´æƒæä¸¦åˆ†é¡æ‰€æœ‰æŠ€è¡“å‚µå‹™
- [ ] ç”¢å‡ºå¯åŸ·è¡Œçš„é‡æ§‹è¨ˆç•«ï¼ˆå«æ™‚é–“è¡¨ï¼‰
- [ ] è¨­è¨ˆæ¸…æ™°çš„æ–°æ¶æ§‹ï¼ˆMermaid åœ–è¡¨ï¼‰
- [ ] æä¾›å…·é«”çš„é·ç§»ç­–ç•¥ï¼ˆStrangler Fig Patternï¼‰
- [ ] ä½¿ç”¨ `/memory` æ²‰æ¾±è‡³å°‘ 3 å€‹é‡æ§‹æ¨¡å¼

### â­ é¡å¤–æˆå°±

- [ ] å¯¦éš›å¯¦ä½œ POC ä¸¦æ¸¬è©¦é€šé
- [ ] å»ºç«‹è‡ªå‹•åŒ–å‚µå‹™æƒæè…³æœ¬
- [ ] ç”¢å‡ºå¯å¾©ç”¨çš„é‡æ§‹è¨ˆç•«ç¯„æœ¬
- [ ] è¨­è¨ˆå®Œæ•´çš„ç›£æ§èˆ‡å‘Šè­¦ç³»çµ±
- [ ] æ’°å¯«é‡æ§‹ case study æ–‡ç« 

---

## å­¸ç¿’åæ€

### åæ€å•é¡Œ

1. **å‚µå‹™è­˜åˆ¥**ï¼š
   - AI èƒ½è­˜åˆ¥å“ªäº›é¡å‹çš„æŠ€è¡“å‚µå‹™ï¼Ÿå“ªäº›é‚„éœ€è¦äººå·¥åˆ¤æ–·ï¼Ÿ
   - å¦‚ä½•é‡åŒ–æŠ€è¡“å‚µå‹™çš„å½±éŸ¿ï¼Ÿ

2. **æ¶æ§‹è¨­è¨ˆ**ï¼š
   - ç‚ºä»€éº¼é¸æ“‡ Clean Architectureï¼Ÿ
   - Domain Layer ç‚ºä»€éº¼è¦ç¨ç«‹æ–¼ Infrastructureï¼Ÿ

3. **é·ç§»ç­–ç•¥**ï¼š
   - Strangler Fig Pattern çš„æ ¸å¿ƒæ˜¯ä»€éº¼ï¼Ÿ
   - Feature Flag å¦‚ä½•å¯¦ä½œï¼Ÿ

4. **é¢¨éšªç®¡ç†**ï¼š
   - å¦‚ä½•ç¢ºä¿é‡æ§‹ä¸ç ´å£ç¾æœ‰åŠŸèƒ½ï¼Ÿ
   - ä»€éº¼æƒ…æ³ä¸‹æ‡‰è©² rollbackï¼Ÿ

### å»¶ä¼¸ç·´ç¿’

1. **å¯¦éš›åŸ·è¡Œ**ï¼š
   - é¸æ“‡ä¸€å€‹çœŸå¯¦å°ˆæ¡ˆçš„æ¨¡çµ„é€²è¡Œé‡æ§‹
   - å¯¦ä½œ POC ä¸¦æ¸¬è©¦

2. **å·¥å…·æ•´åˆ**ï¼š
   - æ•´åˆ SonarQube è‡ªå‹•æª¢æ¸¬æŠ€è¡“å‚µå‹™
   - è¨­å®š GitHub Action è‡ªå‹•åŸ·è¡Œå®‰å…¨æƒæ

3. **æ¨¡å¼æ“´å±•**ï¼š
   - ç ”ç©¶å…¶ä»–é‡æ§‹æ¨¡å¼ï¼ˆBranch by Abstractionï¼‰
   - å­¸ç¿’ DDDï¼ˆDomain-Driven Designï¼‰

---

## ç›¸é—œè³‡æº

### ä¸‹ä¸€æ­¥å­¸ç¿’

- **C01**ï¼šæ™ºèƒ½ä»£ç¢¼å¯©æŸ¥ç³»çµ± - è‡ªå‹•åŒ–å¯©æŸ¥æµç¨‹
- **C11**ï¼šä¼æ¥­ç´šé–‹ç™¼ç’°å¢ƒæ­å»º - æ•´åˆæ¸¬è©¦åŸºç¤è¨­æ–½
- **E02**ï¼šAI Code Review ç³»çµ± - å»ºç«‹æŒçºŒå¯©æŸ¥æ©Ÿåˆ¶

### å·¥å…·åƒè€ƒ

- **SonarQube**: ä»£ç¢¼å“è³ªæŒçºŒæª¢æ¸¬
- **LaunchDarkly**: Feature Flag æœå‹™
- **Sentry**: éŒ¯èª¤è¿½è¹¤èˆ‡ç›£æ§
- **SQLAlchemy**: Python ORM

### å­¸ç¿’è³‡æº

- **Refactoring (Martin Fowler)**: é‡æ§‹ç¶“å…¸æ›¸ç±
- **Clean Architecture (Robert C. Martin)**: æ¶æ§‹è¨­è¨ˆåŸå‰‡
- **Working Effectively with Legacy Code**: è™•ç† legacy ç³»çµ±
- **Strangler Fig Pattern**: Microsoft æ¶æ§‹æ¨¡å¼

---

**å»ºè­°å®Œæˆæ™‚é–“**ï¼š2.5-3 å°æ™‚
**é›£åº¦è©•ä¼°**ï¼š4/5
**é‡è¦åº¦**ï¼š5/5ï¼ˆå¤§å‹å°ˆæ¡ˆå¿…ç¶“ä¹‹è·¯ï¼‰
**å¯å¾©ç”¨æ€§**ï¼š5/5ï¼ˆæ­¤æµç¨‹é©ç”¨æ–¼ä»»ä½• legacy ç³»çµ±é‡æ§‹ï¼‰
