# 問題排查速查表

## 🔧 快速診斷指南

當 Claude Code 沒有按預期工作時，使用此速查表快速定位和解決問題。

---

## 🚨 常見問題分類

### 1. Agent 相關問題
### 2. MCP 連接問題
### 3. 輸出格式問題
### 4. 效能問題
### 5. 配置問題

---

## 🤖 Agent 相關問題

### 問題 1：Agent 沒有按預期工作

**症狀**：
- Agent 回應與預期不符
- 沒有展現專業能力
- 輸出品質下降

**診斷步驟**：
```bash
# 1. 確認當前 Agent 狀態
/agents:current

# 2. 檢查 Agent 是否正確啟動
/agents

# 3. 查看 Agent 幫助資訊
/agents:help [agent-name]
```

**常見原因和解決方案**：

#### 原因 1：Agent 沒有正確切換
```bash
# 問題：忘記切換到專業 Agent
❌ 直接提問技術問題

# 解決：先切換 Agent
✅ /agents:code-reviewer
   "請審查這段程式碼"
```

#### 原因 2：提示詞不夠具體
```bash
# 問題：指令太模糊
❌ "幫我看看這個"

# 解決：提供具體指令
✅ "請審查這個 Python 函數的程式碼品質，
   重點關注錯誤處理和輸入驗證"
```

#### 原因 3：上下文不足
```bash
# 問題：缺少背景資訊
❌ "生成測試"

# 解決：提供完整上下文
✅ "為這個用戶認證模組生成單元測試，
   需要測試登入成功、密碼錯誤、帳號鎖定等場景"
```

#### 原因 4：Agent 選擇錯誤
```bash
# 診斷：確認任務類型
程式碼審查 → code-reviewer ✓
安全檢查 → security-auditor ✓
效能分析 → performance-analyzer ✓
文檔撰寫 → documentation-writer ✓
測試生成 → test-generator ✓

# 解決：切換到正確 Agent
/agents:[correct-agent]
```

---

### 問題 2：Agent 回應太慢

**症狀**：
- Agent 回應時間異常長
- 處理複雜任務時超時

**診斷步驟**：
```bash
# 1. 檢查任務複雜度
"請分析這個任務的複雜度"

# 2. 檢查輸入資料大小
"檢查輸入檔案或內容的大小"

# 3. 檢查網路連接
"測試網路連接狀態"
```

**解決方案**：

#### 分解複雜任務
```bash
# 問題：一次處理太多內容
❌ "分析整個 10,000 行的專案"

# 解決：分階段處理
✅ "先分析核心模組，再逐步展開其他部分"
```

#### 限制輸入範圍
```bash
# 問題：輸入資料過大
❌ 一次添加所有檔案

# 解決：選擇性添加
✅ claude --add-file specific_file.py
```

---

## 🌐 MCP 連接問題

### 問題 1：MCP Server 啟動失敗

**症狀**：
- "Connection refused" 錯誤
- MCP 功能無法使用
- 外部工具無法存取

**診斷步驟**：
```bash
# 1. 檢查 MCP 狀態
claude --mcp-list

# 2. 檢查 MCP 配置
claude --mcp-check

# 3. 檢查錯誤日誌
cat ~/.claude/logs/mcp.log
```

**解決方案**：

#### 檢查依賴項目
```bash
# 檢查 Node.js
node --version
# 應該顯示 v18+ 版本

# 檢查 npm 套件
npm list -g | grep @modelcontextprotocol

# 重新安裝 (如果需要)
npm install -g @modelcontextprotocol/server-filesystem
```

#### 檢查配置檔案
```bash
# 檢查配置檔案語法
cat ~/.config/claude/config.json | jq .

# 常見配置錯誤
❌ 缺少必要的環境變數
❌ JSON 語法錯誤
❌ 檔案權限問題

# 修復範例
✅ 確保 JSON 格式正確
✅ 設置必要的環境變數
✅ 修正檔案權限：chmod 600 ~/.config/claude/config.json
```

#### 重置 MCP 配置
```bash
# 備份現有配置
cp ~/.config/claude/config.json ~/.config/claude/config.json.backup

# 重置配置
claude --mcp-reset

# 重新配置基本 MCP
```

---

### 問題 2：MCP 認證失敗

**症狀**：
- "Authentication failed" 錯誤
- API token 相關錯誤
- 權限被拒絕

**診斷步驟**：
```bash
# 1. 檢查環境變數
echo $GITHUB_TOKEN
echo $SLACK_BOT_TOKEN

# 2. 測試 API token
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user

# 3. 檢查 token 權限
# 確認 token 有必要的 scopes
```

**解決方案**：

#### 重新生成 Token
```bash
# GitHub Token
1. 訪問 GitHub Settings > Developer settings > Personal access tokens
2. 生成新 token，確保包含必要權限
3. 更新環境變數

# Slack Token
1. 訪問 Slack App 管理頁面
2. 重新生成 Bot Token
3. 確認 App 有必要的 scopes
```

#### 更新配置
```bash
# 更新 ~/.config/claude/config.json
{
  "mcpServers": {
    "github": {
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}

# 重新載入配置
claude --mcp-reload
```

---

## 🎨 輸出格式問題

### 問題 1：輸出格式不一致

**症狀**：
- 相同指令產生不同格式
- 專業格式沒有生效
- 輸出結構混亂

**診斷步驟**：
```bash
# 1. 檢查當前輸出風格
/output-style:current

# 2. 檢查可用風格
/output-style

# 3. 檢查風格說明
/output-style:help [style-name]
```

**解決方案**：

#### 確保正確使用輸出風格
```bash
# 問題：忘記設置輸出風格
❌ /agents:documentation-writer
   "生成 API 文檔"

# 解決：組合使用
✅ /agents:documentation-writer
   /output-style:api-documentation
   "生成 API 文檔"
```

#### 提供格式指引
```bash
# 問題：指令不夠具體
❌ "生成報告"

# 解決：明確格式要求
✅ "生成安全審計報告，包含：
   1. 執行摘要
   2. 風險分級
   3. 詳細發現
   4. 修復建議"
```

---

### 問題 2：自訂風格無效

**症狀**：
- 自訂輸出風格沒有生效
- 風格定義檔案錯誤

**診斷步驟**：
```bash
# 1. 檢查風格檔案位置
ls ~/.claude/output-styles/

# 2. 檢查檔案內容
cat ~/.claude/output-styles/custom-style.yaml

# 3. 檢查語法錯誤
```

**解決方案**：

#### 檢查檔案格式
```yaml
# 正確的風格定義格式
name: custom-report
description: 自訂報告格式
category: reporting

template: |
  # {{title}}

  ## 摘要
  {{summary}}

  ## 詳細內容
  {{content}}

parameters:
  - title: string
  - summary: string
  - content: string
```

#### 重新載入風格
```bash
# 重新載入自訂風格
claude --reload-styles

# 測試自訂風格
/output-style:custom-report
"測試自訂格式"
```

---

## ⚡ 效能問題

### 問題 1：回應速度慢

**症狀**：
- 長時間等待回應
- 處理大檔案時超時
- 複雜任務執行緩慢

**診斷步驟**：
```bash
# 1. 檢查輸入大小
wc -l [檔案名稱]    # 檢查行數
du -h [檔案名稱]    # 檢查檔案大小

# 2. 檢查系統資源
top                  # 檢查 CPU 和記憶體使用
df -h               # 檢查磁碟空間

# 3. 檢查網路狀態
ping 8.8.8.8        # 檢查網路連接
```

**解決方案**：

#### 優化輸入大小
```bash
# 問題：一次處理太多檔案
❌ claude --add-dir ./large_project

# 解決：選擇性添加
✅ claude --add-file ./src/main.py
   claude --add-file ./src/utils.py
```

#### 分批處理
```bash
# 問題：一次處理複雜任務
❌ "分析整個專案並生成完整報告"

# 解決：分階段處理
✅ "第一步：分析核心架構"
   "第二步：檢查安全性"
   "第三步：評估效能"
   "第四步：整合報告"
```

#### 使用背景處理
```bash
# 對於耗時任務
/bashes
"在背景執行長時間任務"

# 定期檢查進度
"檢查背景任務狀態"
```

---

### 問題 2：記憶體使用過高

**症狀**：
- 系統變慢
- Out of memory 錯誤
- 瀏覽器標籤頁崩潰

**解決方案**：

#### 清理會話資料
```bash
# 重新開始會話
claude --new-session

# 清理臨時檔案
rm -rf ~/.claude/temp/*

# 限制檔案添加
claude --add-file specific_file.py  # 而不是整個目錄
```

#### 優化工作方式
```bash
# 避免同時處理多個大型任務
# 定期保存重要結果
# 使用 /memory 記錄關鍵資訊
```

---

## ⚙️ 配置問題

### 問題 1：配置檔案錯誤

**症狀**：
- Claude Code 啟動失敗
- 功能無法正常使用
- 設定沒有生效

**診斷步驟**：
```bash
# 1. 檢查配置檔案位置
ls -la ~/.config/claude/
ls -la ~/.claude/

# 2. 檢查檔案權限
ls -la ~/.config/claude/config.json

# 3. 驗證 JSON 語法
cat ~/.config/claude/config.json | jq .
```

**解決方案**：

#### 修復檔案權限
```bash
# 設定正確權限
chmod 755 ~/.config/claude/
chmod 600 ~/.config/claude/config.json
```

#### 修復 JSON 語法
```json
// 常見錯誤
❌ {
  "key": "value",  // 多餘的逗號
}

// 正確格式
✅ {
  "key": "value"
}
```

#### 重置配置
```bash
# 備份現有配置
cp ~/.config/claude/config.json ~/.config/claude/config.json.backup

# 生成新配置
claude --init-config

# 重新添加自訂設定
```

---

### 問題 2：環境變數問題

**症狀**：
- MCP 認證失敗
- API 無法存取
- 功能受限

**診斷步驟**：
```bash
# 1. 檢查環境變數
env | grep CLAUDE
env | grep GITHUB
env | grep SLACK

# 2. 檢查 shell 配置
cat ~/.bashrc | grep export
cat ~/.zshrc | grep export

# 3. 測試變數載入
echo $GITHUB_TOKEN
```

**解決方案**：

#### 設定環境變數
```bash
# 添加到 shell 配置檔案
echo 'export GITHUB_TOKEN="your_token_here"' >> ~/.bashrc

# 重新載入配置
source ~/.bashrc

# 或者在當前會話設定
export GITHUB_TOKEN="your_token_here"
```

#### 持久化設定
```bash
# 在 ~/.bashrc 或 ~/.zshrc 中添加
export GITHUB_TOKEN="your_token"
export SLACK_BOT_TOKEN="your_token"
export OPENAI_API_KEY="your_key"

# 重新啟動 terminal 或執行
source ~/.bashrc
```

---

## 🔍 進階診斷工具

### 詳細日誌檢查
```bash
# 檢查 Claude Code 日誌
tail -f ~/.claude/logs/claude.log

# 檢查 MCP 日誌
tail -f ~/.claude/logs/mcp.log

# 檢查錯誤日誌
tail -f ~/.claude/logs/error.log
```

### 系統狀態檢查
```bash
# 檢查 Claude Code 版本
claude --version

# 檢查系統相容性
claude --system-check

# 檢查網路連接
claude --network-test
```

### 配置驗證
```bash
# 驗證完整配置
claude --validate-config

# 測試所有 MCP 連接
claude --test-all-mcp

# 檢查 Agent 可用性
claude --test-agents
```

---

## 🆘 緊急恢復程序

### 當所有功能都無法使用時

1. **完全重置**：
```bash
# 備份重要資料
cp ~/.config/claude/config.json ~/config_backup.json
cp -r ~/.claude/memory/ ~/memory_backup/

# 完全重置
rm -rf ~/.config/claude/
rm -rf ~/.claude/

# 重新初始化
claude --init
```

2. **重新安裝**：
```bash
# 重新安裝 Claude Code
pip uninstall claude-code
pip install claude-code

# 重新安裝 MCP servers
npm uninstall -g @modelcontextprotocol/server-*
npm install -g @modelcontextprotocol/server-filesystem
```

3. **恢復配置**：
```bash
# 恢復備份的配置
cp ~/config_backup.json ~/.config/claude/config.json
cp -r ~/memory_backup/ ~/.claude/memory/
```

---

## 📞 獲得幫助

### 社群支援
- **官方文檔**: [Claude Code Documentation](https://docs.anthropic.com/claude-code)
- **GitHub Issues**: [報告問題](https://github.com/anthropic/claude-code/issues)
- **Discord 社群**: [加入討論](https://discord.gg/claude-code)

### 提供錯誤報告時包含的資訊
```bash
# 收集系統資訊
claude --system-info > system_info.txt

# 收集錯誤日誌
tail -100 ~/.claude/logs/error.log > error_log.txt

# 收集配置資訊（移除敏感資料）
cat ~/.config/claude/config.json | jq 'del(.mcpServers[].env)' > config_info.json
```

---

**最後更新**：2025年1月
**版本**：v1.0
**維護者**：Claude Code 課程團隊

---

## 🔗 相關速查表

- [Agent使用速查](./Agent使用速查.md) - Agent 專家系統
- [MCP配置速查](./MCP配置速查.md) - 工具整合
- [輸出風格速查](./輸出風格速查.md) - 格式控制
- [常用組合模式](./常用組合模式.md) - 工作流程範本