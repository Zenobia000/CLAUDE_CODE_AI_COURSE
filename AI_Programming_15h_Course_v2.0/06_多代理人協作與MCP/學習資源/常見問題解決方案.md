# 常見問題解決方案 - 情境驅動的故障排除指南

## 📋 使用說明

這不是 FAQ 列表，而是**診斷流程圖 + 解決方案**。

**使用方式**：
1. 找到你遇到的問題分類
2. 跟著診斷步驟逐步排查
3. 套用解決方案
4. 記錄你的經驗

---

## 問題分類

- [問題 1：MCP 配置後沒反應](#問題-1mcp-配置後沒反應)
- [問題 2：API Rate Limit](#問題-2api-rate-limit)
- [問題 3：權限不足 (403/401)](#問題-3權限不足-403401)
- [問題 4：MCP 調用超時](#問題-4mcp-調用超時)
- [問題 5：Agent 切換後上下文丟失](#問題-5agent-切換後上下文丟失)
- [問題 6：並行執行沒有加速](#問題-6並行執行沒有加速)
- [問題 7：錯誤沒有被捕獲](#問題-7錯誤沒有被捕獲)
- [問題 8：Token 洩漏警告](#問題-8token-洩漏警告)

---

## 問題 1：MCP 配置後沒反應

### 症狀

```
User: "列出我的 GitHub repositories"
Claude: "我無法存取你的 GitHub..."
```

### 診斷流程圖

```
MCP 配置後沒反應
    ↓
檢查 1：配置檔位置正確嗎？
├─ 否 → 移動到 .claude/mcp-config.json
└─ 是 ↓

檢查 2：JSON 格式正確嗎？
├─ 否 → 修正 JSON 語法錯誤
└─ 是 ↓

檢查 3：重啟 Claude Code 了嗎？
├─ 否 → 重啟 Claude Code
└─ 是 ↓

檢查 4：MCP server 可執行嗎？
├─ 否 → 安裝依賴 / 檢查指令
└─ 是 ↓

檢查 5：Token/環境變數正確嗎？
├─ 否 → 更新 token / 設定環境變數
└─ 是 ↓

檢查 6：網路連線正常嗎？
├─ 否 → 檢查防火牆 / VPN
└─ 是 ↓

進階診斷 → 查看錯誤日誌
```

### 解決方案

#### 方案 A：驗證配置檔

```bash
# 1. 確認檔案存在
ls -la .claude/mcp-config.json

# 2. 驗證 JSON 格式
cat .claude/mcp-config.json | jq .

# 如果報錯，修正 JSON 語法
```

#### 方案 B：測試 MCP server

```bash
# 手動執行 MCP server 測試
npx -y @modelcontextprotocol/server-github

# 應該啟動而不報錯
```

#### 方案 C：驗證 Token

```bash
# 測試 GitHub token
curl -H "Authorization: token YOUR_TOKEN" \
  https://api.github.com/user

# 應該返回你的用戶資訊
```

### 預防措施

- ✅ 配置後立即測試
- ✅ 使用配置驗證腳本
- ✅ 保留可用的配置備份

---

## 問題 2：API Rate Limit

### 症狀

```
Error: API rate limit exceeded for user XXX
Reset time: 2025-10-30 15:00:00 UTC
```

### 快速解決

**立即行動**：
```
User: "檢查我的 API rate limit 狀態"

Claude 會告訴你：
- 當前使用量
- 剩餘配額
- 重置時間
```

**等待重置 OR 優化調用**

### 長期方案

#### 方案 A：快取機制

```javascript
// 快取最近的結果
const cache = new Map();

function getCachedData(key, ttl = 300) {
    if (cache.has(key)) {
        const {data, timestamp} = cache.get(key);
        if (Date.now() - timestamp < ttl * 1000) {
            return data;  // 使用快取
        }
    }
    // 調用 API
}
```

#### 方案 B：批次請求

```
不要：
- 10 次單獨調用 → 使用 10 次配額

要：
- 1 次批次調用 → 使用 1 次配額
```

#### 方案 C：升級 Token

- 未認證：60 次/小時
- 已認證：5,000 次/小時
- GitHub Apps：更高配額

### 監控建議

```
User: "設定監控：
如果 rate limit 剩餘 < 10%，
發送警報到 Slack"
```

---

## 問題 3：權限不足 (403/401)

### 症狀

```
Error: 403 Forbidden
Resource not accessible by personal access token
```

### 診斷

```
權限錯誤
    ↓
401 Unauthorized？
├─ 是 → Token 無效或過期
│   └─ 重新生成 token
└─ 否 (403) ↓

檢查：需要哪個權限？
    ├─ 讀取 repo → repo:status
    ├─ 創建 issue → repo
    └─ Admin 操作 → repo (full control)

更新 Token 權限
    ↓
測試驗證
```

### 解決方案

1. **查看錯誤訊息**（通常會說明需要哪個權限）
2. **前往 GitHub Settings → Tokens**
3. **編輯 token，加上需要的 scope**
4. **更新配置檔**
5. **重啟 Claude Code**

### 權限參考

| 操作 | 最小權限 |
|-----|---------|
| 讀取公開 repo | public_repo |
| 讀取私人 repo | repo:status |
| 創建 issue | repo |
| 創建 PR | repo |
| 管理 repo | repo (full) |

---

## 問題 4：MCP 調用超時

### 症狀

```
Error: Operation timed out after 30s
```

### 診斷

```
超時錯誤
    ↓
資料量太大？
├─ 是 → 使用分頁 / 限制結果數量
└─ 否 ↓

查詢複雜度高？
├─ 是 → 優化查詢 / 加索引
└─ 否 ↓

網路問題？
├─ 是 → 檢查連線 / 使用 VPN
└─ 否 ↓

伺服器問題？
└─ 聯絡服務提供商
```

### 解決方案

#### 方案 A：分頁查詢

```
不要：
"獲取所有 issues"（可能有 10,000 個）

要：
"獲取最近 100 個 issues"
"獲取第 1-100 個 issues"
```

#### 方案 B：增加超時時間

```json
{
  "mcpServers": {
    "database": {
      // ...
      "timeout": 60000  // 60 秒
    }
  }
}
```

#### 方案 C：非同步處理

```
對於大型操作：
1. 觸發操作
2. 返回 job ID
3. 定期檢查狀態
4. 完成後獲取結果
```

---

## 問題 5：Agent 切換後上下文丟失

### 症狀

```
User: "/agents:security-auditor
      審查剛才的程式碼"

Claude: "我沒有看到任何程式碼..."
```

### 真相

**這通常不是問題！** Claude 保留完整對話歷史。

### 可能原因

1. **描述不清楚**："剛才的" 指的是什麼？
2. **上下文太長**：超過 context window
3. **新開對話**：真的是新對話

### 解決方案

#### 明確指定

```
不要：
"審查剛才的程式碼"

要：
"審查我在 3 則訊息前提供的 login.js 程式碼"
```

#### 重新提供上下文

```
User: "/agents:security-auditor

審查以下程式碼：
[重新貼上程式碼]
"
```

---

## 問題 6：並行執行沒有加速

### 症狀

設定並行，但執行時間沒有減少。

### 診斷

```
並行沒有加速
    ↓
任務真的獨立嗎？
├─ 否 → 有依賴關係，無法並行
└─ 是 ↓

任務很快完成嗎？
├─ 是 → 並行開銷 > 收益
└─ 否 ↓

有共享資源限制嗎？
├─ 是 → Rate limit / Connection pool
└─ 否 ↓

實作問題？
└─ 檢查是否真的並行執行
```

### 解決方案

#### 確認真的並行

```
User: "同時執行以下任務，
並顯示每個任務的開始和完成時間：
1. 從 GitHub 獲取 issues
2. 從 Database 查詢數據
3. 從 Slack 讀取訊息"

檢查時間戳記：
[10:00:00] Task 1 開始
[10:00:00] Task 2 開始  ← 同時開始
[10:00:00] Task 3 開始  ← 同時開始
[10:00:05] Task 1 完成
[10:00:06] Task 2 完成
[10:00:04] Task 3 完成
```

#### 權衡並行開銷

```
如果單個任務 < 1 秒：
並行開銷可能 > 收益

如果單個任務 > 5 秒：
並行收益顯著
```

---

## 問題 7：錯誤沒有被捕獲

### 症狀

MCP 調用失敗，整個流程崩潰。

### 解決方案

#### 明確要求錯誤處理

```
User: "執行以下流程，
每個步驟如果失敗，
記錄錯誤並繼續：

1. 從 GitHub 獲取資料
   If 失敗 → 使用快取資料
2. 從 Database 查詢
   If 失敗 → 跳過此步驟
3. 生成報告
   If 前面都失敗 → 生成錯誤報告
"
```

#### 設計降級方案

```
主要方案 → 失敗
    ↓
Plan B → 失敗
    ↓
Plan C → 最後手段
```

---

## 問題 8：Token 洩漏警告

### 症狀

GitHub / Slack 寄信：
"We detected your token in a public repository"

### 立即行動

**1. 撤銷 token（5 分鐘內）**
```
前往服務設定 → Revoke token
```

**2. 生成新 token**

**3. 更新配置**

**4. 檢查 Git 歷史**
```bash
git log -p | grep -i "token\|secret\|api"
```

**5. 如果在 Git 歷史中**
```bash
# 清除歷史（危險操作！）
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .claude/mcp-config.json" \
  --prune-empty --tag-name-filter cat -- --all

git push --force --all
```

### 預防措施

```bash
# .gitignore
.claude/mcp-config.json
*.env
secrets/
.env.*
```

---

## 🎓 學習建議

### 遇到新問題時

1. **不要慌張**：99% 的問題都可以解決
2. **系統診斷**：跟著診斷流程圖走
3. **記錄經驗**：下次遇到更快解決
4. **分享給團隊**：避免重複踩坑

### 建立問題解決能力

1. **理解原理** > 記住答案
2. **舉一反三** > 死記硬背
3. **建立模式** > 解決單一問題

**記住**：
> 問題是最好的老師
> 每次解決問題都是一次成長

---

**需要更多幫助？**
- 查看其他學習資源
- 參考情境題庫的實戰案例
- 向社群提問
