# 安全與治理檢查清單 - MCP 與多代理人系統安全配置指南

## 📋 使用說明

這是**可執行的檢查清單**，不是理論文檔。

**使用方式**：
1. 配置新 MCP 時，逐項檢查
2. 定期安全審計時，重新檢查
3. 生產環境部署前，完整檢查
4. 發生安全事件後，重新評估

**檢查清單格式**：
- [ ] 待檢查項目
- ✅ 已通過
- ❌ 未通過（需要修復）
- ⚠️ 部分通過（需要改進）

---

## 🔒 Level 1：MCP 配置安全

### 1.1 Token 與 API Keys 管理

#### 基本要求（必須 100% 通過）

- [ ] **絕不硬編碼 Secrets**
  ```json
  ❌ "GITHUB_TOKEN": "ghp_actual_token"
  ✅ "GITHUB_TOKEN": "${GITHUB_TOKEN}"
  ```

- [ ] **使用環境變數**
  ```bash
  ✅ 配置檔引用環境變數
  ✅ .env 檔案存在
  ✅ .env 已加入 .gitignore
  ```

- [ ] **.gitignore 配置正確**
  ```gitignore
  # 必須包含
  .env
  .env.*
  .claude/mcp-config.json
  *.secret
  secrets/
  **/*secret*
  **/*token*
  **/*key*
  ```

- [ ] **提供範本檔案**
  ```bash
  ✅ .env.example 存在
  ✅ 範本中使用佔位符，無真實 token
  ✅ README.md 說明如何設定環境變數
  ```

#### 進階要求（生產環境必須）

- [ ] **Token 輪換機制**
  - 設定 Token 有效期限（建議 90 天）
  - 定期（例如每月）更新 Token
  - 記錄 Token 創建和更新日期

- [ ] **Token 權限最小化**
  ```
  ✅ GitHub Token：僅授予需要的 scope
  ✅ Database：使用只讀帳號（如適用）
  ✅ Slack Bot：僅授予需要的權限
  ✅ Notion：僅分享必要的頁面
  ```

- [ ] **Token 洩漏監控**
  - 使用 GitHub Secret Scanning（如適用）
  - 設定警報機制
  - 訂閱服務商的安全通知

### 1.2 配置檔案安全

#### 配置檔權限檢查

- [ ] **文件權限適當**
  ```bash
  # Linux/Mac
  ✅ chmod 600 .env（僅擁有者可讀寫）
  ✅ chmod 600 .claude/mcp-config.json

  # Windows
  ✅ 設定檔案僅當前用戶可存取
  ```

- [ ] **配置檔位置安全**
  ```
  ✅ 配置檔不在公開目錄（如 web root）
  ✅ 配置檔不在共享目錄
  ✅ 配置檔路徑在 .gitignore 中
  ```

#### 配置內容檢查

- [ ] **無敏感資料硬編碼**
  ```bash
  # 檢查指令
  grep -r "password\|secret\|token\|key" .claude/
  grep -r "ghp_\|xoxb-\|secret_" .claude/

  ✅ 應該沒有任何匹配（或僅有環境變數引用）
  ```

- [ ] **驗證 JSON 格式**
  ```bash
  cat .claude/mcp-config.json | jq .
  ✅ 無語法錯誤
  ```

### 1.3 環境隔離

- [ ] **開發/生產環境分離**
  ```bash
  # 開發環境
  .env.development

  # 生產環境
  .env.production

  ✅ 不同環境使用不同 Token
  ✅ 開發環境不使用生產環境 Token
  ```

- [ ] **測試環境配置**
  ```
  ✅ 測試環境有獨立的資料庫
  ✅ 測試環境使用 Mock 或 Sandbox API
  ✅ 測試資料不包含真實用戶資料
  ```

---

## 🔐 Level 2：資料庫安全

### 2.1 連線安全

#### 帳號權限（關鍵！）

- [ ] **使用只讀帳號**（如果只需要查詢）
  ```sql
  -- PostgreSQL
  CREATE USER claude_readonly WITH PASSWORD 'secure_password';
  GRANT CONNECT ON DATABASE your_db TO claude_readonly;
  GRANT USAGE ON SCHEMA public TO claude_readonly;
  GRANT SELECT ON ALL TABLES IN SCHEMA public TO claude_readonly;

  ✅ 僅授予 SELECT 權限
  ❌ 絕不授予 INSERT, UPDATE, DELETE
  ❌ 絕不授予 DROP, CREATE 權限
  ```

- [ ] **權限最小化原則**
  ```
  ✅ 僅授予需要的資料表
  ✅ 僅授予需要的欄位（如支援）
  ✅ 不授予系統資料表存取權限
  ✅ 不授予其他 schema 的權限
  ```

#### 連線字串安全

- [ ] **連線字串使用環境變數**
  ```json
  ✅ "DATABASE_URL": "${DATABASE_URL}"
  ❌ "DATABASE_URL": "postgresql://user:password@host/db"
  ```

- [ ] **連線參數安全**
  ```
  ✅ 使用 SSL/TLS 連線（sslmode=require）
  ✅ 連線超時設定合理（避免長時間占用）
  ✅ 連線池大小限制（避免耗盡連線）
  ```

### 2.2 查詢安全

- [ ] **防止 SQL Injection**
  ```
  ✅ 使用參數化查詢
  ✅ 不直接拼接 SQL 字串
  ✅ 使用 ORM 或查詢建構器

  User: "查詢用戶 {user_input}"
  ✅ 使用 prepared statement
  ❌ 不要 f"SELECT * FROM users WHERE name = '{user_input}'"
  ```

- [ ] **敏感資料遮罩**
  ```sql
  ❌ SELECT * FROM users  -- 包含 password hash, email
  ✅ SELECT id, name, created_at FROM users  -- 僅查詢需要的欄位
  ```

### 2.3 資料保護

- [ ] **不查詢敏感資料**
  ```
  避免查詢：
  ❌ 密碼（即使是 hash）
  ❌ 信用卡號
  ❌ 身分證字號
  ❌ 完整 email（考慮遮罩）
  ```

- [ ] **查詢結果限制**
  ```sql
  ✅ 使用 LIMIT 限制返回數量
  ✅ 避免 SELECT * 返回所有欄位
  ✅ 避免返回大量資料（分頁處理）
  ```

---

## 🌐 Level 3：API 與外部服務安全

### 3.1 API Token 管理

#### GitHub

- [ ] **Token 權限審查**
  ```
  最小權限選擇：
  ✅ public_repo（僅公開 repo）
  ⚠️ repo（私人 repo 存取，需要時才授予）
  ❌ admin:org（除非絕對必要）
  ❌ delete_repo（危險權限，避免）
  ```

- [ ] **Token 類型選擇**
  ```
  ✅ Personal Access Token (Classic)：短期使用
  ✅ Fine-grained Token：更精細權限控制
  ⚠️ OAuth App：團隊共用（需要嚴格管理）
  ```

#### Slack

- [ ] **Bot Token vs User Token**
  ```
  ✅ 優先使用 Bot Token（xoxb-）
  ⚠️ User Token（xoxp-）僅在必要時使用

  Bot Token Scopes（最小化）：
  ✅ channels:read（讀取頻道）
  ✅ chat:write（發送訊息）
  ❌ channels:manage（除非需要創建頻道）
  ❌ admin.*（避免管理員權限）
  ```

#### Notion

- [ ] **Integration 權限**
  ```
  ✅ 僅分享必要的頁面/Database
  ✅ 使用 Internal Integration（內部使用）
  ⚠️ Public Integration（需要 OAuth flow，更複雜）
  ```

### 3.2 API 調用安全

- [ ] **Rate Limit 遵守**
  ```
  ✅ 實作 Rate Limit 檢查
  ✅ 設定合理的調用頻率
  ✅ 使用快取減少調用
  ✅ 監控 API 使用量
  ```

- [ ] **錯誤處理**
  ```
  ✅ 捕獲所有 API 錯誤
  ✅ 不洩漏詳細錯誤訊息給用戶
  ✅ 記錄錯誤日誌供調試
  ✅ 設定重試機制（合理次數）
  ```

- [ ] **超時設定**
  ```
  ✅ 設定連線超時（例如 30 秒）
  ✅ 設定讀取超時（例如 60 秒）
  ✅ 長時間操作使用非同步處理
  ```

---

## 👥 Level 4：Agent 與工作流程安全

### 4.1 Agent 權限控制

- [ ] **Agent 角色隔離**
  ```
  ✅ security-auditor：僅審計，不修改程式碼
  ✅ reviewer：僅審查，不執行部署
  ✅ data-analyst：僅查詢，不修改資料
  ⚠️ devops-engineer：部署權限（需要嚴格控制）
  ```

- [ ] **危險操作確認**
  ```
  危險操作應該要求確認：
  ⚠️ 刪除資料
  ⚠️ 生產環境部署
  ⚠️ 權限變更
  ⚠️ 系統配置修改

  User: "執行此操作前，請先說明影響並要求我確認"
  ```

### 4.2 工作流程安全

- [ ] **輸入驗證**
  ```
  ✅ 驗證用戶輸入格式
  ✅ 驗證資料範圍
  ✅ 防止代碼注入
  ✅ 過濾特殊字元
  ```

- [ ] **輸出過濾**
  ```
  ✅ 避免輸出敏感資料
  ✅ 遮罩部分敏感資訊（如 Email）
  ✅ 不記錄密碼或 Token
  ```

- [ ] **錯誤處理安全**
  ```
  ✅ 不洩漏系統內部資訊
  ✅ 不洩漏檔案路徑
  ✅ 不洩漏資料庫結構
  ✅ 僅返回必要的錯誤訊息
  ```

---

## 📝 Level 5：日誌與審計

### 5.1 日誌記錄

- [ ] **記錄關鍵操作**
  ```
  ✅ MCP 連線/斷線
  ✅ API 調用（成功/失敗）
  ✅ 資料庫查詢（不記錄結果）
  ✅ Agent 切換
  ✅ 錯誤和異常
  ```

- [ ] **日誌安全**
  ```
  ❌ 絕不記錄：
     - 密碼
     - Token
     - API Keys
     - 完整信用卡號
     - 個人敏感資料

  ✅ 可以記錄：
     - 操作類型
     - 時間戳記
     - 用戶 ID（去識別化）
     - 操作結果（成功/失敗）
  ```

- [ ] **日誌存取控制**
  ```
  ✅ 日誌僅授權人員可存取
  ✅ 日誌不存放在公開目錄
  ✅ 設定日誌保留期限
  ✅ 定期審查日誌存取記錄
  ```

### 5.2 審計追蹤

- [ ] **可追溯性**
  ```
  ✅ 誰（Who）：哪個用戶/Agent
  ✅ 何時（When）：精確時間戳記
  ✅ 做什麼（What）：操作類型
  ✅ 結果（Result）：成功/失敗
  ✅ 影響（Impact）：修改了什麼
  ```

- [ ] **定期審計**
  ```
  建議頻率：
  ✅ 每週：檢查異常存取
  ✅ 每月：審查 Token 使用
  ✅ 每季：完整安全審計
  ✅ 事件發生後：立即審計
  ```

---

## 🚨 Level 6：事件回應

### 6.1 Token 洩漏處理

#### 立即行動（5 分鐘內）

- [ ] **Step 1：撤銷 Token**
  ```
  ✅ GitHub：Settings → Developer settings → Revoke token
  ✅ Slack：App Settings → Revoke token
  ✅ Notion：Settings → Revoke integration
  ✅ Database：撤銷帳號或更改密碼
  ```

- [ ] **Step 2：生成新 Token**
  ```
  ✅ 重新生成 Token
  ✅ 更新 .env 檔案
  ✅ 重啟 Claude Code
  ✅ 驗證新 Token 可用
  ```

#### 調查行動（30 分鐘內）

- [ ] **Step 3：調查洩漏範圍**
  ```bash
  # 檢查 Git 歷史
  git log -p | grep -i "token\|secret\|password\|api"

  # 檢查所有分支
  git log --all -p | grep -i "token\|secret"

  ✅ 確認洩漏的 commit
  ✅ 確認是否已推送到遠端
  ✅ 確認影響範圍
  ```

- [ ] **Step 4：清除 Git 歷史**（如果已提交）
  ```bash
  # ⚠️ 危險操作！會改寫歷史
  # 僅在確認必要時執行

  # 方法 1：移除特定檔案的歷史
  git filter-branch --force --index-filter \
    "git rm --cached --ignore-unmatch .env" \
    --prune-empty --tag-name-filter cat -- --all

  # 方法 2：使用 BFG Repo-Cleaner（推薦）
  bfg --delete-files .env
  bfg --replace-text passwords.txt

  # 強制推送
  git push --force --all
  git push --force --tags

  # ⚠️ 通知團隊成員重新 clone
  ```

#### 預防行動（持續）

- [ ] **Step 5：加強預防**
  ```
  ✅ 更新 .gitignore
  ✅ 設定 pre-commit hook
  ✅ 啟用 GitHub Secret Scanning
  ✅ 團隊安全培訓
  ```

### 6.2 未授權存取處理

- [ ] **發現未授權存取**
  ```
  檢查指標：
  ✅ 異常 API 調用量
  ✅ 非預期時間的操作
  ✅ 未知 IP 的連線
  ✅ 非預期的資料存取
  ```

- [ ] **立即回應**
  ```
  ✅ 撤銷所有可疑 Token
  ✅ 重置所有密碼
  ✅ 審查存取日誌
  ✅ 通知受影響的用戶
  ✅ 評估資料洩漏範圍
  ```

---

## 📋 快速檢查清單（使用前）

### 配置新 MCP 時（10 分鐘檢查）

```
在配置任何新 MCP 之前，確認：

1. Token 管理
   - [ ] Token 已加入環境變數
   - [ ] .env 在 .gitignore 中
   - [ ] 配置檔不包含真實 token
   - [ ] .env.example 已更新

2. 權限檢查
   - [ ] Token 權限最小化
   - [ ] 資料庫使用只讀帳號（如適用）
   - [ ] API scope 僅授予必要權限

3. 測試
   - [ ] 在開發環境測試
   - [ ] 驗證權限足夠
   - [ ] 驗證權限不過度

4. 文檔
   - [ ] README.md 說明如何配置
   - [ ] 記錄 Token 創建日期
   - [ ] 記錄權限範圍
```

### 生產環境部署前（30 分鐘檢查）

```
1. 環境隔離
   - [ ] 生產環境有獨立 Token
   - [ ] .env.production 僅在生產環境存在
   - [ ] 開發環境配置未混入

2. 安全加固
   - [ ] 所有 Token 已輪換（如超過 90 天）
   - [ ] 權限重新審查
   - [ ] 日誌記錄已啟用
   - [ ] 監控已設定

3. 備份與回滾
   - [ ] 配置已備份
   - [ ] 回滾計畫已準備
   - [ ] 緊急聯絡人已確認

4. 測試
   - [ ] 在 Staging 環境完整測試
   - [ ] 模擬失敗情境
   - [ ] 驗證錯誤處理
```

### 定期審計（每月 1 次）

```
1. Token 審計
   - [ ] 檢查所有 Token 是否仍然需要
   - [ ] 檢查 Token 年齡（超過 90 天輪換）
   - [ ] 檢查未使用的 Token（撤銷）

2. 權限審計
   - [ ] 審查所有 MCP 權限
   - [ ] 確認仍遵循最小權限原則
   - [ ] 移除不需要的權限

3. 日誌審計
   - [ ] 審查異常存取
   - [ ] 審查失敗的操作
   - [ ] 審查錯誤率趨勢

4. 配置審計
   - [ ] 確認 .gitignore 正確
   - [ ] 確認無 secrets 洩漏
   - [ ] 確認環境隔離正確
```

---

## 🎓 安全最佳實踐總結

### ✅ 永遠遵守的原則

1. **最小權限原則**
   - Token 僅授予必要權限
   - 資料庫使用只讀帳號
   - API 僅呼叫必要端點

2. **防禦深度**
   - 不依賴單一安全措施
   - 多層防護（Token + 權限 + 監控）
   - 假設會被攻破，準備應對方案

3. **零信任**
   - 不信任用戶輸入
   - 不信任外部 API
   - 驗證所有資料

4. **可見性**
   - 記錄關鍵操作
   - 監控異常行為
   - 定期審計

### ❌ 永遠避免的錯誤

1. **硬編碼 Secrets**
   ```
   ❌ 絕不在程式碼中寫 Token
   ❌ 絕不提交 .env 到 Git
   ❌ 絕不在註解中寫密碼
   ```

2. **過度權限**
   ```
   ❌ 不需要寫入就不授予 INSERT
   ❌ 不需要刪除就不授予 DELETE
   ❌ 不需要管理員就不授予 admin
   ```

3. **忽略錯誤**
   ```
   ❌ 不處理 API 錯誤
   ❌ 不檢查權限不足
   ❌ 不記錄失敗操作
   ```

4. **共享帳號**
   ```
   ❌ 不共享個人 Token
   ❌ 不共享資料庫密碼
   ❌ 不使用團隊共用帳號
   ```

---

## 📚 相關資源

- **MCP 配置** → 參考 `MCP配置速查表.md`
- **故障排除** → 參考 `常見問題解決方案.md`
- **最佳實踐** → 參考 `最佳實踐案例集.md`
- **情境練習** → 查看 `情境題庫/` 中的安全相關情境

---

## 🚦 安全等級自評

### Level 1：基本安全 (60 分)
```
✅ Token 使用環境變數
✅ .env 在 .gitignore
✅ 無硬編碼 secrets
```

### Level 2：良好安全 (75 分)
```
Level 1 +
✅ Token 權限最小化
✅ 資料庫使用只讀帳號
✅ 開發/生產環境分離
```

### Level 3：優秀安全 (85 分)
```
Level 2 +
✅ 定期 Token 輪換
✅ 日誌記錄完善
✅ 異常監控啟用
✅ 定期安全審計
```

### Level 4：企業級安全 (95 分)
```
Level 3 +
✅ 完整的事件回應計畫
✅ 自動化安全檢查
✅ 安全培訓計畫
✅ 合規性認證（如需要）
```

**你的系統目前在哪個等級？**

---

**記住**：
> 安全不是一次性的任務
> 而是持續的過程
> 今天安全，不代表明天安全
> 定期檢查，持續改進

**開始檢查你的系統安全吧！** 🔒
