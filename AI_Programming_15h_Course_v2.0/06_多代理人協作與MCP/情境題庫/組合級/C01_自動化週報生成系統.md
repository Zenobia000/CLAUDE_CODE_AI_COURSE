# C01: 自動化週報生成系統 - 4-MCP 協同實戰

## 📋 情境描述

### 你的痛點

作為團隊 Leader，每週五下午你需要花 2 小時生成週報：

**手動流程的地獄**：
1. **GitHub**：打開瀏覽器 → 查看 closed issues → 複製到筆記
2. **Database**：打開 SQL 客戶端 → 寫查詢 → 導出數據 → 整理
3. **手動整理**：Excel / Google Sheets → 計算 → 製表 → 寫摘要
4. **Slack**：複製內容 → 格式化 → 發到 #engineering
5. **Notion**：再複製一次 → 建立頁面 → 歸檔

**每週浪費 2 小時**，而且還經常遺漏資料或格式錯誤。

### 你想要的

> "如果週五下午 4 點，我只要說一句話：'生成本週週報'，
> 然後 AI 自動抓資料、分析、生成、發送、歸檔... 5 分鐘搞定！"

**這就是本情境要實現的！**

---

## 🎯 學習目標

完成本情境後，你將能夠：

- [ ] 設計 4-MCP 協同的工作流程
- [ ] 掌握並行與串行編排
- [ ] 實作完整的自動化系統
- [ ] 建立錯誤處理與回退機制
- [ ] 體驗多 Agent 協同工作
- [ ] 從手動 2 小時 → 自動 5 分鐘

**時間預估**：2-2.5 小時
- 理解需求與設計：20 分鐘
- 配置 MCP：20 分鐘
- 實作工作流程：60 分鐘
- 測試與優化：20 分鐘

---

## 第一部分：需求分析與系統設計（20 分鐘）

### 功能需求

**週報應該包含**：

1. **GitHub 活動統計**
   - 本週 closed issues 數量
   - 本週 merged PRs 數量
   - 本週 commits 統計
   - Top 貢獻者

2. **用戶數據分析**
   - 本週新用戶數
   - 用戶活躍度（週對週比較）
   - 用戶留存率

3. **業務指標**
   - 本週訂單數與金額
   - 熱賣產品 Top 5
   - 平均訂單價值

4. **系統健康度**
   - 平均回應時間
   - 錯誤率
   - 系統正常運行時間

5. **趨勢分析**
   - 數據趨勢洞察
   - 異常指標警示
   - 下週建議

### 輸出要求

- **Slack 完整版**：發到 #engineering（含詳細數據）
- **Slack 摘要版**：發到 #management（只含關鍵指標）
- **Notion 歸檔**：儲存完整週報到 Notion Database

---

### 系統架構設計

```
┌─────────────────────────────────────────────────────────┐
│          自動化週報生成系統                               │
└─────────────────────────────────────────────────────────┘

階段 1：資料獲取（並行 Parallel）
┌──────────────────────────────────────────────────────────┐
│  Task 1.1: GitHub MCP                                     │
│  ├─ 獲取 closed issues                                    │
│  ├─ 獲取 merged PRs                                      │
│  ├─ 獲取 commits 統計                                     │
│  └─ 識別 top 貢獻者                                       │
│                                                           │
│  Task 1.2: Database MCP                                   │
│  ├─ 查詢新用戶數                                          │
│  ├─ 查詢用戶活躍度                                        │
│  ├─ 查詢訂單統計                                          │
│  └─ 查詢系統效能指標                                      │
└──────────────────────────────────────────────────────────┘
                        ↓ 等待兩個任務都完成
階段 2：資料分析（串行 Sequential）
┌──────────────────────────────────────────────────────────┐
│  Task 2.1: data-analyst Agent                             │
│  ├─ 整合 GitHub 和 Database 資料                         │
│  ├─ 計算週對週變化                                        │
│  ├─ 識別趨勢與異常                                        │
│  └─ 生成洞察與建議                                        │
│                                                           │
│  Task 2.2: tech-writer Agent                              │
│  ├─ 撰寫專業週報文案                                      │
│  ├─ 格式化資料與圖表                                      │
│  ├─ 添加摘要與重點                                        │
│  └─ 生成兩個版本（詳細 + 摘要）                          │
└──────────────────────────────────────────────────────────┘
                        ↓
階段 3：分發與歸檔（並行 Parallel）
┌──────────────────────────────────────────────────────────┐
│  Task 3.1: Slack MCP                                      │
│  ├─ 發送詳細版到 #engineering                            │
│  └─ 發送摘要版到 #management                             │
│                                                           │
│  Task 3.2: Notion MCP                                     │
│  ├─ 創建週報頁面                                          │
│  ├─ 填入完整內容                                          │
│  └─ 歸檔到週報 Database                                  │
└──────────────────────────────────────────────────────────┘
                        ↓
階段 4：確認與通知（串行 Sequential）
┌──────────────────────────────────────────────────────────┐
│  Task 4.1: 驗證與日誌                                     │
│  ├─ 確認 Slack 發送成功                                  │
│  ├─ 確認 Notion 儲存成功                                 │
│  ├─ 生成執行日誌                                          │
│  └─ 記錄執行時間與狀態                                    │
└──────────────────────────────────────────────────────────┘

執行時間：預計 5-8 分鐘
```

---

## 第二部分：配置所有 MCP（20 分鐘）

### 檢查清單

確認你已經配置了：

- [ ] GitHub MCP（B01）
- [ ] Database MCP（B02）
- [ ] Slack MCP（B03）
- [ ] Notion MCP（B04）

### 完整配置範例

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    },
    "postgres": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-postgres"],
      "env": {
        "POSTGRES_CONNECTION_STRING": "${DATABASE_URL}"
      }
    },
    "slack": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-slack"],
      "env": {
        "SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}",
        "SLACK_TEAM_ID": "${SLACK_TEAM_ID}"
      }
    },
    "notion": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-notion"],
      "env": {
        "NOTION_API_KEY": "${NOTION_API_KEY}"
      }
    }
  }
}
```

### Notion 準備工作

**創建週報 Database**：

在 Notion 中創建一個 Database，欄位包含：
- 標題（Title）：週報日期範圍
- 週次（Number）
- GitHub Stats（Text）
- User Stats（Text）
- Business Metrics（Text）
- 生成時間（Date）
- 狀態（Select）：成功 / 失敗

---

## 第三部分：實作自動化流程（60 分鐘）

### Step 1：定義週報範本（5 分鐘）

```markdown
# 工程週報 - {日期範圍}

## 📊 本週數據總覽

### GitHub 活動
- **Closed Issues**: {count} 個 （週增長：{growth}%）
- **Merged PRs**: {count} 個
- **Commits**: {count} 個
- **Top 貢獻者**:
  1. {contributor1} - {commits} commits
  2. {contributor2} - {commits} commits
  3. {contributor3} - {commits} commits

### 用戶指標
- **新用戶**: {count} 人 （週增長：{growth}%）
- **活躍用戶**: {count} 人 （活躍率：{rate}%）
- **用戶留存**:
  - Day 7: {rate}%
  - Day 30: {rate}%

### 業務指標
- **訂單數**: {count} 筆 （週增長：{growth}%）
- **訂單金額**: NT$ {amount} （週增長：{growth}%）
- **平均訂單價值**: NT$ {aov}
- **熱賣產品 Top 5**:
  1. {product1} - {sales} 筆
  2. {product2} - {sales} 筆
  3. {product3} - {sales} 筆
  4. {product4} - {sales} 筆
  5. {product5} - {sales} 筆

### 系統健康度
- **平均回應時間**: {ms}ms
- **錯誤率**: {rate}%
- **系統正常運行**: {uptime}%

## 🎯 本週重點

### 已完成
{completed_list}

### 進行中
{in_progress_list}

## 📈 趨勢分析

{ai_insights}

## ⚠️ 需要關注

{alerts_and_warnings}

## 📝 下週計畫

{next_week_plan}

---
*本週報由 AI 自動生成 • {生成時間}*
```

---

### Step 2：實作階段 1 - 資料獲取（15 分鐘）

```
You: "開始生成本週週報

【階段 1：資料獲取】並行執行

Task 1.1: GitHub 資料
- Repo: {你的 repo 名稱}
- 時間範圍：過去 7 天
- 獲取：
  * Closed issues（含標題、標籤）
  * Merged PRs（含作者、檔案變更數）
  * Commits 統計（含作者、訊息）
  * Top 3 貢獻者

Task 1.2: Database 資料
- 時間範圍：過去 7 天 vs 前一週
- 查詢：
  * 新用戶數（含週對週比較）
  * 活躍用戶數與活躍率
  * 用戶留存率（Day 7, Day 30）
  * 訂單數量與金額
  * 熱賣產品 Top 5
  * 系統效能指標（回應時間、錯誤率）

【執行時機】：同時啟動兩個任務，等待都完成
【Agent】：data-analyst
【預計時間】：2-3 分鐘

開始執行階段 1"
```

**預期執行過程**：

```
[00:00] 階段 1 開始...
[00:05] 並行獲取資料中...
[00:30] GitHub MCP: 獲取 issues...
[00:35] Database MCP: 查詢用戶數據...
[01:15] GitHub MCP: 獲取 PRs...
[01:20] Database MCP: 查詢訂單統計...
[01:45] GitHub MCP: 統計 commits...
[01:50] Database MCP: 查詢系統指標...
[02:10] GitHub MCP: 完成 ✓
[02:15] Database MCP: 完成 ✓
[02:20] 階段 1 完成！

GitHub 資料：
- 15 個 closed issues
- 8 個 merged PRs
- 127 commits
- Top 貢獻者：Alice (45), Bob (32), Charlie (28)

Database 資料：
- 新用戶：234 人 （↑15%）
- 活躍用戶：3,456 人 （活躍率 34.5%）
- 留存率：Day 7: 45%, Day 30: 28%
- 訂單：1,234 筆，NT$ 2,345,678 （↑8%）
- 熱賣產品：Product A (234), Product B (189), ...
```

---

### Step 3：實作階段 2 - 資料分析（20 分鐘）

```
You: "【階段 2：資料分析】串行執行

Task 2.1: 資料整合與分析
- Agent: data-analyst
- 任務：
  1. 整合階段 1 的所有資料
  2. 計算週對週變化百分比
  3. 識別異常指標（如突然下降）
  4. 發現趨勢（如持續增長）
  5. 生成洞察與建議
  6. 找出需要關注的問題

Task 2.2: 週報撰寫
- Agent: tech-writer
- 任務：
  1. 使用週報範本
  2. 填入所有數據
  3. 撰寫「趨勢分析」段落
  4. 撰寫「需要關注」段落
  5. 撰寫「下週計畫」段落
  6. 生成兩個版本：
     - 詳細版（完整內容）
     - 摘要版（只含關鍵指標與重點）

【執行順序】：Task 2.1 完成後再執行 Task 2.2
【預計時間】：2-3 分鐘

開始執行階段 2"
```

**預期執行過程**：

```
[02:20] 階段 2 開始...
[02:25] data-analyst: 整合資料...
[02:45] data-analyst: 計算週對週變化...
[03:00] data-analyst: 識別趨勢與異常...

【洞察分析】
✅ 正面趨勢：
- 用戶增長穩定（+15%，連續 4 週）
- 訂單轉換率提升（+3%）
- 系統穩定性良好（99.8% uptime）

⚠️ 需要關注：
- 用戶留存率下降（Day 30: 28% → 25%）
- Product B 銷量下滑（-12%）
- 系統回應時間略增（120ms → 145ms）

[03:30] data-analyst: 分析完成 ✓

[03:35] tech-writer: 開始撰寫週報...
[04:00] tech-writer: 填入數據...
[04:30] tech-writer: 撰寫摘要與建議...
[04:50] tech-writer: 生成兩個版本...
[05:00] tech-writer: 完成 ✓

【週報已生成】
- 詳細版：1,200 字，8 個段落
- 摘要版：300 字，關鍵指標 + 重點

[05:00] 階段 2 完成！
```

---

### Step 4：實作階段 3 - 分發與歸檔（15 分鐘）

```
You: "【階段 3：分發與歸檔】並行執行

Task 3.1: 發送到 Slack
- MCP: Slack MCP
- 任務：
  1. 發送詳細版到 #engineering
     - 完整內容
     - 使用程式碼區塊和表格格式化
     - 添加表情符號
  2. 發送摘要版到 #management
     - 只含關鍵指標
     - 突出重點與建議

Task 3.2: 儲存到 Notion
- MCP: Notion MCP
- 任務：
  1. 在「週報」Database 創建新 entry
  2. 填入週次、日期範圍
  3. 填入完整週報內容
  4. 設定狀態為「成功」

【執行時機】：同時執行兩個任務
【預計時間】：1-2 分鐘

開始執行階段 3"
```

**預期執行過程**：

```
[05:00] 階段 3 開始...
[05:05] 並行分發中...

[05:10] Slack MCP: 發送到 #engineering...
[05:30] Slack MCP: 發送到 #management...
[05:45] Slack MCP: 完成 ✓

[05:15] Notion MCP: 創建週報頁面...
[05:40] Notion MCP: 填入內容...
[05:55] Notion MCP: 完成 ✓

[06:00] 階段 3 完成！

【分發結果】
✅ Slack #engineering:
   https://workspace.slack.com/archives/C123/p1234567890

✅ Slack #management:
   https://workspace.slack.com/archives/C456/p1234567891

✅ Notion 週報:
   https://notion.so/週報-2025-10-24-to-10-30
```

---

### Step 5：實作階段 4 - 確認與日誌（5 分鐘）

```
You: "【階段 4：確認與通知】

Task 4.1: 驗證與日誌
- 確認 Slack 訊息發送成功
- 確認 Notion 頁面創建成功
- 生成執行報告
- 記錄執行時間

開始執行階段 4，生成最終報告"
```

**最終報告**：

```
╔══════════════════════════════════════════════════════════╗
║        📊 自動化週報生成 - 執行報告                      ║
╚══════════════════════════════════════════════════════════╝

【執行摘要】
✅ 狀態：成功
⏱️  總執行時間：6 分 15 秒
📅 週報期間：2025-10-24 到 2025-10-30

【階段執行詳情】
✅ 階段 1：資料獲取（並行）- 2:20
   ├─ GitHub MCP: 2:10 ✓
   └─ Database MCP: 2:15 ✓

✅ 階段 2：資料分析（串行）- 2:40
   ├─ 資料整合: 1:10 ✓
   └─ 週報撰寫: 1:30 ✓

✅ 階段 3：分發歸檔（並行）- 1:00
   ├─ Slack 發送: 0:50 ✓
   └─ Notion 儲存: 0:55 ✓

✅ 階段 4：確認日誌 - 0:15

【數據統計】
📊 GitHub:
   - 15 issues closed
   - 8 PRs merged
   - 127 commits

📈 Users:
   - 234 new users (+15%)
   - 3,456 active users

💰 Business:
   - 1,234 orders
   - NT$ 2,345,678 (+8%)

【輸出結果】
✅ Slack #engineering:
   https://workspace.slack.com/archives/C123/p1234567890

✅ Slack #management:
   https://workspace.slack.com/archives/C456/p1234567891

✅ Notion 週報:
   https://notion.so/週報-2025-10-24-to-10-30

【時間對比】
❌ 手動流程：2 小時
✅ 自動化流程：6 分鐘
💡 節省時間：114 分鐘（95% 提升）

╔══════════════════════════════════════════════════════════╗
║  🎉 週報已成功生成並分發！                              ║
╚══════════════════════════════════════════════════════════╝
```

---

## 第四部分：錯誤處理與優化（20 分鐘）

### 常見錯誤處理

#### 錯誤 1：GitHub API Rate Limit

**症狀**：
```
Error: API rate limit exceeded
```

**回退方案**：
```
You: "如果遇到 GitHub rate limit，
使用快取的上週資料，
並在週報中標註「使用快取資料」"
```

**實作**：
```
if (github_api_fails) {
    使用快取資料
    在週報加上警告：
    "⚠️ GitHub 資料使用快取（API 限制）"
}
```

---

#### 錯誤 2：Database 查詢超時

**症狀**：
```
Error: Query timeout after 30s
```

**回退方案**：
```
You: "如果資料庫查詢超時，
使用簡化查詢（只查核心指標），
並標註「簡化資料」"
```

---

#### 錯誤 3：Slack 發送失敗

**症狀**：
```
Error: Channel not found
```

**回退方案**：
```
You: "如果 Slack 發送失敗，
儲存為本地檔案 weekly_report.md，
通知我手動發送"
```

---

### 優化技巧

#### 優化 1：快取資料

```
You: "實作快取機制：
- 快取 GitHub 資料 5 分鐘
- 快取 Database 查詢 2 分鐘
- 加速重複執行"
```

#### 優化 2：進度通知

```
You: "在執行過程中發送進度通知到 Slack：
- 階段 1 完成 → 發送通知
- 階段 2 完成 → 發送通知
- 最終完成 → 發送完整報告連結"
```

#### 優化 3：定時執行

```
You: "設定排程：
每週五下午 4:00 自動執行週報生成"
```

---

## 第五部分：擴展挑戰

### 挑戰 1：添加圖表

```
You: "在週報中添加視覺化圖表：
- 用戶增長趨勢圖
- 訂單金額變化圖
- GitHub 活動熱力圖

使用 Chart.js 或 matplotlib 生成，
上傳到 Slack 和 Notion"
```

### 挑戰 2：智能異常偵測

```
You: "實作智能異常偵測：
- 如果任何指標下降 > 20%，觸發警報
- 發送到 #alerts channel
- 標記為「需要立即處理」"
```

### 挑戰 3：多語言版本

```
You: "生成多語言週報：
- 中文版：發到台灣團隊
- 英文版：發到國際團隊
- 使用 tech-writer Agent 翻譯"
```

### 挑戰 4：對比分析

```
You: "添加對比分析：
- 與去年同期對比
- 與季度目標對比
- 與競品數據對比（如果有）"
```

---

## 🎓 學習檢查點

完成本情境後，檢查你是否掌握：

### 技術層面
- [ ] 能設計 4-MCP 協同的工作流程
- [ ] 理解並行與串行的應用時機
- [ ] 能實作完整的錯誤處理機制
- [ ] 掌握多 Agent 切換策略
- [ ] 知道如何優化執行時間

### 流程層面
- [ ] 能拆解複雜任務為多個階段
- [ ] 能識別任務之間的依賴關係
- [ ] 能設計回退方案
- [ ] 能實作進度追蹤與日誌

### 商業層面
- [ ] 理解自動化的價值（時間節省 95%）
- [ ] 能向團隊展示自動化成果
- [ ] 能複製此模式到其他報表
- [ ] 能評估自動化的 ROI

---

## 📚 延伸學習

**相關情境**：
- `C02_知識萃取系統.md` - 類似的多 MCP 協同模式
- `C08_團隊協作儀表板.md` - 即時版的週報系統
- `E01_企業級DevOps自動化平台.md` - 更複雜的工作流程編排

**進階主題**：
- 自訂 MCP 開發：`實作/練習2_自訂MCP開發/`
- 工作流程編排深入：`理論/6.2_多代理人編排實戰.md`

---

## 💡 關鍵收穫

**這個情境展示了 MCP 協同的核心價值**：

1. **從手動到自動**
   - 2 小時 → 6 分鐘
   - 95% 時間節省
   - 零人工介入

2. **多 MCP 協同的威力**
   - 4 個 MCP 無縫配合
   - 並行執行節省時間
   - 自動錯誤處理

3. **多 Agent 提升品質**
   - data-analyst：專業資料分析
   - tech-writer：專業文案撰寫
   - 輸出品質遠超手動

4. **可複製的模式**
   - 週報 → 月報、季報
   - 工程報表 → 業務報表
   - 一個模式，無限應用

**恭喜完成最核心的組合級情境！** 🎉

你已經掌握了多 MCP 協同的精髓，
現在你可以設計任何自動化工作流程了！
