# C05: 智能通知分發系統 - 多渠道協同與循環編排

## 📋 情境描述

### 你的痛點

系統有各種事件需要通知不同的人：
- 緊急：系統錯誤 → Slack + Email + 電話
- 重要：部署完成 → Slack + Email
- 一般：日常更新 → Slack only

**手動通知的混亂**：
1. 判斷優先級 → 選擇渠道 → 逐一發送
2. 如果失敗 → 手動重試 → 可能遺漏
3. 沒有統一管理 → 通知散亂

### 你想要的

> "智能判斷事件優先級，自動選擇最佳通知渠道組合，失敗自動重試，確保訊息送達"

---

## 🎯 學習目標

- [ ] 掌握多通知渠道整合
- [ ] 學會循環編排模式（重試機制）
- [ ] 實作智能通知策略
- [ ] 建立通知去重與追蹤
- [ ] 理解條件分支在實際場景中的應用

**時間**：1.5 小時

---

## 系統架構

```
輸入：事件 (type, severity, message, recipients)

階段 1：事件分析（串行）
├─ 判斷事件嚴重程度（Critical/High/Medium/Low）
├─ 決定通知渠道組合
│   ├─ Critical: Slack + Email + SMS
│   ├─ High: Slack + Email
│   ├─ Medium: Slack
│   └─ Low: 合併為摘要（每小時一次）
└─ 識別收件人列表

階段 2：通知發送（並行 + 循環）
For each 渠道:
    ├─ 嘗試發送
    ├─ If 失敗 → 等待 → 重試（最多 3 次）
    └─ If 仍失敗 → 記錄到失敗佇列

階段 3：確認與追蹤（串行）
├─ 確認所有渠道的發送狀態
├─ 記錄通知日誌
├─ 如果有失敗 → 發送警報給管理員
└─ 更新通知儀表板

階段 4：摘要與報告（條件）
If 低優先級事件累積 > 10:
    └─ 生成摘要通知
```

---

## 第一部分：配置多渠道 MCP（15 分鐘）

### 需要的 MCP

- Slack MCP
- Email MCP (可使用 nodemailer 或 SendGrid)
- SMS MCP (可選，使用 Twilio)

### 通知策略配置

```javascript
const NOTIFICATION_STRATEGY = {
    'critical': {
        channels: ['slack', 'email', 'sms'],
        retry: 3,
        retryDelay: 30, // 秒
        requireAllSuccess: true
    },
    'high': {
        channels: ['slack', 'email'],
        retry: 3,
        retryDelay: 15,
        requireAllSuccess: false // 至少一個成功即可
    },
    'medium': {
        channels: ['slack'],
        retry: 2,
        retryDelay: 10,
        requireAllSuccess: false
    },
    'low': {
        channels: ['slack'],
        batch: true, // 合併為摘要
        batchInterval: 3600, // 1 小時
        retry: 1,
        retryDelay: 5
    }
};
```

---

## 第二部分：實作通知系統（60 分鐘）

### 測試 1：Critical 事件

```
You: "發送 Critical 通知：

事件類型：系統錯誤
嚴重程度：Critical
訊息：Database connection pool exhausted
影響：50% 請求失敗
收件人：engineering-oncall, ops-team, management

執行智能通知流程"
```

**預期執行過程**：

```
[00:00] 分析事件...
事件嚴重程度：Critical
通知渠道：Slack + Email + SMS
收件人：3 個群組，共 15 人

[00:05] 階段 2：並行發送通知...

[00:10] Slack MCP：發送中...
[00:15] Email MCP：發送中...
[00:20] SMS MCP：發送中...

[00:25] Slack MCP：成功 ✓
[00:30] Email MCP：失敗 ✗ (SMTP timeout)
[00:35] SMS MCP：成功 ✓

[00:40] Email MCP：重試 (1/3)...
[01:10] Email MCP：成功 ✓

[01:15] 階段 3：確認狀態...
✅ Slack: 15/15 已送達
✅ Email: 15/15 已送達（重試 1 次）
✅ SMS: 15/15 已送達

[01:20] 記錄通知日誌...
[01:25] 更新儀表板...

【通知完成】
⏱️  總時間：1 分 25 秒
📊 成功率：100% (3/3 渠道)
🔄 重試次數：1 次
✅ 狀態：所有收件人已收到通知
```

---

### 測試 2：High 事件 with 部分失敗

```
You: "發送 High 通知：

事件：部署完成
嚴重程度：High
訊息：v2.1.0 已部署到 Production
收件人：engineering-team

如果 Email 失敗達到最大重試次數，
只要 Slack 成功就視為完成"
```

**預期執行過程**：

```
[00:00] 分析事件：High 優先級
通知渠道：Slack + Email
策略：至少一個成功即可

[00:05] 並行發送...

[00:10] Slack MCP：成功 ✓
[00:12] Email MCP：失敗 ✗

[00:27] Email MCP：重試 (1/3)...
[00:42] Email MCP：失敗 ✗

[00:57] Email MCP：重試 (2/3)...
[01:12] Email MCP：失敗 ✗

[01:27] Email MCP：重試 (3/3)...
[01:42] Email MCP：失敗 ✗

[01:45] 評估狀態：
✅ Slack: 成功
❌ Email: 失敗（達到最大重試次數）

決策：
- 至少一個渠道成功（Slack ✓）
- 視為部分成功
- 記錄 Email 失敗到錯誤佇列
- 發送警報給管理員

【通知完成（部分成功）】
⏱️  總時間：1 分 45 秒
📊 成功率：50% (1/2 渠道)
⚠️  警告：Email 渠道持續失敗，需要檢查
```

---

### 測試 3：Low 事件批次處理

```
You: "發送多個 Low 優先級事件：

事件 1: 用戶註冊 (user123)
事件 2: 訂單完成 (order456)
事件 3: 用戶註冊 (user789)
...
事件 15: 訂單完成 (order999)

策略：合併為摘要，每小時發送一次"
```

**預期輸出**：

```
[00:00] 接收 Low 優先級事件...
事件已加入批次佇列

當前佇列：15 個事件
下次發送時間：14:00 (還有 45 分鐘)

[14:00] 時間到，生成摘要通知...

【過去 1 小時事件摘要】

📊 統計：
- 新用戶註冊：8 人
- 訂單完成：7 筆
- 總事件數：15 個

📝 詳細資訊：
- 用戶註冊：user123, user789, ...
- 訂單：order456, order999, ...

發送到：#daily-updates

✅ 摘要通知已發送
```

---

## 第三部分：循環編排實戰（15 分鐘）

### 循環重試邏輯

```
You: "實作智能重試機制：

重試策略：
1. 第一次失敗 → 等待 10 秒 → 重試
2. 第二次失敗 → 等待 30 秒 → 重試
3. 第三次失敗 → 等待 60 秒 → 重試
4. 仍失敗 → 放棄，記錄錯誤

特殊情況：
- 如果是 rate limit → 等待更久（5 分鐘）
- 如果是網路斷線 → 立即放棄，不重試
- 如果是權限錯誤 → 立即放棄，發送警報"
```

**循環編排範例**：

```
Loop: 最多 3 次
    ├─ 嘗試發送通知
    ├─ If 成功 → 退出循環
    ├─ If 失敗：
    │   ├─ 分析錯誤類型
    │   ├─ If rate_limit → 等待 5 分鐘
    │   ├─ If network_error → 立即放棄
    │   ├─ If auth_error → 立即放棄 + 警報
    │   └─ Else → 指數退避等待
    └─ 繼續下一次嘗試

If 循環結束仍失敗：
    └─ 記錄到失敗佇列，定期重試
```

---

## 第四部分：進階功能（30 分鐘）

### 功能 1：通知去重

```
You: "實作通知去重：
- 相同事件 5 分鐘內只發送一次
- 避免通知轟炸"
```

**範例**：
```
[10:00:00] 事件：Database slow query
[10:00:05] 事件：Database slow query (去重，不發送)
[10:01:30] 事件：Database slow query (去重，不發送)
[10:06:00] 事件：Database slow query (超過 5 分鐘，發送)
```

### 功能 2：通知儀表板

```
You: "建立通知儀表板：
- 即時顯示通知狀態
- 統計發送成功率
- 顯示失敗佇列
- 追蹤渠道健康度"
```

### 功能 3：智能升級

```
You: "實作智能升級機制：
- Medium 事件持續 10 分鐘未解決 → 升級為 High
- High 事件持續 30 分鐘未解決 → 升級為 Critical
- 自動增加通知渠道"
```

---

## 第五部分：錯誤處理與監控（20 分鐘）

### 錯誤場景處理

**場景 1：所有渠道都失敗**
```
策略：
1. 記錄到持久化佇列
2. 每 5 分鐘重試一次
3. 持續 1 小時仍失敗 → 發送緊急警報
4. 使用備用通知方式（如 PagerDuty）
```

**場景 2：收件人無效**
```
策略：
1. 跳過無效收件人
2. 記錄錯誤
3. 通知管理員更新收件人列表
4. 繼續發送給其他有效收件人
```

**場景 3：通知風暴**
```
偵測：1 分鐘內 > 100 個事件

策略：
1. 啟動限流機制
2. 合併相似事件
3. 發送摘要而非逐一通知
4. 警報給管理員檢查系統
```

---

## 🎓 學習檢查點

- [ ] 能設計多渠道通知策略
- [ ] 掌握循環編排（重試機制）
- [ ] 理解條件分支的實際應用
- [ ] 能實作智能通知去重
- [ ] 掌握錯誤處理與降級策略
- [ ] 能建立通知監控與追蹤

---

## 📊 實戰數據對比

**手動通知**：
- 判斷優先級：30 秒
- 選擇渠道：15 秒
- 逐一發送：5 分鐘
- 確認送達：2 分鐘
- **總計**：約 8 分鐘/次

**自動化通知**：
- 自動判斷與發送：30 秒
- 自動重試與確認：1 分鐘
- **總計**：1.5 分鐘
- **效率提升**：5.3x

**可靠性提升**：
- 自動重試機制：99.5% 送達率
- 手動通知：約 85% 送達率（可能遺漏）

---

## 💡 關鍵收穫

**智能通知系統 = 可靠的訊息傳遞保證**

1. **循環編排的威力**
   - 自動重試
   - 指數退避
   - 錯誤分類處理

2. **多渠道協同**
   - 並行發送（速度）
   - 降級策略（可靠性）
   - 智能選擇（成本）

3. **條件分支的實際應用**
   - 根據嚴重程度選擇策略
   - 根據錯誤類型決定行動
   - 智能升級機制

4. **可複製的模式**
   - 通知系統 → 任何需要重試的操作
   - API 調用、資料同步、任務執行

**恭喜完成核心組合級情境題！** 🎉
