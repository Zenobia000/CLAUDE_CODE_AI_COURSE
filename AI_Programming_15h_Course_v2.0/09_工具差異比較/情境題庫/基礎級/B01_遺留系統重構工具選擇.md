# B01: 遺留系統重構工具選擇

**難度**：★★☆
**預估時間**：思考 5 分鐘 + 閱讀解答 10 分鐘
**考察重點**：理解大型重構的工具需求

---

## 情境描述

### 背景

你剛加入一家傳統金融科技公司，接手一個關鍵的後端系統。

### 系統現狀

```
專案資訊：
- 名稱：核心交易系統
- 語言：Python 2.7（是的，Python 2！）
- 代碼量：200,000 行
- 檔案數：150+ 個模組
- 年齡：5 年（2019 年開發）
- 測試覆蓋率：幾乎為 0
- 文檔：只有幾頁過時的 Wiki

技術債：
├─ Python 2.7 已經 EOL（End of Life）
├─ 使用 deprecated 的套件（如 Flask 0.12）
├─ 沒有型別註解
├─ 全域變數滿天飛
├─ Callback Hell（深層巢狀）
└─ 安全漏洞（未修補的 CVEs）

業務影響：
- 每天處理 100 萬筆交易
- 系統不穩定（每週當機 1-2 次）
- 新功能開發困難（牽一髮動全身）
- 技術人員流動率高（沒人想維護這個系統）
```

### 上級指示

```
CTO 的要求：
"這個系統必須重構，但不能停止服務。
你有 3 個月時間完成以下目標：

1. 遷移到 Python 3.11
2. 添加型別註解
3. 重構核心邏輯（消除技術債）
4. 建立測試套件（覆蓋率 > 80%）
5. 編寫完整文檔

預算：有足夠的工具預算
風險：絕對不能影響生產環境"
```

---

## 任務

### Part 1: 初步決策（5 分鐘思考）

請回答以下問題（不看參考解答）：

1. **你會選擇哪個 AI 工具？**
   - [ ] Claude Code
   - [ ] GitHub Copilot
   - [ ] Cursor
   - [ ] 工具組合：_____________

2. **你的理由是？**（用 2-3 句話說明）
   ```
   理由：
   _______________________________________
   _______________________________________
   _______________________________________
   ```

3. **你的重構計劃？**（簡要列出步驟）
   ```
   Phase 1: _______________________________
   Phase 2: _______________________________
   Phase 3: _______________________________
   ```

### Part 2: 風險評估

這個重構專案的最大風險是什麼？

```
風險 1: _______________________________
風險 2: _______________________________
風險 3: _______________________________
```

---

## 考察重點

這題測試你是否理解：

- [ ] 大型重構的複雜性
- [ ] Context window 的重要性
- [ ] EPCV 工作流的價值
- [ ] 風險管理的必要性
- [ ] 工具與任務的匹配度

---

## 參考解答

### 工具選擇：[Claude Code]（必選）

#### 決策邏輯

```
分析 1: 代碼規模
- 200,000 行代碼，150+ 檔案
- Copilot (8K) ✗ 無法理解全局
- Cursor (32K) ✗ 勉強看到 30-40 個檔案，不夠
- Claude Code (200K) ✓ 可以理解整個系統

分析 2: 任務複雜度
- 語言遷移（Python 2 → 3）涉及所有檔案
- 需要追蹤依賴關係（150 個模組互相依賴）
- 需要識別所有 breaking changes
→ 只有 Claude Code 能做全局分析

分析 3: 風險管理
- 這是金融系統，錯誤成本極高
- 需要系統性的重構計劃（EPCV 工作流）
- 需要生成完整的測試套件
→ Claude Code 的深度分析不可或缺

分析 4: 時間與成本
- 3 個月是充裕時間（可以接受 Claude Code 的慢速度）
- 預算充足（可以負擔 API 成本）
- 失敗的成本 >> 工具成本
→ 應該選最可靠的工具
```

#### 為什麼不選其他工具？

**❌ Copilot 不可行**

```
問題：
1. Context 太小（8K tokens）
   - 無法理解模組間的依賴關係
   - 重構 A 模組時不知道會破壞 B, C, D

2. 缺少全局視野
   - 無法識別所有 Python 2 → 3 的改動點
   - 可能漏掉關鍵的 breaking changes

3. 無法做系統性規劃
   - 只能單檔案補全
   - 無法生成完整的重構計劃

結論：用 Copilot 重構會導致災難
```

**❌ Cursor 勉強但不理想**

```
問題：
1. Context 不夠大（32K tokens）
   - 可以看到 30-40 個檔案
   - 但這個系統有 150 個檔案
   - 會漏掉 70% 的依賴關係

2. 風險太高
   - 對金融系統來說，任何遺漏都可能導致重大事故
   - Cursor 的"夠用但不完美"在這裡不夠好

3. 缺少深度分析
   - 沒有 EPCV 工作流
   - 無法生成系統性的風險評估

結論：如果預算不夠才考慮 Cursor，否則必須用 Claude Code
```

### 正確的重構計劃

#### Phase 1: 探索與評估（Week 1-2）

```bash
使用 Claude Code 進行深度分析

你: "分析這個 Python 2.7 專案，評估遷移到 Python 3.11 的工作量和風險"

Claude Code (Explore):
"正在分析 200,000 行代碼...

發現的關鍵問題：
1. 依賴套件問題（35 個套件）
   - 15 個已經不支援 Python 2
   - 8 個需要升級到新版本
   - 3 個需要尋找替代方案
   - 9 個無需變更

2. 語法改動（1,247 處）
   - print 語句 → print() 函數：342 處
   - dict.iteritems() → dict.items()：156 處
   - unicode vs str：89 處
   - ...

3. 模組依賴關係圖
   [生成 150 個模組的依賴關係圖]

   核心模組（必須優先重構）：
   - transaction_core.py（被 78 個模組依賴）
   - database_layer.py（被 65 個模組依賴）
   - auth_service.py（被 52 個模組依賴）

   獨立模組（可以先重構）：
   - reporting_utils.py（無依賴）
   - log_formatter.py（無依賴）
   - ...

4. 風險評估
   高風險區域（需極度謹慎）：
   - transaction_processor.py（處理金流）
   - balance_calculator.py（計算餘額）
   - settlement_service.py（清算邏輯）

   這些模組的測試覆蓋率：< 10% ⚠️
   建議：先寫測試，再重構

建議重構順序（12 週計劃）：
Week 1-2:  探索 + 規劃
Week 3-4:  重構獨立模組（低風險）
Week 5-6:  重構工具模組（中風險）
Week 7-9:  重構核心模組（高風險）
Week 10-11: 整合測試 + 性能測試
Week 12:   灰度發佈 + 監控"
```

#### Phase 2: 建立安全網（Week 3-4）

```bash
你: "為高風險模組生成完整的測試套件"

Claude Code (Create):
"為 transaction_processor.py 生成測試...

分析現有邏輯：
- 23 個 public 函數
- 67 個 private 函數
- 342 個可能的執行路徑

生成的測試：
1. 單元測試（156 個測試案例）
   - 正常流程：45 個
   - 邊界情況：67 個
   - 錯誤處理：44 個

2. 整合測試（23 個場景）
   - 完整交易流程
   - 並發測試
   - 錯誤恢復

3. 性能測試（5 個 benchmark）
   - 確保重構後性能不下降

執行測試：
✓ 156 unit tests passed
✓ 23 integration tests passed
✓ 5 performance benchmarks passed

現在可以安全重構了"
```

#### Phase 3: 漸進式重構（Week 5-9）

```bash
# Week 5-6: 低風險模組
你: "重構 reporting_utils.py 到 Python 3"

Claude Code:
[生成完整的重構代碼 + 測試]
"這個模組沒有依賴，可以直接重構"

# Week 7-9: 核心模組（謹慎處理）
你: "重構 transaction_processor.py"

Claude Code:
"這是高風險模組，讓我們分 10 個小步驟：

Step 1: 添加型別註解（不改邏輯）
Step 2: 執行測試 → ✓ Pass
Step 3: 修改 print 語句
Step 4: 執行測試 → ✓ Pass
Step 5: 修改 dict.iteritems()
Step 6: 執行測試 → ✓ Pass
...

每一步都確保測試通過
每一步都 commit（可以回滾）"
```

#### Phase 4: 驗證與發佈（Week 10-12）

```bash
你: "生成灰度發佈計劃"

Claude Code:
"建議的發佈策略：

Week 10: Staging 環境完整測試
- 模擬生產流量
- 運行 7 天無錯誤

Week 11: 灰度發佈
- Day 1-2:  1% 流量（監控錯誤率）
- Day 3-4:  10% 流量
- Day 5-6:  50% 流量
- Day 7:    100% 流量

監控指標：
- 錯誤率（目標：< 0.01%）
- 回應時間（目標：不增加）
- 交易成功率（目標：> 99.99%）

緊急回滾計劃：
- 準備 Python 2.7 環境（可立即切回）
- 使用 Feature Flag 快速切換
- 24 小時待命團隊"
```

### 成本效益分析

#### 成本

```
工具成本：
- Claude Code API：約 $500-1000（3 個月）
- 開發時間：3 個月 × 1 個開發者

總成本：約 $40,000（含人力）
```

#### 效益

```
避免的風險：
1. 系統崩潰成本：$100,000+/次
2. 技術債累積：每年 $50,000（效率損失）
3. 安全漏洞風險：不可估量
4. 人員流動成本：$30,000（招聘+訓練）

長期效益：
1. 系統穩定性提升（當機減少 90%）
2. 開發速度提升（新功能快 3x）
3. 維護成本降低（每年節省 $100,000）
4. 團隊士氣提升（技術債解決）

ROI：> 10x（第一年）
```

### 關鍵成功因素

#### ✅ 成功的原因

1. **選對工具**
   - Claude Code 能理解整個系統
   - EPCV 工作流提供系統性方法
   - 200K context 避免遺漏依賴

2. **漸進式重構**
   - 先建立測試安全網
   - 小步驟迭代（每步都測試）
   - 隨時可以回滾

3. **風險管理**
   - 識別高風險區域
   - 灰度發佈策略
   - 完善的監控和回滾機制

#### ❌ 如果選錯工具會怎樣？

**場景：用 Copilot 重構**

```
Week 1: 開始重構第一個模組
Week 2: 發現 Copilot 看不到依賴關係
Week 3: 手動追蹤依賴（效率極低）
Week 4: 重構 10 個模組，發現破壞了 30 個其他模組
Week 5: 開始修 bugs（打地鼠）
Week 6: 發現修不完（依賴太複雜）
Week 7: 專案宣告失敗
Week 8: 回滾到原始版本
Week 9: CTO 被炒，專案組解散

結果：浪費 $80,000，毫無成果
```

---

## 自我檢查

完成這題後，問自己：

- [ ] 我理解為什麼 Claude Code 是唯一選擇了嗎？
- [ ] 我知道大型重構的關鍵風險了嗎？
- [ ] 我能設計出漸進式的重構計劃嗎？
- [ ] 我理解工具選擇的成本效益分析了嗎？

---

## 延伸思考

### 問題 1：預算限制

```
如果公司預算有限，不能用 Claude Code，怎麼辦？

選項 A：用 Cursor（風險較高但成本低）
選項 B：手動重構（慢但可控）
選項 C：延後重構（技術債累積）

你的選擇？理由？
```

### 問題 2：時間壓力

```
如果只有 1 個月時間，策略要如何調整？

可能的方案：
- 只重構最關鍵的模組？
- 部分遷移（雙版本並存）？
- 說服管理層延長時間？

你會怎麼做？
```

---

**學習重點總結**

這題的核心教訓：

```
1. 工具選擇不是偏好問題，是能力問題
   - 大型重構必須有足夠的 context
   - 200K vs 8K 不是漸進差異，是質變

2. 風險管理是首要考慮
   - 金融系統錯不起
   - 工具成本 << 失敗成本
   - 選最可靠的工具，不是最便宜的

3. 系統性方法論必不可少
   - EPCV 工作流 > 隨機重構
   - 測試先行 > 重構後測試
   - 灰度發佈 > 一次性上線
```

---

**最後更新**：2025-10-30
