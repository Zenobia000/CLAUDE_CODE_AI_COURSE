# C03 - 銷售數據儀表板

## 📌 情境描述

### 業務背景
你是一家電商公司的數據分析師,每週需要向管理層匯報銷售數據。目前的流程是:
1. 從 MySQL 匯出訂單數據到 Excel
2. 手動製作樞紐分析表和圖表
3. 複製到 PowerPoint 製作報告
4. 整個流程需要 3 小時

### 現況痛點
- **重複勞動**:每週都是同樣的分析邏輯
- **時效性差**:數據匯出後已經過時
- **缺乏互動**:PowerPoint 無法深入鑽取
- **難以分享**:需要 Email 發送檔案
- **洞察不足**:只有基礎統計,缺乏趨勢分析和異常檢測

### 任務目標
使用 Claude Code 協助開發自動化銷售數據儀表板,實現:
- 實時數據連接(直接從資料庫讀取)
- 自動化分析(趨勢、同比、異常檢測)
- 互動式儀表板(可篩選、鑽取)
- AI 驅動洞察(自動生成業務建議)
- 隨時訪問(Web 介面,無需發送檔案)

---

## 🎯 學習目標

完成本情境後,你將能夠:

- [ ] **設計儀表板架構**:數據層、分析層、展示層分離
- [ ] **實時數據連接**:從資料庫動態讀取,避免匯出檔案
- [ ] **自動化分析邏輯**:趨勢計算、同比環比、異常檢測
- [ ] **互動式可視化**:Plotly 或 ECharts 建立動態圖表
- [ ] **AI 驅動洞察**:LLM 自動解讀數據並給出建議
- [ ] **部署與分享**:Streamlit Cloud 或 Docker 部署
- [ ] **效能優化**:快取機制、查詢優化

**時間估計**:2.5-3 小時

---

## 🏗️ 系統架構

```
┌─────────────────────────────────────────────────┐
│              Data Sources (數據源)               │
├──────────────┬──────────────┬───────────────────┤
│  MySQL       │  PostgreSQL  │  CSV / Excel      │
│ (訂單數據)    │ (用戶數據)    │ (外部數據)         │
└───────┬──────┴──────┬───────┴─────────┬─────────┘
        │             │                 │
        └─────────────┴─────────────────┘
                      ▼
          ┌─────────────────────┐
          │   Data Access Layer │
          │  - SQLAlchemy       │
          │  - Connection pool  │
          │  - Query cache      │
          └──────────┬──────────┘
                     ▼
          ┌─────────────────────┐
          │  Analytics Engine   │
          │  - Trend analysis   │
          │  - YoY / MoM calc   │
          │  - Anomaly detect   │
          │  - Aggregation      │
          └──────────┬──────────┘
                     ▼
          ┌─────────────────────┐
          │   AI Insight Layer  │
          │  - LLM analysis     │
          │  - Pattern detect   │
          │  - Recommendation   │
          └──────────┬──────────┘
                     ▼
          ┌─────────────────────┐
          │  Visualization Layer│
          │  - Plotly charts    │
          │  - Interactive      │
          │  - Responsive       │
          └──────────┬──────────┘
                     ▼
          ┌─────────────────────┐
          │  Web UI (Streamlit) │
          │  - Sidebar filters  │
          │  - Multi-page       │
          │  - Export function  │
          └─────────────────────┘
                     │
                     ▼
          ┌─────────────────────┐
          │   Deployment        │
          │  - Streamlit Cloud  │
          │  - Docker container │
          │  - Authentication   │
          └─────────────────────┘
```

---

## 📋 核心任務

### 階段一:數據存取層建立(30 分鐘)

**任務**:
1. 建立資料庫連接(SQLAlchemy)
2. 設計查詢函數(訂單、用戶、產品)
3. 實作查詢快取(@st.cache_data)
4. 參數化查詢(日期範圍、產品類別篩選)

**與 AI 協作要點**:
- "使用 SQLAlchemy 建立 MySQL 連接池"
- "設計查詢函數 get_sales_data(date_from, date_to, category=None)"
- "用 @st.cache_data 快取查詢結果,TTL=300 秒"
- "SQL 查詢優化:只查詢需要的欄位,加上適當索引"

**檢查點**:
- [ ] 可以從資料庫讀取訂單數據
- [ ] 查詢支援日期範圍篩選
- [ ] 快取生效(相同查詢 < 100ms)
- [ ] 連接池配置正確(避免連接洩漏)

---

### 階段二:分析邏輯實作(45 分鐘)

**任務**:
1. 關鍵指標計算(總銷售額、訂單數、客單價、轉換率)
2. 時間序列分析(日/週/月趨勢)
3. 同比環比計算(YoY, MoM)
4. 異常檢測(識別異常日期)
5. 產品/地區/渠道分析

**與 AI 協作要點**:
- "計算關鍵指標:總銷售額、平均客單價、訂單數、轉換率"
- "實作同比計算:compare_yoy(current_data, last_year_data)"
- "使用 Z-score 方法檢測銷售額異常日期"
- "Group by 產品類別、地區、銷售渠道,計算各維度占比"

**檢查點**:
- [ ] 關鍵指標計算正確
- [ ] 趨勢數據按日/週/月正確聚合
- [ ] 同比計算準確(考慮閏年)
- [ ] 異常檢測識別出明顯異常點
- [ ] 多維度分析數據結構完整

---

### 階段三:互動式可視化(40 分鐘)

**任務**:
1. 實作關鍵指標卡片(Metric Cards)
2. 時間序列圖表(折線圖、面積圖)
3. 佔比分析(圓餅圖、樹狀圖)
4. 地理分布(地圖熱力圖)
5. 互動篩選器(日期、類別、地區)

**與 AI 協作要點**:
- "使用 Streamlit st.metric 顯示關鍵指標,帶上升/下降箭頭"
- "用 Plotly 繪製時間序列折線圖,支援 zoom 和 hover"
- "實作產品類別佔比的 Sunburst 圖(樹狀圖)"
- "使用 Plotly geo 繪製銷售地理分布熱力圖"

**檢查點**:
- [ ] Metric Cards 顯示關鍵指標及變化百分比
- [ ] 時間序列圖可以 zoom、hover 查看詳細數據
- [ ] 圓餅圖/樹狀圖正確展示佔比
- [ ] 地圖顯示各地區銷售分布
- [ ] 篩選器可以動態更新所有圖表

---

### 階段四:AI 驅動洞察(35 分鐘)

**任務**:
1. 自動生成數據摘要(總體趨勢描述)
2. 異常點解釋(為什麼某日銷售額異常)
3. 模式識別(週期性、季節性)
4. 業務建議(基於數據的行動建議)

**與 AI 協作要點**:
- "設計 prompt:給 LLM 提供數據摘要(總銷售額、趨勢、異常點),要求生成業務洞察"
- "實作異常解釋:當檢測到異常時,結合上下文數據請 LLM 分析原因"
- "週期性分析:識別週末效應、月末效應"
- "生成 Top 3 行動建議(基於數據洞察)"

**範例 Prompt**:
```
Based on the following sales data summary:
- Total Revenue: $1.2M (↑15% vs last month)
- Total Orders: 5,420 (↑8%)
- Average Order Value: $221 (↑6%)
- Anomaly detected on 2024-01-15 (Revenue: $85K, 2.5x normal)
- Top category: Electronics (45%), followed by Fashion (30%)

Please provide:
1. Key insights (2-3 sentences)
2. Explanation for the Jan 15 anomaly
3. Top 3 actionable recommendations
```

**檢查點**:
- [ ] 自動生成數據摘要(自然語言描述趨勢)
- [ ] 異常點有 AI 解釋(可能原因)
- [ ] 識別出週期性模式(如週末銷售高峰)
- [ ] 提供 3 條可執行的業務建議

---

### 階段五:部署與優化(30 分鐘)

**任務**:
1. 多頁面設計(概覽、產品分析、地區分析)
2. 匯出功能(下載 CSV、PDF 報告)
3. 效能優化(lazy loading、query optimization)
4. 部署到 Streamlit Cloud 或 Docker

**與 AI 協作要點**:
- "使用 Streamlit 多頁面功能(pages/ 目錄)組織儀表板"
- "實作 CSV 匯出:st.download_button(data.to_csv())"
- "優化查詢:只在用戶點擊時才載入詳細數據(lazy loading)"
- "Dockerfile:包含 Python、Streamlit、資料庫驅動"

**檢查點**:
- [ ] 儀表板有多個頁面(概覽、深入分析)
- [ ] 可以下載數據為 CSV
- [ ] 初始載入時間 < 3 秒
- [ ] 部署成功,外部可訪問(Streamlit Cloud URL)

---

## 💡 學習重點

### 1. 儀表板架構設計

**關鍵概念**:
- **分層架構**:數據層、業務邏輯層、展示層分離
- **狀態管理**:Streamlit Session State 保存篩選條件
- **快取策略**:st.cache_data 用於數據、st.cache_resource 用於連接

**AI 協作策略**:
- "解釋 Streamlit 的 Rerun 機制,如何避免重複查詢?"
- "設計狀態管理策略:哪些狀態存在 session_state?"

---

### 2. 自動化分析技巧

**關鍵概念**:
- **時間序列分析**:resample、rolling、pct_change
- **異常檢測**:Z-score、IQR、Isolation Forest
- **同比環比**:shift、groupby 時間粒度

**AI 協作策略**:
- "使用 Pandas 計算月度同比增長率"
- "實作 rolling 7 天移動平均,平滑波動"
- "Z-score > 3 標記為異常,解釋這個閾值的意義"

---

### 3. 互動式可視化最佳實踐

**關鍵概念**:
- **圖表選擇**:時間序列用折線、佔比用餅圖、分布用直方圖
- **互動性**:hover、click、zoom、filter
- **響應式設計**:適配手機、平板、桌面

**Plotly vs Matplotlib**:
```
Plotly 優點:
- 原生互動(hover、zoom、pan)
- 美觀現代
- 易於整合 Streamlit

Matplotlib 優點:
- 靜態圖表品質高
- 高度客製化
- 生態系統成熟
```

**AI 協作策略**:
- "用 Plotly Express 繪製分組柱狀圖,比較各產品類別銷售額"
- "實作 drill-down:點擊類別後顯示該類別的詳細產品"

---

### 4. AI 增強分析

**關鍵概念**:
- **自動摘要**:將數據轉為自然語言
- **根因分析**:解釋異常背後的原因
- **預測建議**:基於趨勢給出未來預測

**Prompt 設計技巧**:
```python
# 好的 Prompt 結構
prompt = f"""
Role: You are a business analyst expert.

Context:
{data_summary}

Task:
1. Summarize key trends
2. Explain anomalies
3. Provide 3 actionable recommendations

Format: Use bullet points, be concise.
"""
```

**AI 協作策略**:
- "設計 prompt 讓 LLM 分析銷售數據趨勢"
- "如何避免 LLM 幻覺(不要編造不存在的數據)?"

---

## 🔧 技術棧建議

### 核心工具
- **Web 框架**:Streamlit / Dash
- **數據處理**:Pandas
- **可視化**:Plotly / Matplotlib / Seaborn
- **資料庫連接**:SQLAlchemy、psycopg2、pymysql
- **AI 分析**:OpenAI API / Anthropic Claude
- **異常檢測**:scipy、scikit-learn
- **部署**:Streamlit Cloud、Docker、Heroku

### 環境設定
```bash
# 安裝依賴
pip install streamlit pandas plotly sqlalchemy pymysql openai python-dotenv

# 啟動開發伺服器
streamlit run app.py

# 部署準備
# requirements.txt
streamlit==1.28.0
pandas==2.1.0
plotly==5.17.0
sqlalchemy==2.0.0
pymysql==1.1.0
openai==1.3.0

# .streamlit/config.toml
[theme]
primaryColor="#FF4B4B"
backgroundColor="#FFFFFF"
secondaryBackgroundColor="#F0F2F6"
```

---

## 📊 成功標準

完成後應該能夠:

### 功能完整性
- [ ] 實時連接資料庫,無需匯出檔案
- [ ] 顯示關鍵指標(銷售額、訂單數、客單價、轉換率)
- [ ] 時間序列趨勢分析(日/週/月)
- [ ] 同比環比計算
- [ ] 異常檢測與標註
- [ ] 多維度分析(產品、地區、渠道)
- [ ] AI 自動生成洞察和建議
- [ ] 互動篩選器(日期、類別、地區)
- [ ] 匯出功能(CSV、PDF)

### 品質指標
- [ ] **載入速度**:初始載入 < 3 秒
- [ ] **查詢效能**:篩選後更新 < 1 秒
- [ ] **準確性**:計算結果與 SQL 直接查詢一致
- [ ] **可用性**:7x24 穩定運行

### 使用者體驗
- [ ] 介面直觀,無需培訓可使用
- [ ] 圖表互動流暢(hover、zoom)
- [ ] 手機端可正常瀏覽
- [ ] AI 洞察有價值(不是廢話)

---

## 🚀 擴展挑戰

### 進階挑戰 1:預測模型整合
加入銷售預測功能,預測未來 30 天銷售趨勢。

**提示**:
- "使用 Prophet 或 SARIMA 模型預測時間序列"
- "訓練模型:過去 365 天數據,預測未來 30 天"
- "視覺化:實際值 vs 預測值,帶置信區間"

---

### 進階挑戰 2:實時告警系統
當銷售額異常時,自動發送 Slack/Email 告警。

**提示**:
- "設定異常閾值:銷售額 > 2 倍標準差"
- "使用 Slack Webhook 發送告警訊息"
- "告警訊息包含:異常時間、數值、可能原因(AI 生成)"

---

### 進階挑戰 3:自然語言查詢
讓用戶用自然語言提問(如"上週哪個產品賣最好?")。

**提示**:
- "使用 LLM 將自然語言轉為 SQL 查詢"
- "實作 Text-to-SQL 鏈:User Question → SQL → Execute → Visualize"
- "安全控制:只允許 SELECT 查詢,禁止 UPDATE/DELETE"

---

### 進階挑戰 4:多租戶隔離
支援多個業務單位,各自只能看到自己的數據。

**提示**:
- "實作基於角色的訪問控制(RBAC)"
- "查詢自動加上 WHERE team_id = current_user.team_id"
- "使用 Streamlit Authenticator 管理登入"

---

## 📚 相關資源

### 理論文件
- `理論/8.3_資料分析自動化.md` - 分析自動化概念

### 快速上手
- `快速上手/10分鐘搭建RAG系統.md` - Streamlit 快速入門參考

### 工具參考
- `工具速查/README.md` - 可視化工具選型

### 其他情境
- `B03_自動化分析報告生成` - 自動化報告基礎
- `C01_完整ETL管線開發` - 數據管線設計
- `C04_資料品質監控系統` - 監控設計思路

---

## 💬 AI 提示詞範例

### 架構設計階段
```
我需要建立銷售數據儀表板,數據來源是 MySQL 訂單表(200萬行)。

需求:
- 關鍵指標:銷售額、訂單數、客單價、轉換率
- 時間序列趨勢分析(日/週/月)
- 同比環比計算
- 產品/地區多維度分析
- AI 自動生成洞察

請幫我:
1. 設計儀表板架構(數據層、分析層、展示層)
2. 推薦技術棧(Web 框架、可視化庫)
3. 建議效能優化策略(快取、查詢優化)
```

### 實作階段
```
我用 Pandas 計算同比增長率,但結果不對:

```python
# 當前代碼
df['last_year'] = df['revenue'].shift(365)
df['yoy_growth'] = (df['revenue'] - df['last_year']) / df['last_year']
```

問題:
1. 閏年怎麼處理?(2024 有 366 天)
2. 去年同期可能沒有數據(新產品)
3. 增長率有時是 inf(分母為 0)

請改進這段代碼並解釋。
```

### 可視化階段
```
我想用 Plotly 繪製時間序列圖,但有特殊需求:

需求:
1. 顯示每日銷售額折線圖
2. 用紅點標記異常日期
3. hover 顯示:日期、銷售額、同比增長率
4. 可以 zoom、pan
5. 異常點有 tooltip 解釋原因

請給出完整代碼示例。
```

### 優化階段
```
儀表板載入很慢(首次載入 10 秒),需要優化:

當前架構:
- 每次 rerun 都查詢資料庫
- 查詢全表(200 萬行)再用 Pandas 過濾
- 沒有使用快取
- 所有圖表同時渲染

請給出優化方案:
1. 如何用 st.cache_data 快取查詢?
2. SQL 查詢如何優化(只查需要的)?
3. 如何實作 lazy loading(只載入可見圖表)?
```

---

**相關情境題**:
- 🟢 B03_自動化分析報告生成 - 簡化版自動化報告
- 🟡 C01_完整ETL管線開發 - 數據管線設計
- 🟡 C02_企業文檔問答系統 - Streamlit 部署參考
- 🟡 C04_資料品質監控系統 - 監控指標設計
