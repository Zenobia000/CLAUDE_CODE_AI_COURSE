# B03: 自動化分析報告生成 - 從 2 小時到 2 分鐘

## 📋 情境描述

**你的痛點**：
```
每週五下午的惡夢：
- 下載銷售資料 CSV
- 打開 Excel 手動計算
- 逐個製作圖表
- 複製貼上到 PowerPoint
- 整理成報告發送給主管

耗時：2 小時
錯誤率：經常算錯或忘記更新某個圖表
```

**你想要的**：
```
一鍵生成報告：
- 自動載入資料
- 自動探索性分析（EDA）
- 自動生成視覺化圖表
- 自動撰寫洞察與建議
- 輸出專業 Markdown/PDF 報告

目標：2 分鐘完成
```

---

## 🎯 學習目標

完成本題後，你將能夠：
- [ ] 用 AI 自動生成探索性分析代碼
- [ ] 自動產出多種資料視覺化圖表
- [ ] 用 AI 提取關鍵洞察與趨勢
- [ ] 生成結構化的分析報告
- [ ] 設定自動化排程（可選）

**時間**：30-45 分鐘

---

## 🏗️ 系統架構

### 報告生成流程

```
CSV 資料
    ↓
┌─────────────────────┐
│ 1. 資料載入與清洗    │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 2. 探索性分析 (EDA) │
│   - 基本統計         │
│   - 缺失值檢查       │
│   - 分佈分析         │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 3. 視覺化生成        │
│   - 趨勢圖          │
│   - 分佈圖          │
│   - 對比圖          │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 4. 洞察提取          │
│   - 關鍵趨勢         │
│   - 異常偵測         │
│   - 建議生成         │
└─────────────────────┘
    ↓
Markdown 報告
```

---

## 📝 任務階段

### 階段 1：環境準備（5 分鐘）

**任務 1.1**：安裝依賴

```bash
# 創建專案目錄
mkdir auto-report
cd auto-report

# 安裝必要套件
pip install pandas matplotlib seaborn openai python-dotenv
```

**任務 1.2**：準備測試資料

創建範例銷售資料 `sales_data.csv`：
```bash
cat > sales_data.csv << 'EOF'
date,product,category,quantity,revenue,region
2024-01-01,Product A,Electronics,15,4500,North
2024-01-01,Product B,Clothing,25,2500,South
2024-01-02,Product A,Electronics,18,5400,North
2024-01-02,Product C,Electronics,12,3600,East
2024-01-03,Product B,Clothing,30,3000,South
2024-01-03,Product A,Electronics,20,6000,North
2024-01-04,Product C,Electronics,15,4500,East
2024-01-04,Product D,Furniture,8,8000,West
2024-01-05,Product A,Electronics,22,6600,North
2024-01-05,Product B,Clothing,28,2800,South
EOF
```

**任務 1.3**：設定 API Key

創建 `.env`：
```bash
OPENAI_API_KEY=your_openai_api_key_here
```

---

### 階段 2：資料探索與清洗（10 分鐘）

**任務 2.1**：快速 EDA

創建 `analyze.py`：
```python
import pandas as pd
import numpy as np
from datetime import datetime

# 載入資料
df = pd.read_csv('sales_data.csv')
df['date'] = pd.to_datetime(df['date'])

print("=" * 50)
print("資料基本資訊")
print("=" * 50)
print(f"資料筆數：{len(df)}")
print(f"日期範圍：{df['date'].min()} 到 {df['date'].max()}")
print(f"產品數量：{df['product'].nunique()}")
print(f"類別：{df['category'].unique().tolist()}")
print(f"地區：{df['region'].unique().tolist()}")

print("\n" + "=" * 50)
print("基本統計")
print("=" * 50)
print(df.describe())

print("\n" + "=" * 50)
print("缺失值檢查")
print("=" * 50)
print(df.isnull().sum())

print("\n" + "=" * 50)
print("各類別銷售總覽")
print("=" * 50)
print(df.groupby('category').agg({
    'quantity': 'sum',
    'revenue': 'sum'
}).sort_values('revenue', ascending=False))
```

**執行**：
```bash
python analyze.py
```

**任務 2.2**：用 AI 生成深度分析

```
User: "分析這份銷售資料，提供：
1. 資料品質報告（缺失值、異常值）
2. 銷售趨勢分析
3. 產品與類別表現
4. 地區差異分析
5. 潛在問題與建議

請生成 Python 代碼來完成這些分析。"
```

---

### 階段 3：自動化視覺化（10 分鐘）

**任務 3.1**：生成多種圖表

創建 `visualize.py`：
```python
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import os

# 設定中文字體（如果需要）
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']  # Mac
# plt.rcParams['font.sans-serif'] = ['Microsoft YaHei']  # Windows

# 創建輸出目錄
os.makedirs('charts', exist_ok=True)

# 載入資料
df = pd.read_csv('sales_data.csv')
df['date'] = pd.to_datetime(df['date'])

# 圖表 1：每日營收趨勢
plt.figure(figsize=(10, 6))
daily_revenue = df.groupby('date')['revenue'].sum()
plt.plot(daily_revenue.index, daily_revenue.values, marker='o')
plt.title('Daily Revenue Trend', fontsize=16, fontweight='bold')
plt.xlabel('Date')
plt.ylabel('Revenue ($)')
plt.xticks(rotation=45)
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.savefig('charts/daily_revenue.png', dpi=300)
plt.close()

# 圖表 2：產品類別營收佔比
plt.figure(figsize=(8, 8))
category_revenue = df.groupby('category')['revenue'].sum()
plt.pie(category_revenue.values, labels=category_revenue.index,
        autopct='%1.1f%%', startangle=90)
plt.title('Revenue by Category', fontsize=16, fontweight='bold')
plt.tight_layout()
plt.savefig('charts/category_pie.png', dpi=300)
plt.close()

# 圖表 3：地區銷售對比
plt.figure(figsize=(10, 6))
region_data = df.groupby('region').agg({
    'quantity': 'sum',
    'revenue': 'sum'
})
x = np.arange(len(region_data))
width = 0.35
fig, ax = plt.subplots(figsize=(10, 6))
ax.bar(x - width/2, region_data['quantity'], width, label='Quantity', alpha=0.8)
ax.bar(x + width/2, region_data['revenue']/100, width, label='Revenue (x100)', alpha=0.8)
ax.set_xlabel('Region')
ax.set_ylabel('Value')
ax.set_title('Sales by Region', fontsize=16, fontweight='bold')
ax.set_xticks(x)
ax.set_xticks(region_data.index)
ax.legend()
plt.tight_layout()
plt.savefig('charts/region_comparison.png', dpi=300)
plt.close()

# 圖表 4：產品表現熱圖
plt.figure(figsize=(10, 8))
product_region = df.pivot_table(
    values='revenue',
    index='product',
    columns='region',
    aggfunc='sum',
    fill_value=0
)
sns.heatmap(product_region, annot=True, fmt='.0f', cmap='YlOrRd')
plt.title('Product Performance by Region', fontsize=16, fontweight='bold')
plt.tight_layout()
plt.savefig('charts/product_heatmap.png', dpi=300)
plt.close()

print("✅ 所有圖表已生成到 charts/ 目錄")
```

**任務 3.2**：執行並檢視圖表

```bash
python visualize.py
ls charts/
```

---

### 階段 4：AI 洞察提取（10 分鐘）

**任務 4.1**：用 AI 分析圖表並提取洞察

創建 `generate_insights.py`：
```python
import pandas as pd
from openai import OpenAI
from dotenv import load_dotenv
import os

load_dotenv()
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

# 載入資料並計算關鍵指標
df = pd.read_csv('sales_data.csv')
df['date'] = pd.to_datetime(df['date'])

# 彙整關鍵數據
summary = {
    "total_revenue": df['revenue'].sum(),
    "total_quantity": df['quantity'].sum(),
    "avg_daily_revenue": df.groupby('date')['revenue'].sum().mean(),
    "top_category": df.groupby('category')['revenue'].sum().idxmax(),
    "top_region": df.groupby('region')['revenue'].sum().idxmax(),
    "best_product": df.groupby('product')['revenue'].sum().idxmax(),
    "revenue_by_category": df.groupby('category')['revenue'].sum().to_dict(),
    "revenue_by_region": df.groupby('region')['revenue'].sum().to_dict(),
}

# 構建提示詞
prompt = f"""
Based on the following sales data summary, provide a comprehensive analysis:

Data Summary:
- Total Revenue: ${summary['total_revenue']:,.2f}
- Total Units Sold: {summary['total_quantity']}
- Average Daily Revenue: ${summary['avg_daily_revenue']:,.2f}
- Top Category: {summary['top_category']}
- Top Region: {summary['top_region']}
- Best Selling Product: {summary['best_product']}

Revenue by Category:
{summary['revenue_by_category']}

Revenue by Region:
{summary['revenue_by_region']}

Please provide:
1. Key Trends (3-4 points)
2. Notable Insights (3-4 points)
3. Potential Issues or Concerns (2-3 points)
4. Actionable Recommendations (3-4 points)

Format the response in clear Markdown format with headers and bullet points.
"""

# 調用 AI 生成洞察
response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {"role": "system", "content": "You are a data analyst providing business insights."},
        {"role": "user", "content": prompt}
    ],
    temperature=0.7
)

insights = response.choices[0].message.content

print("=" * 50)
print("AI 生成的洞察")
print("=" * 50)
print(insights)

# 儲存洞察到檔案
with open('insights.md', 'w') as f:
    f.write(insights)

print("\n✅ 洞察已儲存到 insights.md")
```

**任務 4.2**：執行並查看洞察

```bash
python generate_insights.py
cat insights.md
```

---

### 階段 5：生成完整報告（10 分鐘）

**任務 5.1**：整合所有元素

創建 `generate_report.py`：
```python
import pandas as pd
from datetime import datetime
import os

def generate_report():
    # 載入資料
    df = pd.read_csv('sales_data.csv')
    df['date'] = pd.to_datetime(df['date'])

    # 載入 AI 洞察
    with open('insights.md', 'r') as f:
        insights = f.read()

    # 生成報告
    report = f"""# 銷售分析報告

**生成時間**：{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

**分析期間**：{df['date'].min().strftime('%Y-%m-%d')} 至 {df['date'].max().strftime('%Y-%m-%d')}

---

## 執行摘要

本報告分析了 {len(df)} 筆銷售交易資料，涵蓋 {df['date'].nunique()} 天的銷售記錄。

**關鍵指標**：
- **總營收**：${df['revenue'].sum():,.2f}
- **總銷售數量**：{df['quantity'].sum()} 件
- **平均每日營收**：${df.groupby('date')['revenue'].sum().mean():,.2f}
- **交易數量**：{len(df)} 筆

---

## 資料概覽

### 基本統計

| 指標 | 數值 |
|------|------|
| 總營收 | ${df['revenue'].sum():,.2f} |
| 總銷售量 | {df['quantity'].sum()} |
| 平均單價 | ${df['revenue'].mean():,.2f} |
| 產品種類 | {df['product'].nunique()} |
| 銷售地區 | {df['region'].nunique()} |

### 類別表現

"""

    # 類別表現表格
    category_stats = df.groupby('category').agg({
        'quantity': 'sum',
        'revenue': 'sum'
    }).sort_values('revenue', ascending=False)

    report += "\n| 類別 | 銷售量 | 營收 | 佔比 |\n"
    report += "|------|--------|------|------|\n"
    for cat, row in category_stats.iterrows():
        pct = (row['revenue'] / df['revenue'].sum()) * 100
        report += f"| {cat} | {row['quantity']} | ${row['revenue']:,.2f} | {pct:.1f}% |\n"

    report += "\n### 地區表現\n\n"

    # 地區表現表格
    region_stats = df.groupby('region').agg({
        'quantity': 'sum',
        'revenue': 'sum'
    }).sort_values('revenue', ascending=False)

    report += "\n| 地區 | 銷售量 | 營收 | 佔比 |\n"
    report += "|------|--------|------|------|\n"
    for reg, row in region_stats.iterrows():
        pct = (row['revenue'] / df['revenue'].sum()) * 100
        report += f"| {reg} | {row['quantity']} | ${row['revenue']:,.2f} | {pct:.1f}% |\n"

    report += "\n---\n\n## 視覺化分析\n\n"

    # 加入圖表
    charts = [
        ('daily_revenue.png', '每日營收趨勢'),
        ('category_pie.png', '類別營收佔比'),
        ('region_comparison.png', '地區銷售對比'),
        ('product_heatmap.png', '產品地區表現熱圖')
    ]

    for chart, title in charts:
        if os.path.exists(f'charts/{chart}'):
            report += f"### {title}\n\n"
            report += f"![{title}](charts/{chart})\n\n"

    report += "---\n\n## AI 洞察與建議\n\n"
    report += insights

    report += "\n\n---\n\n## 附錄\n\n"
    report += "### 資料來源\n"
    report += f"- 檔案：sales_data.csv\n"
    report += f"- 記錄數：{len(df)}\n"
    report += f"- 分析日期：{datetime.now().strftime('%Y-%m-%d')}\n"

    # 儲存報告
    with open('sales_report.md', 'w') as f:
        f.write(report)

    print("=" * 50)
    print("報告生成成功！")
    print("=" * 50)
    print(f"報告位置：sales_report.md")
    print(f"圖表目錄：charts/")
    print(f"AI 洞察：insights.md")

if __name__ == "__main__":
    generate_report()
```

**任務 5.2**：生成完整報告

```bash
python generate_report.py
```

**任務 5.3**：查看報告

```bash
# 在 Markdown 編輯器中打開
code sales_report.md

# 或轉換為 PDF（可選）
pip install markdown-pdf
markdown-pdf sales_report.md
```

---

## ✅ 檢查點

### 檢查點 1：基礎功能完成

- [ ] 成功載入並分析資料
- [ ] 生成至少 3 種視覺化圖表
- [ ] AI 成功提取關鍵洞察
- [ ] 生成結構化 Markdown 報告

### 檢查點 2：報告品質

- [ ] 報告包含基本統計資訊
- [ ] 圖表清晰且有意義
- [ ] AI 洞察合理且可執行
- [ ] 報告格式專業美觀

### 檢查點 3：自動化程度

- [ ] 一鍵執行即可生成完整報告
- [ ] 無需手動調整或編輯
- [ ] 可處理不同的輸入資料
- [ ] 錯誤處理完善

---

## 💡 優化建議

### 優化 1：整合為單一腳本

創建 `auto_report.py`：
```python
import subprocess
import sys

def run_command(cmd, description):
    print(f"\n{'='*50}")
    print(f"{description}")
    print(f"{'='*50}")
    result = subprocess.run(cmd, shell=True)
    if result.returncode != 0:
        print(f"❌ 執行失敗：{description}")
        sys.exit(1)
    print(f"✅ 完成：{description}")

if __name__ == "__main__":
    print("🚀 開始生成自動化報告...")

    run_command("python analyze.py", "步驟 1/4: 資料探索")
    run_command("python visualize.py", "步驟 2/4: 生成圖表")
    run_command("python generate_insights.py", "步驟 3/4: AI 洞察提取")
    run_command("python generate_report.py", "步驟 4/4: 生成完整報告")

    print("\n" + "="*50)
    print("🎉 報告生成完成！")
    print("="*50)
    print("請查看：sales_report.md")
```

**使用**：
```bash
python auto_report.py
```

---

### 優化 2：支援多種資料格式

```python
def load_data(file_path):
    """自動識別並載入資料"""
    if file_path.endswith('.csv'):
        return pd.read_csv(file_path)
    elif file_path.endswith('.xlsx'):
        return pd.read_excel(file_path)
    elif file_path.endswith('.json'):
        return pd.read_json(file_path)
    else:
        raise ValueError(f"不支援的格式：{file_path}")

# 使用
df = load_data('sales_data.csv')  # 或 .xlsx, .json
```

---

### 優化 3：增加異常偵測

```python
def detect_anomalies(df):
    """偵測異常值"""
    # 使用 IQR 方法
    Q1 = df['revenue'].quantile(0.25)
    Q3 = df['revenue'].quantile(0.75)
    IQR = Q3 - Q1

    lower_bound = Q1 - 1.5 * IQR
    upper_bound = Q3 + 1.5 * IQR

    anomalies = df[(df['revenue'] < lower_bound) | (df['revenue'] > upper_bound)]

    if len(anomalies) > 0:
        print(f"⚠️  偵測到 {len(anomalies)} 筆異常交易：")
        print(anomalies[['date', 'product', 'revenue']])
    return anomalies
```

---

### 優化 4：設定自動化排程

**方法 A：使用 Cron (Linux/Mac)**

```bash
# 編輯 crontab
crontab -e

# 每週五下午 3 點執行
0 15 * * 5 cd /path/to/auto-report && python auto_report.py
```

**方法 B：使用 Windows 工作排程器**

```powershell
# 創建排程任務
schtasks /create /tn "WeeklySalesReport" /tr "python C:\path\to\auto_report.py" /sc weekly /d FRI /st 15:00
```

**方法 C：使用 Python schedule 套件**

```python
import schedule
import time

def job():
    print("開始生成週報...")
    subprocess.run("python auto_report.py", shell=True)

# 每週五 15:00 執行
schedule.every().friday.at("15:00").do(job)

while True:
    schedule.run_pending()
    time.sleep(60)
```

---

## 🎯 擴展挑戰

### 挑戰 1：多期對比

比較本週與上週的數據：
```python
this_week = df[df['date'] >= '2024-01-01']
last_week = df[df['date'] < '2024-01-01']

comparison = pd.DataFrame({
    'This Week': [
        this_week['revenue'].sum(),
        this_week['quantity'].sum()
    ],
    'Last Week': [
        last_week['revenue'].sum(),
        last_week['quantity'].sum()
    ],
    'Change %': [
        ((this_week['revenue'].sum() - last_week['revenue'].sum())
         / last_week['revenue'].sum() * 100),
        ((this_week['quantity'].sum() - last_week['quantity'].sum())
         / last_week['quantity'].sum() * 100)
    ]
}, index=['Revenue', 'Quantity'])
```

### 挑戰 2：預測下週銷售

使用簡單線性迴歸：
```python
from sklearn.linear_model import LinearRegression

# 準備資料
daily_sales = df.groupby('date')['revenue'].sum().reset_index()
daily_sales['day_num'] = range(len(daily_sales))

X = daily_sales[['day_num']]
y = daily_sales['revenue']

# 訓練模型
model = LinearRegression()
model.fit(X, y)

# 預測下週（假設 7 天後）
next_days = [[len(daily_sales) + i] for i in range(1, 8)]
predictions = model.predict(next_days)

print("下週預測營收：")
for i, pred in enumerate(predictions, 1):
    print(f"  Day {i}: ${pred:,.2f}")
```

### 挑戰 3：郵件自動發送

使用 `smtplib` 發送報告：
```python
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage

def send_report(to_email):
    msg = MIMEMultipart()
    msg['From'] = 'your_email@example.com'
    msg['To'] = to_email
    msg['Subject'] = f'週報 - {datetime.now().strftime("%Y-%m-%d")}'

    # 讀取報告內容
    with open('sales_report.md', 'r') as f:
        body = f.read()

    msg.attach(MIMEText(body, 'plain'))

    # 附加圖表（可選）
    for chart in os.listdir('charts'):
        with open(f'charts/{chart}', 'rb') as f:
            img = MIMEImage(f.read())
            img.add_header('Content-ID', f'<{chart}>')
            msg.attach(img)

    # 發送
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.starttls()
    server.login('your_email@example.com', 'your_password')
    server.send_message(msg)
    server.quit()
```

### 挑戰 4：互動式儀表板

使用 Streamlit：
```python
import streamlit as st

st.title("銷售分析儀表板")

# 上傳檔案
uploaded_file = st.file_uploader("上傳 CSV", type=['csv'])

if uploaded_file:
    df = pd.read_csv(uploaded_file)

    # 顯示基本統計
    st.metric("總營收", f"${df['revenue'].sum():,.2f}")
    st.metric("總銷售量", df['quantity'].sum())

    # 互動式圖表
    chart_type = st.selectbox("選擇圖表",
                              ["每日趨勢", "類別分佈", "地區對比"])

    if chart_type == "每日趨勢":
        st.line_chart(df.groupby('date')['revenue'].sum())
```

---

## 📚 總結

完成本題後，你應該：

**掌握的技能**：
- ✅ 自動化資料探索與分析
- ✅ 批次生成多種視覺化圖表
- ✅ 用 AI 提取業務洞察
- ✅ 生成結構化分析報告

**理解的概念**：
- ✅ EDA（探索性資料分析）的流程
- ✅ 資料視覺化的最佳實踐
- ✅ AI 在資料分析中的應用場景
- ✅ 報告自動化的價值

**建立的認知**：
- ✅ 自動化可以節省 90% 以上的時間
- ✅ AI 適合處理重複性分析任務
- ✅ 標準化流程是自動化的前提
- ✅ 報告格式化比內容生成更簡單

---

**下一步**：
- 挑戰組合級 C03：銷售數據儀表板（更完整的實作）
- 或嘗試將本系統應用到你的真實工作場景

**記住**：
> 自動化的關鍵是標準化流程。
> AI 擅長處理重複性任務。
> 從簡單報告開始，逐步擴展功能。
> 2 小時 → 2 分鐘，這不是夢想。
