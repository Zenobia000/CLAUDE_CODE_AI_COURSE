# 8.3 資料分析自動化 - AI 驅動的資料洞察

## 📋 章節概述

**學習時長**：10 分鐘
**難度**：⭐⭐ 基礎至中級
**前置知識**：Python 基礎、資料分析概念

本章教你：
- ✅ 用 AI 自動化探索性資料分析（EDA）
- ✅ 自動生成資料視覺化
- ✅ 自動產出分析報告
- ✅ 選擇合適的 AI Agent 進行資料分析

---

## 🎯 資料分析常見任務

### 典型工作流程

```
1. 探索性資料分析（EDA）
   ├─ 載入資料
   ├─ 檢視基本資訊（形狀、型別、統計摘要）
   ├─ 檢查資料品質（空值、異常值、重複值）
   └─ 理解資料分佈與關聯性

2. 資料視覺化
   ├─ 分佈圖（直方圖、箱型圖）
   ├─ 關聯性圖（散佈圖、相關矩陣）
   ├─ 時序圖（折線圖、趨勢圖）
   └─ 類別分析（長條圖、圓餅圖）

3. 洞察提取
   ├─ 識別趨勢
   ├─ 發現異常
   ├─ 比較分組
   └─ 產生報告

4. 自動化報告
   ├─ 整理發現
   ├─ 附加圖表
   ├─ 提出建議
   └─ 輸出文檔
```

### Linux 類比

```
資料分析 = Linux 系統監控

探索資料：
df -h        →  查看資料大小（df.info()）
top          →  查看資源使用（df.describe()）
ps aux       →  查看行程狀態（df.head()）

視覺化：
htop         →  圖形化監控（Matplotlib/Seaborn）
sar          →  歷史趨勢圖（時序分析）

報告：
grep + awk   →  提取關鍵資訊（資料洞察）
> report.txt →  輸出報告（自動生成文檔）
```

---

## 🤖 AI 輔助資料分析工作流程

### 傳統方式 vs AI 輔助

```
任務                  傳統方式              AI 輔助
──────────────────────────────────────────────────────
探索性分析           手寫 30 行代碼        AI 生成完整 EDA
                    (30 分鐘)            (3 分鐘)

資料視覺化           查文檔找範例          AI 生成客製化圖表
                    調整參數              自動選擇最佳圖表類型
                    (20 分鐘)            (2 分鐘)

洞察提取             手動檢視所有圖表      AI 自動識別異常與趨勢
                    記錄發現              生成洞察摘要
                    (40 分鐘)            (5 分鐘)

報告生成             Word/PowerPoint       AI 自動生成 Markdown
                    複製貼上圖表          附帶圖表與解釋
                    (60 分鐘)            (5 分鐘)
```

---

## 🚀 完整範例：銷售數據分析自動化

### 情境描述

**需求**：
- 每週都有新的銷售數據 CSV
- 需要生成週報：銷售趨勢、產品分析、地區比較
- 目前手動分析需要 2 小時

**目標**：
- 用 AI 自動化整個流程
- 5 分鐘生成完整報告

### 完整實現代碼

**`auto_analysis.py`**：
```python
#!/usr/bin/env python3
"""
Automated Sales Data Analysis System

Automatically perform EDA, create visualizations, and generate reports.
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from pathlib import Path
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# Set plotting style
sns.set_style("whitegrid")
plt.rcParams['figure.figsize'] = (12, 6)
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']  # 支援中文


# ===== 1. Exploratory Data Analysis =====
class AutoEDA:
    """Automated Exploratory Data Analysis"""

    def __init__(self, df: pd.DataFrame, output_dir: str = "output"):
        self.df = df
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        self.report = []

    def add_section(self, title: str, content: str):
        """Add section to report"""
        self.report.append(f"\n## {title}\n")
        self.report.append(content + "\n")

    def basic_info(self):
        """Generate basic information"""
        self.add_section("基本資訊", f"""
- 資料筆數：{len(self.df):,} 筆
- 欄位數量：{len(self.df.columns)} 個
- 記憶體使用：{self.df.memory_usage(deep=True).sum() / 1024**2:.2f} MB
- 資料期間：{self.df['date'].min()} 至 {self.df['date'].max()}
        """)

    def data_quality(self):
        """Check data quality"""
        missing = self.df.isnull().sum()
        missing_pct = (missing / len(self.df) * 100).round(2)

        quality_report = "### 資料品質檢查\n\n"

        # Missing values
        if missing.sum() == 0:
            quality_report += "✅ 無空值\n\n"
        else:
            quality_report += "⚠️ 空值統計：\n\n"
            for col, count in missing[missing > 0].items():
                quality_report += f"- {col}: {count} ({missing_pct[col]}%)\n"
            quality_report += "\n"

        # Duplicates
        dup_count = self.df.duplicated().sum()
        if dup_count == 0:
            quality_report += "✅ 無重複記錄\n\n"
        else:
            quality_report += f"⚠️ 發現 {dup_count} 筆重複記錄\n\n"

        self.add_section("資料品質", quality_report)

    def statistical_summary(self):
        """Generate statistical summary"""
        desc = self.df.describe()

        summary = "### 統計摘要\n\n"
        summary += desc.to_markdown() + "\n"

        self.add_section("統計分析", summary)

    def run_eda(self):
        """Run complete EDA"""
        print("📊 Running Exploratory Data Analysis...")

        self.basic_info()
        self.data_quality()
        self.statistical_summary()

        print("✅ EDA completed")


# ===== 2. Automated Visualization =====
class AutoVisualization:
    """Automated Data Visualization"""

    def __init__(self, df: pd.DataFrame, output_dir: str = "output"):
        self.df = df
        self.output_dir = Path(output_dir)
        self.charts = []

    def sales_trend(self):
        """Sales trend over time"""
        print("📈 Generating sales trend chart...")

        plt.figure(figsize=(14, 6))

        # Daily sales
        daily_sales = self.df.groupby('date')['amount'].sum()
        plt.plot(daily_sales.index, daily_sales.values, marker='o', linewidth=2)

        plt.title('銷售趨勢圖', fontsize=16, fontweight='bold')
        plt.xlabel('日期', fontsize=12)
        plt.ylabel('銷售額 ($)', fontsize=12)
        plt.grid(True, alpha=0.3)
        plt.xticks(rotation=45)
        plt.tight_layout()

        chart_path = self.output_dir / "sales_trend.png"
        plt.savefig(chart_path, dpi=300, bbox_inches='tight')
        plt.close()

        self.charts.append(("銷售趨勢圖", str(chart_path)))
        print(f"✅ Saved to {chart_path}")

    def product_analysis(self):
        """Product sales analysis"""
        print("📊 Generating product analysis chart...")

        fig, axes = plt.subplots(1, 2, figsize=(16, 6))

        # Top products by revenue
        product_revenue = self.df.groupby('product')['amount'].sum().sort_values(ascending=False).head(10)

        axes[0].barh(product_revenue.index, product_revenue.values, color='skyblue')
        axes[0].set_title('前 10 名產品銷售額', fontsize=14, fontweight='bold')
        axes[0].set_xlabel('銷售額 ($)', fontsize=12)
        axes[0].grid(True, alpha=0.3, axis='x')

        # Sales quantity by product
        product_quantity = self.df['product'].value_counts().head(10)

        axes[1].barh(product_quantity.index, product_quantity.values, color='lightcoral')
        axes[1].set_title('前 10 名產品銷售數量', fontsize=14, fontweight='bold')
        axes[1].set_xlabel('銷售筆數', fontsize=12)
        axes[1].grid(True, alpha=0.3, axis='x')

        plt.tight_layout()

        chart_path = self.output_dir / "product_analysis.png"
        plt.savefig(chart_path, dpi=300, bbox_inches='tight')
        plt.close()

        self.charts.append(("產品分析", str(chart_path)))
        print(f"✅ Saved to {chart_path}")

    def regional_comparison(self):
        """Regional sales comparison"""
        print("🗺️  Generating regional comparison chart...")

        plt.figure(figsize=(12, 6))

        region_sales = self.df.groupby('region')['amount'].sum().sort_values(ascending=False)

        colors = sns.color_palette("husl", len(region_sales))
        plt.bar(region_sales.index, region_sales.values, color=colors)

        plt.title('地區銷售比較', fontsize=16, fontweight='bold')
        plt.xlabel('地區', fontsize=12)
        plt.ylabel('銷售額 ($)', fontsize=12)
        plt.xticks(rotation=45, ha='right')
        plt.grid(True, alpha=0.3, axis='y')
        plt.tight_layout()

        chart_path = self.output_dir / "regional_comparison.png"
        plt.savefig(chart_path, dpi=300, bbox_inches='tight')
        plt.close()

        self.charts.append(("地區比較", str(chart_path)))
        print(f"✅ Saved to {chart_path}")

    def generate_all(self):
        """Generate all visualizations"""
        print("🎨 Generating visualizations...")

        self.sales_trend()
        self.product_analysis()
        self.regional_comparison()

        print(f"✅ Generated {len(self.charts)} charts")
        return self.charts


# ===== 3. Insight Extraction =====
class InsightExtractor:
    """Extract insights from data"""

    def __init__(self, df: pd.DataFrame):
        self.df = df
        self.insights = []

    def trend_analysis(self):
        """Analyze trends"""
        daily_sales = self.df.groupby('date')['amount'].sum()

        # Calculate growth
        first_week = daily_sales.iloc[:7].mean()
        last_week = daily_sales.iloc[-7:].mean()
        growth_rate = ((last_week - first_week) / first_week * 100)

        if growth_rate > 10:
            insight = f"📈 **銷售成長強勁**：相比首週，最近一週銷售額成長 {growth_rate:.1f}%"
        elif growth_rate < -10:
            insight = f"📉 **銷售下滑警示**：相比首週，最近一週銷售額下降 {abs(growth_rate):.1f}%"
        else:
            insight = f"➡️ **銷售穩定**：相比首週，最近一週銷售額變化 {growth_rate:+.1f}%"

        self.insights.append(insight)

    def top_performers(self):
        """Identify top performing products"""
        top_product = self.df.groupby('product')['amount'].sum().idxmax()
        top_revenue = self.df.groupby('product')['amount'].sum().max()

        insight = f"🏆 **明星產品**：{top_product} 是銷售冠軍，創造 ${top_revenue:,.0f} 營收"
        self.insights.append(insight)

    def regional_insights(self):
        """Regional performance insights"""
        region_revenue = self.df.groupby('region')['amount'].sum().sort_values(ascending=False)

        top_region = region_revenue.index[0]
        top_region_pct = (region_revenue.iloc[0] / region_revenue.sum() * 100)

        insight = f"🗺️  **地區優勢**：{top_region} 貢獻 {top_region_pct:.1f}% 的總營收"
        self.insights.append(insight)

    def anomaly_detection(self):
        """Detect anomalies"""
        # Detect outliers using IQR method
        Q1 = self.df['amount'].quantile(0.25)
        Q3 = self.df['amount'].quantile(0.75)
        IQR = Q3 - Q1

        outliers = self.df[(self.df['amount'] < Q1 - 1.5 * IQR) |
                            (self.df['amount'] > Q3 + 1.5 * IQR)]

        if len(outliers) > 0:
            insight = f"⚠️ **異常交易**：發現 {len(outliers)} 筆異常金額交易，需進一步調查"
            self.insights.append(insight)

    def extract_all(self):
        """Extract all insights"""
        print("💡 Extracting insights...")

        self.trend_analysis()
        self.top_performers()
        self.regional_insights()
        self.anomaly_detection()

        print(f"✅ Extracted {len(self.insights)} insights")
        return self.insights


# ===== 4. Report Generation =====
class ReportGenerator:
    """Automated report generation"""

    def __init__(self, output_path: str = "output/report.md"):
        self.output_path = Path(output_path)
        self.output_path.parent.mkdir(exist_ok=True)
        self.content = []

    def add_header(self):
        """Add report header"""
        date_str = datetime.now().strftime("%Y-%m-%d %H:%M")

        header = f"""# 銷售數據分析報告

**生成時間**：{date_str}
**分析系統**：AI 驅動自動化分析

---

"""
        self.content.append(header)

    def add_eda_section(self, eda_report: list):
        """Add EDA section"""
        self.content.extend(eda_report)

    def add_charts_section(self, charts: list):
        """Add charts section"""
        self.content.append("\n## 視覺化分析\n\n")

        for title, path in charts:
            self.content.append(f"### {title}\n\n")
            self.content.append(f"![{title}]({path})\n\n")

    def add_insights_section(self, insights: list):
        """Add insights section"""
        self.content.append("\n## 關鍵洞察\n\n")

        for insight in insights:
            self.content.append(f"{insight}\n\n")

    def add_recommendations(self):
        """Add recommendations"""
        recommendations = """
## 行動建議

基於以上分析，建議採取以下行動：

1. **優化產品組合**
   - 加強明星產品的庫存與行銷
   - 評估低績效產品是否下架

2. **地區策略調整**
   - 在高績效地區增加資源投入
   - 分析低績效地區的原因，調整策略

3. **異常監控**
   - 建立即時異常監控機制
   - 調查異常交易的原因

4. **持續優化**
   - 每週自動生成此報告
   - 追蹤趨勢變化，及時調整

---

**報告結束**
"""
        self.content.append(recommendations)

    def generate(self, eda_report, charts, insights):
        """Generate complete report"""
        print("📝 Generating report...")

        self.add_header()
        self.add_eda_section(eda_report)
        self.add_charts_section(charts)
        self.add_insights_section(insights)
        self.add_recommendations()

        # Write to file
        with open(self.output_path, 'w', encoding='utf-8') as f:
            f.writelines(self.content)

        print(f"✅ Report saved to {self.output_path}")


# ===== Main Pipeline =====
def run_auto_analysis(csv_path: str, output_dir: str = "output"):
    """Run complete automated analysis pipeline"""
    print("=" * 60)
    print("Automated Sales Data Analysis System")
    print("=" * 60)

    # Load data
    print(f"\n📂 Loading data from {csv_path}...")
    df = pd.read_csv(csv_path)
    df['date'] = pd.to_datetime(df['date'])
    print(f"✅ Loaded {len(df):,} records")

    # Run EDA
    eda = AutoEDA(df, output_dir)
    eda.run_eda()

    # Generate visualizations
    viz = AutoVisualization(df, output_dir)
    charts = viz.generate_all()

    # Extract insights
    insights = InsightExtractor(df)
    insights_list = insights.extract_all()

    # Generate report
    report = ReportGenerator(f"{output_dir}/sales_analysis_report.md")
    report.generate(eda.report, charts, insights_list)

    print("\n" + "=" * 60)
    print("✅ Analysis completed successfully!")
    print("=" * 60)
    print(f"\n📁 Output files:")
    print(f"  - Report: {output_dir}/sales_analysis_report.md")
    print(f"  - Charts: {output_dir}/*.png")


# ===== CLI =====
if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser(description='Automated Sales Data Analysis')
    parser.add_argument('--input', required=True, help='Input CSV file')
    parser.add_argument('--output', default='output', help='Output directory')

    args = parser.parse_args()

    run_auto_analysis(args.input, args.output)
```

### 使用方式

**執行自動化分析**：
```bash
python auto_analysis.py --input sales_data.csv --output output
```

**輸出**：
```
============================================================
Automated Sales Data Analysis System
============================================================

📂 Loading data from sales_data.csv...
✅ Loaded 1,234 records
📊 Running Exploratory Data Analysis...
✅ EDA completed
🎨 Generating visualizations...
📈 Generating sales trend chart...
✅ Saved to output/sales_trend.png
📊 Generating product analysis chart...
✅ Saved to output/product_analysis.png
🗺️  Generating regional comparison chart...
✅ Saved to output/regional_comparison.png
✅ Generated 3 charts
💡 Extracting insights...
✅ Extracted 4 insights
📝 Generating report...
✅ Report saved to output/sales_analysis_report.md

============================================================
✅ Analysis completed successfully!
============================================================

📁 Output files:
  - Report: output/sales_analysis_report.md
  - Charts: output/*.png
```

---

## 🔧 AI Agent 選擇

### 推薦 Agent

**場景：資料分析任務**
```bash
# 切換到資料分析師 Agent
/agents:data-analyst

# 描述需求
我有一個銷售數據 CSV，請幫我：
1. 進行探索性資料分析
2. 生成視覺化圖表
3. 提取關鍵洞察
4. 自動產出分析報告
```

**為什麼選 data-analyst Agent？**
- ✅ 專業的資料分析知識
- ✅ 自動選擇合適的視覺化類型
- ✅ 識別資料中的模式與異常
- ✅ 生成專業的分析報告

---

## 📊 進階：自動化排程

### 設定每週自動分析

**Cron Job 設定**：
```bash
# 編輯 crontab
crontab -e

# 每週一早上 8 點執行分析
0 8 * * 1 /usr/bin/python3 /path/to/auto_analysis.py --input /data/weekly_sales.csv --output /reports/$(date +\%Y-\%m-\%d)
```

### 郵件通知

**加入郵件發送**：
```python
def send_email_report(report_path: str, recipients: list):
    """Send report via email"""
    import smtplib
    from email.mime.multipart import MIMEMultipart
    from email.mime.text import MIMEText
    from email.mime.base import MIMEBase
    from email import encoders

    # Email configuration
    sender = "analytics@company.com"
    password = os.getenv("EMAIL_PASSWORD")

    # Create message
    msg = MIMEMultipart()
    msg['From'] = sender
    msg['To'] = ", ".join(recipients)
    msg['Subject'] = f"週報：銷售數據分析 - {datetime.now().strftime('%Y-%m-%d')}"

    # Attach report
    with open(report_path, 'r', encoding='utf-8') as f:
        body = f.read()
    msg.attach(MIMEText(body, 'plain', 'utf-8'))

    # Send email
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.starttls()
    server.login(sender, password)
    server.send_message(msg)
    server.quit()

    print(f"✅ Report sent to {len(recipients)} recipients")
```

---

## 🎯 實戰練習

### 練習 1：生成你的第一份自動化報告

**任務**：
```
1. 準備測試資料（或使用範例 CSV）
2. 執行自動化分析腳本
3. 檢視生成的報告與圖表
4. 評估洞察的準確性
```

### 練習 2：客製化分析邏輯

**任務**：
```
擴展分析系統，加入：
- 季節性分析（月份比較）
- 客戶分群（RFM 分析）
- 預測趨勢（簡單線性回歸）
```

---

## 📚 延伸閱讀

**資料分析工具**：
- [Pandas Profiling](https://github.com/pandas-profiling/pandas-profiling) - 一鍵生成 EDA 報告
- [Sweetviz](https://github.com/fbdesignpro/sweetviz) - 美觀的 EDA 視覺化
- [Plotly](https://plotly.com/python/) - 互動式圖表

**自動化報告**：
- [Jupyter Book](https://jupyterbook.org/) - 將 Notebook 轉換成書籍
- [Papermill](https://papermill.readthedocs.io/) - 參數化執行 Notebook

---

## 🎯 學習檢查點

完成本章後，你應該能夠：

- [ ] 用 AI 生成探索性資料分析代碼
- [ ] 自動生成資料視覺化圖表
- [ ] 從資料中自動提取洞察
- [ ] 產出完整的自動化分析報告
- [ ] 設定定時自動化分析任務

---

**章節版本**：v1.0
**最後更新**：2025-10-30
**預計學習時長**：10 分鐘（理論）+ 20 分鐘（實作）
