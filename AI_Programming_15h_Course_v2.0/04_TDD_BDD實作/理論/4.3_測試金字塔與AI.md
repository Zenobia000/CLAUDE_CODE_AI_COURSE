# 4.3 測試金字塔與 AI

## 📋 內容概述

本章探討測試金字塔理論，以及如何在不同測試層級運用 AI 輔助測試策略。

**閱讀時間**：15 分鐘

---

## 🎯 學習目標

- 理解測試金字塔的三個層級
- 掌握不同層級的測試分配比例
- 學習 AI 在各層級的應用策略
- 能為專案設計完整的測試策略

---

## 第一部分：測試金字塔理論

### 經典測試金字塔

```
         ╱╲
        ╱  ╲
       ╱ E2E ╲        E2E Tests (End-to-End)
      ╱  10%  ╲       - 執行最慢（秒級-分鐘級）
     ╱────────╲       - 成本最高（維護困難）
    ╱          ╲      - 價值高（使用者視角）
   ╱   Integration  ╲
  ╱       20%       ╲  Integration Tests
 ╱──────────────────╲  - 執行中等（秒級）
╱                    ╲ - 成本中等
        Unit               - 價值中等
        70%
                           Unit Tests
                           - 執行最快（毫秒級）
                           - 成本最低（易維護）
                           - 價值高（快速反饋）
```

### 為什麼是金字塔形狀？

**原則 1：速度與成本的權衡**
```
單元測試：
- 執行時間：1-10ms
- 維護成本：低
- 數量：可以有上千個
- 總執行時間：幾秒

E2E 測試：
- 執行時間：10-60 秒
- 維護成本：高（UI 變動、環境依賴）
- 數量：只能有幾十個
- 總執行時間：幾分鐘到幾十分鐘
```

**原則 2：反饋速度的重要性**
```
開發者寫程式碼 → 2 分鐘後得到反饋
    ✓ 可接受：立即修正

開發者寫程式碼 → 30 分鐘後得到反饋
    ✗ 不可接受：可能已經寫了其他程式碼
    開發者上下文切換成本高
```

**原則 3：測試的信心層級**
```
單元測試：高信心於「個別元件正確」
整合測試：高信心於「元件協作正確」
E2E 測試：高信心於「整體流程正確」

需要三個層級互補，才能全面覆蓋
```

---

## 第二部分：三個層級詳解

### Level 1：Unit Tests（單元測試）

**定義**：測試單一函數、方法或類別的行為

**特點**：
- ✅ 執行快（毫秒級）
- ✅ 隔離性好（不依賴外部系統）
- ✅ 易於維護
- ✅ 失敗時容易定位問題
- ❌ 無法驗證系統整體行為

**適合測試什麼**：
- 業務邏輯
- 資料轉換
- 驗證規則
- 演算法
- 工具函數

**範例**：
```python
# 單元測試：測試價格計算邏輯
def test_calculate_price_with_vip_discount():
    calculator = PriceCalculator()

    price = calculator.calculate_price(
        original_price=1000,
        customer_type='VIP',
        quantity=5
    )

    # VIP 折扣 15%
    assert price == 850

def test_calculate_price_bulk_discount():
    calculator = PriceCalculator()

    price = calculator.calculate_price(
        original_price=100,
        customer_type='REGULAR',
        quantity=10  # 超過 10 件，享 5% 折扣
    )

    assert price == 95
```

**AI 輔助策略**：
```
1. 用 AI 生成測試骨架
2. AI 建議邊界情況
3. AI 協助產生測試資料
4. AI 幫助重構測試程式碼
```

---

### Level 2：Integration Tests（整合測試）

**定義**：測試多個元件之間的互動和協作

**特點**：
- ✓ 驗證元件間的協作
- ✓ 可以發現介面問題
- ⚠️ 執行較慢（秒級）
- ⚠️ 可能依賴外部資源（資料庫、API）
- ❌ 失敗時定位問題較困難

**適合測試什麼**：
- Service 層與 Repository 層的互動
- API 端點的完整流程
- 資料庫操作
- 第三方服務整合
- 訊息佇列

**範例**：
```python
# 整合測試：測試訂單服務與資料庫的互動
def test_create_order_saves_to_database():
    # Arrange
    order_service = OrderService(database=test_db)
    user = User(id=1, email="test@example.com")
    cart = Cart(items=[
        CartItem(product_id=1, quantity=2)
    ])

    # Act
    order = order_service.create_order(user, cart)

    # Assert
    saved_order = test_db.orders.find_by_id(order.id)
    assert saved_order is not None
    assert saved_order.user_id == user.id
    assert len(saved_order.items) == 1
    assert saved_order.status == 'pending'

def test_create_order_sends_confirmation_email():
    # Arrange
    email_service = MockEmailService()
    order_service = OrderService(
        database=test_db,
        email_service=email_service
    )

    # Act
    order = order_service.create_order(user, cart)

    # Assert
    assert email_service.sent_emails_count == 1
    sent_email = email_service.sent_emails[0]
    assert sent_email.to == user.email
    assert "Order Confirmation" in sent_email.subject
```

**AI 輔助策略**：
```
1. AI 幫助設計測試資料
2. AI 生成 mock/stub 物件
3. AI 建議測試場景
4. AI 協助清理測試環境
```

---

### Level 3：E2E Tests（端對端測試）

**定義**：從使用者視角測試完整的業務流程

**特點**：
- ✓ 最接近真實使用情境
- ✓ 驗證整個系統的行為
- ✓ 可以發現跨系統的問題
- ❌ 執行最慢（分鐘級）
- ❌ 最難維護（UI 變動、環境不穩定）
- ❌ 失敗時定位問題最困難

**適合測試什麼**：
- 關鍵使用者流程
- 跨系統的業務流程
- 支付、認證等核心功能
- 重要的整合點

**範例**：
```python
# E2E 測試：測試完整的購物流程（使用 Playwright）
def test_user_can_complete_purchase_flow(browser):
    page = browser.new_page()

    # Step 1: 用戶登入
    page.goto('https://example.com/login')
    page.fill('input[name="email"]', 'test@example.com')
    page.fill('input[name="password"]', 'password123')
    page.click('button[type="submit"]')

    # Step 2: 瀏覽商品
    page.goto('https://example.com/products')
    page.click('text=iPhone 15')

    # Step 3: 加入購物車
    page.click('button:has-text("Add to Cart")')
    assert page.locator('.cart-badge').inner_text() == '1'

    # Step 4: 結帳
    page.click('a:has-text("Cart")')
    page.click('button:has-text("Checkout")')

    # Step 5: 填寫配送資訊
    page.fill('input[name="address"]', '123 Main St')
    page.fill('input[name="city"]', 'Taipei')

    # Step 6: 確認訂單
    page.click('button:has-text("Place Order")')

    # 驗證：訂單成功頁面
    assert 'Order Confirmed' in page.title()
    assert page.locator('.order-number').is_visible()
```

**AI 輔助策略**：
```
1. AI 生成測試腳本
2. AI 幫助定位元素選擇器
3. AI 建議測試流程
4. AI 協助診斷失敗原因
```

---

## 第三部分：測試分配策略

### 70-20-10 黃金比例

**為什麼是這個比例？**

```
單元測試 70%：
- 快速反饋（幾秒內）
- 覆蓋核心邏輯
- 便宜且易維護
→ 投資報酬率最高

整合測試 20%：
- 驗證元件協作
- 發現介面問題
- 執行時間可接受（幾十秒）
→ 補充單元測試無法驗證的部分

E2E 測試 10%：
- 驗證關鍵流程
- 最接近真實情況
- 執行慢但價值高
→ 只測試最重要的流程
```

### 實際專案範例

#### 電商專案的測試分配

**總共 500 個測試**：

```
【單元測試 - 350 個】
├── 商品邏輯測試：100 個
│   ├── 價格計算（折扣、稅金）
│   ├── 庫存管理
│   └── 商品分類
│
├── 訂單邏輯測試：80 個
│   ├── 訂單建立
│   ├── 訂單狀態轉換
│   └── 訂單計算
│
├── 用戶邏輯測試：70 個
│   ├── 用戶註冊驗證
│   ├── 權限檢查
│   └── 用戶資訊更新
│
└── 工具函數測試：100 個
    ├── 資料驗證
    ├── 格式轉換
    └── 加密解密

【整合測試 - 100 個】
├── API 端點測試：50 個
│   ├── 商品 API
│   ├── 訂單 API
│   └── 用戶 API
│
├── 資料庫操作：30 個
│   ├── CRUD 操作
│   └── 交易處理
│
└── 第三方整合：20 個
    ├── 支付閘道
    ├── 物流 API
    └── 郵件服務

【E2E 測試 - 50 個】
├── 核心購物流程：20 個
│   ├── 瀏覽-加購-結帳
│   ├── 套用優惠碼
│   └── 不同付款方式
│
├── 用戶管理：15 個
│   ├── 註冊-登入-登出
│   ├── 修改個人資訊
│   └── 查看訂單歷史
│
└── 管理後台：15 個
    ├── 商品管理
    ├── 訂單處理
    └── 用戶管理
```

---

## 第四部分：AI 在不同層級的應用

### 單元測試層級的 AI 應用

**應用 1：生成測試案例**
```
人類：「幫我生成 calculate_discount() 的單元測試」
AI：生成涵蓋：
     - 正常情況
     - 邊界情況（0, 負數, 超大數）
     - 特殊情況（VIP, 新用戶, 批量購買）
```

**應用 2：建議遺漏的測試**
```
人類：「檢查我的測試覆蓋」
AI：「你遺漏了：
     - quantity = 0 的情況
     - customer_type 為 null 的情況
     - 價格為負數的情況」
```

**應用 3：重構測試程式碼**
```
人類：「這些測試有很多重複，請重構」
AI：「可以提取 fixture / 使用參數化測試」
```

---

### 整合測試層級的 AI 應用

**應用 1：生成 Mock 物件**
```
人類：「我需要 mock PaymentGateway」
AI：生成完整的 mock 包含：
     - 成功付款
     - 失敗付款
     - 超時
     - 部分退款
```

**應用 2：設計測試資料**
```
人類：「幫我設計訂單整合測試的測試資料」
AI：生成：
     - 用戶資料（不同等級）
     - 商品資料（不同類型、價格）
     - 優惠規則
     - 預期結果
```

**應用 3：診斷失敗原因**
```
人類：「整合測試失敗了，錯誤是...」
AI：「可能原因：
     1. 資料庫交易未正確回滾
     2. 測試順序依賴問題
     3. 時區設定不一致
     建議...」
```

---

### E2E 測試層級的 AI 應用

**應用 1：生成測試腳本**
```
人類：「幫我寫完整的購物流程 E2E 測試」
AI：生成 Playwright/Selenium 腳本
     涵蓋：登入 → 瀏覽 → 加購 → 結帳 → 確認
```

**應用 2：優化選擇器**
```
人類：「這個選擇器太脆弱：#app > div > div:nth-child(3)」
AI：「建議改為：
     - data-testid="checkout-button"
     - button:has-text("Checkout")
     - [aria-label="Proceed to checkout"]」
```

**應用 3：視覺回歸測試**
```
人類：「幫我設置視覺回歸測試」
AI：「建議使用 Percy/Applitools
     關鍵頁面截圖：首頁、商品頁、結帳頁
     設置差異閾值：5%」
```

---

## 第五部分：測試策略設計

### 新專案的測試策略

**第一週：基礎架構**
```
1. 設置測試框架（pytest/Jest）
2. 建立 CI/CD pipeline
3. 寫第一個單元測試
4. 確保測試可自動執行
```

**第二週：核心邏輯**
```
1. 為核心業務邏輯建立單元測試
2. 目標：60% 覆蓋率
3. 建立測試習慣
```

**第三週：整合測試**
```
1. 加入整合測試
2. 測試 API 端點
3. 測試資料庫操作
```

**第四週：E2E 測試**
```
1. 設置 E2E 測試框架
2. 測試 2-3 個核心流程
3. 整合到 CI/CD
```

---

### Legacy 專案的測試策略

**階段 1：建立安全網（Characterization Tests）**
```
目標：為現有行為建立測試
方法：
1. 執行程式碼，記錄輸出
2. 將輸出作為預期結果
3. 建立測試「現狀」
4. 重構時有保護
```

**階段 2：增量覆蓋**
```
原則：新程式碼 100% 覆蓋
      舊程式碼逐步增加
      優先測試：
      - 經常變更的模組
      - 關鍵業務邏輯
      - 常出 bug 的地方
```

**階段 3：重構與提升**
```
有測試保護後：
→ 重構複雜程式碼
→ 提升程式碼品質
→ 擴展測試覆蓋
```

---

## 🎯 總結

### 測試金字塔的核心原則

1. **70-20-10 比例**：單元測試為主力
2. **速度與成本權衡**：快速反饋最重要
3. **三層互補**：全面覆蓋不同層面
4. **持續優化**：根據專案調整比例

### AI 在測試金字塔的價值

1. **單元測試**：加速測試生成，提醒邊界情況
2. **整合測試**：協助設計測試資料和 mock
3. **E2E 測試**：生成測試腳本，診斷失敗
4. **跨層級**：統一的測試策略建議

### 關鍵建議

1. **從單元測試開始**：建立堅實基礎
2. **測試金字塔而非冰淇淋**：避免 E2E 過多
3. **快速反饋最重要**：測試執行要快
4. **AI 輔助但人類決策**：測試策略需要判斷

---

## 📚 延伸閱讀

- **Test Pyramid** by Martin Fowler
- **Growing Object-Oriented Software, Guided by Tests**
- **The Practical Test Pyramid**

---

## 🔗 下一步

完成理論學習後，開始實作練習：

➡️ **實作練習 1：TDD 任務管理系統**
- 應用完整的 TDD 流程
- 建立三層測試
- 體驗測試金字塔

➡️ **實作練習 2：BDD 購物車流程**
- 用 BDD 方式開發
- E2E 測試實戰
- 整合測試設計

---

**記住：測試不是負擔，而是信心的來源！**
**建立完整的測試金字塔，享受安心重構的自由！**
