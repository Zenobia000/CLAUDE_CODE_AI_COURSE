# CI/CD 常見問題與解決方案

## 🎯 問題分類索引

本文檔收集 CI/CD 實施過程中最常見的問題及其解決方案，特別針對 AI 時代的新挑戰。

**快速導航**：
- 🚀 [Workflow 執行問題](#workflow-執行問題)
- 🔒 [安全掃描問題](#安全掃描問題)
- 🐳 [Docker/容器化問題](#docker容器化問題)
- 📦 [依賴管理問題](#依賴管理問題)
- 🔧 [配置和權限問題](#配置和權限問題)
- ⚡ [效能優化問題](#效能優化問題)

---

## 🚀 Workflow 執行問題

### Q1: GitHub Actions workflow 沒有觸發

**症狀**：
- Push 程式碼後，Actions tab 沒有新的 workflow 執行
- PR 建立後，檢查狀態沒有出現

**常見原因及解決方案**：

**1. YAML 語法錯誤**
```yaml
# ❌ 錯誤：縮排不正確
name: Test
on:
push:  # 縮排錯誤
  branches: [main]

# ✅ 正確：縮排一致
name: Test
on:
  push:
    branches: [main]
```

**2. 檔案路徑錯誤**
```bash
# ❌ 錯誤位置
.github/workflow/test.yml    # 缺少 s

# ✅ 正確位置
.github/workflows/test.yml   # workflows 有 s
```

**3. 分支條件不匹配**
```yaml
# 檢查分支設定
on:
  push:
    branches: [main, develop]  # 確保包含你推送的分支
  pull_request:
    branches: [main]           # 確保 PR 目標分支正確
```

**除錯步驟**：
```bash
# 1. 檢查 YAML 語法
yamllint .github/workflows/test.yml

# 2. 檢查檔案是否存在
ls -la .github/workflows/

# 3. 檢查 Git 狀態
git status
git log --oneline -5

# 4. 檢查分支名稱
git branch -a
```

### Q2: Workflow 執行失敗，錯誤訊息不清楚

**症狀**：
- Workflow 顯示紅色 X，但錯誤訊息模糊
- 找不到具體的失敗原因

**解決策略**：

**1. 啟用詳細日誌**
```yaml
# 在 workflow 中加入除錯資訊
jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug information
        run: |
          echo "GitHub Context:"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "SHA: ${{ github.sha }}"
          echo "Ref: ${{ github.ref }}"

          echo "Environment:"
          env | sort

          echo "File system:"
          ls -la
```

**2. 分步驟除錯**
```yaml
# 將複雜步驟拆解
- name: Install dependencies
  run: |
    echo "Installing Node.js dependencies..."
    npm ci
    echo "Dependencies installed successfully"

- name: Run tests
  run: |
    echo "Running test suite..."
    npm test
    echo "Tests completed"
```

**3. 使用 tmate 遠端除錯**
```yaml
# 當需要互動式除錯時
- name: Setup tmate session
  if: failure()
  uses: mxschmitt/action-tmate@v3
  with:
    limit-access-to-actor: true
```

### Q3: Actions 執行時間過長

**症狀**：
- Workflow 執行超過 10-20 分鐘
- 頻繁超時失敗

**優化策略**：

**1. 使用快取**
```yaml
# Node.js 快取
- name: Cache Node modules
  uses: actions/cache@v3
  with:
    path: ~/.npm
    key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
    restore-keys: |
      ${{ runner.os }}-node-

# Python 快取
- name: Cache pip packages
  uses: actions/cache@v3
  with:
    path: ~/.cache/pip
    key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
```

**2. 並行執行**
```yaml
jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [16, 18, 20]
      fail-fast: false
    runs-on: ${{ matrix.os }}
```

**3. 跳過不必要的步驟**
```yaml
- name: Skip tests for docs-only changes
  id: skip
  run: |
    if git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -qE "^docs/|\.md$"; then
      echo "skip=true" >> $GITHUB_OUTPUT
    fi

- name: Run tests
  if: steps.skip.outputs.skip != 'true'
  run: npm test
```

---

## 🔒 安全掃描問題

### Q4: CodeQL 掃描失敗或找不到程式碼

**症狀**：
- CodeQL 初始化成功，但分析失敗
- 提示 "No source code was seen during the build"

**解決方案**：

**1. 自動建置失敗**
```yaml
# 對於編譯語言，指定建置步驟
- name: Initialize CodeQL
  uses: github/codeql-action/init@v2
  with:
    languages: java

# 取代 autobuild，使用自定義建置
- name: Build project
  run: |
    mvn clean compile test-compile

- name: Perform CodeQL Analysis
  uses: github/codeql-action/analyze@v2
```

**2. 語言檢測問題**
```yaml
# 明確指定語言
- name: Initialize CodeQL
  uses: github/codeql-action/init@v2
  with:
    languages: javascript, python, java
    # 明確指定來源目錄
    source-root: src
```

**3. 檔案路徑排除**
```yaml
# 排除不需要掃描的檔案
- name: Initialize CodeQL
  uses: github/codeql-action/init@v2
  with:
    config: |
      paths-ignore:
        - "node_modules"
        - "vendor"
        - "**/test/**"
        - "**/*.test.js"
```

### Q5: Snyk 掃描發現過多誤報

**症狀**：
- Snyk 報告大量低危漏洞
- 影響正常的 PR 合併流程

**解決策略**：

**1. 調整嚴重性閾值**
```yaml
- name: Run Snyk to check for vulnerabilities
  uses: snyk/actions/node@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  with:
    args: --severity-threshold=medium  # 只關注中危以上
```

**2. 使用 .snyk 配置檔案**
```yaml
# .snyk
version: v1.0.0
ignore:
  # 暫時忽略特定漏洞
  SNYK-JS-LODASH-567746:
    - '*':
        reason: 'False positive - we do not use the vulnerable function'
        expires: '2024-12-31T23:59:59.999Z'

  # 忽略開發依賴的低危漏洞
  SNYK-JS-MINIMIST-559764:
    - 'devDependencies > *':
        reason: 'Dev dependency, not used in production'
```

**3. 分離生產和開發依賴掃描**
```yaml
- name: Snyk production dependencies
  run: snyk test --severity-threshold=high --prod

- name: Snyk development dependencies
  run: snyk test --severity-threshold=critical --dev
  continue-on-error: true  # 開發依賴失敗不阻止流程
```

### Q6: Trivy 容器掃描報告太多 OS 漏洞

**症狀**：
- 大量的作業系統層級漏洞
- 難以區分應用層級的真正風險

**優化配置**：

**1. 分層掃描**
```yaml
# 只掃描應用層漏洞
- name: Scan application vulnerabilities
  run: |
    trivy image --vuln-type library --severity HIGH,CRITICAL myapp:latest

# 分別掃描 OS 層（可設為警告）
- name: Scan OS vulnerabilities
  run: |
    trivy image --vuln-type os --severity CRITICAL myapp:latest
  continue-on-error: true
```

**2. 使用 distroless 基礎映像**
```dockerfile
# 減少攻擊面
FROM gcr.io/distroless/java:11
COPY app.jar /
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

**3. 定期更新基礎映像**
```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
```

---

## 🐳 Docker/容器化問題

### Q7: Docker 建置在 CI 中失敗，但本地成功

**症狀**：
- 本地 `docker build` 成功
- GitHub Actions 中 Docker 建置失敗

**常見原因及解決方案**：

**1. 平台差異問題**
```yaml
# 指定平台
- name: Build Docker image
  run: |
    docker build --platform=linux/amd64 -t myapp:latest .
```

**2. 檔案路徑大小寫問題**
```bash
# 檢查 Dockerfile 中的路徑
# ❌ 在 Linux 中可能失敗
COPY App.js /app/

# ✅ 確保大小寫正確
COPY app.js /app/
```

**3. 建置上下文過大**
```dockerfile
# .dockerignore
node_modules
.git
.github
*.md
tests/
coverage/
```

**4. 多階段建置問題**
```dockerfile
# 確保所有階段都能存取到必要檔案
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine AS runtime
WORKDIR /app
# 確保從正確的階段複製檔案
COPY --from=builder /app/node_modules ./node_modules
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### Q8: 容器在 CI 中啟動失敗

**症狀**：
- Docker 建置成功，但容器執行失敗
- 健康檢查一直失敗

**除錯策略**：

**1. 加入詳細日誌**
```yaml
- name: Run container with logs
  run: |
    # 啟動容器
    docker run -d --name test-container myapp:latest

    # 等待啟動
    sleep 10

    # 檢查狀態和日誌
    docker ps -a
    docker logs test-container

    # 健康檢查
    docker exec test-container curl -f http://localhost:8080/health
```

**2. 設定適當的健康檢查**
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1
```

**3. 檢查環境變數**
```yaml
- name: Debug container environment
  run: |
    docker run --rm myapp:latest env | sort
    docker run --rm myapp:latest cat /etc/passwd
    docker run --rm myapp:latest ls -la /app
```

---

## 📦 依賴管理問題

### Q9: npm/pip 安裝在 CI 中失敗

**症狀**：
- 依賴安裝超時或失敗
- 版本衝突問題

**解決方案**：

**1. 網路問題**
```yaml
# 設定 npm registry mirror
- name: Setup npm
  run: |
    npm config set registry https://registry.npmmirror.com/
    npm config set timeout 60000

# 重試機制
- name: Install dependencies with retry
  run: |
    for i in {1..3}; do
      npm ci && break
      echo "Attempt $i failed, retrying..."
      sleep 5
    done
```

**2. 快取策略**
```yaml
# 更精確的快取鍵
- name: Cache dependencies
  uses: actions/cache@v3
  with:
    path: |
      ~/.npm
      node_modules
    key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/package.json') }}
    restore-keys: |
      ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
      ${{ runner.os }}-npm-
```

**3. 版本鎖定**
```yaml
# 確保使用正確的套件管理器版本
- name: Setup Node.js
  uses: actions/setup-node@v3
  with:
    node-version: '18'
    npm-version: '9.5.0'  # 鎖定 npm 版本
```

### Q10: 依賴版本衝突

**症狀**：
- 本地可以安裝，CI 中版本衝突
- Peer dependency 警告

**解決策略**：

**1. 清理安裝**
```yaml
- name: Clean install
  run: |
    rm -rf node_modules package-lock.json
    npm cache clean --force
    npm install
```

**2. 使用 --legacy-peer-deps**
```yaml
- name: Install with legacy peer deps
  run: npm install --legacy-peer-deps
```

**3. 明確的版本管理**
```json
// package.json
{
  "overrides": {
    "vulnerable-package": "^2.0.0"
  },
  "resolutions": {
    "vulnerable-package": "^2.0.0"
  }
}
```

---

## 🔧 配置和權限問題

### Q11: GitHub Secrets 設定問題

**症狀**：
- Secrets 無法存取
- 權限不足錯誤

**解決方案**：

**1. 檢查 Secrets 範圍**
```yaml
# 確保在正確的範圍設定 secrets
# Repository secrets: 整個倉庫可用
# Environment secrets: 特定環境才可用
# Organization secrets: 組織層級共享

jobs:
  deploy:
    environment: production  # 如果使用環境 secrets
    steps:
      - name: Use secret
        run: echo "Secret value: ${{ secrets.SECRET_NAME }}"
```

**2. 權限設定**
```yaml
# workflow 檔案中明確設定權限
permissions:
  contents: read
  security-events: write
  actions: read
  packages: write

jobs:
  security-scan:
    permissions:
      security-events: write  # CodeQL 需要此權限
```

**3. 除錯 secrets**
```yaml
- name: Debug secrets (安全方式)
  run: |
    # ❌ 絕對不要直接印出 secret
    # echo "${{ secrets.SECRET_NAME }}"

    # ✅ 檢查 secret 是否存在
    if [ -z "${{ secrets.SECRET_NAME }}" ]; then
      echo "SECRET_NAME is not set"
      exit 1
    else
      echo "SECRET_NAME is set (length: ${#SECRET_NAME})"
    fi
```

### Q12: 跨倉庫權限問題

**症狀**：
- 無法存取其他倉庫的資源
- GITHUB_TOKEN 權限不足

**解決方案**：

**1. 使用 Personal Access Token**
```yaml
# 建立具有適當權限的 PAT
- name: Checkout private repo
  uses: actions/checkout@v4
  with:
    repository: myorg/private-repo
    token: ${{ secrets.PAT_TOKEN }}
    path: private-repo
```

**2. 使用 GitHub App**
```yaml
- name: Generate token
  id: generate_token
  uses: tibdex/github-app-token@v1
  with:
    app_id: ${{ secrets.APP_ID }}
    private_key: ${{ secrets.APP_PRIVATE_KEY }}

- name: Use generated token
  uses: actions/checkout@v4
  with:
    token: ${{ steps.generate_token.outputs.token }}
```

---

## ⚡ 效能優化問題

### Q13: CI/CD 管線執行時間過長

**症狀**：
- 單次執行超過 30 分鐘
- 開發者等待時間過長

**優化策略**：

**1. 並行化策略**
```yaml
jobs:
  test:
    strategy:
      matrix:
        group: [1, 2, 3, 4]
    steps:
      - name: Run test group ${{ matrix.group }}
        run: npm test -- --group=${{ matrix.group }}

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Lint code
        run: npm run lint

  security:
    runs-on: ubuntu-latest
    steps:
      - name: Security scan
        run: npm audit
```

**2. 智能觸發**
```yaml
# 只在相關檔案變更時執行
on:
  push:
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
```

**3. 階段性執行**
```yaml
jobs:
  quick-check:
    runs-on: ubuntu-latest
    steps:
      - name: Lint and unit tests
        run: |
          npm run lint
          npm run test:unit

  full-test:
    needs: quick-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Integration tests
        run: npm run test:integration
```

### Q14: 資源使用過度

**症狀**：
- Actions 分鐘數快速消耗
- 費用超出預期

**成本控制**：

**1. 監控使用量**
```yaml
- name: Report resource usage
  run: |
    echo "Job started at: $(date)"
    echo "Runner: ${{ runner.os }}"
    echo "Repository: ${{ github.repository }}"
    echo "Event: ${{ github.event_name }}"
```

**2. 優化 Runner 選擇**
```yaml
jobs:
  # 輕量任務使用小型 runner
  lint:
    runs-on: ubuntu-latest

  # 重量任務使用高效 runner
  build:
    runs-on: ubuntu-latest-4-cores

  # 自託管 runner 降低成本
  deploy:
    runs-on: self-hosted
```

**3. 條件執行**
```yaml
jobs:
  expensive-job:
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      !contains(github.event.head_commit.message, '[skip ci]')
```

---

## 🆘 緊急問題處理

### 生產環境部署失敗

**立即行動**：
```bash
# 1. 快速回退
kubectl rollout undo deployment/myapp

# 2. 檢查服務狀態
kubectl get pods -l app=myapp
kubectl describe pods -l app=myapp

# 3. 查看日誌
kubectl logs -l app=myapp --tail=100

# 4. 暫停自動部署
gh workflow disable deploy.yml
```

**後續分析**：
```bash
# 1. 下載 CI 日誌
gh run download <run-id>

# 2. 分析失敗原因
grep -i error *.log
grep -i fail *.log

# 3. 準備修復
git checkout -b hotfix/deployment-fix
```

### 安全漏洞緊急修復

**立即響應**：
```bash
# 1. 評估風險等級
snyk test --severity-threshold=critical

# 2. 暫停受影響的服務
kubectl scale deployment myapp --replicas=0

# 3. 應用緊急補丁
docker pull myapp:last-known-good
kubectl set image deployment/myapp myapp=myapp:last-known-good

# 4. 驗證修復
curl -f https://myapp.example.com/health
```

---

## 📚 延伸資源

### 🔧 除錯工具

- **GitHub CLI**：`gh workflow list`, `gh run view`
- **act**：本地執行 GitHub Actions
- **yamllint**：YAML 語法檢查
- **docker-compose**：本地容器測試

### 📖 參考文檔

- **GitHub Actions 疑難排解**：官方除錯指南
- **Docker 最佳實踐**：容器化指南
- **Kubernetes 問題排查**：K8s 官方文檔
- **DevOps 故障排除**：SRE 實踐手冊

### 🎯 預防措施

- **定期健康檢查**：每週檢查 CI/CD 狀態
- **監控告警**：設定關鍵指標告警
- **文檔更新**：記錄新發現的問題和解決方案
- **團隊培訓**：提升團隊故障排除能力

---

**快速支援**：遇到緊急問題？使用 `Ctrl+F` 搜尋關鍵字，或直接查看對應分類 →