# 安全掃描工具配置範例

## 🎯 配置總覽

在 AI 時代，40% 的生成代碼包含安全問題。本文檔提供實戰可用的安全掃描配置範例，建立**三層防禦體系**。

**安全掃描三層防護**：
```
Layer 1: 靜態分析 (SAST) → 找出代碼邏輯漏洞
Layer 2: 依賴掃描 (SCA)  → 找出第三方套件漏洞
Layer 3: 容器掃描       → 找出映像和執行環境漏洞
```

---

## 🛡️ GitHub Actions 安全掃描配置

### 完整安全掃描 Workflow

```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # 每週一早上 8 點執行
    - cron: '0 8 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Layer 1: 靜態分析 (CodeQL)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, python, java
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      # Layer 2: 依賴掃描 (Snyk)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      # Layer 3: 容器掃描 (Trivy)
      - name: Build Docker image
        run: docker build -t myapp:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      # 額外安全檢查
      - name: Secret detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      # 安全掃描報告
      - name: Generate security report
        if: always()
        run: |
          echo "## 🔒 Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CodeQL Analysis" >> $GITHUB_STEP_SUMMARY
          echo "✅ Static analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency Scan" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dependency vulnerabilities checked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Scan" >> $GITHUB_STEP_SUMMARY
          echo "✅ Container image scanned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the Security tab."
```

---

## 🔧 分層掃描配置

### Layer 1: 靜態應用安全測試 (SAST)

#### CodeQL 高級配置

```yaml
# .github/workflows/codeql.yml
name: CodeQL Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '30 2 * * 2'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'python', 'java']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        # 使用自定義查詢套件
        queries: +security-extended,+security-and-quality
        # 排除測試文件
        config: |
          paths-ignore:
            - "**/test/**"
            - "**/tests/**"
            - "**/*_test.py"
            - "**/*.test.js"

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

    # 自定義安全檢查失敗條件
    - name: Check CodeQL results
      run: |
        # 如果發現高危漏洞，工作流程失敗
        if [ -f codeql-results.json ]; then
          high_severity=$(jq '.runs[0].results[] | select(.level=="error")' codeql-results.json | wc -l)
          if [ "$high_severity" -gt 0 ]; then
            echo "❌ Found $high_severity high severity security issues"
            exit 1
          fi
        fi
```

#### SonarQube 整合

```yaml
# .github/workflows/sonarqube.yml
name: SonarQube Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sonarqube:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Setup SonarQube scanner
      uses: warchant/setup-sonar-scanner@v7

    - name: Run SonarQube analysis
      run: |
        sonar-scanner \
          -Dsonar.projectKey=myproject \
          -Dsonar.sources=src \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.qualitygate.wait=true

    - name: SonarQube Quality Gate check
      uses: sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### Layer 2: 軟體組成分析 (SCA)

#### 多語言依賴掃描

```yaml
# .github/workflows/dependency-scan.yml
name: Dependency Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # 每日掃描
    - cron: '0 6 * * *'

jobs:
  scan-dependencies:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Python 依賴掃描
    - name: Python dependency scan
      if: hashFiles('requirements.txt') != ''
      run: |
        pip install safety
        pip install -r requirements.txt
        safety check

    # Node.js 依賴掃描
    - name: Node.js dependency scan
      if: hashFiles('package.json') != ''
      run: |
        npm ci
        npm audit --audit-level high
        npx retire

    # Java 依賴掃描
    - name: Java dependency scan
      if: hashFiles('pom.xml') != ''
      run: |
        mvn dependency-check:check -DfailBuildOnCVSS=7

    # Snyk 整合掃描
    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --all-projects

    # 產生依賴報告
    - name: Generate dependency report
      run: |
        echo "## 📦 Dependency Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status | Issues Found |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|--------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Safety (Python) | ✅ | 0 |" >> $GITHUB_STEP_SUMMARY
        echo "| npm audit | ✅ | 0 |" >> $GITHUB_STEP_SUMMARY
        echo "| Snyk | ✅ | 0 |" >> $GITHUB_STEP_SUMMARY
```

#### Dependabot 自動化配置

```yaml
# .github/dependabot.yml
version: 2
updates:
  # Node.js 依賴
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
    open-pull-requests-limit: 5
    reviewers:
      - "security-team"
    assignees:
      - "lead-developer"
    commit-message:
      prefix: "security"
      include: "scope"

  # Python 依賴
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"
    ignore:
      - dependency-name: "*"
        update-types: ["version-update:semver-patch"]

  # Docker 基礎映像
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
```

### Layer 3: 容器與基礎設施掃描

#### 多工具容器掃描

```yaml
# .github/workflows/container-scan.yml
name: Container Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  container-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t myapp:latest .
        docker build -t myapp:${{ github.sha }} .

    # Trivy 掃描
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'myapp:latest'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    # Docker Scout 掃描
    - name: Docker Scout scan
      uses: docker/scout-action@v1
      with:
        command: cves
        image: myapp:latest
        sarif-file: scout-report.sarif

    # Snyk 容器掃描
    - name: Snyk Container scan
      uses: snyk/actions/docker@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        image: myapp:latest
        args: --severity-threshold=high

    # 掃描結果上傳
    - name: Upload scan results
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: scout-report.sarif

    # 容器配置檢查
    - name: Container configuration check
      run: |
        # 檢查 Dockerfile 最佳實踐
        docker run --rm -v "$PWD":/project hadolint/hadolint hadolint /project/Dockerfile

        # 檢查映像大小
        IMAGE_SIZE=$(docker images myapp:latest --format "table {{.Size}}" | tail -n1)
        echo "Image size: $IMAGE_SIZE" >> $GITHUB_STEP_SUMMARY

        # 檢查是否使用 root 用戶
        if docker run --rm myapp:latest whoami | grep -q root; then
          echo "⚠️ Container running as root user" >> $GITHUB_STEP_SUMMARY
        fi
```

---

## 🚨 安全掃描自動修復配置

### GitHub Copilot Autofix 整合

```yaml
# .github/workflows/autofix.yml
name: Security Autofix

on:
  schedule:
    # 每週自動修復
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  autofix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      security-events: read

    steps:
    - uses: actions/checkout@v4

    # 執行安全掃描
    - name: Run security scan
      id: scan
      uses: github/codeql-action/analyze@v2

    # GitHub Copilot 自動修復
    - name: Auto-fix security issues
      if: steps.scan.outputs.results-count > 0
      uses: github/copilot-autofix-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # 建立修復 PR
    - name: Create fix PR
      if: steps.autofix.outputs.fixed-count > 0
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          security: auto-fix security vulnerabilities

          🤖 Auto-generated security fixes:
          - Fixed ${{ steps.autofix.outputs.fixed-count }} security issues
          - Powered by GitHub Copilot Autofix

        title: "🔒 Security: Auto-fix vulnerabilities"
        body: |
          ## 🤖 Automated Security Fix

          This PR was automatically generated to fix security vulnerabilities detected in the codebase.

          ### Fixed Issues
          - **Count**: ${{ steps.autofix.outputs.fixed-count }}
          - **Types**: ${{ steps.autofix.outputs.issue-types }}

          ### Verification Required
          - [ ] Review the changes carefully
          - [ ] Run tests to ensure functionality
          - [ ] Verify the fixes address the security issues

          **Powered by**: GitHub Copilot Autofix
        branch: security/auto-fix-${{ github.run_id }}
        reviewers: security-team
        assignees: lead-developer
```

### 自定義修復腳本

```yaml
# .github/workflows/custom-autofix.yml
name: Custom Security Autofix

on:
  security_advisory:
    types: [published]

jobs:
  custom-fix:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 自定義安全修復腳本
    - name: Apply security fixes
      run: |
        #!/bin/bash
        echo "🔧 Applying custom security fixes..."

        # 修復常見的 JavaScript 安全問題
        if [ -f "package.json" ]; then
          # 移除危險的 eval 用法
          find . -name "*.js" -type f -exec sed -i 's/eval(/\/\/ SECURITY: eval disabled - /g' {} \;

          # 修復原型污染
          find . -name "*.js" -type f -exec sed -i 's/__proto__/\/\/ SECURITY: __proto__ disabled/g' {} \;
        fi

        # 修復 Python 安全問題
        if [ -f "requirements.txt" ]; then
          # 更新到安全版本
          pip-compile --upgrade-package django==4.2.7
          pip-compile --upgrade-package requests==2.31.0
        fi

        # 修復 Docker 安全問題
        if [ -f "Dockerfile" ]; then
          # 移除 root 用戶
          sed -i '/USER root/d' Dockerfile
          echo "USER 1000:1000" >> Dockerfile
        fi

    # 運行測試確保修復不會破壞功能
    - name: Run tests after fixes
      run: |
        if [ -f "package.json" ]; then
          npm test
        fi
        if [ -f "requirements.txt" ]; then
          pytest
        fi

    # 創建修復 PR
    - name: Create fix PR
      uses: peter-evans/create-pull-request@v5
      with:
        commit-message: "security: apply automated security fixes"
        title: "🔒 Automated Security Fixes"
        body: |
          ## Automated Security Fixes Applied

          This PR includes automated fixes for common security vulnerabilities:

          - ✅ Removed dangerous eval() usage
          - ✅ Fixed prototype pollution vectors
          - ✅ Updated vulnerable dependencies
          - ✅ Fixed Docker security configurations

          All tests pass after applying these fixes.
```

---

## 📊 掃描結果處理與報告

### 安全報告儀表板

```yaml
# .github/workflows/security-dashboard.yml
name: Security Dashboard

on:
  schedule:
    - cron: '0 9 * * *'  # 每日生成報告

jobs:
  security-report:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 收集所有安全掃描結果
    - name: Collect security scan results
      run: |
        mkdir -p security-reports

        # 下載最新的 SARIF 報告
        gh api repos/${{ github.repository }}/code-scanning/analyses \
          --jq '.[] | select(.created_at > (now - 86400 | todate)) | .sarif_id' \
          | head -10 \
          | xargs -I {} gh api repos/${{ github.repository }}/code-scanning/sarifs/{} > security-reports/sarif-{}.json

    # 生成安全趨勢報告
    - name: Generate security trends
      run: |
        python scripts/generate-security-report.py > security-dashboard.md

        # 生成報告內容
        cat > security-dashboard.md << EOF
        ## 🔒 Security Dashboard - $(date +%Y-%m-%d)

        ### 📊 漏洞統計
        | 類型 | 高危 | 中危 | 低危 | 總計 |
        |------|------|------|------|------|
        | CodeQL | 0 | 2 | 5 | 7 |
        | Snyk | 1 | 3 | 8 | 12 |
        | Trivy | 0 | 1 | 3 | 4 |

        ### 📈 安全趨勢 (過去 30 天)
        - ✅ 高危漏洞: 減少 75%
        - 🔄 中危漏洞: 持平
        - 📉 修復時間: 平均 2.3 天

        ### 🎯 本週安全目標
        - [ ] 修復剩餘 1 個高危漏洞
        - [ ] 更新 3 個過期依賴
        - [ ] 完成安全掃描覆蓋率提升
        EOF

    # 更新安全頁面
    - name: Update security page
      run: |
        cp security-dashboard.md docs/security-status.md
        git add docs/security-status.md
        git commit -m "docs: update security dashboard [skip ci]"
        git push

    # 發送安全報告通知
    - name: Send security notification
      uses: 8398a7/action-slack@v3
      with:
        status: always
        channel: '#security'
        text: |
          📊 Daily Security Report Generated

          🔴 High: 1 issue
          🟡 Medium: 6 issues
          🟢 Low: 16 issues

          View full report: ${{ github.server_url }}/${{ github.repository }}/blob/main/docs/security-status.md
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

---

## 🛠️ 工具配置檔案範例

### CodeQL 自定義查詢配置

```yaml
# .github/codeql/codeql-config.yml
name: "CodeQL Config"

disable-default-queries: false

queries:
  - name: security-extended
    uses: security-extended
  - name: security-and-quality
    uses: security-and-quality
  - name: custom-queries
    uses: ./.github/codeql/custom-queries/

paths-ignore:
  - "node_modules"
  - "vendor"
  - "**/test/**"
  - "**/tests/**"
  - "**/*_test.go"
  - "**/*.test.ts"

paths:
  - "src"
  - "lib"
  - "app"

packs:
  javascript:
    - codeql/javascript-queries:AlertSuppression.ql
    - codeql/javascript-queries:Security/CWE-079
```

### Snyk 配置檔案

```yaml
# .snyk
version: v1.0.0

# 忽略特定漏洞（臨時）
ignore:
  SNYK-JS-LODASH-567746:
    - '*':
        reason: 'False positive - not using vulnerable function'
        expires: '2024-12-31T23:59:59.999Z'

# 補丁設定
patches: {}

# 語言設定
language-settings:
  javascript:
    packageManager: npm
  python:
    packageManager: pip
```

### Trivy 配置檔案

```yaml
# .trivyignore
# 忽略特定的 CVE
CVE-2023-12345  # 已確認不影響我們的使用場景
CVE-2023-67890  # 將在下次主要更新時修復

# trivy.yaml
format: json
exit-code: 1
severity: HIGH,CRITICAL
ignorefile: .trivyignore
cache-dir: /tmp/trivy/cache
timeout: 10m
ignore-unfixed: true
```

---

## 🎯 最佳實踐檢查清單

### ✅ 掃描配置檢查

- [ ] **多層掃描**：SAST + SCA + Container 三層防護
- [ ] **自動觸發**：Push、PR、定期掃描
- [ ] **結果整合**：統一上傳到 GitHub Security tab
- [ ] **失敗條件**：高危漏洞阻止 PR 合併
- [ ] **自動修復**：Dependabot + Copilot Autofix
- [ ] **報告通知**：Slack/Teams 通知相關團隊

### ✅ 安全流程檢查

- [ ] **掃描覆蓋率**：覆蓋所有程式碼和依賴
- [ ] **修復 SLA**：高危 24 小時、中危 1 週
- [ ] **例外管理**：有文檔記錄的風險接受
- [ ] **定期審查**：每月檢視安全掃描配置
- [ ] **團隊培訓**：確保團隊理解安全流程

---

**下一步**：選擇適合你專案的配置，開始建立安全 CI/CD 管線 →