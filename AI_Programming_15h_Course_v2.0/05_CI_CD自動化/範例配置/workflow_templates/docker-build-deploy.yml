# Docker æ§‹å»ºèˆ‡éƒ¨ç½²ç¯„æœ¬
#
# ç”¨é€”ï¼šè‡ªå‹•æ§‹å»º Docker æ˜ åƒä¸¦æ¨é€åˆ° Registryï¼Œç„¶å¾Œéƒ¨ç½²åˆ°ç›®æ¨™ç’°å¢ƒ
# é©ç”¨å ´æ™¯ï¼šå®¹å™¨åŒ–æ‡‰ç”¨çš„ CI/CD
#
# ä½¿ç”¨æ–¹å¼ï¼š
# 1. è¤‡è£½æ­¤æª”æ¡ˆåˆ° .github/workflows/
# 2. æ ¹æ“šå°ˆæ¡ˆéœ€æ±‚èª¿æ•´é…ç½®
# 3. è¨­å®šå¿…è¦çš„ GitHub Secrets

name: Docker Build & Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

# è¨­å®šæ¬Šé™ï¼ˆæ¨é€åˆ° GHCR éœ€è¦ï¼‰
permissions:
  contents: read
  packages: write

env:
  # é…ç½® Registryï¼ˆå¯é¸æ“‡ä¸åŒçš„ Registryï¼‰
  REGISTRY: ghcr.io
  # æ˜ åƒåç¨±ï¼ˆè‡ªå‹•ä½¿ç”¨ repository åç¨±ï¼‰
  IMAGE_NAME: ${{ github.repository }}

jobs:
  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: æ§‹å»º Docker æ˜ åƒ
  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æå– metadataï¼ˆtags, labelsï¼‰
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Git SHAï¼ˆçŸ­ç‰ˆï¼‰
            type=sha,prefix={{branch}}-,format=short
            # åˆ†æ”¯åç¨±
            type=ref,event=branch
            # PR ç·¨è™Ÿ
            type=ref,event=pr
            # Latestï¼ˆåªåœ¨ main åˆ†æ”¯ï¼‰
            type=raw,value=latest,enable={{is_default_branch}}
            # èªç¾©åŒ–ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰ tagï¼‰
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}  # PR ä¸æ¨é€
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # å¿«å–ç­–ç•¥ï¼ˆå¤§å¹…åŠ é€Ÿæ§‹å»ºï¼‰
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # å»ºç«‹ provenanceï¼ˆä¾›æ‡‰éˆå®‰å…¨ï¼‰
          provenance: true
          sbom: true

      - name: Show image digest
        run: |
          echo "Image pushed successfully!"
          echo "Digest: ${{ steps.build.outputs.digest }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: å®¹å™¨å®‰å…¨æƒæ
  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # ç™¼ç¾æ¼æ´æ™‚å¤±æ•—

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æ–¹å¼ 1ï¼šä½¿ç”¨ SSH éƒ¨ç½²åˆ°é ç«¯ä¼ºæœå™¨
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /app
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop-${{ github.sha }}
            docker-compose down
            docker-compose up -d
            docker image prune -f

      # æ–¹å¼ 2ï¼šéƒ¨ç½²åˆ°é›²ç«¯æœå‹™ï¼ˆä»¥ Railway ç‚ºä¾‹ï¼‰
      # - name: Deploy to Railway
      #   uses: bervProject/railway-deploy@main
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: my-service

      - name: Wait for deployment
        run: sleep 20

      - name: Health check
        run: |
          for i in {1..10}; do
            if curl -f https://dev.example.com/health; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "âŒ Health check failed"
          exit 1

  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 4: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://app.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # è¨˜éŒ„ç•¶å‰é‹è¡Œçš„ç‰ˆæœ¬ï¼ˆç”¨æ–¼å›é€€ï¼‰
      - name: Save current version
        id: current
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker ps --format '{{.Image}}' | grep ${{ env.IMAGE_NAME }} | head -1 > /tmp/previous_version.txt
            cat /tmp/previous_version.txt

      # è—ç¶ éƒ¨ç½²ï¼šéƒ¨ç½²åˆ° blue ç’°å¢ƒ
      - name: Deploy to blue environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /app
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}
            docker-compose -f docker-compose.blue.yml down
            IMAGE_TAG=main-${{ github.sha }} docker-compose -f docker-compose.blue.yml up -d

      - name: Wait for blue environment
        run: sleep 30

      # å¥åº·æª¢æŸ¥ blue ç’°å¢ƒ
      - name: Health check blue environment
        id: health
        run: |
          for i in {1..15}; do
            if curl -f https://blue.app.example.com/health; then
              echo "âœ… Blue environment healthy"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "âŒ Blue environment unhealthy"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      # åˆ‡æ›æµé‡åˆ° blue
      - name: Switch traffic to blue
        if: steps.health.outputs.healthy == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # æ›´æ–° Nginx/Load Balancer é…ç½®
            /app/scripts/switch-to-blue.sh

      # é©—è­‰ç”Ÿç”¢ç’°å¢ƒ
      - name: Verify production
        run: |
          sleep 10
          if ! curl -f https://app.example.com/health; then
            echo "âŒ Production verification failed"
            exit 1
          fi
          echo "âœ… Production deployment successful"

      # æ¸…ç†èˆŠçš„ green ç’°å¢ƒ
      - name: Cleanup green environment
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ç­‰å¾… 5 åˆ†é˜ç¢ºèªæ²’å•é¡Œå¾Œå†é—œé–‰ green
            sleep 300
            docker-compose -f docker-compose.green.yml down

      # éƒ¨ç½²å¤±æ•—æ™‚é€šçŸ¥
      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "ğŸš¨ Production deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Failed*\nCommit: `${{ github.sha }}`\nActor: @${{ github.actor }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# é…ç½®èªªæ˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# å¿…è¦çš„ GitHub Secretsï¼š
# ========================
# å¦‚æœä½¿ç”¨ SSH éƒ¨ç½²ï¼š
#   - DEV_HOST: é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ IP/åŸŸå
#   - DEV_USER: SSH ç”¨æˆ¶å
#   - PROD_HOST: ç”Ÿç”¢ç’°å¢ƒä¸»æ©Ÿ IP/åŸŸå
#   - PROD_USER: SSH ç”¨æˆ¶å
#   - SSH_PRIVATE_KEY: SSH ç§é‘°
#
# å¦‚æœä½¿ç”¨é›²ç«¯æœå‹™ï¼š
#   - RAILWAY_TOKEN: Railway éƒ¨ç½² token
#   - æˆ–å…¶ä»–é›²ç«¯æœå‹™çš„ credentials
#
# é€šçŸ¥ï¼ˆå¯é¸ï¼‰ï¼š
#   - SLACK_WEBHOOK: Slack webhook URL
#
# ç’°å¢ƒä¿è­·è¦å‰‡ï¼š
# ==============
# åœ¨ GitHub è¨­å®šç”Ÿç”¢ç’°å¢ƒä¿è­·ï¼š
# Settings > Environments > production > Protection rules
#   - Required reviewersï¼ˆéœ€è¦å¯©æ‰¹ï¼‰
#   - Wait timerï¼ˆç­‰å¾…æ™‚é–“ï¼‰
#   - Deployment branchesï¼ˆé™åˆ¶åˆ†æ”¯ï¼‰
#
# ä½¿ç”¨æŠ€å·§ï¼š
# =========
# 1. Docker æ˜ åƒæ¨™è¨˜ç­–ç•¥ï¼š
#    - main-abc123f: ç”Ÿç”¢ç‰ˆæœ¬ï¼ˆå¸¶ git SHAï¼‰
#    - develop-def456a: é–‹ç™¼ç‰ˆæœ¬
#    - latest: æœ€æ–°ç©©å®šç‰ˆæœ¬
#
# 2. å¿«å–ç­–ç•¥ï¼š
#    - ä½¿ç”¨ GitHub Actions cache åŠ é€Ÿæ§‹å»º
#    - mode=max: å¿«å–æ‰€æœ‰å±¤
#
# 3. å®‰å…¨æƒæï¼š
#    - Trivy æƒæå®¹å™¨æ¼æ´
#    - ç™¼ç¾ High/Critical æ¼æ´æ™‚å¤±æ•—
#
# 4. è—ç¶ éƒ¨ç½²ï¼š
#    - é›¶åœæ©Ÿæ™‚é–“
#    - å¿«é€Ÿå›é€€
#    - éœ€è¦é›™å€è³‡æº
#
# 5. å¥åº·æª¢æŸ¥ï¼š
#    - å¸¶é‡è©¦æ©Ÿåˆ¶
#    - è¶…æ™‚è¨­ç½®
#    - å¤±æ•—æ™‚é˜»æ­¢éƒ¨ç½²
