# C07：資料庫遷移自動化 ⭐

## 📋 情境資訊

**難度等級**：⭐⭐ 組合級
**預估時間**：1.5-2 小時
**核心技能**：資料庫遷移、備份策略、回退機制、資料完整性驗證
**前置知識**：基礎級 B01-B06、組合級 C04

---

## 🎯 情境背景

你是資料庫可靠性工程師(DBRE),負責建立安全的資料庫遷移自動化系統。

**上次事故**：
```bash
事故報告 #456
日期：2024-10-20
影響：8 小時停機

問題：
1. 遷移腳本刪除了生產環境關鍵欄位
2. 沒有備份
3. 回退腳本未測試
4. 資料遺失無法恢復

損失：$250,000
```

**目標**：建立零風險的資料庫遷移流程

---

## 🎬 階段展開

### 階段 1：安全遷移框架（30 分鐘）

**遷移腳本範例**（Alembic）：
```python
# migrations/versions/001_add_user_status.py
"""add user status column

Revision ID: 001
"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    # Step 1: 添加欄位（允許 NULL）
    op.add_column('users',
        sa.Column('status', sa.String(20), nullable=True)
    )
    
    # Step 2: 設定預設值
    op.execute("UPDATE users SET status = 'active' WHERE status IS NULL")
    
    # Step 3: 設為 NOT NULL
    op.alter_column('users', 'status', nullable=False)
    
    # Step 4: 建立索引
    op.create_index('idx_users_status', 'users', ['status'])

def downgrade():
    # 回退必須經過測試
    op.drop_index('idx_users_status')
    op.drop_column('users', 'status')
```

**遷移測試**（`.github/workflows/migration-test.yml`）：
```yaml
name: Migration Test

on:
  pull_request:
    paths:
      - 'migrations/**'

jobs:
  test-migration:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alembic psycopg2-binary

      - name: Load sample data
        run: |
          psql -h localhost -U postgres -d test_db < tests/fixtures/sample_data.sql

      - name: Run migration (upgrade)
        run: alembic upgrade head

      - name: Verify schema
        run: python tests/verify_schema.py

      - name: Verify data integrity
        run: python tests/verify_data.py

      - name: Test rollback
        run: alembic downgrade -1

      - name: Verify rollback
        run: python tests/verify_rollback.py

      - name: Test re-upgrade
        run: alembic upgrade head
```

**資料驗證腳本**（`tests/verify_data.py`）：
```python
import sys
from sqlalchemy import create_engine, text

def verify_data_integrity():
    engine = create_engine("postgresql://postgres:test@localhost/test_db")
    
    with engine.connect() as conn:
        # 檢查資料完整性
        result = conn.execute(text("""
            SELECT COUNT(*) as total,
                   COUNT(status) as with_status
            FROM users
        """))
        row = result.fetchone()
        
        if row.total != row.with_status:
            print(f"❌ Data integrity check failed: {row.with_status}/{row.total}")
            return False
        
        # 檢查業務邏輯約束
        result = conn.execute(text("""
            SELECT COUNT(*) FROM users 
            WHERE status NOT IN ('active', 'inactive', 'suspended')
        """))
        invalid_count = result.scalar()
        
        if invalid_count > 0:
            print(f"❌ Found {invalid_count} users with invalid status")
            return False
    
    print("✅ Data integrity verified")
    return True

if __name__ == "__main__":
    success = verify_data_integrity()
    sys.exit(0 if success else 1)
```

**檢查點 1**：
- [ ] 遷移腳本能正確升級
- [ ] 遷移腳本能正確回退
- [ ] 資料完整性驗證通過
- [ ] Schema 驗證通過

---

### 階段 2：生產環境備份策略（25 分鐘）

**備份自動化**（`.github/workflows/prod-migration.yml`）：
```yaml
name: Production Migration

on:
  workflow_dispatch:
    inputs:
      migration_id:
        description: 'Migration ID to apply'
        required: true

jobs:
  backup-and-migrate:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Create backup
        id: backup
        run: |
          BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
          
          pg_dump ${{ secrets.PROD_DB_URL }} > $BACKUP_FILE
          
          # 壓縮備份
          gzip $BACKUP_FILE
          
          # 上傳到 S3
          aws s3 cp ${BACKUP_FILE}.gz s3://backups/database/
          
          echo "backup_file=${BACKUP_FILE}.gz" >> $GITHUB_OUTPUT

      - name: Verify backup
        run: |
          # 驗證備份檔案完整性
          gunzip -t ${{ steps.backup.outputs.backup_file }}

      - name: Apply migration
        id: migrate
        run: |
          export DATABASE_URL=${{ secrets.PROD_DB_URL }}
          alembic upgrade ${{ github.event.inputs.migration_id }}

      - name: Verify migration
        run: python tests/verify_schema.py

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Migration failed. Restoring from backup..."
          
          # 從 S3 下載備份
          aws s3 cp s3://backups/database/${{ steps.backup.outputs.backup_file }} .
          
          # 解壓並恢復
          gunzip ${{ steps.backup.outputs.backup_file }}
          psql ${{ secrets.PROD_DB_URL }} < ${BACKUP_FILE%.gz}
          
          echo "Database restored successfully"

      - name: Notify team
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production migration ${{ github.event.inputs.migration_id }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

**檢查點 2**：
- [ ] 備份自動建立
- [ ] 備份上傳到安全儲存
- [ ] 備份驗證通過
- [ ] 失敗時自動回退

---

### 階段 3：零停機遷移策略（20 分鐘）

**藍綠部署資料庫遷移**：
```python
# migrations/versions/002_zero_downtime_rename.py
"""rename column with zero downtime

步驟：
1. 添加新欄位
2. 雙寫（同時寫入舊欄位和新欄位）
3. 資料回填
4. 切換讀取到新欄位
5. 刪除舊欄位
"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    # Phase 1: 添加新欄位
    op.add_column('products',
        sa.Column('description_new', sa.Text, nullable=True)
    )
    
    # Phase 2: 資料回填
    op.execute("""
        UPDATE products 
        SET description_new = description 
        WHERE description_new IS NULL
    """)
    
    # Phase 3: 設為 NOT NULL（此時應用已切換到新欄位）
    op.alter_column('products', 'description_new', nullable=False)
    
    # Phase 4: 重命名（可選，或保留舊欄位一段時間）
    # op.alter_column('products', 'description_new', new_column_name='description_v2')

def downgrade():
    # 回退策略
    op.drop_column('products', 'description_new')
```

**應用層雙寫邏輯**：
```python
# app/models/product.py
class Product(Base):
    __tablename__ = 'products'
    
    id = Column(Integer, primary_key=True)
    description = Column(Text)  # 舊欄位
    description_new = Column(Text)  # 新欄位
    
    @validates('description_new')
    def update_description(self, key, value):
        # 雙寫：同時更新兩個欄位
        self.description = value
        return value
    
    @property
    def active_description(self):
        # Feature flag 控制讀取哪個欄位
        if os.getenv('USE_NEW_DESCRIPTION') == 'true':
            return self.description_new
        return self.description
```

**檢查點 3**：
- [ ] 零停機遷移策略實施
- [ ] 雙寫邏輯正確
- [ ] Feature flag 控制切換
- [ ] 資料一致性維持

---

### 階段 4：監控與告警（10 分鐘）

**遷移監控**：
```yaml
- name: Monitor migration progress
  run: |
    # 監控長時間運行的查詢
    psql ${{ secrets.PROD_DB_URL }} -c "
      SELECT pid, now() - query_start as duration, query 
      FROM pg_stat_activity 
      WHERE query NOT LIKE '%pg_stat_activity%'
      ORDER BY duration DESC;
    "
    
    # 監控鎖定
    psql ${{ secrets.PROD_DB_URL }} -c "
      SELECT * FROM pg_locks WHERE NOT granted;
    "
    
    # 監控資料庫大小
    psql ${{ secrets.PROD_DB_URL }} -c "
      SELECT pg_size_pretty(pg_database_size('production_db'));
    "
```

**檢查點 4**：
- [ ] 遷移進度可見
- [ ] 鎖定監控就緒
- [ ] 效能影響可控
- [ ] 告警正確觸發

---

## 🎯 學習檢查點

### 技術能力
- [ ] 實現安全遷移框架
- [ ] 建立自動備份系統
- [ ] 實現零停機遷移
- [ ] 完成監控與告警

### 安全指標
- [ ] 100% 遷移測試覆蓋
- [ ] 備份驗證通過率 100%
- [ ] 零資料遺失
- [ ] 回退時間 < 5 分鐘

---

## 💡 延伸挑戰

### 挑戰 1：大表遷移優化
- 分批遷移百萬級資料
- 最小化鎖定時間
- 進度追蹤

### 挑戰 2：多資料庫協調遷移
- 微服務多資料庫
- 事務一致性
- 分散式鎖

### 挑戰 3：自動化測試資料生成
- 產生測試資料集
- 壓力測試
- 邊界情況測試

---

## 📚 參考資源

- [Alembic 文檔](https://alembic.sqlalchemy.org/)
- [Zero-Downtime Migrations](https://github.com/ankane/strong_migrations)
- [Database Reliability Engineering](https://www.oreilly.com/library/view/database-reliability-engineering/9781491925935/)

---

**下一步**：完成後可挑戰 **C08：效能測試整合** 或 **E02：微服務架構 CI/CD**！
