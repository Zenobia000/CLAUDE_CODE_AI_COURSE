# C06：容器化應用管線 ⭐

## 📋 情境資訊

**難度等級**：⭐⭐ 組合級
**預估時間**：1.5-2 小時
**核心技能**：Docker 優化、多階段構建、容器掃描、鏡像簽名
**前置知識**：基礎級 B04、組合級 C01

---

## 🎯 情境背景

你是一家雲原生公司的容器架構師,負責優化整個容器化 CI/CD 管線。

**痛點**：
```bash
問題 1：鏡像過大（2.5GB）
- 構建時間 15 分鐘
- 部署時間 8 分鐘
- 儲存成本高

問題 2：安全漏洞
- 基礎鏡像有 23 個 Critical 漏洞
- 未進行鏡像掃描
- 無鏡像簽名驗證

問題 3：構建效率低
- 每次都完整構建
- 無快取策略
- 無多階段構建
```

**目標**：
- 鏡像大小 < 100MB
- 構建時間 < 3 分鐘
- 零 Critical 漏洞
- 完整安全掃描

---

## 🎬 情境展開

### 階段 1：多階段構建優化（25 分鐘）

**優化前的 Dockerfile**：
```dockerfile
# ❌ 問題：所有依賴都打包進鏡像
FROM node:18

WORKDIR /app

COPY package*.json ./
RUN npm install  # 包含 devDependencies

COPY . .
RUN npm run build

CMD ["node", "dist/main.js"]
# 結果：1.2GB
```

**優化後的 Dockerfile**：
```dockerfile
# Stage 1: Dependencies
FROM node:18-alpine AS deps
RUN apk add --no-cache libc6-compat

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Stage 2: Builder
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# Stage 3: Runner
FROM node:18-alpine AS runner

WORKDIR /app

# 建立非 root 使用者
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 appuser

# 只複製必要檔案
COPY --from=deps --chown=appuser:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=appuser:nodejs /app/dist ./dist
COPY --chown=appuser:nodejs package.json ./

USER appuser

EXPOSE 3000

ENV NODE_ENV=production

CMD ["node", "dist/main.js"]
# 結果：85MB（減少 93%）
```

**構建快取優化**：
```yaml
# .github/workflows/build.yml
name: Build Docker Image

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: myapp:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
```

**檢查點 1**：
- [ ] 鏡像大小 < 100MB
- [ ] 構建時間 < 5 分鐘
- [ ] 使用非 root 使用者
- [ ] 快取正常運作

---

### 階段 2：多層次容器掃描（20 分鐘）

**1. Trivy 掃描配置**：
```yaml
# .github/workflows/container-scan.yml
name: Container Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t myapp:test .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy fs scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'

      - name: Run Grype scan
        uses: anchore/scan-action@v3
        with:
          image: 'myapp:test'
          fail-build: true
          severity-cutoff: high
```

**2. 鏡像簽名與驗證**：
```yaml
# 使用 Cosign 簽名鏡像
- name: Install Cosign
  uses: sigstore/cosign-installer@v3

- name: Sign image
  run: |
    cosign sign --key cosign.key myapp:${{ github.sha }}
  env:
    COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}

- name: Verify signature
  run: |
    cosign verify --key cosign.pub myapp:${{ github.sha }}
```

**3. SBOM 生成**：
```yaml
- name: Generate SBOM
  uses: anchore/sbom-action@v0
  with:
    image: 'myapp:test'
    format: 'spdx-json'
    output-file: 'sbom.spdx.json'

- name: Upload SBOM
  uses: actions/upload-artifact@v3
  with:
    name: sbom
    path: sbom.spdx.json
```

**檢查點 2**：
- [ ] 無 Critical/High 漏洞
- [ ] 鏡像已簽名
- [ ] SBOM 已生成
- [ ] 掃描結果上傳到 Security tab

---

### 階段 3：鏡像發布與版本管理（20 分鐘）

**1. 多 Registry 發布**：
```yaml
# .github/workflows/publish.yml
name: Publish Docker Images

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
            dockerhub/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sign images
        run: |
          for tag in ${{ steps.meta.outputs.tags }}; do
            cosign sign --key cosign.key $tag
          done
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
```

**2. 清理舊鏡像**：
```yaml
# .github/workflows/cleanup.yml
name: Cleanup Old Images

on:
  schedule:
    - cron: '0 0 * * 0'  # 每週日

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Delete old images
        uses: actions/delete-package-versions@v4
        with:
          package-name: 'myapp'
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-pre-release-versions: false
```

**檢查點 3**：
- [ ] 多 Registry 發布成功
- [ ] 版本標籤正確
- [ ] 舊鏡像自動清理
- [ ] 所有鏡像已簽名

---

### 階段 4：Kubernetes 整合（15 分鐘）

**1. Helm Chart 部署**：
```yaml
# .github/workflows/deploy-k8s.yml
name: Deploy to Kubernetes

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Deploy to staging
        run: |
          helm upgrade --install myapp ./charts/myapp \
            --namespace staging \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --wait

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/myapp -n staging
          kubectl get pods -n staging
```

**2. 鏡像掃描 Admission Controller**：
```yaml
# 在 K8s 中配置鏡像掃描
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: image-scanner
webhooks:
  - name: scanner.example.com
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    clientConfig:
      service:
        name: image-scanner
        namespace: security
```

**檢查點 4**：
- [ ] Helm 部署成功
- [ ] Pod 正常運行
- [ ] 部署驗證通過
- [ ] Admission Controller 正常運作

---

## 🎯 學習檢查點

### 技術能力
- [ ] 實現多階段構建優化
- [ ] 整合多層次容器掃描
- [ ] 實現鏡像簽名與驗證
- [ ] 完成多 Registry 發布
- [ ] Kubernetes 整合部署

### 效能指標
- [ ] 鏡像大小 < 100MB
- [ ] 構建時間 < 3 分鐘
- [ ] 無 Critical 漏洞
- [ ] 快取命中率 > 80%

---

## 💡 延伸挑戰

### 挑戰 1：Distroless 鏡像
- 使用 Google Distroless 基礎鏡像
- 進一步減小鏡像大小
- 最小化攻擊面

### 挑戰 2：多架構構建
- 支援 AMD64 和 ARM64
- 使用 `docker buildx`
- 測試跨平台相容性

### 挑戰 3：鏡像加密
- 使用 encrypted container images
- 實現運行時解密
- 保護敏感應用

---

## 📚 參考資源

- [Docker 最佳實踐](https://docs.docker.com/develop/dev-best-practices/)
- [Trivy 文檔](https://aquasecurity.github.io/trivy/)
- [Cosign 文檔](https://docs.sigstore.dev/cosign/overview/)
- [Distroless Images](https://github.com/GoogleContainerTools/distroless)

---

**下一步**：完成後可挑戰 **C07：資料庫遷移自動化** 或 **E01：企業級完整 DevOps 管線**！
