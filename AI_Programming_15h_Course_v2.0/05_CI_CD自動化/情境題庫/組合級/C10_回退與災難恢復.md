# C10：回退與災難恢復 ⭐

## 📋 情境資訊

**難度等級**：⭐⭐ 組合級
**預估時間**：1.5-2 小時
**核心技能**：回退策略、災難恢復、Blue-Green 部署、Canary 發布
**前置知識**：組合級 C02、C04

---

## 🎯 情境背景

生產環境部署失敗,但回退腳本未經測試導致 8 小時停機。你的任務是建立完整的回退與災難恢復系統。

**目標**：
- 回退時間 < 5 分鐘
- 零數據丟失
- 完整演練文檔
- 自動觸發回退

---

## 🎬 階段展開

### 階段 1：Blue-Green 部署（30 分鐘）

**Blue-Green 策略**：
```yaml
# .github/workflows/blue-green-deploy.yml
name: Blue-Green Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        options: [staging, production]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Green
        run: |
          # 部署新版本到 Green 環境
          railway deploy --service myapp-green --environment ${{ inputs.environment }}

      - name: Health check Green
        run: |
          for i in {1..30}; do
            if curl -f https://green.myapp.com/health; then
              echo "✅ Green is healthy"
              break
            fi
            sleep 10
          done

      - name: Run smoke tests
        run: |
          pytest tests/smoke/ --base-url=https://green.myapp.com

      - name: Switch traffic to Green
        run: |
          # 切換流量
          railway service update myapp --active green

      - name: Verify production
        run: |
          sleep 30
          pytest tests/critical/ --base-url=https://myapp.com

      - name: Rollback on failure
        if: failure()
        run: |
          echo "⚠️ Deployment failed. Rolling back to Blue..."
          railway service update myapp --active blue
          
      - name: Decommission Blue
        if: success()
        run: |
          # 10 分鐘後下線 Blue（留時間快速回退）
          sleep 600
          railway service stop myapp-blue
```

**檢查點 1**：
- [ ] Blue-Green 部署成功
- [ ] 流量切換正確
- [ ] 失敗自動回退
- [ ] 零停機時間

---

### 階段 2：Canary 發布（25 分鐘）

**Canary 策略**：
```yaml
# .github/workflows/canary-deploy.yml
name: Canary Deployment

jobs:
  canary:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Canary (5% traffic)
        run: |
          kubectl set image deployment/myapp myapp=myapp:${{ github.sha }}
          kubectl scale deployment/myapp-canary --replicas=1
          
          # Istio virtual service
          kubectl apply -f - <<EOF
          apiVersion: networking.istio.io/v1beta1
          kind: VirtualService
          metadata:
            name: myapp
          spec:
            hosts:
            - myapp.example.com
            http:
            - match:
              - headers:
                  canary:
                    exact: "true"
              route:
              - destination:
                  host: myapp-canary
                weight: 100
            - route:
              - destination:
                  host: myapp-stable
                weight: 95
              - destination:
                  host: myapp-canary
                weight: 5
          EOF

      - name: Monitor Canary (10 min)
        run: |
          for i in {1..60}; do
            ERROR_RATE=$(curl -s prometheus:9090/api/v1/query?query='rate(http_requests_total{status=~"5..",deployment="canary"}[5m])' | jq -r '.data.result[0].value[1]')
            
            if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
              echo "❌ Canary error rate too high: $ERROR_RATE"
              exit 1
            fi
            
            sleep 10
          done

      - name: Promote Canary (100% traffic)
        run: |
          kubectl scale deployment/myapp-canary --replicas=10
          kubectl scale deployment/myapp-stable --replicas=0
```

**檢查點 2**：
- [ ] Canary 部署成功
- [ ] 流量逐步增加
- [ ] 自動監控指標
- [ ] 異常自動回退

---

### 階段 3：災難恢復計劃（20 分鐘）

**災難恢復腳本**（`scripts/disaster_recovery.sh`）：
```bash
#!/bin/bash
set -e

echo "🚨 Initiating disaster recovery..."

# 1. 停止所有新流量
echo "Step 1: Stopping incoming traffic"
kubectl scale deployment/myapp --replicas=0

# 2. 備份當前狀態
echo "Step 2: Creating backup"
pg_dump $DATABASE_URL > disaster_backup_$(date +%Y%m%d_%H%M%S).sql

# 3. 恢復最後一個已知良好版本
echo "Step 3: Restoring last known good version"
LAST_GOOD_VERSION=$(cat last_good_version.txt)
kubectl set image deployment/myapp myapp=$LAST_GOOD_VERSION

# 4. 恢復資料庫（如果需要）
if [ "$RESTORE_DB" = "true" ]; then
    echo "Step 4: Restoring database"
    psql $DATABASE_URL < $BACKUP_FILE
fi

# 5. 重啟服務
echo "Step 5: Restarting services"
kubectl scale deployment/myapp --replicas=10

# 6. 驗證恢復
echo "Step 6: Verifying recovery"
for i in {1..30}; do
    if curl -f https://myapp.com/health; then
        echo "✅ Service recovered successfully"
        exit 0
    fi
    sleep 10
done

echo "❌ Recovery failed"
exit 1
```

**災難演練 Workflow**：
```yaml
# .github/workflows/disaster-drill.yml
name: Disaster Recovery Drill

on:
  schedule:
    - cron: '0 0 1 * *'  # 每月 1 號

jobs:
  drill:
    runs-on: ubuntu-latest

    steps:
      - name: Simulate disaster
        run: |
          # 在 staging 環境模擬災難
          kubectl delete deployment myapp -n staging

      - name: Execute recovery
        run: |
          bash scripts/disaster_recovery.sh

      - name: Verify recovery
        run: |
          pytest tests/critical/ --base-url=https://staging.myapp.com

      - name: Generate drill report
        run: |
          echo "## Disaster Recovery Drill Report" > report.md
          echo "Date: $(date)" >> report.md
          echo "Recovery Time: $RECOVERY_TIME seconds" >> report.md
          echo "Status: ${{ job.status }}" >> report.md

      - name: Create issue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Monthly Disaster Recovery Drill Report',
              body: report,
              labels: ['disaster-recovery', 'drill']
            });
```

**檢查點 3**：
- [ ] 災難恢復腳本完整
- [ ] 定期演練執行
- [ ] 恢復時間 < 5 分鐘
- [ ] 報告自動生成

---

### 階段 4：自動回退觸發（15 分鐘）

**自動回退邏輯**：
```yaml
# .github/workflows/auto-rollback.yml
name: Auto Rollback

on:
  deployment_status:

jobs:
  monitor-and-rollback:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Monitor deployment (5 min)
        id: monitor
        run: |
          START_TIME=$(date +%s)
          
          while [ $(($(date +%s) - START_TIME)) -lt 300 ]; do
            # 檢查錯誤率
            ERROR_RATE=$(curl -s prometheus:9090/api/v1/query?query='rate(http_requests_total{status=~"5.."}[5m])' | jq -r '.data.result[0].value[1]')
            
            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
              echo "trigger_rollback=true" >> $GITHUB_OUTPUT
              break
            fi
            
            # 檢查 P95 延遲
            P95=$(curl -s prometheus:9090/api/v1/query?query='histogram_quantile(0.95, http_request_duration_seconds_bucket)' | jq -r '.data.result[0].value[1]')
            
            if (( $(echo "$P95 > 0.5" | bc -l) )); then
              echo "trigger_rollback=true" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep 30
          done

      - name: Trigger rollback
        if: steps.monitor.outputs.trigger_rollback == 'true'
        run: |
          echo "🚨 Auto-rollback triggered due to abnormal metrics"
          
          # 執行回退
          kubectl rollout undo deployment/myapp
          
          # 通知團隊
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text": "🚨 Auto-rollback triggered for deployment ${{ github.event.deployment.id }}"}'
```

**檢查點 4**：
- [ ] 自動監控指標
- [ ] 異常自動觸發回退
- [ ] 回退執行成功
- [ ] 團隊收到通知

---

## 🎯 學習檢查點

### 技術能力
- [ ] 實現 Blue-Green 部署
- [ ] 實現 Canary 發布
- [ ] 建立災難恢復計劃
- [ ] 完成自動回退機制

### 可靠性指標
- [ ] 回退時間 < 5 分鐘
- [ ] 零數據丟失
- [ ] 演練定期執行
- [ ] RTO < 10 分鐘

---

## 💡 延伸挑戰

### 挑戰 1：多區域災難恢復
- 跨區域備份
- 自動 failover
- 資料一致性

### 挑戰 2：Chaos Engineering
- 定期混沌測試
- 故障注入
- 韌性驗證

### 挑戰 3：時間旅行回退
- 任意時間點恢復
- Point-in-time recovery
- 變更歷史追蹤

---

## 📚 參考資源

- [Blue-Green Deployment](https://martinfowler.com/bliki/BlueGreenDeployment.html)
- [Canary Release](https://martinfowler.com/bliki/CanaryRelease.html)
- [Disaster Recovery Planning](https://cloud.google.com/architecture/dr-scenarios-planning-guide)
- [Chaos Engineering](https://principlesofchaos.org/)

---

**恭喜完成所有組合級情境！** 現在可以挑戰 **E01：企業級完整 DevOps 管線** 或 **E02：微服務架構 CI/CD**！
