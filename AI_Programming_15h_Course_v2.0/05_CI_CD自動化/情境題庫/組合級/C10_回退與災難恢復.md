# C10ï¼šå›é€€èˆ‡ç½é›£æ¢å¾© â­

## ğŸ“‹ æƒ…å¢ƒè³‡è¨Š

**é›£åº¦ç­‰ç´š**ï¼šâ­â­ çµ„åˆç´š
**é ä¼°æ™‚é–“**ï¼š1.5-2 å°æ™‚
**æ ¸å¿ƒæŠ€èƒ½**ï¼šå›é€€ç­–ç•¥ã€ç½é›£æ¢å¾©ã€Blue-Green éƒ¨ç½²ã€Canary ç™¼å¸ƒ
**å‰ç½®çŸ¥è­˜**ï¼šçµ„åˆç´š C02ã€C04

---

## ğŸ¯ æƒ…å¢ƒèƒŒæ™¯

ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¤±æ•—,ä½†å›é€€è…³æœ¬æœªç¶“æ¸¬è©¦å°è‡´ 8 å°æ™‚åœæ©Ÿã€‚ä½ çš„ä»»å‹™æ˜¯å»ºç«‹å®Œæ•´çš„å›é€€èˆ‡ç½é›£æ¢å¾©ç³»çµ±ã€‚

**ç›®æ¨™**ï¼š
- å›é€€æ™‚é–“ < 5 åˆ†é˜
- é›¶æ•¸æ“šä¸Ÿå¤±
- å®Œæ•´æ¼”ç·´æ–‡æª”
- è‡ªå‹•è§¸ç™¼å›é€€

---

## ğŸ¬ éšæ®µå±•é–‹

### éšæ®µ 1ï¼šBlue-Green éƒ¨ç½²ï¼ˆ30 åˆ†é˜ï¼‰

**Blue-Green ç­–ç•¥**ï¼š
```yaml
# .github/workflows/blue-green-deploy.yml
name: Blue-Green Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        options: [staging, production]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Green
        run: |
          # éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ° Green ç’°å¢ƒ
          railway deploy --service myapp-green --environment ${{ inputs.environment }}

      - name: Health check Green
        run: |
          for i in {1..30}; do
            if curl -f https://green.myapp.com/health; then
              echo "âœ… Green is healthy"
              break
            fi
            sleep 10
          done

      - name: Run smoke tests
        run: |
          pytest tests/smoke/ --base-url=https://green.myapp.com

      - name: Switch traffic to Green
        run: |
          # åˆ‡æ›æµé‡
          railway service update myapp --active green

      - name: Verify production
        run: |
          sleep 30
          pytest tests/critical/ --base-url=https://myapp.com

      - name: Rollback on failure
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed. Rolling back to Blue..."
          railway service update myapp --active blue
          
      - name: Decommission Blue
        if: success()
        run: |
          # 10 åˆ†é˜å¾Œä¸‹ç·š Blueï¼ˆç•™æ™‚é–“å¿«é€Ÿå›é€€ï¼‰
          sleep 600
          railway service stop myapp-blue
```

**æª¢æŸ¥é» 1**ï¼š
- [ ] Blue-Green éƒ¨ç½²æˆåŠŸ
- [ ] æµé‡åˆ‡æ›æ­£ç¢º
- [ ] å¤±æ•—è‡ªå‹•å›é€€
- [ ] é›¶åœæ©Ÿæ™‚é–“

---

### éšæ®µ 2ï¼šCanary ç™¼å¸ƒï¼ˆ25 åˆ†é˜ï¼‰

**Canary ç­–ç•¥**ï¼š
```yaml
# .github/workflows/canary-deploy.yml
name: Canary Deployment

jobs:
  canary:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Canary (5% traffic)
        run: |
          kubectl set image deployment/myapp myapp=myapp:${{ github.sha }}
          kubectl scale deployment/myapp-canary --replicas=1
          
          # Istio virtual service
          kubectl apply -f - <<EOF
          apiVersion: networking.istio.io/v1beta1
          kind: VirtualService
          metadata:
            name: myapp
          spec:
            hosts:
            - myapp.example.com
            http:
            - match:
              - headers:
                  canary:
                    exact: "true"
              route:
              - destination:
                  host: myapp-canary
                weight: 100
            - route:
              - destination:
                  host: myapp-stable
                weight: 95
              - destination:
                  host: myapp-canary
                weight: 5
          EOF

      - name: Monitor Canary (10 min)
        run: |
          for i in {1..60}; do
            ERROR_RATE=$(curl -s prometheus:9090/api/v1/query?query='rate(http_requests_total{status=~"5..",deployment="canary"}[5m])' | jq -r '.data.result[0].value[1]')
            
            if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
              echo "âŒ Canary error rate too high: $ERROR_RATE"
              exit 1
            fi
            
            sleep 10
          done

      - name: Promote Canary (100% traffic)
        run: |
          kubectl scale deployment/myapp-canary --replicas=10
          kubectl scale deployment/myapp-stable --replicas=0
```

**æª¢æŸ¥é» 2**ï¼š
- [ ] Canary éƒ¨ç½²æˆåŠŸ
- [ ] æµé‡é€æ­¥å¢åŠ 
- [ ] è‡ªå‹•ç›£æ§æŒ‡æ¨™
- [ ] ç•°å¸¸è‡ªå‹•å›é€€

---

### éšæ®µ 3ï¼šç½é›£æ¢å¾©è¨ˆåŠƒï¼ˆ20 åˆ†é˜ï¼‰

**ç½é›£æ¢å¾©è…³æœ¬**ï¼ˆ`scripts/disaster_recovery.sh`ï¼‰ï¼š
```bash
#!/bin/bash
set -e

echo "ğŸš¨ Initiating disaster recovery..."

# 1. åœæ­¢æ‰€æœ‰æ–°æµé‡
echo "Step 1: Stopping incoming traffic"
kubectl scale deployment/myapp --replicas=0

# 2. å‚™ä»½ç•¶å‰ç‹€æ…‹
echo "Step 2: Creating backup"
pg_dump $DATABASE_URL > disaster_backup_$(date +%Y%m%d_%H%M%S).sql

# 3. æ¢å¾©æœ€å¾Œä¸€å€‹å·²çŸ¥è‰¯å¥½ç‰ˆæœ¬
echo "Step 3: Restoring last known good version"
LAST_GOOD_VERSION=$(cat last_good_version.txt)
kubectl set image deployment/myapp myapp=$LAST_GOOD_VERSION

# 4. æ¢å¾©è³‡æ–™åº«ï¼ˆå¦‚æœéœ€è¦ï¼‰
if [ "$RESTORE_DB" = "true" ]; then
    echo "Step 4: Restoring database"
    psql $DATABASE_URL < $BACKUP_FILE
fi

# 5. é‡å•Ÿæœå‹™
echo "Step 5: Restarting services"
kubectl scale deployment/myapp --replicas=10

# 6. é©—è­‰æ¢å¾©
echo "Step 6: Verifying recovery"
for i in {1..30}; do
    if curl -f https://myapp.com/health; then
        echo "âœ… Service recovered successfully"
        exit 0
    fi
    sleep 10
done

echo "âŒ Recovery failed"
exit 1
```

**ç½é›£æ¼”ç·´ Workflow**ï¼š
```yaml
# .github/workflows/disaster-drill.yml
name: Disaster Recovery Drill

on:
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ 1 è™Ÿ

jobs:
  drill:
    runs-on: ubuntu-latest

    steps:
      - name: Simulate disaster
        run: |
          # åœ¨ staging ç’°å¢ƒæ¨¡æ“¬ç½é›£
          kubectl delete deployment myapp -n staging

      - name: Execute recovery
        run: |
          bash scripts/disaster_recovery.sh

      - name: Verify recovery
        run: |
          pytest tests/critical/ --base-url=https://staging.myapp.com

      - name: Generate drill report
        run: |
          echo "## Disaster Recovery Drill Report" > report.md
          echo "Date: $(date)" >> report.md
          echo "Recovery Time: $RECOVERY_TIME seconds" >> report.md
          echo "Status: ${{ job.status }}" >> report.md

      - name: Create issue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Monthly Disaster Recovery Drill Report',
              body: report,
              labels: ['disaster-recovery', 'drill']
            });
```

**æª¢æŸ¥é» 3**ï¼š
- [ ] ç½é›£æ¢å¾©è…³æœ¬å®Œæ•´
- [ ] å®šæœŸæ¼”ç·´åŸ·è¡Œ
- [ ] æ¢å¾©æ™‚é–“ < 5 åˆ†é˜
- [ ] å ±å‘Šè‡ªå‹•ç”Ÿæˆ

---

### éšæ®µ 4ï¼šè‡ªå‹•å›é€€è§¸ç™¼ï¼ˆ15 åˆ†é˜ï¼‰

**è‡ªå‹•å›é€€é‚è¼¯**ï¼š
```yaml
# .github/workflows/auto-rollback.yml
name: Auto Rollback

on:
  deployment_status:

jobs:
  monitor-and-rollback:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Monitor deployment (5 min)
        id: monitor
        run: |
          START_TIME=$(date +%s)
          
          while [ $(($(date +%s) - START_TIME)) -lt 300 ]; do
            # æª¢æŸ¥éŒ¯èª¤ç‡
            ERROR_RATE=$(curl -s prometheus:9090/api/v1/query?query='rate(http_requests_total{status=~"5.."}[5m])' | jq -r '.data.result[0].value[1]')
            
            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
              echo "trigger_rollback=true" >> $GITHUB_OUTPUT
              break
            fi
            
            # æª¢æŸ¥ P95 å»¶é²
            P95=$(curl -s prometheus:9090/api/v1/query?query='histogram_quantile(0.95, http_request_duration_seconds_bucket)' | jq -r '.data.result[0].value[1]')
            
            if (( $(echo "$P95 > 0.5" | bc -l) )); then
              echo "trigger_rollback=true" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep 30
          done

      - name: Trigger rollback
        if: steps.monitor.outputs.trigger_rollback == 'true'
        run: |
          echo "ğŸš¨ Auto-rollback triggered due to abnormal metrics"
          
          # åŸ·è¡Œå›é€€
          kubectl rollout undo deployment/myapp
          
          # é€šçŸ¥åœ˜éšŠ
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text": "ğŸš¨ Auto-rollback triggered for deployment ${{ github.event.deployment.id }}"}'
```

**æª¢æŸ¥é» 4**ï¼š
- [ ] è‡ªå‹•ç›£æ§æŒ‡æ¨™
- [ ] ç•°å¸¸è‡ªå‹•è§¸ç™¼å›é€€
- [ ] å›é€€åŸ·è¡ŒæˆåŠŸ
- [ ] åœ˜éšŠæ”¶åˆ°é€šçŸ¥

---

## ğŸ¯ å­¸ç¿’æª¢æŸ¥é»

### æŠ€è¡“èƒ½åŠ›
- [ ] å¯¦ç¾ Blue-Green éƒ¨ç½²
- [ ] å¯¦ç¾ Canary ç™¼å¸ƒ
- [ ] å»ºç«‹ç½é›£æ¢å¾©è¨ˆåŠƒ
- [ ] å®Œæˆè‡ªå‹•å›é€€æ©Ÿåˆ¶

### å¯é æ€§æŒ‡æ¨™
- [ ] å›é€€æ™‚é–“ < 5 åˆ†é˜
- [ ] é›¶æ•¸æ“šä¸Ÿå¤±
- [ ] æ¼”ç·´å®šæœŸåŸ·è¡Œ
- [ ] RTO < 10 åˆ†é˜

---

## ğŸ’¡ å»¶ä¼¸æŒ‘æˆ°

### æŒ‘æˆ° 1ï¼šå¤šå€åŸŸç½é›£æ¢å¾©
- è·¨å€åŸŸå‚™ä»½
- è‡ªå‹• failover
- è³‡æ–™ä¸€è‡´æ€§

### æŒ‘æˆ° 2ï¼šChaos Engineering
- å®šæœŸæ··æ²Œæ¸¬è©¦
- æ•…éšœæ³¨å…¥
- éŸŒæ€§é©—è­‰

### æŒ‘æˆ° 3ï¼šæ™‚é–“æ—…è¡Œå›é€€
- ä»»æ„æ™‚é–“é»æ¢å¾©
- Point-in-time recovery
- è®Šæ›´æ­·å²è¿½è¹¤

---

## ğŸ“š åƒè€ƒè³‡æº

- [Blue-Green Deployment](https://martinfowler.com/bliki/BlueGreenDeployment.html)
- [Canary Release](https://martinfowler.com/bliki/CanaryRelease.html)
- [Disaster Recovery Planning](https://cloud.google.com/architecture/dr-scenarios-planning-guide)
- [Chaos Engineering](https://principlesofchaos.org/)

---

**æ­å–œå®Œæˆæ‰€æœ‰çµ„åˆç´šæƒ…å¢ƒï¼** ç¾åœ¨å¯ä»¥æŒ‘æˆ° **E01ï¼šä¼æ¥­ç´šå®Œæ•´ DevOps ç®¡ç·š** æˆ– **E02ï¼šå¾®æœå‹™æ¶æ§‹ CI/CD**ï¼
