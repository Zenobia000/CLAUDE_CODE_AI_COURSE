# C09：通知與監控整合 ⭐

## 📋 情境資訊

**難度等級**：⭐⭐ 組合級
**預估時間**：1-1.5 小時
**核心技能**：通知整合、監控儀表板、告警規則、事件追蹤
**前置知識**：基礎級 B01-B06

---

## 🎯 情境背景

團隊在深夜發現生產環境故障,但沒有人收到告警。你的任務是建立完整的通知與監控系統。

**目標**：
- 所有關鍵事件通知
- 失敗 5 分鐘內告警
- 完整的部署追蹤
- 儀表板即時更新

---

## 🎬 階段展開

### 階段 1：Slack 通知整合（20 分鐘）

**Rich Slack Notifications**（`.github/workflows/notify.yml`）：
```yaml
name: Notifications

on:
  workflow_run:
    workflows: ["CI", "Deploy"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ github.event.workflow_run.conclusion }}
          custom_payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.event.workflow_run.name }} - ${{ github.event.workflow_run.conclusion }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.event.workflow_run.head_commit.url }}|${{ github.event.workflow_run.head_commit.id }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Duration:*\n${{ github.event.workflow_run.updated_at - github.event.workflow_run.created_at }}s"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

**檢查點 1**：
- [ ] Slack 通知發送成功
- [ ] 包含所有關鍵資訊
- [ ] 連結可點擊
- [ ] 格式美觀

---

### 階段 2：部署儀表板（20 分鐘）

**GitHub Pages Dashboard**（`scripts/generate_dashboard.py`）：
```python
import json
from datetime import datetime
from github import Github

def generate_dashboard():
    g = Github(os.getenv('GITHUB_TOKEN'))
    repo = g.get_repo('owner/repo')
    
    # 獲取最近部署
    deployments = list(repo.get_deployments()[:10])
    
    html = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>Deployment Dashboard</title>
        <meta http-equiv="refresh" content="60">
        <style>
            body {{ font-family: Arial; background: #1e1e1e; color: #fff; }}
            .deployment {{ border: 1px solid #444; margin: 10px; padding: 15px; }}
            .success {{ border-left: 5px solid #4caf50; }}
            .failure {{ border-left: 5px solid #f44336; }}
        </style>
    </head>
    <body>
        <h1>🚀 Deployment Dashboard</h1>
        <p>Last updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    """
    
    for deploy in deployments:
        status_class = 'success' if deploy.statuses[0].state == 'success' else 'failure'
        html += f"""
        <div class="deployment {status_class}">
            <h3>{deploy.environment}</h3>
            <p>Version: {deploy.ref}</p>
            <p>Status: {deploy.statuses[0].state}</p>
            <p>Time: {deploy.created_at}</p>
        </div>
        """
    
    html += "</body></html>"
    
    with open('dashboard.html', 'w') as f:
        f.write(html)

generate_dashboard()
```

**檢查點 2**：
- [ ] 儀表板自動生成
- [ ] 顯示最近部署
- [ ] 自動更新
- [ ] 狀態一目了然

---

### 階段 3：告警規則（15 分鐘）

**Prometheus 告警規則**（`alerts.yml`）：
```yaml
groups:
  - name: deployment_alerts
    rules:
      - alert: DeploymentFailed
        expr: deployment_status{status="failed"} == 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Deployment failed for {{ $labels.environment }}"
          
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
```

**檢查點 3**：
- [ ] 告警規則配置完成
- [ ] 測試觸發成功
- [ ] 通知渠道暢通
- [ ] 告警分級正確

---

### 階段 4：事件追蹤（10 分鐘）

**Sentry 整合**：
```yaml
- name: Report to Sentry
  if: failure()
  run: |
    curl -X POST https://sentry.io/api/0/projects/your-project/events/ \
      -H "Authorization: Bearer ${{ secrets.SENTRY_TOKEN }}" \
      -H "Content-Type: application/json" \
      -d '{
        "message": "Deployment failed",
        "level": "error",
        "tags": {
          "environment": "production",
          "version": "${{ github.sha }}"
        }
      }'
```

**檢查點 4**：
- [ ] 事件正確上報
- [ ] 包含上下文資訊
- [ ] 可追蹤
- [ ] 可分析趨勢

---

## 🎯 學習檢查點

- [ ] 完整通知系統
- [ ] 即時監控儀表板
- [ ] 分級告警機制
- [ ] 事件追蹤完整

---

## 💡 延伸挑戰

### 挑戰 1：自定義監控指標
- 業務指標監控
- 自訂 Prometheus exporter

### 挑戰 2：AI 異常檢測
- 使用機器學習檢測異常
- 自動調整告警閾值

---

## 📚 參考資源

- [Slack API](https://api.slack.com/)
- [Prometheus](https://prometheus.io/)
- [Sentry](https://sentry.io/)

---

**下一步**：完成後挑戰 **C10：回退與災難恢復**！
