# C01ï¼šå®‰å…¨æƒæç®¡ç·šå»ºç«‹ â­

## ğŸ“‹ æƒ…å¢ƒè³‡è¨Š

**é›£åº¦ç­‰ç´š**ï¼šâ­â­ çµ„åˆç´š
**é ä¼°æ™‚é–“**ï¼š1.5-2 å°æ™‚
**æ ¸å¿ƒæŠ€èƒ½**ï¼šå¤šå±¤å®‰å…¨æƒæã€SARIF æ•´åˆã€å®‰å…¨ç­–ç•¥åˆ¶å®š
**å‰ç½®çŸ¥è­˜**ï¼šåŸºç¤ç´š B01-B06 å…¨éƒ¨å®Œæˆ

---

## ğŸ¯ æƒ…å¢ƒèƒŒæ™¯

ä½ å‰›åŠ å…¥ä¸€å®¶é‡‘èç§‘æŠ€å…¬å¸ï¼Œè² è²¬å»ºç«‹ä¼æ¥­ç´šçš„å®‰å…¨æƒæç®¡ç·šã€‚é€™ä¸æ˜¯æ™®é€šçš„ startupï¼Œè€Œæ˜¯è™•ç†é‡‘èè³‡æ–™çš„å…¬å¸ï¼Œå®‰å…¨è¦æ±‚æ¥µå…¶åš´æ ¼ã€‚

**å…¬å¸ç¾æ³**ï¼š
- 40+ å€‹å¾®æœå‹™å°ˆæ¡ˆ
- æ¯å¤© 200+ æ¬¡ç¨‹å¼ç¢¼æäº¤
- è™•ç†æ•æ„Ÿé‡‘èè³‡æ–™ï¼ˆPCI DSS åˆè¦è¦æ±‚ï¼‰
- éå» 6 å€‹æœˆç™¼ç”Ÿ 3 æ¬¡å®‰å…¨äº‹ä»¶

**ä¸Šé€±çš„åš´é‡äº‹æ•…**ï¼š
```bash
# ç”Ÿç”¢ç’°å¢ƒæ´©éœ²äº‹ä»¶
æ—¥æœŸï¼š2024-10-25
å½±éŸ¿ï¼š8,000 ç”¨æˆ¶å€‹è³‡å¤–æ´©
åŸå› ï¼šé–‹ç™¼è€…åœ¨ç¨‹å¼ç¢¼ä¸­ç¡¬ç·¨ç¢¼ API å¯†é‘°
æå¤±ï¼šç½°é‡‘ 50 è¬ç¾å…ƒ + è²è­½æå¤±

# äº‹æ•…åˆ†æ
Root Causeï¼š
1. æ²’æœ‰è‡ªå‹•åŒ–å®‰å…¨æƒæ
2. Code Review æ²’æœ‰ç™¼ç¾ç¡¬ç·¨ç¢¼å¯†é‘°
3. éœæ…‹åˆ†æå·¥å…·è¦†è“‹åº¦ä¸è¶³
4. ç¬¬ä¸‰æ–¹ä¾è³´æœ‰æœªä¿®å¾©çš„ CVE
```

**CISOï¼ˆè³‡å®‰é•·ï¼‰çš„è¦æ±‚**ï¼š
> ã€Œæˆ‘å€‘éœ€è¦å»ºç«‹æ¥­ç•Œæœ€å¼·çš„è‡ªå‹•åŒ–å®‰å…¨æƒæç®¡ç·šã€‚æ¯ä¸€è¡Œç¨‹å¼ç¢¼ã€æ¯ä¸€å€‹ä¾è³´ã€æ¯ä¸€å€‹å®¹å™¨æ˜ åƒéƒ½å¿…é ˆç¶“éåš´æ ¼çš„å®‰å…¨æª¢æŸ¥æ‰èƒ½é€²å…¥ç”Ÿç”¢ç’°å¢ƒã€‚ã€

**å…·é«”è¦æ±‚**ï¼š
- **Zero Trust**ï¼šå‡è¨­æ‰€æœ‰ç¨‹å¼ç¢¼éƒ½æœ‰å•é¡Œ
- **å¤šå±¤é˜²ç¦¦**ï¼šè‡³å°‘ 5 ç¨®ä¸åŒçš„å®‰å…¨æƒæå·¥å…·
- **å³æ™‚é˜»æ“‹**ï¼šç™¼ç¾é«˜å±æ¼æ´ç«‹å³åœæ­¢ pipeline
- **åˆè¦å ±å‘Š**ï¼šç”¢ç”Ÿç¬¦åˆ SOC 2ã€PCI DSS çš„å®‰å…¨å ±å‘Š
- **é–‹ç™¼è€…å‹å–„**ï¼šæä¾›æ˜ç¢ºçš„ä¿®å¾©æŒ‡å°

**ä½ çš„ä»»å‹™**ï¼š
è¨­è¨ˆä¸¦å¯¦ä½œä¼æ¥­ç´šçš„å¤šå±¤å®‰å…¨æƒæç®¡ç·šï¼Œæ¶µè“‹éœæ…‹åˆ†æã€ä¾è³´æƒæã€å®¹å™¨å®‰å…¨ã€å¯†é‘°åµæ¸¬ç­‰å¤šå€‹é¢å‘ã€‚

---

## ğŸ“¦ å°ˆæ¡ˆçµæ§‹

é€™æ˜¯ä¸€å€‹è¤‡é›œçš„ FinTech å°ˆæ¡ˆï¼š

```
fintech-payment-service/
â”œâ”€â”€ backend/                           # å¾Œç«¯æœå‹™
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ auth/                     # èªè­‰æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ payments/                 # æ”¯ä»˜è™•ç†
â”‚   â”‚   â”œâ”€â”€ encryption/               # åŠ å¯†æ¨¡çµ„
â”‚   â”‚   â””â”€â”€ database/                 # è³‡æ–™åº«æ“ä½œ
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ frontend/                          # å‰ç«¯æ‡‰ç”¨
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ infrastructure/                    # åŸºç¤è¨­æ–½ä»£ç¢¼
â”‚   â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ kubernetes/
â”‚   â””â”€â”€ helm/
â”‚
â”œâ”€â”€ scripts/                          # è‡ªå‹•åŒ–è…³æœ¬
â”‚   â”œâ”€â”€ security/
â”‚   â””â”€â”€ deployment/
â”‚
â”œâ”€â”€ .github/
â”‚   â”œâ”€â”€ workflows/
â”‚   â”‚   â”œâ”€â”€ security-scan.yml        # ä¸»è¦å®‰å…¨æƒæ workflow
â”‚   â”‚   â”œâ”€â”€ dependency-check.yml     # ä¾è³´å®‰å…¨æª¢æŸ¥
â”‚   â”‚   â””â”€â”€ container-scan.yml       # å®¹å™¨å®‰å…¨æƒæ
â”‚   â”‚
â”‚   â””â”€â”€ security/                     # å®‰å…¨é…ç½®
â”‚       â”œâ”€â”€ codeql-config.yml
â”‚       â”œâ”€â”€ semgrep-rules.yml
â”‚       â””â”€â”€ security-policy.md
â”‚
â”œâ”€â”€ security/                         # å®‰å…¨ç›¸é—œæª”æ¡ˆ
â”‚   â”œâ”€â”€ policies/                     # å®‰å…¨æ”¿ç­–
â”‚   â”œâ”€â”€ reports/                      # æƒæå ±å‘Šæ¨¡æ¿
â”‚   â””â”€â”€ exceptions/                   # ä¾‹å¤–æ¸…å–®
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ security-guidelines.md
    â””â”€â”€ incident-response.md
```

**æœ‰å®‰å…¨å•é¡Œçš„ç¯„ä¾‹ç¨‹å¼ç¢¼**ï¼š

```python
# backend/src/payments/processor.py
import hashlib
import requests
from cryptography.fernet import Fernet

class PaymentProcessor:
    def __init__(self):
        # âŒ ç¡¬ç·¨ç¢¼å¯†é‘°ï¼ˆCritical æ¼æ´ï¼‰
        self.encryption_key = "gAAAAABhZ6J_secretkey12345"
        self.api_key = "sk_live_51234567890abcdef"

        # âŒ å¼±é›œæ¹Šç®—æ³•ï¼ˆHigh æ¼æ´ï¼‰
        self.hash_algo = hashlib.md5

        # âŒ ä¸å®‰å…¨çš„éš¨æ©Ÿæ•¸ç”Ÿæˆï¼ˆMedium æ¼æ´ï¼‰
        import random
        self.session_id = random.randint(1000, 9999)

    def process_payment(self, card_number, amount):
        # âŒ SQL æ³¨å…¥é¢¨éšªï¼ˆCritical æ¼æ´ï¼‰
        query = f"SELECT * FROM payments WHERE card='{card_number}'"

        # âŒ ä¸å®‰å…¨çš„ HTTP è«‹æ±‚ï¼ˆHigh æ¼æ´ï¼‰
        response = requests.get(
            f"http://payment-api.com/charge",
            params={"amount": amount, "card": card_number},
            verify=False  # âŒ å¿½ç•¥ SSL é©—è­‰
        )

        return response.json()

    def log_transaction(self, data):
        # âŒ æ•æ„Ÿè³‡æ–™è¨˜éŒ„ï¼ˆHigh æ¼æ´ï¼‰
        print(f"Processing payment: {data}")  # å¯èƒ½åŒ…å«å¡è™Ÿ
```

```javascript
// frontend/src/services/api.js
// âŒ å‰ç«¯ç¡¬ç·¨ç¢¼ API å¯†é‘°ï¼ˆCritical æ¼æ´ï¼‰
const API_KEY = 'pk_live_abcdef123456789';

// âŒ ä¸å®‰å…¨çš„ localStorage ä½¿ç”¨ï¼ˆMedium æ¼æ´ï¼‰
const AuthService = {
    login: (credentials) => {
        // âŒ å¯†ç¢¼æ˜æ–‡å‚³è¼¸ï¼ˆHigh æ¼æ´ï¼‰
        fetch('http://api.example.com/login', {
            method: 'POST',
            body: JSON.stringify(credentials), // æ²’æœ‰åŠ å¯†
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': API_KEY
            }
        }).then(response => {
            // âŒ ä¸å®‰å…¨çš„æœ¬åœ°å„²å­˜ï¼ˆMedium æ¼æ´ï¼‰
            localStorage.setItem('authToken', response.data.token);
            localStorage.setItem('userPassword', credentials.password);
        });
    }
};

// âŒ XSS é¢¨éšªï¼ˆHigh æ¼æ´ï¼‰
function displayMessage(message) {
    document.getElementById('output').innerHTML = message;
}
```

---

## ğŸ¯ ä»»å‹™ç›®æ¨™

### å¿…é”ç›®æ¨™ï¼ˆæ ¸å¿ƒè¦æ±‚ï¼‰
1. âœ… å»ºç«‹ **5 å±¤å®‰å…¨æƒæ**ï¼š
   - Layer 1: éœæ…‹ç¨‹å¼ç¢¼åˆ†æï¼ˆCodeQL + Semgrepï¼‰
   - Layer 2: ä¾è³´æ¼æ´æƒæï¼ˆSnyk + OWASP Dependency Checkï¼‰
   - Layer 3: å¯†é‘°å’Œæ•æ„Ÿè³‡æ–™åµæ¸¬ï¼ˆGitLeaks + TruffleHogï¼‰
   - Layer 4: å®¹å™¨æ˜ åƒæƒæï¼ˆTrivy + Grypeï¼‰
   - Layer 5: åŸºç¤è¨­æ–½å³ç¨‹å¼ç¢¼æƒæï¼ˆCheckov + Terrascanï¼‰

2. âœ… å¯¦ä½œ **æ¼æ´ç­‰ç´šç®¡æ§**ï¼š
   - Critical: ç«‹å³é˜»æ­¢ pipeline
   - High: é˜»æ­¢ä½†å…è¨±ä¾‹å¤–æ ¸å‡†
   - Medium: è­¦å‘Šä½†å…è¨±ç¹¼çºŒ
   - Low: è¨˜éŒ„ä½†ä¸é˜»æ­¢

3. âœ… å»ºç«‹ **SARIF å ±å‘Šæ•´åˆ**ï¼š
   - çµ±ä¸€å ±å‘Šæ ¼å¼
   - GitHub Security tab æ•´åˆ
   - å¯è¦–åŒ–å®‰å…¨å„€è¡¨æ¿

4. âœ… è¨­è¨ˆ **å®‰å…¨æ”¿ç­–å¼•æ“**ï¼š
   - å¯é…ç½®çš„å®‰å…¨è¦å‰‡
   - ä¾‹å¤–ç®¡ç†æ©Ÿåˆ¶
   - åˆè¦å ±å‘Šç”Ÿæˆ

### åŠ åˆ†é …ç›®ï¼ˆé€²éšè¦æ±‚ï¼‰
- ğŸŒŸ æ•´åˆ **AI è¼”åŠ©æ¼æ´ä¿®å¾©**ï¼ˆGitHub Copilot Autofixï¼‰
- ğŸŒŸ å»ºç«‹ **å®‰å…¨æŒ‡æ¨™è¿½è¹¤**ï¼ˆå®‰å…¨å‚µå‹™ã€ä¿®å¾©æ™‚é–“ï¼‰
- ğŸŒŸ å¯¦ä½œ **å³æ™‚å®‰å…¨ç›£æ§**ï¼ˆWebhook é€šçŸ¥ï¼‰
- ğŸŒŸ è¨­è¨ˆ **å®‰å…¨åŸ¹è¨“æ•´åˆ**ï¼ˆè‡ªå‹•åˆ†æ´¾å­¸ç¿’è³‡æºï¼‰

---

## ğŸ“š å­¸ç¿’æª¢æŸ¥é»

å®Œæˆæ­¤æƒ…å¢ƒé¡Œæ™‚ï¼Œè«‹ç¢ºèªä½ èƒ½å›ç­”ï¼š

### Checkpoint 1ï¼šä¼æ¥­å®‰å…¨ç­–ç•¥
- [ ] ä»€éº¼æ˜¯ Zero Trust å®‰å…¨æ¨¡å‹ï¼Ÿå¦‚ä½•åœ¨ CI/CD ä¸­å¯¦ä½œï¼Ÿ
- [ ] PCI DSS å’Œ SOC 2 å°ç¨‹å¼ç¢¼å®‰å…¨æœ‰ä»€éº¼è¦æ±‚ï¼Ÿ
- [ ] å¦‚ä½•è¨­è¨ˆå¤šå±¤å®‰å…¨é˜²ç¦¦ç­–ç•¥ï¼Ÿ
- [ ] ä»€éº¼æ˜¯å®‰å…¨å·¦ç§»ï¼ˆShift Security Leftï¼‰ï¼Ÿ

### Checkpoint 2ï¼šå®‰å…¨æƒæå·¥å…·ç”Ÿæ…‹
- [ ] CodeQL vs Semgrep vs SonarQube çš„å·®ç•°å’Œé©ç”¨å ´æ™¯ï¼Ÿ
- [ ] SASTã€DASTã€IASTã€SCA åˆ†åˆ¥æ˜¯ä»€éº¼ï¼Ÿ
- [ ] SARIF æ ¼å¼çš„å„ªå‹¢å’Œç”¨é€”ï¼Ÿ
- [ ] å¦‚ä½•é¸æ“‡å’Œçµ„åˆä¸åŒçš„å®‰å…¨å·¥å…·ï¼Ÿ

### Checkpoint 3ï¼šä¼æ¥­ç´šå¯¦ä½œæŒ‘æˆ°
- [ ] å¦‚ä½•è™•ç†å¤§é‡èª¤å ±ï¼ˆFalse Positiveï¼‰ï¼Ÿ
- [ ] å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œé–‹ç™¼æ•ˆç‡ï¼Ÿ
- [ ] å¦‚ä½•ç®¡ç†å®‰å…¨ä¾‹å¤–å’Œé¢¨éšªæ¥å—ï¼Ÿ
- [ ] å¦‚ä½•å»ºç«‹å®‰å…¨æŒ‡æ¨™å’Œ KPIï¼Ÿ

---

## ğŸš€ å¯¦ä½œæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå®‰å…¨æƒææ¶æ§‹è¨­è¨ˆ

é¦–å…ˆè¨­è¨ˆå®Œæ•´çš„å®‰å…¨æƒææ¶æ§‹ï¼š

```yaml
# .github/workflows/security-comprehensive.yml
name: Comprehensive Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥æ·±åº¦æƒæ
  workflow_dispatch:
    inputs:
      scan_level:
        description: 'Security scan level'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - comprehensive

env:
  SECURITY_SCAN_LEVEL: ${{ github.event.inputs.scan_level || 'standard' }}

jobs:
  # å®‰å…¨æƒæå”èª¿å™¨
  security-orchestrator:
    name: Security Scan Orchestrator
    runs-on: ubuntu-latest
    outputs:
      scan-matrix: ${{ steps.matrix.outputs.matrix }}
      should-run-comprehensive: ${{ steps.decide.outputs.comprehensive }}

    steps:
    - name: Determine scan strategy
      id: decide
      run: |
        case "$SECURITY_SCAN_LEVEL" in
          "quick")
            echo "comprehensive=false" >> $GITHUB_OUTPUT
            ;;
          "comprehensive")
            echo "comprehensive=true" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "comprehensive=${{ github.event_name == 'schedule' }}" >> $GITHUB_OUTPUT
            ;;
        esac

    - name: Generate scan matrix
      id: matrix
      run: |
        if [ "${{ steps.decide.outputs.comprehensive }}" = "true" ]; then
          MATRIX='[
            {"tool": "codeql", "languages": ["python", "javascript"], "queries": "security-extended"},
            {"tool": "semgrep", "config": "auto", "rules": "security,secrets"},
            {"tool": "snyk", "type": "code,deps,docker", "severity": "medium"},
            {"tool": "gitleaks", "config": "extended", "rules": "all"},
            {"tool": "trivy", "scanners": "vuln,secret,config", "severity": "medium"},
            {"tool": "checkov", "frameworks": "terraform,kubernetes", "check": "CKV_*"}
          ]'
        else
          MATRIX='[
            {"tool": "codeql", "languages": ["python", "javascript"], "queries": "security-only"},
            {"tool": "semgrep", "config": "auto", "rules": "security"},
            {"tool": "snyk", "type": "deps", "severity": "high"}
          ]'
        fi

        echo "matrix=$(echo $MATRIX | jq -c .)" >> $GITHUB_OUTPUT

  # Layer 1: éœæ…‹ç¨‹å¼ç¢¼åˆ†æ
  static-analysis:
    name: Layer 1 - Static Code Analysis
    needs: security-orchestrator
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    strategy:
      matrix:
        include: ${{ fromJson(needs.security-orchestrator.outputs.scan-matrix) }}
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´æ­·å²è¨˜éŒ„ï¼ˆæŸäº›å·¥å…·éœ€è¦ï¼‰

    # CodeQL æƒæ
    - name: Initialize CodeQL
      if: matrix.tool == 'codeql'
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ join(matrix.languages, ',') }}
        queries: ${{ matrix.queries }}
        config-file: ./.github/security/codeql-config.yml

    - name: Autobuild
      if: matrix.tool == 'codeql'
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      if: matrix.tool == 'codeql'
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.languages[0] }}"

    # Semgrep æƒæ
    - name: Run Semgrep
      if: matrix.tool == 'semgrep'
      uses: semgrep/semgrep-action@v1
      with:
        config: ${{ matrix.config }}
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

    # Snyk ç¨‹å¼ç¢¼æƒæ
    - name: Run Snyk Code
      if: matrix.tool == 'snyk' && contains(matrix.type, 'code')
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --sarif-file-output=snyk-code.sarif --severity-threshold=${{ matrix.severity }}
        command: code test

    # ä¸Šå‚³ SARIF çµæœ
    - name: Upload SARIF results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: "*.sarif"
        category: "${{ matrix.tool }}"

  # Layer 2: ä¾è³´å®‰å…¨æƒæ
  dependency-security:
    name: Layer 2 - Dependency Security
    needs: security-orchestrator
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # Python ä¾è³´æƒæ
    - name: Python dependency scan
      run: |
        pip install safety pip-audit

        echo "ğŸ” Running safety check..."
        safety check --json --output safety-report.json || true

        echo "ğŸ” Running pip-audit..."
        pip-audit --format=json --output=pip-audit-report.json || true

    # Node.js ä¾è³´æƒæ
    - name: Node.js dependency scan
      if: hashFiles('**/package.json') != ''
      run: |
        cd frontend
        npm audit --audit-level moderate --json > npm-audit-report.json || true

    # OWASP Dependency Check
    - name: OWASP Dependency Check
      if: needs.security-orchestrator.outputs.should-run-comprehensive == 'true'
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'fintech-payment-service'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --nvdApiKey ${{ secrets.NVD_API_KEY }}

    # Snyk ä¾è³´æƒæ
    - name: Snyk dependency scan
      uses: snyk/actions/python-3.10@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --json-file-output=snyk-deps.json
        command: test

    # åˆ†æä¾è³´æƒæçµæœ
    - name: Analyze dependency scan results
      run: |
        python3 << 'EOF'
        import json
        import os

        reports = {
            'safety': 'safety-report.json',
            'pip-audit': 'pip-audit-report.json',
            'npm-audit': 'frontend/npm-audit-report.json',
            'snyk': 'snyk-deps.json'
        }

        total_vulns = 0
        critical_vulns = 0
        high_vulns = 0

        for tool, report_file in reports.items():
            if os.path.exists(report_file):
                try:
                    with open(report_file, 'r') as f:
                        data = json.load(f)

                    # æ ¹æ“šä¸åŒå·¥å…·è§£ææ¼æ´æ•¸é‡
                    tool_vulns = 0
                    if tool == 'safety' and isinstance(data, list):
                        tool_vulns = len(data)
                        critical_vulns += len([v for v in data if v.get('severity') == 'critical'])
                        high_vulns += len([v for v in data if v.get('severity') == 'high'])
                    elif tool == 'snyk' and 'vulnerabilities' in data:
                        tool_vulns = len(data['vulnerabilities'])
                        critical_vulns += len([v for v in data['vulnerabilities'] if v.get('severity') == 'critical'])
                        high_vulns += len([v for v in data['vulnerabilities'] if v.get('severity') == 'high'])

                    total_vulns += tool_vulns
                    print(f"{tool}: {tool_vulns} vulnerabilities")

                except Exception as e:
                    print(f"Error parsing {tool} report: {e}")

        print(f"\nTotal vulnerabilities: {total_vulns}")
        print(f"Critical: {critical_vulns}")
        print(f"High: {high_vulns}")

        # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"TOTAL_VULNS={total_vulns}\n")
            f.write(f"CRITICAL_VULNS={critical_vulns}\n")
            f.write(f"HIGH_VULNS={high_vulns}\n")

        # æ ¹æ“šä¼æ¥­å®‰å…¨æ”¿ç­–æ±ºå®šæ˜¯å¦å¤±æ•—
        if critical_vulns > 0:
            print("âŒ CRITICAL vulnerabilities found - blocking pipeline")
            exit(1)
        elif high_vulns > 5:  # å¯é…ç½®çš„é–¾å€¼
            print("âš ï¸ Too many HIGH vulnerabilities - requires security team approval")
            exit(1)
        EOF

    # ä¸Šå‚³ä¾è³´æƒæå ±å‘Š
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-security-reports
        path: |
          *-report.json
          reports/

  # Layer 3: å¯†é‘°å’Œæ•æ„Ÿè³‡æ–™åµæ¸¬
  secrets-detection:
    name: Layer 3 - Secrets Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # GitLeaks æƒæ
    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    # TruffleHog æƒæ
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    # è‡ªè¨‚å¯†é‘°æ¨¡å¼æƒæ
    - name: Custom secrets scan
      run: |
        echo "ğŸ” Running custom secrets patterns..."

        # å®šç¾©é‡‘èè¡Œæ¥­ç‰¹æœ‰çš„æ•æ„Ÿæ¨¡å¼
        python3 << 'EOF'
        import re
        import os
        import json

        # é‡‘èæ¥­å¸¸è¦‹çš„æ•æ„Ÿæ¨¡å¼
        patterns = {
            'credit_card': r'\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3[0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\b',
            'bank_account': r'\b[0-9]{8,17}\b',
            'ssn': r'\b(?!000)(?!666)(?:[0-6]\d{2}|7[0-6]\d|77[0-2])(?!00)\d{2}(?!0000)\d{4}\b',
            'api_key_stripe': r'sk_live_[0-9a-zA-Z]{24}',
            'api_key_generic': r'[a-zA-Z0-9]{32,}',
            'jwt_token': r'eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*',
            'private_key': r'-----BEGIN [A-Z]+ PRIVATE KEY-----',
        }

        findings = []

        for root, dirs, files in os.walk('.'):
            # è·³é .git å’Œ node_modules
            dirs[:] = [d for d in dirs if d not in ['.git', 'node_modules', '__pycache__']]

            for file in files:
                if file.endswith(('.py', '.js', '.ts', '.jsx', '.tsx', '.json', '.yml', '.yaml')):
                    file_path = os.path.join(root, file)
                    try:
                        with open(file_path, 'r', encoding='utf-8') as f:
                            content = f.read()

                        for pattern_name, pattern in patterns.items():
                            matches = re.finditer(pattern, content, re.IGNORECASE)
                            for match in matches:
                                line_num = content[:match.start()].count('\n') + 1
                                findings.append({
                                    'file': file_path,
                                    'line': line_num,
                                    'pattern': pattern_name,
                                    'match': match.group()[:20] + '...' if len(match.group()) > 20 else match.group()
                                })
                    except Exception as e:
                        continue

        if findings:
            print(f"âŒ Found {len(findings)} potential secrets:")
            for finding in findings:
                print(f"  {finding['file']}:{finding['line']} - {finding['pattern']}: {finding['match']}")

            # å„²å­˜çµæœ
            with open('custom-secrets-report.json', 'w') as f:
                json.dump(findings, f, indent=2)

            # æ ¹æ“šä¼æ¥­æ”¿ç­–æ±ºå®šæ˜¯å¦é˜»æ­¢
            critical_patterns = ['credit_card', 'bank_account', 'ssn', 'private_key']
            critical_findings = [f for f in findings if f['pattern'] in critical_patterns]

            if critical_findings:
                print("âŒ Critical secrets found - blocking pipeline")
                exit(1)
        else:
            print("âœ… No secrets detected")
        EOF

  # Layer 4: å®¹å™¨å®‰å…¨æƒæ
  container-security:
    name: Layer 4 - Container Security
    runs-on: ubuntu-latest
    if: hashFiles('**/Dockerfile') != ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # å»ºæ§‹æ˜ åƒç”¨æ–¼æƒæ
    - name: Build images for scanning
      run: |
        docker build -t backend-scan:latest ./backend
        docker build -t frontend-scan:latest ./frontend

    # Trivy å®¹å™¨æƒæ
    - name: Run Trivy scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'backend-scan:latest'
        format: 'sarif'
        output: 'trivy-backend.sarif'

    - name: Run Trivy scan (Frontend)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'frontend-scan:latest'
        format: 'sarif'
        output: 'trivy-frontend.sarif'

    # Grype å®¹å™¨æƒæï¼ˆé¡å¤–å±¤ç´šï¼‰
    - name: Run Grype scan
      if: needs.security-orchestrator.outputs.should-run-comprehensive == 'true'
      uses: anchore/scan-action@v3
      with:
        image: "backend-scan:latest"
        fail-build: false
        acs-report-enable: true

    # Docker Bench å®‰å…¨æª¢æŸ¥
    - name: Docker Bench Security
      if: needs.security-orchestrator.outputs.should-run-comprehensive == 'true'
      run: |
        docker run --rm --net host --pid host --userns host --cap-add audit_control \
          -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
          -v /etc:/etc:ro \
          -v /usr/bin/docker-containerd:/usr/bin/docker-containerd:ro \
          -v /usr/bin/docker-runc:/usr/bin/docker-runc:ro \
          -v /usr/lib/systemd:/usr/lib/systemd:ro \
          -v /var/lib:/var/lib:ro \
          -v /var/run/docker.sock:/var/run/docker.sock:ro \
          --label docker_bench_security \
          docker/docker-bench-security

    # ä¸Šå‚³å®¹å™¨æƒæçµæœ
    - name: Upload container scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: trivy-*.sarif

  # Layer 5: åŸºç¤è¨­æ–½å³ç¨‹å¼ç¢¼æƒæ
  infrastructure-security:
    name: Layer 5 - Infrastructure Security
    runs-on: ubuntu-latest
    if: hashFiles('infrastructure/**') != ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Checkov æƒæ
    - name: Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: infrastructure/
        framework: terraform,kubernetes,dockerfile
        output_format: sarif
        output_file_path: checkov-report.sarif

    # Terrascan æƒæ
    - name: Run Terrascan
      uses: tenable/terrascan-action@main
      with:
        iac_type: 'terraform'
        iac_dir: 'infrastructure/terraform'
        policy_type: 'all'
        only_warn: true
        sarif_upload: true

    # Kubesec æƒæ Kubernetes é…ç½®
    - name: Run Kubesec
      if: hashFiles('infrastructure/kubernetes/**') != ''
      run: |
        docker run --rm -v $PWD:/app kubesec/kubesec:latest scan /app/infrastructure/kubernetes/*.yaml > kubesec-report.json

  # å®‰å…¨å ±å‘Šå½™ç¸½
  security-summary:
    name: Security Summary & Policy Enforcement
    needs: [static-analysis, dependency-security, secrets-detection, container-security, infrastructure-security]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate comprehensive security report
      run: |
        echo "# ğŸ›¡ï¸ Comprehensive Security Scan Report" > security-summary.md
        echo "" >> security-summary.md
        echo "**Scan Date:** $(date -u)" >> security-summary.md
        echo "**Commit:** ${{ github.sha }}" >> security-summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
        echo "" >> security-summary.md

        # å½™ç¸½å„å±¤ç´šçš„çµæœ
        echo "## ğŸ“Š Security Layers Summary" >> security-summary.md
        echo "" >> security-summary.md
        echo "| Layer | Tool | Status | Critical | High | Medium | Low |" >> security-summary.md
        echo "|-------|------|--------|----------|------|--------|-----|" >> security-summary.md

        # è™•ç†å„ç¨®å ±å‘Šæ ¼å¼ä¸¦å½™ç¸½
        python3 << 'EOF'
        import json
        import os
        import glob

        # å½™ç¸½é‚è¼¯æœƒæ ¹æ“šå¯¦éš›å ±å‘Šæ ¼å¼å¯¦ä½œ
        print("Processing security reports...")

        # æª¢æŸ¥æ˜¯å¦æœ‰é˜»æ–·æ€§å•é¡Œ
        total_critical = int(os.getenv('CRITICAL_VULNS', 0))
        total_high = int(os.getenv('HIGH_VULNS', 0))

        if total_critical > 0:
            print(f"âŒ Found {total_critical} CRITICAL vulnerabilities - Pipeline BLOCKED")
            exit(1)
        elif total_high > 10:  # ä¼æ¥­æ”¿ç­–ï¼šè¶…é 10 å€‹é«˜å±æ¼æ´éœ€è¦å®‰å…¨åœ˜éšŠæ ¸å‡†
            print(f"âš ï¸ Found {total_high} HIGH vulnerabilities - Requires security approval")
            # åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œé€™è£¡æœƒè§¸ç™¼å®‰å…¨åœ˜éšŠå¯©æ ¸æµç¨‹
        else:
            print("âœ… Security scan passed enterprise policy")
        EOF

    - name: Generate step summary
      if: always()
      run: |
        if [ -f security-summary.md ]; then
          cat security-summary.md >> $GITHUB_STEP_SUMMARY
        fi

    # ç™¼é€çµ¦å®‰å…¨åœ˜éšŠçš„è©³ç´°å ±å‘Š
    - name: Send security report to team
      if: env.CRITICAL_VULNS > 0 || env.HIGH_VULNS > 5
      uses: actions/github-script@v6
      with:
        script: |
          // åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œé€™è£¡æœƒç™¼é€åˆ° Slack/Teams/Email
          console.log('Security alert sent to security team');

```

ç”±æ–¼é€™æ˜¯ä¸€å€‹éå¸¸è¤‡é›œçš„ä¼æ¥­ç´šå®‰å…¨æƒæç®¡ç·šï¼Œæˆ‘å»ºè­°åœ¨å¯¦éš›å¯¦ä½œæ™‚ï¼š

1. **åˆ†éšæ®µå¯¦æ–½**ï¼šå…ˆå¾åŸºç¤çš„ 2-3 ç¨®å·¥å…·é–‹å§‹ï¼Œé€æ­¥å¢åŠ 
2. **èª¿æ•´é–¾å€¼**ï¼šæ ¹æ“šå°ˆæ¡ˆçš„å¯¦éš›æƒ…æ³èª¿æ•´æ¼æ´å®¹å¿åº¦
3. **å·¥å…·æ•´åˆ**ï¼šç¢ºä¿å„ç¨®å·¥å…·çš„ç‰ˆæœ¬ç›¸å®¹æ€§å’Œ SARIF æ ¼å¼æ”¯æ´
4. **æ•ˆèƒ½å„ªåŒ–**ï¼šä½¿ç”¨å¹³è¡ŒåŒ–å’Œå¿«å–ä¾†æ¸›å°‘æƒææ™‚é–“
5. **èª¤å ±è™•ç†**ï¼šå»ºç«‹ç™½åå–®æ©Ÿåˆ¶è™•ç†å·²çŸ¥çš„èª¤å ±

---

## âœ… åƒè€ƒè§£ç­”é‡é»

### ä¼æ¥­ç´šå®‰å…¨æƒæçš„é—œéµè¨­è¨ˆåŸå‰‡

1. **å¤šå±¤é˜²ç¦¦**ï¼šä¸ä¾è³´å–®ä¸€å·¥å…·ï¼Œæ¯å±¤è§£æ±ºä¸åŒé¡å‹çš„å®‰å…¨å•é¡Œ
2. **æ™ºèƒ½èª¿åº¦**ï¼šæ ¹æ“šè®Šæ›´ç¯„åœå’Œé¢¨éšªç­‰ç´šé¸æ“‡æƒææ·±åº¦
3. **æ”¿ç­–é©±å‹•**ï¼šå®‰å…¨è¦å‰‡å¯é…ç½®ï¼Œæ”¯æ´ä¸åŒå°ˆæ¡ˆå’Œåˆè¦è¦æ±‚
4. **é–‹ç™¼è€…å‹å–„**ï¼šæä¾›æ¸…æ¥šçš„ä¿®å¾©æŒ‡å°ï¼Œä¸åªæ˜¯å•é¡Œæ¸…å–®

### æˆåŠŸæ¨™æº–

å®Œæˆæ­¤æƒ…å¢ƒé¡Œå¾Œï¼Œä½ æ‡‰è©²èƒ½å¤ ï¼š
- âœ… è¨­è¨ˆä¼æ¥­ç´šçš„å¤šå±¤å®‰å…¨æƒææ¶æ§‹
- âœ… æ•´åˆè‡³å°‘ 5 ç¨®ä¸åŒé¡å‹çš„å®‰å…¨å·¥å…·
- âœ… å»ºç«‹åŸºæ–¼é¢¨éšªçš„å®‰å…¨æ”¿ç­–å¼•æ“
- âœ… ç”Ÿæˆç¬¦åˆåˆè¦è¦æ±‚çš„å®‰å…¨å ±å‘Š
- âœ… å¯¦ä½œè‡ªå‹•åŒ–çš„å®‰å…¨ä¾‹å¤–ç®¡ç†

---

**æ­å–œå®Œæˆ C01ï¼** é€™æ˜¯çµ„åˆç´šæƒ…å¢ƒä¸­æœ€è¤‡é›œçš„ä¸€å€‹ï¼Œå¦‚æœä½ èƒ½å®Œæˆé€™å€‹æŒ‘æˆ°ï¼Œå°±å·²ç¶“å…·å‚™äº†ä¼æ¥­ç´š DevSecOps å·¥ç¨‹å¸«çš„æ ¸å¿ƒæŠ€èƒ½ã€‚

**ä¸‹ä¸€æ­¥**ï¼šç¹¼çºŒæŒ‘æˆ°å…¶ä»–çµ„åˆç´šæƒ…å¢ƒï¼Œæˆ–è€…æ ¹æ“šä½ çš„å¯¦éš›éœ€æ±‚é¸æ“‡ç›¸é—œçš„é€²éšä¸»é¡Œã€‚