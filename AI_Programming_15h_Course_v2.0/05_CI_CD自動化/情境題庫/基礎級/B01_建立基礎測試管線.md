# B01：建立基礎測試管線

## 📋 情境資訊

**難度等級**：⭐ 基礎級
**預估時間**：30 分鐘
**核心技能**：GitHub Actions、pytest、基本 workflow 配置
**前置知識**：理論 5.1（GitHub Actions 整合）

---

## 🎯 情境背景

你加入了一個小型開發團隊,正在開發一個 Python FastAPI 專案。

**現況問題**：
- 每次提交程式碼前,開發者需要手動執行 `pytest`
- 經常有人忘記測試就直接 push,導致 main 分支被破壞
- 每次 code review 都要先問：「你測試過了嗎？」
- 昨天有一次忘記測試,部署到生產環境才發現 bug

**團隊決定**：
> 「我們需要自動化測試！每次 push 和 PR 都要自動執行測試。」

**你的任務**：
為專案建立一個基礎的 GitHub Actions workflow,在每次 push 和 pull request 時自動執行 pytest 測試。

---

## 📦 專案結構

```
my-fastapi-project/
├── app/
│   ├── __init__.py
│   ├── main.py           # FastAPI 應用
│   └── models.py         # 資料模型
│
├── tests/
│   ├── __init__.py
│   ├── test_main.py      # 測試檔案
│   └── test_models.py
│
├── requirements.txt      # 依賴清單
├── .gitignore
└── README.md
```

**requirements.txt 內容**：
```
fastapi==0.104.1
uvicorn==0.24.0
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.1
```

**測試範例（tests/test_main.py）**：
```python
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_read_root():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello World"}

def test_health_check():
    response = client.get("/health")
    assert response.status_code == 200
```

---

## 🎯 任務目標

### 必達目標
1. ✅ 建立 `.github/workflows/test.yml` 檔案
2. ✅ Workflow 在以下情況觸發：
   - Push 到 `main` 或 `develop` 分支
   - 建立或更新 Pull Request 到 `main` 分支
3. ✅ Workflow 執行步驟：
   - 檢出代碼
   - 設置 Python 3.11 環境
   - 安裝依賴（requirements.txt）
   - 執行 pytest 測試
4. ✅ 在 GitHub Actions tab 看到測試執行結果

### 加分項目
- 🌟 使用 pip 快取加速依賴安裝
- 🌟 產生測試報告
- 🌟 設定 PR 保護規則（測試通過才能合併）

---

## 📚 學習檢查點

完成此情境題時,請確認你能回答：

### Checkpoint 1：理解 Workflow 結構
- [ ] 什麼是 workflow？
- [ ] `on` 關鍵字的作用是什麼？
- [ ] `jobs` 和 `steps` 的關係是什麼？

### Checkpoint 2：觸發條件
- [ ] 如何設定在 push 時觸發？
- [ ] 如何設定在 PR 時觸發？
- [ ] 如何限定特定分支？

### Checkpoint 3：執行環境
- [ ] `runs-on: ubuntu-latest` 是什麼意思？
- [ ] 為什麼需要 `actions/checkout@v4`？
- [ ] 如何設置 Python 環境？

### Checkpoint 4：測試執行
- [ ] 如何安裝依賴？
- [ ] 如何執行 pytest？
- [ ] 如何查看測試結果？

---

## 🚀 實作步驟

### 方法 1：用 Claude 生成（推薦）

#### 步驟 1：準備提示詞

複製以下提示詞,貼到 Claude：

```
我有一個 Python FastAPI 專案,結構如下：
- 主程式：app/main.py
- 測試：tests/test_main.py
- 依賴：requirements.txt

請幫我建立一個 GitHub Actions workflow（.github/workflows/test.yml）：

要求：
1. 在 push 到 main 或 develop 分支時觸發
2. 在對 main 的 Pull Request 時觸發
3. 使用 Python 3.11
4. 安裝 requirements.txt 的依賴
5. 執行 pytest 測試
6. 使用 pip 快取加速

請提供完整的 YAML 配置,並加上詳細註解。
```

#### 步驟 2：建立 Workflow 檔案

```bash
# 在專案根目錄
mkdir -p .github/workflows
cd .github/workflows

# 建立 test.yml
vim test.yml
# 將 Claude 生成的內容貼上
```

#### 步驟 3：提交並推送

```bash
git add .github/workflows/test.yml
git commit -m "ci: add automated testing workflow"
git push origin main
```

#### 步驟 4：查看執行結果

1. 前往 GitHub 專案頁面
2. 點選 `Actions` tab
3. 看到你的 workflow 正在執行

### 方法 2：手動編寫（學習用）

如果你想深入理解每個部分,可以手動編寫：

#### 步驟 1：建立檔案

```bash
mkdir -p .github/workflows
touch .github/workflows/test.yml
```

#### 步驟 2：逐步編寫 Workflow

**2.1 基本結構**：
```yaml
name: Test

on:
  # 觸發條件（稍後填寫）

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 步驟（稍後填寫）
```

**2.2 設定觸發條件**：
```yaml
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
```

**2.3 設定執行步驟**：
```yaml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # Step 1: 檢出代碼
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: 設置 Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Step 3: 安裝依賴
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: 執行測試
      - name: Run tests
        run: pytest
```

#### 步驟 3：加入快取（優化）

```yaml
- name: Cache pip packages
  uses: actions/cache@v3
  with:
    path: ~/.cache/pip
    key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    restore-keys: |
      ${{ runner.os }}-pip-
```

#### 步驟 4：完整配置

組合所有部分,完成 `test.yml`。

---

## ✅ 參考解答

### 基礎版本

```yaml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
        run: pytest
```

### 優化版本（加入快取）

```yaml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 快取 pip 套件
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with verbose output
      run: pytest -v
```

### 完整版本（加入測試報告）

```yaml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with coverage
      run: |
        pip install pytest-cov
        pytest --cov=app --cov-report=term --cov-report=xml

    # 產生測試摘要
    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        pytest --tb=line >> $GITHUB_STEP_SUMMARY || true
```

---

## 🎓 理解生成的配置

### 逐行解析

```yaml
# Workflow 名稱（會顯示在 GitHub UI）
name: Test

# 觸發條件
on:
  push:                         # Push 事件
    branches: [main, develop]   # 只在這些分支
  pull_request:                 # PR 事件
    branches: [main]            # 只對 main 的 PR

# 定義工作
jobs:
  test:                         # Job ID
    runs-on: ubuntu-latest      # 執行環境

    steps:                      # 步驟清單
    # 步驟 1：檢出代碼
    - name: Checkout code       # 步驟名稱
      uses: actions/checkout@v4 # 使用官方 action

    # 步驟 2：設置 Python
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:                     # 傳遞參數
        python-version: '3.11'

    # 步驟 3：快取（加速）
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip      # 快取路徑
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        # key 包含 OS 和 requirements.txt 的 hash
        # 如果檔案改變,hash 改變,快取失效

    # 步驟 4：安裝依賴
    - name: Install dependencies
      run: |                    # 執行 shell 命令
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 步驟 5：執行測試
    - name: Run tests
      run: pytest -v            # verbose 輸出
```

### 關鍵概念

**1. 為什麼需要 `actions/checkout@v4`？**
```
GitHub Actions 執行環境是空的 VM
需要先檢出你的代碼
就像 git clone 一樣
```

**2. 快取的原理？**
```
第一次執行：
  - 安裝所有依賴（慢）
  - 將 ~/.cache/pip 存起來

第二次執行：
  - 檢查 key（基於 requirements.txt 的 hash）
  - 如果 key 相同 → 恢復快取（快）
  - 如果 key 不同 → 重新安裝

結果：從 2 分鐘降到 30 秒
```

**3. `${{ }}` 是什麼？**
```
GitHub Actions 的表達式語法
類似模板引擎

${{ runner.os }}           → 'Linux'
${{ github.sha }}          → commit hash
${{ hashFiles('*.txt') }}  → 檔案內容的 hash
```

---

## 🔍 驗證與除錯

### 驗證步驟

**1. 查看 Workflow 執行**
```
前往：https://github.com/你的帳號/你的專案/actions

應該看到：
✅ Test workflow
  ✅ Checkout code (1s)
  ✅ Set up Python (5s)
  ✅ Cache pip packages (2s)
  ✅ Install dependencies (30s)
  ✅ Run tests (3s)

總時間：約 41 秒
```

**2. 測試 PR 觸發**
```bash
# 建立新分支
git checkout -b feature/test-ci

# 做些改變
echo "# Test CI" >> README.md

# 提交
git add README.md
git commit -m "test: verify CI works"
git push origin feature/test-ci

# 在 GitHub 建立 PR
# 應該會自動觸發測試
```

**3. 測試失敗情況**
```python
# 故意寫一個失敗的測試
# tests/test_main.py
def test_should_fail():
    assert 1 == 2  # 這會失敗

# 提交後,workflow 應該失敗
# 觀察 GitHub 如何顯示失敗資訊
```

### 常見問題與解決

**問題 1：workflow 沒有執行**
```
檢查：
1. YAML 格式是否正確？（縮排很重要！）
2. 檔案路徑是否正確？（.github/workflows/）
3. 分支名稱是否匹配？

除錯：
- 前往 Actions tab 查看是否有錯誤訊息
- 檢查 YAML 語法：yamllint test.yml
```

**問題 2：測試執行失敗**
```
檢查：
1. 本機測試是否通過？（pytest）
2. requirements.txt 是否包含所有依賴？
3. 測試路徑是否正確？

除錯：
- 點進失敗的 step,查看詳細日誌
- 複製錯誤訊息,問 Claude
```

**問題 3：快取沒有生效**
```
檢查：
1. key 的格式是否正確？
2. requirements.txt 是否有變更？

驗證：
- 第一次執行：看到 "Cache not found"
- 第二次執行：看到 "Cache restored"
```

---

## 🌟 延伸挑戰

完成基礎版本後,嘗試以下挑戰：

### 挑戰 1：加入測試覆蓋率檢查
```yaml
- name: Run tests with coverage
  run: |
    pip install pytest-cov
    pytest --cov=app --cov-report=term --cov-report=xml

- name: Check coverage threshold
  run: |
    coverage report --fail-under=80
    # 如果覆蓋率 < 80%,workflow 失敗
```

### 挑戰 2：多版本 Python 測試
```yaml
strategy:
  matrix:
    python-version: ['3.9', '3.10', '3.11']
steps:
  - uses: actions/setup-python@v4
    with:
      python-version: ${{ matrix.python-version }}
  # ... 其他步驟
```

### 挑戰 3：設定 PR 保護規則
```
1. Settings → Branches → Branch protection rules
2. 選擇 main 分支
3. ✅ Require status checks to pass before merging
4. ✅ 選擇 "Test" workflow
5. Save

結果：測試不通過的 PR 無法合併
```

### 挑戰 4：在 PR 中顯示測試結果
```yaml
- name: Comment test results on PR
  if: github.event_name == 'pull_request'
  uses: actions/github-script@v6
  with:
    script: |
      const output = `## Test Results ✅
      All tests passed!
      Coverage: 85%
      `;
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: output
      });
```

---

## 📖 知識回顧

完成這個情境題後,你應該學會：

### 核心概念
- ✅ GitHub Actions 的基本結構（workflow, jobs, steps）
- ✅ 如何設定觸發條件（push, pull_request）
- ✅ 如何使用 Actions Marketplace 的 actions
- ✅ 如何執行 shell 命令

### 實戰技能
- ✅ 建立並配置 workflow 檔案
- ✅ 設置 Python 測試環境
- ✅ 使用快取加速 workflow
- ✅ 查看和除錯 workflow 執行結果

### 最佳實踐
- ✅ 用 AI 生成配置範本（節省時間）
- ✅ 加入快取優化效能
- ✅ 使用 verbose 輸出幫助除錯
- ✅ 設定 PR 保護規則確保品質

---

## 📝 學習筆記範本

```markdown
## B01 學習筆記

### 完成時間
[填寫]

### 遇到的問題
1. [問題描述]
   - 解決方案：[...]
2. [問題描述]
   - 解決方案：[...]

### 關鍵學習點
1. GitHub Actions 的 [...] 概念
2. 快取機制的 [...] 原理
3. [...] 的最佳實踐

### 下一步
- [ ] 應用到實際專案
- [ ] 完成挑戰 1
- [ ] 進入 B02
```

---

**恭喜完成 B01！** 繼續前往 `B02_配置程式碼品質檢查.md` →
