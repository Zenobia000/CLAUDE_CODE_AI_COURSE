# B02：配置程式碼品質檢查

## 📋 情境資訊

**難度等級**：⭐ 基礎級
**預估時間**：25 分鐘
**核心技能**：GitHub Actions、flake8、black、isort
**前置知識**：B01（建立基礎測試管線）

---

## 🎯 情境背景

你的團隊已經有了自動化測試（來自 B01），但發現了新問題：

**程式碼風格不一致**：
- 小明喜歡用單引號：`print('hello')`
- 小華喜歴用雙引號：`print("hello")`
- 小李不在乎縮排，混用 tabs 和 spaces
- 小王的 import 順序總是亂的

**昨天的 Code Review**：
```python
# 小明的程式碼
import sys,os
import requests
from app.models import User
def get_user(id):
    user=User.query.filter_by(id=id).first()
    if not user:return None
    return user

# 審查者：「這格式...眼睛好痛」
# 小明：「但是能跑啊！」
```

**團隊決定**：
> 「我們需要自動化程式碼品質檢查！統一格式，提升可讀性。」

**你的任務**：
在現有的測試管線中加入程式碼品質檢查工具（linting），確保程式碼符合 PEP 8 規範。

---

## 📦 專案結構

延續 B01 的專案：

```
my-fastapi-project/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── models.py
│   └── utils.py           # 新增：工具函式
│
├── tests/
│   ├── __init__.py
│   ├── test_main.py
│   └── test_models.py
│
├── requirements.txt
├── .github/
│   └── workflows/
│       └── test.yml       # 現有的測試 workflow
│
├── .gitignore
└── README.md
```

**有問題的程式碼範例（app/utils.py）**：
```python
import sys,os
import requests
from app.models import User

def get_user_data(id,format='json'):
    user=User.query.filter_by(id=id).first()
    if not user:return None

    data={'id':user.id,'name':user.name,'email':user.email}

    if format=='json':
        return data
    elif format=='xml':
        return f"<user><id>{data['id']}</id><name>{data['name']}</name></user>"
    else:return None
```

**問題列表**：
1. Import 順序不當（標準庫、第三方、本地混在一起）
2. 行長度超過 79 字元
3. 缺少空格（`id,format` 應該是 `id, format`）
4. 函式定義後缺少空行
5. 字典定義時缺少空格

---

## 🎯 任務目標

### 必達目標
1. ✅ 在現有 workflow 中加入 **flake8**（PEP 8 檢查）
2. ✅ 在現有 workflow 中加入 **black**（程式碼格式化檢查）
3. ✅ 在現有 workflow 中加入 **isort**（import 排序檢查）
4. ✅ 確保程式碼品質檢查在測試之前執行（快速失敗）
5. ✅ 在 GitHub Actions 中看到品質檢查結果

### 加分項目
- 🌟 建立 `.flake8` 配置檔案自訂規則
- 🌟 建立 `pyproject.toml` 統一工具配置
- 🌟 加入 **mypy** 型別檢查
- 🌟 設定行長度限制為 100 字元（現代標準）

---

## 📚 學習檢查點

完成此情境題時，請確認你能回答：

### Checkpoint 1：程式碼品質工具
- [ ] flake8 的作用是什麼？檢查哪些問題？
- [ ] black 和 flake8 的差別是什麼？
- [ ] isort 解決什麼問題？
- [ ] 為什麼品質檢查要在測試之前執行？

### Checkpoint 2：工具配置
- [ ] 如何設定 flake8 忽略特定規則？
- [ ] 如何統一 black 和 flake8 的行長度設定？
- [ ] pyproject.toml 的優勢是什麼？

### Checkpoint 3：CI/CD 整合
- [ ] 如何在 GitHub Actions 中安裝 linting 工具？
- [ ] 如何讓品質檢查失敗時阻止 workflow？
- [ ] 如何快速定位品質問題？

---

## 🚀 實作步驟

### 方法 1：用 Claude 生成（推薦）

#### 步驟 1：準備提示詞

```
我有一個 Python FastAPI 專案，已經有基礎的測試 workflow。

現在要加入程式碼品質檢查，請幫我修改 .github/workflows/test.yml：

當前 workflow：
[貼上你的 test.yml 內容]

新增需求：
1. 加入 flake8（PEP 8 檢查）
2. 加入 black（格式化檢查，不自動修改，只檢查）
3. 加入 isort（import 排序檢查）
4. 品質檢查要在測試之前執行
5. 設定行長度為 100 字元
6. 任何檢查失敗都要讓 workflow 失敗

請提供：
1. 修改後的完整 workflow
2. 建議的 pyproject.toml 配置
3. 在本機執行這些檢查的指令

請加上詳細註解說明。
```

#### 步驟 2：建立配置檔案

根據 Claude 的建議，建立 `pyproject.toml`：

```bash
# 在專案根目錄
touch pyproject.toml
# 將 Claude 生成的配置貼上
```

#### 步驟 3：修改 Workflow

```bash
# 備份現有檔案
cp .github/workflows/test.yml .github/workflows/test.yml.backup

# 修改 workflow
vim .github/workflows/test.yml
# 將 Claude 生成的內容貼上
```

#### 步驟 4：本機測試

在提交前，先在本機測試：

```bash
# 安裝工具
pip install flake8 black isort

# 執行檢查
flake8 app tests
black --check app tests
isort --check-only app tests

# 如果有問題，修復後再執行
```

### 方法 2：手動編寫（學習用）

#### 步驟 1：了解工具功能

**flake8**：檢查 PEP 8 規範
```bash
# 安裝
pip install flake8

# 檢查指定目錄
flake8 app tests

# 常見錯誤：
# E501: line too long
# E302: expected 2 blank lines
# W503: line break before binary operator
```

**black**：程式碼格式化
```bash
# 安裝
pip install black

# 檢查模式（不修改檔案）
black --check app tests

# 實際格式化（修改檔案）
black app tests
```

**isort**：import 排序
```bash
# 安裝
pip install isort

# 檢查模式
isort --check-only app tests

# 實際排序
isort app tests
```

#### 步驟 2：建立配置檔案

**pyproject.toml**：
```toml
[tool.black]
line-length = 100
target-version = ['py311']
include = '\.pyi?$'
extend-exclude = '''
/(
    \.eggs
  | \.git
  | \.venv
  | build
  | dist
)/
'''

[tool.isort]
profile = "black"
line_length = 100
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true

[tool.flake8]
max-line-length = 100
extend-ignore = ["E203", "W503"]
exclude = [".git", "__pycache__", "build", "dist", ".venv"]
```

#### 步驟 3：修改 Workflow

在現有的 `test.yml` 中加入品質檢查：

```yaml
name: Test and Quality Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: Code Quality Check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-quality-

    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Run flake8
      run: flake8 app tests --max-line-length=100

    - name: Check black formatting
      run: black --check app tests --line-length=100

    - name: Check import sorting
      run: isort --check-only app tests --profile=black

  test:
    needs: quality-check  # 品質檢查通過後才執行測試
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: pytest -v
```

---

## ✅ 參考解答

### 完整 Workflow（test.yml）

```yaml
name: Test and Quality Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Job 1: 程式碼品質檢查（快速失敗）
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache quality tools
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-quality-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-quality-

    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy

    - name: Run flake8 (PEP 8 check)
      run: |
        echo "🔍 Running flake8..."
        flake8 app tests --statistics

    - name: Check black formatting
      run: |
        echo "🎨 Checking black formatting..."
        black --check app tests --diff

    - name: Check import sorting (isort)
      run: |
        echo "📚 Checking import sorting..."
        isort --check-only app tests --diff

    - name: Run mypy (type checking)
      run: |
        echo "🔤 Running mypy type checking..."
        mypy app --ignore-missing-imports
      continue-on-error: true  # 型別檢查失敗不阻止 workflow

  # Job 2: 測試（依賴品質檢查通過）
  test:
    name: Run Tests
    needs: quality-check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with coverage
      run: |
        pip install pytest-cov
        pytest --cov=app --cov-report=term --cov-report=xml -v

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results 🧪" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Quality checks passed ✅" >> $GITHUB_STEP_SUMMARY
        echo "Tests completed ✅" >> $GITHUB_STEP_SUMMARY
```

### 配置檔案（pyproject.toml）

```toml
[tool.black]
line-length = 100
target-version = ['py311']
include = '\.pyi?$'
extend-exclude = '''
/(
    \.eggs
  | \.git
  | \.venv
  | build
  | dist
  | __pycache__
)/
'''

[tool.isort]
profile = "black"
line_length = 100
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
src_paths = ["app", "tests"]

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
no_implicit_optional = true
show_error_codes = true

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false
```

### 獨立的 flake8 配置（.flake8）

如果不用 pyproject.toml，可以建立 `.flake8`：

```ini
[flake8]
max-line-length = 100
extend-ignore =
    E203,  # whitespace before ':'
    W503,  # line break before binary operator
    E501,  # line too long (handled by black)
exclude =
    .git,
    __pycache__,
    build,
    dist,
    .venv,
    .tox
statistics = True
count = True
```

---

## 🔍 驗證與除錯

### 測試品質檢查

**1. 故意引入格式問題**

修改 `app/utils.py`：
```python
import sys,os  # 故意不加空格
import requests
from app.models import User

def get_user_data(id,format='json'):  # 故意不加空格
    user=User.query.filter_by(id=id).first()  # 故意不加空格
    if not user:return None  # 故意寫在同一行
    return {'id':user.id,'name':user.name}  # 故意不加空格
```

**2. 提交並觀察**

```bash
git add .
git commit -m "test: add quality issues"
git push
```

應該看到 workflow 失敗，並顯示具體問題。

**3. 修復問題**

```bash
# 自動修復格式
black app tests
isort app tests

# 檢查修復結果
flake8 app tests
```

### 本機開發工作流程

**每次提交前執行**：
```bash
# 一鍵檢查腳本
echo '#!/bin/bash
echo "🔍 Running quality checks..."
flake8 app tests
black --check app tests
isort --check-only app tests
echo "✅ All quality checks passed!"
' > scripts/quality-check.sh

chmod +x scripts/quality-check.sh
./scripts/quality-check.sh
```

**自動修復腳本**：
```bash
echo '#!/bin/bash
echo "🛠️ Auto-fixing code quality..."
black app tests
isort app tests
echo "✅ Code formatted!"
echo "Please review changes and commit."
' > scripts/format-code.sh

chmod +x scripts/format-code.sh
./scripts/format-code.sh
```

### 常見問題與解決

**問題 1：black 和 flake8 衝突**
```
flake8 抱怨 E203: whitespace before ':'
但 black 就是這樣格式化的
```

**解決**：在 flake8 設定中忽略 E203
```ini
[flake8]
extend-ignore = E203, W503
```

**問題 2：import 順序檢查失敗**
```
isort 想要這樣：
import os
import sys

import requests

from app.models import User
```

**解決**：設定 isort 使用 black profile
```toml
[tool.isort]
profile = "black"
```

**問題 3：型別檢查太嚴格**
```
mypy: error: Function is missing a return type annotation
```

**解決**：針對測試檔案放寬限制
```toml
[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false
```

---

## 🌟 延伸挑戰

### 挑戰 1：Pre-commit Hook

在本機設定 pre-commit hook：

```bash
# 安裝 pre-commit
pip install pre-commit

# 建立 .pre-commit-config.yaml
cat > .pre-commit-config.yaml << EOF
repos:
  - repo: https://github.com/psf/black
    rev: 23.10.1
    hooks:
      - id: black
        language_version: python3.11

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort

  - repo: https://github.com/pycqa/flake8
    rev: 6.1.0
    hooks:
      - id: flake8
EOF

# 安裝 hook
pre-commit install

# 測試
pre-commit run --all-files
```

現在每次 `git commit` 都會自動執行檢查！

### 挑戰 2：自動修復 PR

建立可以自動修復格式的 workflow：

```yaml
name: Auto-fix Code Style

on:
  pull_request:
    branches: [main]

jobs:
  auto-fix:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install tools
      run: pip install black isort

    - name: Auto-fix formatting
      run: |
        black app tests
        isort app tests

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "style: auto-fix code formatting"
        git push
```

### 挑戰 3：品質報告

在 PR 中顯示品質檢查摘要：

```yaml
- name: Generate quality report
  if: github.event_name == 'pull_request'
  run: |
    echo "## Code Quality Report 📊" > quality-report.md
    echo "" >> quality-report.md

    echo "### flake8 Results" >> quality-report.md
    flake8 app tests --statistics >> quality-report.md || true

    echo "### black Check" >> quality-report.md
    black --check app tests >> quality-report.md 2>&1 || true

    echo "### isort Check" >> quality-report.md
    isort --check-only app tests >> quality-report.md 2>&1 || true

- name: Comment PR with quality report
  uses: actions/github-script@v6
  with:
    script: |
      const fs = require('fs');
      const report = fs.readFileSync('quality-report.md', 'utf8');
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: report
      });
```

---

## 📖 知識回顧

完成這個情境題後，你應該學會：

### 核心概念
- ✅ 程式碼品質工具的作用（flake8、black、isort）
- ✅ PEP 8 規範的重要性
- ✅ 自動化品質檢查的價值
- ✅ 工具配置的統一管理（pyproject.toml）

### 實戰技能
- ✅ 在 CI/CD 中整合品質檢查
- ✅ 設定工具配置檔案
- ✅ 本機開發工作流程優化
- ✅ 品質問題的除錯和修復

### 最佳實踐
- ✅ 品質檢查在測試之前執行（快速失敗）
- ✅ 統一工具配置避免衝突
- ✅ 本機和 CI 使用相同工具版本
- ✅ 自動化修復減少手動工作

### 進階概念
- ✅ Pre-commit hook 的設置
- ✅ 自動修復 workflow 的設計
- ✅ 品質報告的生成和展示

---

## 📝 學習筆記範本

```markdown
## B02 學習筆記

### 完成時間
[填寫]

### 工具理解
- **flake8**：[你的理解]
- **black**：[你的理解]
- **isort**：[你的理解]

### 配置要點
1. pyproject.toml 的優勢：[...]
2. 工具衝突的解決：[...]
3. 本機和 CI 的一致性：[...]

### 遇到的問題
1. [問題描述]
   - 解決方案：[...]
2. [問題描述]
   - 解決方案：[...]

### 關鍵學習點
1. [...]
2. [...]
3. [...]

### 應用到實際專案的計畫
- [ ] 加入品質檢查到現有專案
- [ ] 設定 pre-commit hook
- [ ] 統一團隊的程式碼風格

### 下一步
- [ ] 完成挑戰 1
- [ ] 進入 B03
```

---

**恭喜完成 B02！** 你已經學會建立自動化的程式碼品質檢查。接下來前往 `B03_整合靜態分析.md`，學習更深入的安全掃描技術。