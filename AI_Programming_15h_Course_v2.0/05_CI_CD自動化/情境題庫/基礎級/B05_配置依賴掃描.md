# B05ï¼šé…ç½®ä¾è³´æƒæ

## ğŸ“‹ æƒ…å¢ƒè³‡è¨Š

**é›£åº¦ç­‰ç´š**ï¼šâ­ åŸºç¤ç´š
**é ä¼°æ™‚é–“**ï¼š25 åˆ†é˜
**æ ¸å¿ƒæŠ€èƒ½**ï¼šDependabotã€Snykã€ä¾è³´å®‰å…¨ç®¡ç†
**å‰ç½®çŸ¥è­˜**ï¼šB04ï¼ˆå»ºç«‹Dockeræ§‹å»ºæµç¨‹ï¼‰

---

## ğŸ¯ æƒ…å¢ƒèƒŒæ™¯

ä½ çš„åœ˜éšŠç¾åœ¨æœ‰äº†å®Œæ•´çš„ CI/CD ç®¡ç·šï¼Œä½†æ˜¨å¤©ç™¼ç”Ÿäº†ä¸€å€‹è®“æ‰€æœ‰äººéƒ½å†’å†·æ±—çš„äº‹ä»¶ï¼š

**ä¾è³´æ¼æ´äº‹ä»¶**ï¼š
```bash
# æ˜ŸæœŸä¸€æ—©ä¸Š
$ npm audit  # ç¿’æ…£æ€§æª¢æŸ¥
Found 0 vulnerabilities

# æ˜ŸæœŸä¸‰ä¸‹åˆ
$ npm audit
Found 15 vulnerabilities (2 critical, 5 high, 8 moderate)

# ğŸš¨ CRITICAL: Remote Code Execution in 'some-package'
# ğŸš¨ HIGH: SQL Injection in 'another-library'
```

**äº‹ä»¶å›é¡§**ï¼š
- å°ˆæ¡ˆä½¿ç”¨äº† 50+ å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶
- å…¶ä¸­ `requests` å¥—ä»¶æœ‰æ–°ç™¼ç¾çš„ CVE-2023-32681
- `pillow` æ˜ åƒè™•ç†å¥—ä»¶æœ‰åš´é‡çš„è¨˜æ†¶é«”æº¢å‡ºæ¼æ´
- é€™äº›å¥—ä»¶æ¯å¤©éƒ½å¯èƒ½å‡ºç¾æ–°æ¼æ´ï¼Œæ‰‹å‹•æª¢æŸ¥æ ¹æœ¬è·Ÿä¸ä¸Š

**æ›´ç³Ÿçš„æ˜¯**ï¼š
```python
# requirements.txt
requests==2.25.1  # âŒ 2 å¹´å‰çš„ç‰ˆæœ¬ï¼
pillow==8.1.0      # âŒ æœ‰å·²çŸ¥ CVE æ¼æ´
fastapi>=0.65.0    # âŒ å¤ªå¯¬æ³›ï¼Œå¯èƒ½å¼•å…¥ä¸ç›¸å®¹ç‰ˆæœ¬
```

**è³‡å®‰åœ˜éšŠçš„æœ€å¾Œé€šç‰’**ï¼š
> ã€Œä¾è³´æ¼æ´æ˜¯æ”»æ“Šè€…æœ€å¸¸åˆ©ç”¨çš„å…¥å£é»ï¼ä½ å€‘å¿…é ˆå»ºç«‹è‡ªå‹•åŒ–ä¾è³´æƒæå’Œæ›´æ–°æ©Ÿåˆ¶ã€‚ã€

**åœ˜éšŠæ±ºå®š**ï¼š
> ã€Œå»ºç«‹ä¾è³´å®‰å…¨ç›£æ§ï¼Œè‡ªå‹•åµæ¸¬ä¸¦ä¿®å¾©ä¾è³´æ¼æ´ã€‚ã€

**ä½ çš„ä»»å‹™**ï¼š
åœ¨ç¾æœ‰çš„ CI/CD ç®¡ç·šä¸­åŠ å…¥ä¾è³´æƒææ©Ÿåˆ¶ï¼Œè‡ªå‹•åµæ¸¬ä¾è³´æ¼æ´ä¸¦ç®¡ç†å¥—ä»¶æ›´æ–°ã€‚

---

## ğŸ“¦ å°ˆæ¡ˆçµæ§‹

å»¶çºŒ B04 çš„å°ˆæ¡ˆï¼š

```
my-fastapi-project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ utils.py
â”‚   â””â”€â”€ security.py
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_main.py
â”‚   â””â”€â”€ test_security.py
â”‚
â”œâ”€â”€ requirements.txt           # æœ‰éæ™‚ä¾è³´çš„æª”æ¡ˆ
â”œâ”€â”€ requirements-dev.txt       # æ–°å¢ï¼šé–‹ç™¼ä¾è³´
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ .bandit
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .github/
â”‚   â”œâ”€â”€ dependabot.yml        # æ–°å¢ï¼šDependabot é…ç½®
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ test.yml          # ç¾æœ‰çš„å®Œæ•´ CI workflow
â”‚
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

**æœ‰å•é¡Œçš„ä¾è³´æª”æ¡ˆï¼ˆrequirements.txtï¼‰**ï¼š
```
# ç”Ÿç”¢ä¾è³´
fastapi==0.95.2        # âŒ éæ™‚ï¼Œæœ€æ–°æ˜¯ 0.104.1
uvicorn==0.20.0        # âŒ éæ™‚ï¼Œæœ€æ–°æ˜¯ 0.24.0
pydantic==1.10.5       # âŒ ä¸»ç‰ˆæœ¬éæ™‚ï¼Œæœ€æ–°æ˜¯ 2.4.2
requests==2.25.1       # âŒ æœ‰ CVE-2023-32681 æ¼æ´
pillow==8.1.0          # âŒ æœ‰å¤šå€‹ CVE æ¼æ´
cryptography==3.4.8   # âŒ æœ‰ CVE-2023-23931 æ¼æ´
```

**é–‹ç™¼ä¾è³´ï¼ˆrequirements-dev.txtï¼‰**ï¼š
```
# æ¸¬è©¦å·¥å…·
pytest==7.1.2         # âŒ å¯æ›´æ–°åˆ° 7.4.3
pytest-cov==4.0.0     # âŒ å¯æ›´æ–°
pytest-asyncio==0.20.3 # âŒ å¯æ›´æ–°

# ç¨‹å¼ç¢¼å“è³ª
black==22.3.0          # âŒ å¯æ›´æ–°åˆ° 23.10.1
flake8==4.0.1          # âŒ å¯æ›´æ–°
isort==5.10.1          # âŒ å¯æ›´æ–°

# å®‰å…¨æƒæ
bandit==1.7.4          # âŒ å¯æ›´æ–°
safety==2.3.1          # âŒ å¯æ›´æ–°
```

---

## ğŸ¯ ä»»å‹™ç›®æ¨™

### å¿…é”ç›®æ¨™
1. âœ… å•Ÿç”¨ä¸¦é…ç½® **GitHub Dependabot**
2. âœ… åœ¨ CI ä¸­æ•´åˆ **ä¾è³´æ¼æ´æƒæ**ï¼ˆsafetyï¼‰
3. âœ… åœ¨ CI ä¸­æ•´åˆ **Snyk** é€²éšæƒæ
4. âœ… è¨­å®šè‡ªå‹•åŒ–çš„ **PR å»ºç«‹** å’Œ **æ›´æ–°ç­–ç•¥**
5. âœ… å»ºç«‹ä¾è³´æ›´æ–°çš„ **å¯©æŸ¥å’Œæ¸¬è©¦æµç¨‹**

### åŠ åˆ†é …ç›®
- ğŸŒŸ è¨­å®š **è‡ªå‹•åˆä½µ** è£œä¸ç‰ˆæœ¬æ›´æ–°
- ğŸŒŸ å»ºç«‹ **ä¾è³´æ¼æ´å„€è¡¨æ¿**
- ğŸŒŸ é…ç½® **ç·Šæ€¥å®‰å…¨æ›´æ–°** æ©Ÿåˆ¶
- ğŸŒŸ æ•´åˆ **License åˆè¦æª¢æŸ¥**

---

## ğŸ“š å­¸ç¿’æª¢æŸ¥é»

å®Œæˆæ­¤æƒ…å¢ƒé¡Œæ™‚ï¼Œè«‹ç¢ºèªä½ èƒ½å›ç­”ï¼š

### Checkpoint 1ï¼šä¾è³´å®‰å…¨åŸºç¤
- [ ] ä»€éº¼æ˜¯ CVEï¼Ÿç‚ºä»€éº¼ä¾è³´æ¼æ´å±éšªï¼Ÿ
- [ ] Dependabot çš„å·¥ä½œåŸç†æ˜¯ä»€éº¼ï¼Ÿ
- [ ] èªæ„ç‰ˆæœ¬ï¼ˆSemVerï¼‰çš„è¦å‰‡æ˜¯ä»€éº¼ï¼Ÿ
- [ ] ç›´æ¥ä¾è³´ vs é–“æ¥ä¾è³´çš„å·®åˆ¥ï¼Ÿ

### Checkpoint 2ï¼šæƒæå·¥å…·
- [ ] safety å’Œ Snyk çš„å·®åˆ¥æ˜¯ä»€éº¼ï¼Ÿ
- [ ] å¦‚ä½•è®€æ‡‚ä¾è³´æ¼æ´å ±å‘Šï¼Ÿ
- [ ] ä»€éº¼æƒ…æ³ä¸‹æ‡‰è©²ç«‹å³æ›´æ–°ä¾è³´ï¼Ÿ
- [ ] å¦‚ä½•è™•ç†æœ‰ç ´å£æ€§è®Šæ›´çš„æ›´æ–°ï¼Ÿ

### Checkpoint 3ï¼šè‡ªå‹•åŒ–ç­–ç•¥
- [ ] å¦‚ä½•è¨­å®šä¸åŒæ›´æ–°é »ç‡ï¼Ÿ
- [ ] ä»€éº¼æ˜¯ä¾è³´é–å®šï¼ˆdependency pinningï¼‰ï¼Ÿ
- [ ] å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œç©©å®šæ€§ï¼Ÿ

---

## ğŸš€ å¯¦ä½œæ­¥é©Ÿ

### æ–¹æ³• 1ï¼šç”¨ Claude ç”Ÿæˆï¼ˆæ¨è–¦ï¼‰

#### æ­¥é©Ÿ 1ï¼šæº–å‚™æç¤ºè©

```
æˆ‘éœ€è¦ç‚º Python FastAPI å°ˆæ¡ˆå»ºç«‹å®Œæ•´çš„ä¾è³´å®‰å…¨ç®¡ç†ã€‚

ç•¶å‰ç‹€æ³ï¼š
- æœ‰ requirements.txtï¼ˆç”Ÿç”¢ä¾è³´ï¼‰
- æœ‰ requirements-dev.txtï¼ˆé–‹ç™¼ä¾è³´ï¼‰
- å°ˆæ¡ˆä½¿ç”¨ GitHub Actions åš CI/CD
- å·²æœ‰å®Œæ•´çš„æ¸¬è©¦ã€å“è³ªæª¢æŸ¥ã€å®‰å…¨æƒææµç¨‹

éœ€æ±‚ï¼š
1. é…ç½® GitHub Dependabot è‡ªå‹•åµæ¸¬éæœŸä¾è³´
2. åœ¨ CI ä¸­åŠ å…¥ä¾è³´æ¼æ´æƒæï¼ˆsafetyã€Snykï¼‰
3. è¨­å®šè‡ªå‹• PR å»ºç«‹å’Œåˆä½µç­–ç•¥
4. å€åˆ†ä¸åŒåš´é‡ç­‰ç´šçš„è™•ç†æ–¹å¼

è«‹æä¾›ï¼š
1. å®Œæ•´çš„ .github/dependabot.yml é…ç½®
2. ä¿®æ”¹å¾Œçš„ GitHub Actions workflow
3. ä¾è³´æ¼æ´è™•ç†çš„æœ€ä½³å¯¦è¸
4. æœ¬æ©Ÿæª¢æŸ¥ä¾è³´çš„æŒ‡ä»¤

è«‹åŠ ä¸Šè©³ç´°è¨»è§£èªªæ˜ç­–ç•¥è€ƒé‡ã€‚
```

#### æ­¥é©Ÿ 2ï¼šå»ºç«‹ Dependabot é…ç½®

```bash
# å»ºç«‹ dependabot é…ç½®
mkdir -p .github
touch .github/dependabot.yml
# å°‡ Claude ç”Ÿæˆçš„é…ç½®è²¼ä¸Š
```

#### æ­¥é©Ÿ 3ï¼šä¿®æ”¹ç¾æœ‰ Workflow

å°‡ä¾è³´æƒææ•´åˆåˆ°ç¾æœ‰çš„ CI workflow ä¸­ã€‚

#### æ­¥é©Ÿ 4ï¼šæ¸¬è©¦é…ç½®

```bash
# æœ¬æ©Ÿæ¸¬è©¦ä¾è³´æƒæ
pip install safety
safety check

# æˆ–ä½¿ç”¨ Snyk CLI
npm install -g snyk
snyk test --file=requirements.txt
```

### æ–¹æ³• 2ï¼šæ‰‹å‹•é…ç½®ï¼ˆå­¸ç¿’ç”¨ï¼‰

#### æ­¥é©Ÿ 1ï¼šäº†è§£å·¥å…·

**Dependabot**ï¼š
- GitHub åŸç”Ÿçš„ä¾è³´ç®¡ç†æ©Ÿå™¨äºº
- è‡ªå‹•åµæ¸¬éæœŸä¾è³´å’Œå®‰å…¨æ¼æ´
- è‡ªå‹•å»ºç«‹ PR æ›´æ–°ä¾è³´
- æ”¯æ´å¤šç¨®èªè¨€å’Œå¥—ä»¶ç®¡ç†å™¨

**safety**ï¼š
- Python å®‰å…¨è³‡æ–™åº«æª¢æŸ¥å·¥å…·
- å…è²»ä¸”è¼•é‡ç´š
- æª¢æŸ¥å·²çŸ¥çš„ CVE æ¼æ´

**Snyk**ï¼š
- å•†æ¥­ç´šå®‰å…¨æƒæå¹³å°
- æ›´å…¨é¢çš„æ¼æ´è³‡æ–™åº«
- æä¾›ä¿®å¾©å»ºè­°

#### æ­¥é©Ÿ 2ï¼šå»ºç«‹ Dependabot é…ç½®

`.github/dependabot.yml`ï¼š

```yaml
version: 2

updates:
  # Python ä¾è³´æƒæ
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
    open-pull-requests-limit: 10

    # è‡ªå‹•åˆä½µè¦å‰‡
    allow:
      - dependency-type: "all"

    # ç‰ˆæœ¬æ›´æ–°ç­–ç•¥
    versioning-strategy: "increase"

    # åˆ†çµ„æ›´æ–°ï¼ˆæ¸›å°‘ PR æ•¸é‡ï¼‰
    groups:
      production-dependencies:
        patterns:
          - "fastapi"
          - "uvicorn"
          - "pydantic"
        update-types:
          - "minor"
          - "patch"

      development-dependencies:
        patterns:
          - "pytest*"
          - "black"
          - "flake8"
          - "isort"
        update-types:
          - "minor"
          - "patch"

  # GitHub Actions ä¾è³´
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    open-pull-requests-limit: 5

  # Docker ä¾è³´
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 3
```

#### æ­¥é©Ÿ 3ï¼šä¿®æ”¹ CI Workflow

åœ¨ç¾æœ‰ workflow ä¸­åŠ å…¥ä¾è³´æƒæ jobï¼š

```yaml
# åœ¨ç¾æœ‰ workflow ä¸­åŠ å…¥
jobs:
  # ... ä¿ç•™ç¾æœ‰ jobs

  # æ–°å¢ï¼šä¾è³´å®‰å…¨æƒæ
  dependency-scan:
    name: Dependency Security Scan
    needs: quality-check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # safety æƒæ
    - name: Install safety
      run: |
        pip install safety

    - name: Run safety check
      id: safety
      run: |
        echo "ğŸ” Running safety check..."
        safety check --json --output safety-report.json
        safety check --short-report
      continue-on-error: true

    # Snyk æƒæï¼ˆéœ€è¦ tokenï¼‰
    - name: Run Snyk vulnerability scan
      if: vars.SNYK_TOKEN != ''
      uses: snyk/actions/python-3.10@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=requirements.txt

    # æª¢æŸ¥åš´é‡æ¼æ´
    - name: Check for critical vulnerabilities
      run: |
        if [ -f safety-report.json ]; then
          VULN_COUNT=$(cat safety-report.json | jq '. | length')
          echo "Found $VULN_COUNT vulnerabilities"

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "âŒ Found vulnerabilities in dependencies!"
            echo "Please review and update the affected packages."

            # é¡¯ç¤ºæ¼æ´è©³æƒ…
            cat safety-report.json | jq -r '.[] | "Package: \(.package) \(.installed_version) - \(.vulnerability)"'

            # å°æ–¼é«˜å±æ¼æ´ï¼Œè®“ workflow å¤±æ•—
            HIGH_VULN=$(cat safety-report.json | jq '[.[] | select(.severity == "high" or .severity == "critical")] | length')
            if [ "$HIGH_VULN" -gt 0 ]; then
              echo "âŒ Found $HIGH_VULN high/critical vulnerabilities!"
              exit 1
            fi
          else
            echo "âœ… No vulnerabilities found in dependencies."
          fi
        fi

    # ä¸Šå‚³å ±å‘Š
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-reports
        path: |
          safety-report.json
```

#### æ­¥é©Ÿ 4ï¼šè¨­å®š PR è‡ªå‹•åˆä½µ

å»ºç«‹é¡å¤–çš„ workflow è™•ç† Dependabot PRï¼š

`.github/workflows/dependabot-auto-merge.yml`ï¼š

```yaml
name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Fetch Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    # åªè‡ªå‹•åˆä½µè£œä¸ç‰ˆæœ¬
    - name: Auto-merge patch updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
      run: |
        echo "Auto-merging patch update for ${{ steps.metadata.outputs.dependency-names }}"
        gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # è‡ªå‹•æ ¸å‡†éç ´å£æ€§æ›´æ–°
    - name: Auto-approve minor updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: |
        echo "Auto-approving minor update for ${{ steps.metadata.outputs.dependency-names }}"
        gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## âœ… åƒè€ƒè§£ç­”

### å®Œæ•´ Dependabot é…ç½®ï¼ˆ.github/dependabot.ymlï¼‰

```yaml
version: 2

updates:
  # === Python ä¾è³´ç®¡ç† ===
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"        # æ¯é€±æª¢æŸ¥
      day: "monday"            # é€±ä¸€åŸ·è¡Œ
      time: "09:00"            # æ—©ä¸Š 9 é»
      timezone: "Asia/Taipei"

    # PR ç®¡ç†
    open-pull-requests-limit: 10
    reviewers:
      - "team/backend-dev"
    assignees:
      - "security-team"

    # å…è¨±çš„æ›´æ–°é¡å‹
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"

    # å¿½ç•¥ç‰¹å®šå¥—ä»¶
    ignore:
      - dependency-name: "requests"
        versions: ["2.26.x"]    # å·²çŸ¥ä¸ç›¸å®¹ç‰ˆæœ¬

    # åˆ†çµ„æ›´æ–°ç­–ç•¥
    groups:
      # æ ¸å¿ƒæ¡†æ¶ä¸€èµ·æ›´æ–°
      web-framework:
        patterns:
          - "fastapi"
          - "uvicorn"
          - "pydantic"
        update-types:
          - "minor"
          - "patch"

      # æ¸¬è©¦å·¥å…·ä¸€èµ·æ›´æ–°
      testing:
        patterns:
          - "pytest*"
          - "*test*"
        update-types:
          - "minor"
          - "patch"

      # ç¨‹å¼ç¢¼å“è³ªå·¥å…·
      code-quality:
        patterns:
          - "black"
          - "flake8"
          - "isort"
          - "mypy"
        update-types:
          - "minor"
          - "patch"

    # æäº¤è¨Šæ¯è¨­å®š
    commit-message:
      prefix: "deps"
      include: "scope"

  # === GitHub Actions ä¾è³´ ===
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    open-pull-requests-limit: 5
    commit-message:
      prefix: "ci"

  # === Docker ä¾è³´ ===
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 3
    commit-message:
      prefix: "docker"
```

### å®Œæ•´ä¾è³´æƒæ Workflow

```yaml
name: Dependency Security Scan

on:
  schedule:
    - cron: '0 9 * * 1'  # æ¯é€±ä¸€æ—©ä¸Š 9 é»
  push:
    branches: [main]
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
  pull_request:
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # === safety æƒæ ===
    - name: Install safety
      run: |
        pip install safety

    - name: Run safety check
      id: safety
      run: |
        echo "ğŸ” Running safety vulnerability scan..."

        # ç”Ÿæˆ JSON å ±å‘Š
        safety check --json --output safety-report.json || true

        # ç”Ÿæˆå¯è®€å ±å‘Š
        safety check --output text --output safety-report.txt || true

        # é¡¯ç¤ºæ‘˜è¦
        if [ -f safety-report.json ]; then
          VULN_COUNT=$(cat safety-report.json | jq '. | length // 0')
          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "Found $VULN_COUNT vulnerabilities"
        fi

    # === Snyk æƒæ ===
    - name: Run Snyk vulnerability scan
      if: vars.SNYK_TOKEN != ''
      uses: snyk/actions/python-3.10@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --file=requirements.txt
        command: test

    # === æ¼æ´åˆ†æå’Œå ±å‘Š ===
    - name: Analyze vulnerabilities
      id: analyze
      run: |
        if [ -f safety-report.json ] && [ -s safety-report.json ]; then
          # è¨ˆç®—ä¸åŒåš´é‡ç­‰ç´šçš„æ¼æ´æ•¸é‡
          CRITICAL=$(cat safety-report.json | jq '[.[] | select(.severity == "critical")] | length // 0')
          HIGH=$(cat safety-report.json | jq '[.[] | select(.severity == "high")] | length // 0')
          MEDIUM=$(cat safety-report.json | jq '[.[] | select(.severity == "medium")] | length // 0')
          LOW=$(cat safety-report.json | jq '[.[] | select(.severity == "low")] | length // 0')

          echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_count=$LOW" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Vulnerability Summary:"
          echo "Critical: $CRITICAL"
          echo "High: $HIGH"
          echo "Medium: $MEDIUM"
          echo "Low: $LOW"

          # ç”Ÿæˆè©³ç´°å ±å‘Š
          echo "## ğŸš¨ Dependency Vulnerability Report" > vulnerability-summary.md
          echo "" >> vulnerability-summary.md
          echo "| Severity | Count | Action Required |" >> vulnerability-summary.md
          echo "|----------|-------|-----------------|" >> vulnerability-summary.md
          echo "| ğŸ”´ Critical | $CRITICAL | Immediate fix |" >> vulnerability-summary.md
          echo "| ğŸŸ  High | $HIGH | Fix within 24h |" >> vulnerability-summary.md
          echo "| ğŸŸ¡ Medium | $MEDIUM | Fix within 1 week |" >> vulnerability-summary.md
          echo "| ğŸŸ¢ Low | $LOW | Fix when convenient |" >> vulnerability-summary.md
          echo "" >> vulnerability-summary.md

          if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
            echo "## ğŸš¨ Urgent Action Required" >> vulnerability-summary.md
            echo "" >> vulnerability-summary.md
            echo "Found critical or high severity vulnerabilities:" >> vulnerability-summary.md
            echo "" >> vulnerability-summary.md
            cat safety-report.json | jq -r '.[] | select(.severity == "critical" or .severity == "high") | "- **\(.package)** \(.installed_version): \(.vulnerability)"' >> vulnerability-summary.md
          fi
        else
          echo "critical_count=0" >> $GITHUB_OUTPUT
          echo "high_count=0" >> $GITHUB_OUTPUT
          echo "medium_count=0" >> $GITHUB_OUTPUT
          echo "low_count=0" >> $GITHUB_OUTPUT
        fi

    # === å¤±æ•—æ¢ä»¶æª¢æŸ¥ ===
    - name: Fail on critical vulnerabilities
      if: steps.analyze.outputs.critical_count > 0
      run: |
        echo "âŒ Found ${{ steps.analyze.outputs.critical_count }} critical vulnerabilities!"
        echo "These must be fixed immediately before merging."
        echo ""
        echo "Vulnerability details:"
        cat safety-report.txt
        exit 1

    - name: Warn on high vulnerabilities
      if: steps.analyze.outputs.high_count > 0 && steps.analyze.outputs.critical_count == 0
      run: |
        echo "âš ï¸ Found ${{ steps.analyze.outputs.high_count }} high severity vulnerabilities."
        echo "Please review and plan fixes within 24 hours."
        echo ""
        echo "Vulnerability details:"
        cat safety-report.txt

    # === å ±å‘Šå’Œç¸½çµ ===
    - name: Generate step summary
      if: always()
      run: |
        if [ -f vulnerability-summary.md ]; then
          cat vulnerability-summary.md >> $GITHUB_STEP_SUMMARY
        else
          echo "## âœ… No Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies are secure!" >> $GITHUB_STEP_SUMMARY
        fi

    # === ä¸Šå‚³å ±å‘Š ===
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-security-reports
        path: |
          safety-report.json
          safety-report.txt
          vulnerability-summary.md

    # === PR è©•è«–ï¼ˆå¦‚æœæ˜¯ PRï¼‰ ===
    - name: Comment vulnerability report on PR
      if: github.event_name == 'pull_request' && steps.analyze.outputs.vulnerability_count > 0
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('vulnerability-summary.md')) {
            const report = fs.readFileSync('vulnerability-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }
```

### Dependabot Auto-merge Workflow

```yaml
name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot PR
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
    - name: Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: Enable auto-merge for patch updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-patch' &&
        contains(fromJson('["direct", "indirect"]'), steps.metadata.outputs.dependency-type)
      run: |
        echo "Enabling auto-merge for patch update: ${{ steps.metadata.outputs.dependency-names }}"
        gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Auto-approve minor updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-minor' &&
        steps.metadata.outputs.dependency-type == 'direct'
      run: |
        echo "Auto-approving minor update: ${{ steps.metadata.outputs.dependency-names }}"
        gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on major updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-major'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš¨ **Major Version Update Detected**

            This PR updates **${{ steps.metadata.outputs.dependency-names }}** to a new major version.

            **âš ï¸ Manual review required:**
            - Check for breaking changes in the changelog
            - Update code if necessary
            - Thoroughly test the application
            - Review migration guides

            This PR will not be auto-merged.`
          });
```

---

## ğŸ” é©—è­‰èˆ‡é™¤éŒ¯

### æœ¬æ©Ÿæ¸¬è©¦ä¾è³´æƒæ

**1. å®‰è£å’ŒåŸ·è¡Œ safety**ï¼š
```bash
# å®‰è£ safety
pip install safety

# åŸºæœ¬æƒæ
safety check

# ç”Ÿæˆ JSON å ±å‘Š
safety check --json --output safety-report.json

# åªæª¢æŸ¥ç‰¹å®šæª”æ¡ˆ
safety check --file requirements.txt

# å¿½ç•¥ç‰¹å®šæ¼æ´ï¼ˆè‡¨æ™‚ï¼‰
safety check --ignore 39462
```

**2. ä½¿ç”¨ Snyk CLI**ï¼š
```bash
# å®‰è£ Snyk CLI
npm install -g snyk

# é©—è­‰èº«ä»½ï¼ˆéœ€è¦è¨»å†Šå¸³è™Ÿï¼‰
snyk auth

# æƒæ Python å°ˆæ¡ˆ
snyk test --file=requirements.txt

# ç›£æ§å°ˆæ¡ˆï¼ˆæŒçºŒç›£æ§ï¼‰
snyk monitor --file=requirements.txt
```

**3. æœ¬æ©Ÿ Dependabot æ¸¬è©¦**ï¼š
```bash
# é›–ç„¶ç„¡æ³•åœ¨æœ¬æ©Ÿå®Œæ•´æ¸¬è©¦ Dependabotï¼Œ
# ä½†å¯ä»¥æª¢æŸ¥é…ç½®æª”æ¡ˆèªæ³•
cat .github/dependabot.yml | yq eval '.' -
```

### æ¸¬è©¦ Dependabot è¡Œç‚º

**1. å»ºç«‹æ¸¬è©¦ç”¨éæ™‚ä¾è³´**ï¼š
```
# requirements.txt
requests==2.20.0    # æ•…æ„ä½¿ç”¨å¾ˆèˆŠçš„ç‰ˆæœ¬
flask==1.0.0        # æ•…æ„ä½¿ç”¨å¾ˆèˆŠçš„ç‰ˆæœ¬
```

**2. æäº¤ä¸¦è§€å¯Ÿ**ï¼š
```bash
git add requirements.txt
git commit -m "test: add outdated dependencies for Dependabot testing"
git push
```

ç­‰å¾…å¹¾åˆ†é˜å¾Œï¼Œæ‡‰è©²çœ‹åˆ° Dependabot å»ºç«‹çš„ PRã€‚

**3. æ¸¬è©¦è‡ªå‹•åˆä½µ**ï¼š
æäº¤ä¸€å€‹è£œä¸ç‰ˆæœ¬æ›´æ–°çš„ PRï¼Œè§€å¯Ÿæ˜¯å¦è‡ªå‹•åˆä½µã€‚

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±º

**å•é¡Œ 1ï¼šsafety æƒæå¤ªåš´æ ¼**
```
safety å ±å‘Šäº†å¾ˆå¤šä½é¢¨éšªçš„èˆŠæ¼æ´
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# å»ºç«‹ .safety-ignore æª”æ¡ˆ
echo "39462" > .safety-ignore  # å¿½ç•¥ç‰¹å®š CVE

# æˆ–åœ¨ workflow ä¸­èª¿æ•´
safety check --ignore 39462,40291
```

**å•é¡Œ 2ï¼šDependabot PR å¤ªå¤š**
```
Dependabot ä¸€æ¬¡å»ºç«‹äº† 20+ å€‹ PR
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```yaml
# åœ¨ dependabot.yml ä¸­åŠ å…¥åˆ†çµ„
groups:
  all-dependencies:
    patterns:
      - "*"
    update-types:
      - "patch"
```

**å•é¡Œ 3ï¼šè‡ªå‹•åˆä½µä¸å·¥ä½œ**
```
è£œä¸æ›´æ–°æ²’æœ‰è‡ªå‹•åˆä½µ
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] workflow æœ‰æ­£ç¢ºçš„æ¬Šé™è¨­å®š
- [ ] branch protection å…è¨±è‡ªå‹•åˆä½µ
- [ ] PR ç¢ºå¯¦æ˜¯è£œä¸ç‰ˆæœ¬æ›´æ–°
- [ ] æ‰€æœ‰æª¢æŸ¥éƒ½é€šé

---

## ğŸŒŸ å»¶ä¼¸æŒ‘æˆ°

### æŒ‘æˆ° 1ï¼šä¾è³´æ¼æ´å„€è¡¨æ¿

å»ºç«‹å¯è¦–åŒ–çš„ä¾è³´å®‰å…¨ç‹€æ…‹ï¼š

```yaml
- name: Create security dashboard
  run: |
    cat > security-dashboard.html << 'EOF'
    <!DOCTYPE html>
    <html>
    <head>
        <title>Dependency Security Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <h1>ğŸ“Š Dependency Security Status</h1>
        <canvas id="vulnChart" width="400" height="200"></canvas>

        <script>
        const ctx = document.getElementById('vulnChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [${{ steps.analyze.outputs.critical_count }},
                           ${{ steps.analyze.outputs.high_count }},
                           ${{ steps.analyze.outputs.medium_count }},
                           ${{ steps.analyze.outputs.low_count }}],
                    backgroundColor: ['#dc2626', '#ea580c', '#d97706', '#65a30d']
                }]
            }
        });
        </script>
    </body>
    </html>
    EOF

- name: Deploy dashboard to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: .
    publish_branch: gh-pages
```

### æŒ‘æˆ° 2ï¼šç·Šæ€¥å®‰å…¨æ›´æ–°æ©Ÿåˆ¶

å»ºç«‹é«˜å„ªå…ˆç´šå®‰å…¨æ›´æ–°æµç¨‹ï¼š

```yaml
name: Emergency Security Update

on:
  repository_dispatch:
    types: [security-emergency]

jobs:
  emergency-update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Update vulnerable packages
      run: |
        # æ›´æ–°ç‰¹å®šå¥—ä»¶åˆ°å®‰å…¨ç‰ˆæœ¬
        pip install pip-tools
        pip-compile --upgrade-package ${{ github.event.client_payload.package }}

    - name: Create emergency PR
      uses: peter-evans/create-pull-request@v5
      with:
        title: "ğŸš¨ Emergency Security Update: ${{ github.event.client_payload.package }}"
        body: |
          Emergency security update for critical vulnerability.

          **Package**: ${{ github.event.client_payload.package }}
          **CVE**: ${{ github.event.client_payload.cve }}
          **Severity**: Critical

          This is an automated emergency update.
        branch: emergency/security-${{ github.event.client_payload.package }}
        labels: |
          security
          emergency
          auto-merge
```

### æŒ‘æˆ° 3ï¼šLicense åˆè¦æª¢æŸ¥

ç¢ºä¿ä¾è³´çš„ License ç¬¦åˆå…¬å¸æ”¿ç­–ï¼š

```yaml
- name: License compliance check
  run: |
    pip install pip-licenses
    pip-licenses --format=json --output-file=licenses.json

    # æª¢æŸ¥ç¦ç”¨çš„ License
    FORBIDDEN_LICENSES=("GPL" "AGPL" "SSPL")

    for license in "${FORBIDDEN_LICENSES[@]}"; do
      if cat licenses.json | jq -r '.[].License' | grep -i "$license"; then
        echo "âŒ Found forbidden license: $license"
        exit 1
      fi
    done

    echo "âœ… All licenses are compliant"
```

---

## ğŸ“– çŸ¥è­˜å›é¡§

å®Œæˆé€™å€‹æƒ…å¢ƒé¡Œå¾Œï¼Œä½ æ‡‰è©²å­¸æœƒï¼š

### æ ¸å¿ƒæ¦‚å¿µ
- âœ… ä¾è³´å®‰å…¨çš„é‡è¦æ€§ï¼ˆä¾›æ‡‰éˆæ”»æ“Šï¼‰
- âœ… CVE å’Œæ¼æ´è©•ç´šç³»çµ±
- âœ… èªæ„ç‰ˆæœ¬æ§åˆ¶ï¼ˆSemVerï¼‰
- âœ… ç›´æ¥ä¾è³´ vs é–“æ¥ä¾è³´

### å¯¦æˆ°æŠ€èƒ½
- âœ… é…ç½® GitHub Dependabot
- âœ… æ•´åˆä¾è³´å®‰å…¨æƒæåˆ° CI/CD
- âœ… è¨­å®šè‡ªå‹•åŒ–æ›´æ–°ç­–ç•¥
- âœ… ä¾è³´æ¼æ´çš„åˆ†æå’Œè™•ç†

### æœ€ä½³å¯¦è¸
- âœ… è‡ªå‹•åŒ–ä¾è³´ç›£æ§
- âœ… åˆ†ç´šè™•ç†ä¸åŒåš´é‡ç­‰ç´šæ¼æ´
- âœ… å¹³è¡¡å®‰å…¨æ€§å’Œç©©å®šæ€§
- âœ… å»ºç«‹ä¾è³´æ›´æ–°çš„å¯©æŸ¥æµç¨‹

### é€²éšæ¦‚å¿µ
- âœ… ä¾è³´æ›´æ–°çš„åˆ†çµ„ç­–ç•¥
- âœ… ç·Šæ€¥å®‰å…¨æ›´æ–°æ©Ÿåˆ¶
- âœ… License åˆè¦æª¢æŸ¥
- âœ… ä¾è³´æ¼æ´å„€è¡¨æ¿

---

## ğŸ“ å­¸ç¿’ç­†è¨˜ç¯„æœ¬

```markdown
## B05 å­¸ç¿’ç­†è¨˜

### å®Œæˆæ™‚é–“
[å¡«å¯«]

### ä¾è³´å®‰å…¨ç†è§£
- **CVE ç³»çµ±**ï¼š[ä½ çš„ç†è§£]
- **SemVer è¦å‰‡**ï¼š[ä½ çš„ç†è§£]
- **ä¾›æ‡‰éˆæ”»æ“Š**ï¼š[é¢¨éšªå’Œé˜²è­·]

### å·¥å…·æ¯”è¼ƒ
| å·¥å…· | å„ªå‹¢ | åŠ£å‹¢ | é©ç”¨å ´æ™¯ |
|------|------|------|---------|
| Dependabot | [å¡«å¯«] | [å¡«å¯«] | [å¡«å¯«] |
| safety | [å¡«å¯«] | [å¡«å¯«] | [å¡«å¯«] |
| Snyk | [å¡«å¯«] | [å¡«å¯«] | [å¡«å¯«] |

### é‡åˆ°çš„å•é¡Œ
1. [å•é¡Œæè¿°]
   - è§£æ±ºæ–¹æ¡ˆï¼š[...]
2. [å•é¡Œæè¿°]
   - è§£æ±ºæ–¹æ¡ˆï¼š[...]

### æ›´æ–°ç­–ç•¥è¨­è¨ˆ
- **è£œä¸æ›´æ–°**ï¼š[è‡ªå‹•è™•ç†ç­–ç•¥]
- **æ¬¡ç‰ˆæœ¬æ›´æ–°**ï¼š[å¯©æŸ¥æµç¨‹]
- **ä¸»ç‰ˆæœ¬æ›´æ–°**ï¼š[è¬¹æ…è™•ç†æ–¹å¼]

### é—œéµå­¸ç¿’é»
1. ä¾è³´ç›£æ§çš„é‡è¦æ€§ï¼š[...]
2. è‡ªå‹•åŒ– vs æ‰‹å‹•æ§åˆ¶çš„å¹³è¡¡ï¼š[...]
3. å®‰å…¨æ€§å’Œç©©å®šæ€§çš„æ¬Šè¡¡ï¼š[...]

### æ‡‰ç”¨åˆ°å¯¦éš›å°ˆæ¡ˆçš„è¨ˆç•«
- [ ] å•Ÿç”¨å°ˆæ¡ˆçš„ Dependabot
- [ ] å»ºç«‹ä¾è³´æƒæ workflow
- [ ] è¨­å®šåœ˜éšŠçš„æ›´æ–°å¯©æŸ¥æµç¨‹

### ä¸‹ä¸€æ­¥
- [ ] å®ŒæˆæŒ‘æˆ° 1
- [ ] é€²å…¥ B06
```

---

**æ­å–œå®Œæˆ B05ï¼** ä½ å·²ç¶“æŒæ¡ä¾è³´å®‰å…¨ç®¡ç†çš„æ ¸å¿ƒæŠ€èƒ½ã€‚æ¥ä¸‹ä¾†å‰å¾€ `B06_å»ºç«‹ç°¡æ˜“éƒ¨ç½²æµç¨‹.md`ï¼Œå­¸ç¿’åŸºç¤çš„è‡ªå‹•åŒ–éƒ¨ç½²æµç¨‹ã€‚