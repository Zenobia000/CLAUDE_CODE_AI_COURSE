# B05：配置依賴掃描

## 📋 情境資訊

**難度等級**：⭐ 基礎級
**預估時間**：25 分鐘
**核心技能**：Dependabot、Snyk、依賴安全管理
**前置知識**：B04（建立Docker構建流程）

---

## 🎯 情境背景

你的團隊現在有了完整的 CI/CD 管線，但昨天發生了一個讓所有人都冒冷汗的事件：

**依賴漏洞事件**：
```bash
# 星期一早上
$ npm audit  # 習慣性檢查
Found 0 vulnerabilities

# 星期三下午
$ npm audit
Found 15 vulnerabilities (2 critical, 5 high, 8 moderate)

# 🚨 CRITICAL: Remote Code Execution in 'some-package'
# 🚨 HIGH: SQL Injection in 'another-library'
```

**事件回顧**：
- 專案使用了 50+ 個第三方套件
- 其中 `requests` 套件有新發現的 CVE-2023-32681
- `pillow` 映像處理套件有嚴重的記憶體溢出漏洞
- 這些套件每天都可能出現新漏洞，手動檢查根本跟不上

**更糟的是**：
```python
# requirements.txt
requests==2.25.1  # ❌ 2 年前的版本！
pillow==8.1.0      # ❌ 有已知 CVE 漏洞
fastapi>=0.65.0    # ❌ 太寬泛，可能引入不相容版本
```

**資安團隊的最後通牒**：
> 「依賴漏洞是攻擊者最常利用的入口點！你們必須建立自動化依賴掃描和更新機制。」

**團隊決定**：
> 「建立依賴安全監控，自動偵測並修復依賴漏洞。」

**你的任務**：
在現有的 CI/CD 管線中加入依賴掃描機制，自動偵測依賴漏洞並管理套件更新。

---

## 📦 專案結構

延續 B04 的專案：

```
my-fastapi-project/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── models.py
│   ├── utils.py
│   └── security.py
│
├── tests/
│   ├── __init__.py
│   ├── test_main.py
│   └── test_security.py
│
├── requirements.txt           # 有過時依賴的檔案
├── requirements-dev.txt       # 新增：開發依賴
├── pyproject.toml
├── .bandit
├── Dockerfile
├── .dockerignore
├── docker-compose.yml
├── .github/
│   ├── dependabot.yml        # 新增：Dependabot 配置
│   └── workflows/
│       └── test.yml          # 現有的完整 CI workflow
│
├── .gitignore
└── README.md
```

**有問題的依賴檔案（requirements.txt）**：
```
# 生產依賴
fastapi==0.95.2        # ❌ 過時，最新是 0.104.1
uvicorn==0.20.0        # ❌ 過時，最新是 0.24.0
pydantic==1.10.5       # ❌ 主版本過時，最新是 2.4.2
requests==2.25.1       # ❌ 有 CVE-2023-32681 漏洞
pillow==8.1.0          # ❌ 有多個 CVE 漏洞
cryptography==3.4.8   # ❌ 有 CVE-2023-23931 漏洞
```

**開發依賴（requirements-dev.txt）**：
```
# 測試工具
pytest==7.1.2         # ❌ 可更新到 7.4.3
pytest-cov==4.0.0     # ❌ 可更新
pytest-asyncio==0.20.3 # ❌ 可更新

# 程式碼品質
black==22.3.0          # ❌ 可更新到 23.10.1
flake8==4.0.1          # ❌ 可更新
isort==5.10.1          # ❌ 可更新

# 安全掃描
bandit==1.7.4          # ❌ 可更新
safety==2.3.1          # ❌ 可更新
```

---

## 🎯 任務目標

### 必達目標
1. ✅ 啟用並配置 **GitHub Dependabot**
2. ✅ 在 CI 中整合 **依賴漏洞掃描**（safety）
3. ✅ 在 CI 中整合 **Snyk** 進階掃描
4. ✅ 設定自動化的 **PR 建立** 和 **更新策略**
5. ✅ 建立依賴更新的 **審查和測試流程**

### 加分項目
- 🌟 設定 **自動合併** 補丁版本更新
- 🌟 建立 **依賴漏洞儀表板**
- 🌟 配置 **緊急安全更新** 機制
- 🌟 整合 **License 合規檢查**

---

## 📚 學習檢查點

完成此情境題時，請確認你能回答：

### Checkpoint 1：依賴安全基礎
- [ ] 什麼是 CVE？為什麼依賴漏洞危險？
- [ ] Dependabot 的工作原理是什麼？
- [ ] 語意版本（SemVer）的規則是什麼？
- [ ] 直接依賴 vs 間接依賴的差別？

### Checkpoint 2：掃描工具
- [ ] safety 和 Snyk 的差別是什麼？
- [ ] 如何讀懂依賴漏洞報告？
- [ ] 什麼情況下應該立即更新依賴？
- [ ] 如何處理有破壞性變更的更新？

### Checkpoint 3：自動化策略
- [ ] 如何設定不同更新頻率？
- [ ] 什麼是依賴鎖定（dependency pinning）？
- [ ] 如何平衡安全性和穩定性？

---

## 🚀 實作步驟

### 方法 1：用 Claude 生成（推薦）

#### 步驟 1：準備提示詞

```
我需要為 Python FastAPI 專案建立完整的依賴安全管理。

當前狀況：
- 有 requirements.txt（生產依賴）
- 有 requirements-dev.txt（開發依賴）
- 專案使用 GitHub Actions 做 CI/CD
- 已有完整的測試、品質檢查、安全掃描流程

需求：
1. 配置 GitHub Dependabot 自動偵測過期依賴
2. 在 CI 中加入依賴漏洞掃描（safety、Snyk）
3. 設定自動 PR 建立和合併策略
4. 區分不同嚴重等級的處理方式

請提供：
1. 完整的 .github/dependabot.yml 配置
2. 修改後的 GitHub Actions workflow
3. 依賴漏洞處理的最佳實踐
4. 本機檢查依賴的指令

請加上詳細註解說明策略考量。
```

#### 步驟 2：建立 Dependabot 配置

```bash
# 建立 dependabot 配置
mkdir -p .github
touch .github/dependabot.yml
# 將 Claude 生成的配置貼上
```

#### 步驟 3：修改現有 Workflow

將依賴掃描整合到現有的 CI workflow 中。

#### 步驟 4：測試配置

```bash
# 本機測試依賴掃描
pip install safety
safety check

# 或使用 Snyk CLI
npm install -g snyk
snyk test --file=requirements.txt
```

### 方法 2：手動配置（學習用）

#### 步驟 1：了解工具

**Dependabot**：
- GitHub 原生的依賴管理機器人
- 自動偵測過期依賴和安全漏洞
- 自動建立 PR 更新依賴
- 支援多種語言和套件管理器

**safety**：
- Python 安全資料庫檢查工具
- 免費且輕量級
- 檢查已知的 CVE 漏洞

**Snyk**：
- 商業級安全掃描平台
- 更全面的漏洞資料庫
- 提供修復建議

#### 步驟 2：建立 Dependabot 配置

`.github/dependabot.yml`：

```yaml
version: 2

updates:
  # Python 依賴掃描
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
    open-pull-requests-limit: 10

    # 自動合併規則
    allow:
      - dependency-type: "all"

    # 版本更新策略
    versioning-strategy: "increase"

    # 分組更新（減少 PR 數量）
    groups:
      production-dependencies:
        patterns:
          - "fastapi"
          - "uvicorn"
          - "pydantic"
        update-types:
          - "minor"
          - "patch"

      development-dependencies:
        patterns:
          - "pytest*"
          - "black"
          - "flake8"
          - "isort"
        update-types:
          - "minor"
          - "patch"

  # GitHub Actions 依賴
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    open-pull-requests-limit: 5

  # Docker 依賴
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 3
```

#### 步驟 3：修改 CI Workflow

在現有 workflow 中加入依賴掃描 job：

```yaml
# 在現有 workflow 中加入
jobs:
  # ... 保留現有 jobs

  # 新增：依賴安全掃描
  dependency-scan:
    name: Dependency Security Scan
    needs: quality-check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # safety 掃描
    - name: Install safety
      run: |
        pip install safety

    - name: Run safety check
      id: safety
      run: |
        echo "🔍 Running safety check..."
        safety check --json --output safety-report.json
        safety check --short-report
      continue-on-error: true

    # Snyk 掃描（需要 token）
    - name: Run Snyk vulnerability scan
      if: vars.SNYK_TOKEN != ''
      uses: snyk/actions/python-3.10@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=requirements.txt

    # 檢查嚴重漏洞
    - name: Check for critical vulnerabilities
      run: |
        if [ -f safety-report.json ]; then
          VULN_COUNT=$(cat safety-report.json | jq '. | length')
          echo "Found $VULN_COUNT vulnerabilities"

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "❌ Found vulnerabilities in dependencies!"
            echo "Please review and update the affected packages."

            # 顯示漏洞詳情
            cat safety-report.json | jq -r '.[] | "Package: \(.package) \(.installed_version) - \(.vulnerability)"'

            # 對於高危漏洞，讓 workflow 失敗
            HIGH_VULN=$(cat safety-report.json | jq '[.[] | select(.severity == "high" or .severity == "critical")] | length')
            if [ "$HIGH_VULN" -gt 0 ]; then
              echo "❌ Found $HIGH_VULN high/critical vulnerabilities!"
              exit 1
            fi
          else
            echo "✅ No vulnerabilities found in dependencies."
          fi
        fi

    # 上傳報告
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-reports
        path: |
          safety-report.json
```

#### 步驟 4：設定 PR 自動合併

建立額外的 workflow 處理 Dependabot PR：

`.github/workflows/dependabot-auto-merge.yml`：

```yaml
name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Fetch Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    # 只自動合併補丁版本
    - name: Auto-merge patch updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
      run: |
        echo "Auto-merging patch update for ${{ steps.metadata.outputs.dependency-names }}"
        gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 自動核准非破壞性更新
    - name: Auto-approve minor updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: |
        echo "Auto-approving minor update for ${{ steps.metadata.outputs.dependency-names }}"
        gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## ✅ 參考解答

### 完整 Dependabot 配置（.github/dependabot.yml）

```yaml
version: 2

updates:
  # === Python 依賴管理 ===
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"        # 每週檢查
      day: "monday"            # 週一執行
      time: "09:00"            # 早上 9 點
      timezone: "Asia/Taipei"

    # PR 管理
    open-pull-requests-limit: 10
    reviewers:
      - "team/backend-dev"
    assignees:
      - "security-team"

    # 允許的更新類型
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"

    # 忽略特定套件
    ignore:
      - dependency-name: "requests"
        versions: ["2.26.x"]    # 已知不相容版本

    # 分組更新策略
    groups:
      # 核心框架一起更新
      web-framework:
        patterns:
          - "fastapi"
          - "uvicorn"
          - "pydantic"
        update-types:
          - "minor"
          - "patch"

      # 測試工具一起更新
      testing:
        patterns:
          - "pytest*"
          - "*test*"
        update-types:
          - "minor"
          - "patch"

      # 程式碼品質工具
      code-quality:
        patterns:
          - "black"
          - "flake8"
          - "isort"
          - "mypy"
        update-types:
          - "minor"
          - "patch"

    # 提交訊息設定
    commit-message:
      prefix: "deps"
      include: "scope"

  # === GitHub Actions 依賴 ===
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    open-pull-requests-limit: 5
    commit-message:
      prefix: "ci"

  # === Docker 依賴 ===
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 3
    commit-message:
      prefix: "docker"
```

### 完整依賴掃描 Workflow

```yaml
name: Dependency Security Scan

on:
  schedule:
    - cron: '0 9 * * 1'  # 每週一早上 9 點
  push:
    branches: [main]
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
  pull_request:
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # === safety 掃描 ===
    - name: Install safety
      run: |
        pip install safety

    - name: Run safety check
      id: safety
      run: |
        echo "🔍 Running safety vulnerability scan..."

        # 生成 JSON 報告
        safety check --json --output safety-report.json || true

        # 生成可讀報告
        safety check --output text --output safety-report.txt || true

        # 顯示摘要
        if [ -f safety-report.json ]; then
          VULN_COUNT=$(cat safety-report.json | jq '. | length // 0')
          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "Found $VULN_COUNT vulnerabilities"
        fi

    # === Snyk 掃描 ===
    - name: Run Snyk vulnerability scan
      if: vars.SNYK_TOKEN != ''
      uses: snyk/actions/python-3.10@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --file=requirements.txt
        command: test

    # === 漏洞分析和報告 ===
    - name: Analyze vulnerabilities
      id: analyze
      run: |
        if [ -f safety-report.json ] && [ -s safety-report.json ]; then
          # 計算不同嚴重等級的漏洞數量
          CRITICAL=$(cat safety-report.json | jq '[.[] | select(.severity == "critical")] | length // 0')
          HIGH=$(cat safety-report.json | jq '[.[] | select(.severity == "high")] | length // 0')
          MEDIUM=$(cat safety-report.json | jq '[.[] | select(.severity == "medium")] | length // 0')
          LOW=$(cat safety-report.json | jq '[.[] | select(.severity == "low")] | length // 0')

          echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_count=$LOW" >> $GITHUB_OUTPUT

          echo "📊 Vulnerability Summary:"
          echo "Critical: $CRITICAL"
          echo "High: $HIGH"
          echo "Medium: $MEDIUM"
          echo "Low: $LOW"

          # 生成詳細報告
          echo "## 🚨 Dependency Vulnerability Report" > vulnerability-summary.md
          echo "" >> vulnerability-summary.md
          echo "| Severity | Count | Action Required |" >> vulnerability-summary.md
          echo "|----------|-------|-----------------|" >> vulnerability-summary.md
          echo "| 🔴 Critical | $CRITICAL | Immediate fix |" >> vulnerability-summary.md
          echo "| 🟠 High | $HIGH | Fix within 24h |" >> vulnerability-summary.md
          echo "| 🟡 Medium | $MEDIUM | Fix within 1 week |" >> vulnerability-summary.md
          echo "| 🟢 Low | $LOW | Fix when convenient |" >> vulnerability-summary.md
          echo "" >> vulnerability-summary.md

          if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
            echo "## 🚨 Urgent Action Required" >> vulnerability-summary.md
            echo "" >> vulnerability-summary.md
            echo "Found critical or high severity vulnerabilities:" >> vulnerability-summary.md
            echo "" >> vulnerability-summary.md
            cat safety-report.json | jq -r '.[] | select(.severity == "critical" or .severity == "high") | "- **\(.package)** \(.installed_version): \(.vulnerability)"' >> vulnerability-summary.md
          fi
        else
          echo "critical_count=0" >> $GITHUB_OUTPUT
          echo "high_count=0" >> $GITHUB_OUTPUT
          echo "medium_count=0" >> $GITHUB_OUTPUT
          echo "low_count=0" >> $GITHUB_OUTPUT
        fi

    # === 失敗條件檢查 ===
    - name: Fail on critical vulnerabilities
      if: steps.analyze.outputs.critical_count > 0
      run: |
        echo "❌ Found ${{ steps.analyze.outputs.critical_count }} critical vulnerabilities!"
        echo "These must be fixed immediately before merging."
        echo ""
        echo "Vulnerability details:"
        cat safety-report.txt
        exit 1

    - name: Warn on high vulnerabilities
      if: steps.analyze.outputs.high_count > 0 && steps.analyze.outputs.critical_count == 0
      run: |
        echo "⚠️ Found ${{ steps.analyze.outputs.high_count }} high severity vulnerabilities."
        echo "Please review and plan fixes within 24 hours."
        echo ""
        echo "Vulnerability details:"
        cat safety-report.txt

    # === 報告和總結 ===
    - name: Generate step summary
      if: always()
      run: |
        if [ -f vulnerability-summary.md ]; then
          cat vulnerability-summary.md >> $GITHUB_STEP_SUMMARY
        else
          echo "## ✅ No Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies are secure!" >> $GITHUB_STEP_SUMMARY
        fi

    # === 上傳報告 ===
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-security-reports
        path: |
          safety-report.json
          safety-report.txt
          vulnerability-summary.md

    # === PR 評論（如果是 PR） ===
    - name: Comment vulnerability report on PR
      if: github.event_name == 'pull_request' && steps.analyze.outputs.vulnerability_count > 0
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('vulnerability-summary.md')) {
            const report = fs.readFileSync('vulnerability-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }
```

### Dependabot Auto-merge Workflow

```yaml
name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot PR
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
    - name: Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: Enable auto-merge for patch updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-patch' &&
        contains(fromJson('["direct", "indirect"]'), steps.metadata.outputs.dependency-type)
      run: |
        echo "Enabling auto-merge for patch update: ${{ steps.metadata.outputs.dependency-names }}"
        gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Auto-approve minor updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-minor' &&
        steps.metadata.outputs.dependency-type == 'direct'
      run: |
        echo "Auto-approving minor update: ${{ steps.metadata.outputs.dependency-names }}"
        gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on major updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-major'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🚨 **Major Version Update Detected**

            This PR updates **${{ steps.metadata.outputs.dependency-names }}** to a new major version.

            **⚠️ Manual review required:**
            - Check for breaking changes in the changelog
            - Update code if necessary
            - Thoroughly test the application
            - Review migration guides

            This PR will not be auto-merged.`
          });
```

---

## 🔍 驗證與除錯

### 本機測試依賴掃描

**1. 安裝和執行 safety**：
```bash
# 安裝 safety
pip install safety

# 基本掃描
safety check

# 生成 JSON 報告
safety check --json --output safety-report.json

# 只檢查特定檔案
safety check --file requirements.txt

# 忽略特定漏洞（臨時）
safety check --ignore 39462
```

**2. 使用 Snyk CLI**：
```bash
# 安裝 Snyk CLI
npm install -g snyk

# 驗證身份（需要註冊帳號）
snyk auth

# 掃描 Python 專案
snyk test --file=requirements.txt

# 監控專案（持續監控）
snyk monitor --file=requirements.txt
```

**3. 本機 Dependabot 測試**：
```bash
# 雖然無法在本機完整測試 Dependabot，
# 但可以檢查配置檔案語法
cat .github/dependabot.yml | yq eval '.' -
```

### 測試 Dependabot 行為

**1. 建立測試用過時依賴**：
```
# requirements.txt
requests==2.20.0    # 故意使用很舊的版本
flask==1.0.0        # 故意使用很舊的版本
```

**2. 提交並觀察**：
```bash
git add requirements.txt
git commit -m "test: add outdated dependencies for Dependabot testing"
git push
```

等待幾分鐘後，應該看到 Dependabot 建立的 PR。

**3. 測試自動合併**：
提交一個補丁版本更新的 PR，觀察是否自動合併。

### 常見問題與解決

**問題 1：safety 掃描太嚴格**
```
safety 報告了很多低風險的舊漏洞
```

**解決方案**：
```bash
# 建立 .safety-ignore 檔案
echo "39462" > .safety-ignore  # 忽略特定 CVE

# 或在 workflow 中調整
safety check --ignore 39462,40291
```

**問題 2：Dependabot PR 太多**
```
Dependabot 一次建立了 20+ 個 PR
```

**解決方案**：
```yaml
# 在 dependabot.yml 中加入分組
groups:
  all-dependencies:
    patterns:
      - "*"
    update-types:
      - "patch"
```

**問題 3：自動合併不工作**
```
補丁更新沒有自動合併
```

**檢查清單**：
- [ ] workflow 有正確的權限設定
- [ ] branch protection 允許自動合併
- [ ] PR 確實是補丁版本更新
- [ ] 所有檢查都通過

---

## 🌟 延伸挑戰

### 挑戰 1：依賴漏洞儀表板

建立可視化的依賴安全狀態：

```yaml
- name: Create security dashboard
  run: |
    cat > security-dashboard.html << 'EOF'
    <!DOCTYPE html>
    <html>
    <head>
        <title>Dependency Security Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <h1>📊 Dependency Security Status</h1>
        <canvas id="vulnChart" width="400" height="200"></canvas>

        <script>
        const ctx = document.getElementById('vulnChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [${{ steps.analyze.outputs.critical_count }},
                           ${{ steps.analyze.outputs.high_count }},
                           ${{ steps.analyze.outputs.medium_count }},
                           ${{ steps.analyze.outputs.low_count }}],
                    backgroundColor: ['#dc2626', '#ea580c', '#d97706', '#65a30d']
                }]
            }
        });
        </script>
    </body>
    </html>
    EOF

- name: Deploy dashboard to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: .
    publish_branch: gh-pages
```

### 挑戰 2：緊急安全更新機制

建立高優先級安全更新流程：

```yaml
name: Emergency Security Update

on:
  repository_dispatch:
    types: [security-emergency]

jobs:
  emergency-update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Update vulnerable packages
      run: |
        # 更新特定套件到安全版本
        pip install pip-tools
        pip-compile --upgrade-package ${{ github.event.client_payload.package }}

    - name: Create emergency PR
      uses: peter-evans/create-pull-request@v5
      with:
        title: "🚨 Emergency Security Update: ${{ github.event.client_payload.package }}"
        body: |
          Emergency security update for critical vulnerability.

          **Package**: ${{ github.event.client_payload.package }}
          **CVE**: ${{ github.event.client_payload.cve }}
          **Severity**: Critical

          This is an automated emergency update.
        branch: emergency/security-${{ github.event.client_payload.package }}
        labels: |
          security
          emergency
          auto-merge
```

### 挑戰 3：License 合規檢查

確保依賴的 License 符合公司政策：

```yaml
- name: License compliance check
  run: |
    pip install pip-licenses
    pip-licenses --format=json --output-file=licenses.json

    # 檢查禁用的 License
    FORBIDDEN_LICENSES=("GPL" "AGPL" "SSPL")

    for license in "${FORBIDDEN_LICENSES[@]}"; do
      if cat licenses.json | jq -r '.[].License' | grep -i "$license"; then
        echo "❌ Found forbidden license: $license"
        exit 1
      fi
    done

    echo "✅ All licenses are compliant"
```

---

## 📖 知識回顧

完成這個情境題後，你應該學會：

### 核心概念
- ✅ 依賴安全的重要性（供應鏈攻擊）
- ✅ CVE 和漏洞評級系統
- ✅ 語意版本控制（SemVer）
- ✅ 直接依賴 vs 間接依賴

### 實戰技能
- ✅ 配置 GitHub Dependabot
- ✅ 整合依賴安全掃描到 CI/CD
- ✅ 設定自動化更新策略
- ✅ 依賴漏洞的分析和處理

### 最佳實踐
- ✅ 自動化依賴監控
- ✅ 分級處理不同嚴重等級漏洞
- ✅ 平衡安全性和穩定性
- ✅ 建立依賴更新的審查流程

### 進階概念
- ✅ 依賴更新的分組策略
- ✅ 緊急安全更新機制
- ✅ License 合規檢查
- ✅ 依賴漏洞儀表板

---

## 📝 學習筆記範本

```markdown
## B05 學習筆記

### 完成時間
[填寫]

### 依賴安全理解
- **CVE 系統**：[你的理解]
- **SemVer 規則**：[你的理解]
- **供應鏈攻擊**：[風險和防護]

### 工具比較
| 工具 | 優勢 | 劣勢 | 適用場景 |
|------|------|------|---------|
| Dependabot | [填寫] | [填寫] | [填寫] |
| safety | [填寫] | [填寫] | [填寫] |
| Snyk | [填寫] | [填寫] | [填寫] |

### 遇到的問題
1. [問題描述]
   - 解決方案：[...]
2. [問題描述]
   - 解決方案：[...]

### 更新策略設計
- **補丁更新**：[自動處理策略]
- **次版本更新**：[審查流程]
- **主版本更新**：[謹慎處理方式]

### 關鍵學習點
1. 依賴監控的重要性：[...]
2. 自動化 vs 手動控制的平衡：[...]
3. 安全性和穩定性的權衡：[...]

### 應用到實際專案的計畫
- [ ] 啟用專案的 Dependabot
- [ ] 建立依賴掃描 workflow
- [ ] 設定團隊的更新審查流程

### 下一步
- [ ] 完成挑戰 1
- [ ] 進入 B06
```

---

**恭喜完成 B05！** 你已經掌握依賴安全管理的核心技能。接下來前往 `B06_建立簡易部署流程.md`，學習基礎的自動化部署流程。