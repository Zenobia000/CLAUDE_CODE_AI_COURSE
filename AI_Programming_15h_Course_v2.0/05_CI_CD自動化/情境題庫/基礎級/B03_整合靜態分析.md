# B03：整合靜態分析

## 📋 情境資訊

**難度等級**：⭐ 基礎級
**預估時間**：30 分鐘
**核心技能**：CodeQL、bandit、安全掃描
**前置知識**：B02（配置程式碼品質檢查）

---

## 🎯 情境背景

你的團隊現在有了測試自動化和程式碼品質檢查，但昨天發生了一件事：

**安全漏洞事件**：
```python
# 小華提交的程式碼
@app.get("/user/{user_id}")
def get_user(user_id: str):
    # ❌ SQL 注入漏洞！
    query = f"SELECT * FROM users WHERE id = '{user_id}'"
    result = db.execute(query)
    return result.fetchone()
```

測試通過 ✅
品質檢查通過 ✅
但是這段程式碼有嚴重的 **SQL 注入漏洞**！

**資安團隊的警告**：
> 「根據統計，40% 的 AI 生成代碼包含安全問題。你們必須加入自動化安全掃描！」

**昨晚的緊急修復**：
```python
# 攻擊範例
user_id = "1' OR '1'='1"
# 變成：SELECT * FROM users WHERE id = '1' OR '1'='1'
# 結果：取得所有用戶資料！
```

**團隊決定**：
> 「我們需要靜態安全分析！在代碼進入生產環境前就發現漏洞。」

**你的任務**：
在現有的 CI/CD 管線中整合靜態安全分析工具，自動偵測常見的安全漏洞。

---

## 📦 專案結構

延續 B02 的專案：

```
my-fastapi-project/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── models.py
│   ├── utils.py
│   └── security.py        # 新增：有安全問題的檔案
│
├── tests/
│   ├── __init__.py
│   ├── test_main.py
│   └── test_security.py   # 新增：安全測試
│
├── requirements.txt
├── pyproject.toml
├── .github/
│   └── workflows/
│       └── test.yml       # 現有的測試+品質檢查 workflow
│
├── .gitignore
└── README.md
```

**有安全問題的程式碼（app/security.py）**：
```python
import os
import subprocess
import hashlib
from fastapi import HTTPException
from sqlalchemy import text

class UserService:
    def __init__(self, db):
        self.db = db

    def get_user_by_id(self, user_id: str):
        """❌ SQL 注入漏洞"""
        query = f"SELECT * FROM users WHERE id = '{user_id}'"
        result = self.db.execute(text(query))
        return result.fetchone()

    def execute_command(self, command: str):
        """❌ 命令注入漏洞"""
        result = subprocess.run(f"ls {command}", shell=True, capture_output=True)
        return result.stdout.decode()

    def hash_password(self, password: str):
        """❌ 弱雜湊算法"""
        return hashlib.md5(password.encode()).hexdigest()

    def get_secret_key(self):
        """❌ 硬編碼密鑰"""
        secret = "super_secret_key_123"
        return secret

    def debug_info(self):
        """❌ 敏感資訊洩露"""
        return {
            "database_url": os.getenv("DATABASE_URL"),
            "api_key": os.getenv("API_KEY"),
            "debug": True
        }
```

**這段程式碼的安全問題**：
1. **SQL 注入**：直接字串插值建構 SQL
2. **命令注入**：shell=True + 用戶輸入
3. **弱雜湊**：MD5 已不安全
4. **硬編碼密鑰**：密鑰寫在程式碼中
5. **資訊洩露**：除錯資訊包含敏感資料

---

## 🎯 任務目標

### 必達目標
1. ✅ 整合 **CodeQL** 靜態分析到 GitHub Actions
2. ✅ 整合 **bandit** Python 安全掃描工具
3. ✅ 配置安全掃描在品質檢查之後執行
4. ✅ 設定發現高危漏洞時讓 workflow 失敗
5. ✅ 在 GitHub Security tab 查看掃描結果

### 加分項目
- 🌟 配置 **Semgrep** 額外的安全掃描
- 🌟 建立安全掃描結果摘要
- 🌟 設定 PR 評論顯示漏洞資訊
- 🌟 區分不同嚴重等級的處理方式

---

## 📚 學習檢查點

完成此情境題時，請確認你能回答：

### Checkpoint 1：安全掃描工具
- [ ] CodeQL 和 bandit 的差別是什麼？
- [ ] 靜態分析能發現哪些類型的漏洞？
- [ ] 什麼是 SAST（Static Application Security Testing）？

### Checkpoint 2：漏洞類型
- [ ] SQL 注入的原理和預防方法？
- [ ] 命令注入的風險和防護？
- [ ] 為什麼 MD5 不安全？
- [ ] 硬編碼密鑰的危害？

### Checkpoint 3：CI/CD 安全整合
- [ ] 如何在 GitHub Actions 中設定 CodeQL？
- [ ] 如何設定安全掃描的失敗條件？
- [ ] 如何查看和理解安全掃描報告？

---

## 🚀 實作步驟

### 方法 1：用 Claude 生成（推薦）

#### 步驟 1：準備提示詞

```
我需要在現有的 CI/CD 管線中加入安全掃描。

當前 workflow 包括：
1. 程式碼品質檢查（flake8, black, isort）
2. 單元測試

現在要加入安全掃描：
1. CodeQL 靜態分析（GitHub 原生）
2. bandit Python 安全掃描
3. 安全掃描要在品質檢查之後、測試之前執行

需求：
- 如果發現 HIGH 或 CRITICAL 漏洞，讓 workflow 失敗
- 結果要顯示在 GitHub Security tab
- 在 PR 中顯示掃描摘要

專案是 Python FastAPI 應用。

請提供：
1. 完整的修改後 workflow
2. bandit 的配置檔案
3. 本機執行安全掃描的指令
4. 常見漏洞的修復範例

請加上詳細註解。
```

#### 步驟 2：啟用 CodeQL

在 GitHub 專案中：
1. `Settings` → `Security` → `Code security and analysis`
2. 啟用 `CodeQL analysis`
3. 或者手動在 workflow 中配置

#### 步驟 3：建立 bandit 配置

```bash
# 建立 .bandit 配置檔案
touch .bandit
# 將 Claude 建議的配置貼上
```

#### 步驟 4：修改 Workflow

```bash
# 備份現有檔案
cp .github/workflows/test.yml .github/workflows/test.yml.backup

# 修改 workflow
vim .github/workflows/test.yml
# 將 Claude 生成的內容貼上
```

### 方法 2：手動配置（學習用）

#### 步驟 1：了解工具

**CodeQL**：
- GitHub 開發的語義代碼分析引擎
- 支援多種語言（Python、JavaScript、Java 等）
- 能追蹤數據流，發現複雜漏洞
- 免費且整合在 GitHub 中

**bandit**：
- Python 專用的安全 linter
- 檢查常見的安全問題
- 輕量級，執行快速
- 開源且可自訂規則

#### 步驟 2：建立 bandit 配置

**bandit 配置檔（.bandit）**：
```yaml
# Bandit configuration file
skips: ['B101']  # 跳過 assert_used 檢查（測試檔案常用）

exclude_dirs:
  - /tests
  - /venv
  - /.venv

# 測試相關的規則調整
[bandit]
# B101: assert_used - 測試檔案中的 assert 是正常的
# B601: paramiko_calls - 如果使用 paramiko 且確認安全
# B602: subprocess_popen_with_shell_equals_true - 需要謹慎使用

# 只檢查 HIGH 和 MEDIUM 嚴重等級
confidence: HIGH
severity: HIGH,MEDIUM
```

#### 步驟 3：修改 Workflow

在現有 workflow 中加入安全掃描 job：

```yaml
name: Test, Quality Check and Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Job 1: 程式碼品質檢查
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    # ... (保持原有配置)

  # Job 2: 安全掃描（新增）
  security-scan:
    name: Security Scan
    needs: quality-check
    runs-on: ubuntu-latest
    permissions:
      security-events: write  # CodeQL 需要的權限
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # CodeQL 初始化
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python
        queries: security-extended  # 使用擴展安全查詢

    # 自動建構（Python 不需要編譯）
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    # 執行 CodeQL 分析
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

    # bandit 安全掃描
    - name: Install bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]

    - name: Run bandit security scan
      run: |
        echo "🔒 Running bandit security scan..."
        bandit -r app -f json -o bandit-report.json
        bandit -r app -f txt
      continue-on-error: true

    # 檢查嚴重漏洞
    - name: Check for critical vulnerabilities
      run: |
        # 檢查 bandit 報告中的 HIGH 嚴重等級
        if [ -f bandit-report.json ]; then
          HIGH_ISSUES=$(cat bandit-report.json | jq '.results | map(select(.issue_severity == "HIGH")) | length')
          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "❌ Found $HIGH_ISSUES high severity security issues!"
            echo "Please review and fix these issues before merging."
            exit 1
          else
            echo "✅ No high severity security issues found."
          fi
        fi

    # 上傳安全報告
    - name: Upload bandit report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  # Job 3: 測試（依賴安全掃描通過）
  test:
    name: Run Tests
    needs: security-scan
    runs-on: ubuntu-latest
    # ... (保持原有配置)
```

#### 步驟 4：測試配置

本機執行安全掃描：

```bash
# 安裝工具
pip install bandit[toml]

# 執行 bandit 掃描
bandit -r app -v

# 生成報告
bandit -r app -f json -o security-report.json
bandit -r app -f html -o security-report.html
```

---

## ✅ 參考解答

### 完整 Workflow（test.yml）

```yaml
name: Complete CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: 程式碼品質檢查
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy

    - name: Run quality checks
      run: |
        echo "🔍 Running flake8..."
        flake8 app tests
        echo "🎨 Checking black formatting..."
        black --check app tests
        echo "📚 Checking import sorting..."
        isort --check-only app tests

  # Job 2: 安全掃描
  security-scan:
    name: Security Analysis
    needs: quality-check
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # CodeQL 安全分析
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python
        queries: security-extended,security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:python"

    # bandit 安全掃描
    - name: Install bandit
      run: |
        pip install bandit[toml]

    - name: Run bandit security scan
      id: bandit
      run: |
        echo "🔒 Running bandit security scan..."
        bandit -r app -f json -o bandit-report.json -ll
        bandit -r app -f txt | tee bandit-output.txt

        # 檢查是否有高危漏洞
        HIGH_COUNT=$(cat bandit-report.json | jq '.results | map(select(.issue_severity == "HIGH")) | length // 0')
        MEDIUM_COUNT=$(cat bandit-report.json | jq '.results | map(select(.issue_severity == "MEDIUM")) | length // 0')

        echo "high_issues=$HIGH_COUNT" >> $GITHUB_OUTPUT
        echo "medium_issues=$MEDIUM_COUNT" >> $GITHUB_OUTPUT

        echo "📊 Security scan summary:"
        echo "High severity issues: $HIGH_COUNT"
        echo "Medium severity issues: $MEDIUM_COUNT"
      continue-on-error: true

    # 安全掃描摘要
    - name: Security scan summary
      run: |
        echo "## 🔒 Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status | High | Medium |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL | ✅ Completed | - | - |" >> $GITHUB_STEP_SUMMARY
        echo "| bandit | ✅ Completed | ${{ steps.bandit.outputs.high_issues }} | ${{ steps.bandit.outputs.medium_issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in the Security tab." >> $GITHUB_STEP_SUMMARY

    # 檢查是否有嚴重漏洞
    - name: Fail on critical vulnerabilities
      if: steps.bandit.outputs.high_issues > 0
      run: |
        echo "❌ Found ${{ steps.bandit.outputs.high_issues }} high severity security issues!"
        echo "Please review and fix these issues before merging."
        echo ""
        echo "Detailed report:"
        cat bandit-output.txt
        exit 1

    # 上傳安全報告
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit-output.txt

  # Job 3: 測試
  test:
    name: Run Tests
    needs: security-scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run tests with coverage
      run: |
        pytest --cov=app --cov-report=term --cov-report=xml -v

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
```

### bandit 配置檔（.bandit）

```yaml
skips:
  - B101  # assert_used (測試檔案中的 assert)
  - B601  # paramiko_calls (如果確認 paramiko 使用安全)

exclude_dirs:
  - "tests"
  - "venv"
  - ".venv"
  - "__pycache__"

# 只掃描應用程式代碼
include: "app"

# 測試相關設定
[bandit.assert_used]
skips = ["*test*.py", "test_*.py"]
```

### pyproject.toml 整合配置

```toml
[tool.bandit]
exclude_dirs = ["tests", "venv", ".venv"]
skips = ["B101", "B601"]

# 安全掃描設定
[tool.bandit.assert_used]
exclude = ["*test*.py"]

# 如果使用 Semgrep
[tool.semgrep]
config = "auto"
```

---

## 🔍 驗證與除錯

### 測試安全掃描

**1. 觀察漏洞偵測**

提交有安全問題的程式碼，觀察掃描結果：

```bash
git add app/security.py
git commit -m "test: add code with security issues"
git push
```

應該看到：
- bandit 檢測到多個安全問題
- workflow 因高危漏洞而失敗
- GitHub Security tab 顯示 CodeQL 結果

**2. 修復漏洞**

修復 `app/security.py` 中的問題：

```python
import os
import hashlib
import secrets
from fastapi import HTTPException
from sqlalchemy import text
from typing import Optional

class UserService:
    def __init__(self, db):
        self.db = db

    def get_user_by_id(self, user_id: str) -> Optional[dict]:
        """✅ 使用參數化查詢防止 SQL 注入"""
        query = text("SELECT * FROM users WHERE id = :user_id")
        result = self.db.execute(query, {"user_id": user_id})
        return result.fetchone()

    def hash_password(self, password: str) -> str:
        """✅ 使用安全的雜湊算法"""
        salt = secrets.token_hex(16)
        password_hash = hashlib.pbkdf2_hmac('sha256',
                                          password.encode(),
                                          salt.encode(),
                                          100000)
        return f"{salt}:{password_hash.hex()}"

    def get_secret_key(self) -> str:
        """✅ 從環境變數讀取密鑰"""
        secret = os.getenv("SECRET_KEY")
        if not secret:
            raise ValueError("SECRET_KEY environment variable not set")
        return secret

    def debug_info(self) -> dict:
        """✅ 只在開發環境提供除錯資訊"""
        if os.getenv("ENVIRONMENT") == "development":
            return {
                "debug": True,
                "version": "1.0.0"
            }
        return {"debug": False}
```

**3. 驗證修復**

```bash
# 本機測試
bandit -r app -v

# 提交修復
git add app/security.py
git commit -m "fix: resolve security vulnerabilities"
git push
```

現在 workflow 應該通過！

### 常見問題與解決

**問題 1：CodeQL 權限錯誤**
```
Error: Could not upload results: 403 Forbidden
```

**解決**：確保 workflow 有正確權限
```yaml
permissions:
  security-events: write
  contents: read
  actions: read
```

**問題 2：bandit 誤報**
```
Issue: [B101:assert_used] Use of assert detected
```

**解決**：在 `.bandit` 中排除測試檔案
```yaml
skips: ["B101"]
exclude_dirs: ["tests"]
```

**問題 3：太多 LOW 等級警告**
```
bandit 報告了 50+ 個 LOW 等級問題
```

**解決**：只關注 HIGH 和 MEDIUM
```bash
bandit -r app -ll  # 只顯示 LOW 以上等級
bandit -r app -i   # 增加信心等級過濾
```

---

## 🌟 延伸挑戰

### 挑戰 1：整合 Semgrep

加入更強大的安全掃描工具：

```yaml
- name: Run Semgrep
  uses: returntocorp/semgrep-action@v1
  with:
    config: >-
      p/security-audit
      p/secrets
      p/python
  env:
    SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
```

### 挑戰 2：安全報告儀表板

建立安全漏洞摘要：

```yaml
- name: Generate security dashboard
  run: |
    echo "## 🛡️ Security Dashboard" > security-dashboard.md
    echo "" >> security-dashboard.md

    # CodeQL 結果
    echo "### CodeQL Analysis" >> security-dashboard.md
    echo "Status: ✅ Completed" >> security-dashboard.md
    echo "View results in Security tab" >> security-dashboard.md
    echo "" >> security-dashboard.md

    # bandit 結果
    echo "### bandit Security Scan" >> security-dashboard.md
    HIGH_COUNT=$(cat bandit-report.json | jq '.results | map(select(.issue_severity == "HIGH")) | length // 0')
    MEDIUM_COUNT=$(cat bandit-report.json | jq '.results | map(select(.issue_severity == "MEDIUM")) | length // 0')
    LOW_COUNT=$(cat bandit-report.json | jq '.results | map(select(.issue_severity == "LOW")) | length // 0')

    echo "| Severity | Count |" >> security-dashboard.md
    echo "|----------|-------|" >> security-dashboard.md
    echo "| 🔴 High | $HIGH_COUNT |" >> security-dashboard.md
    echo "| 🟡 Medium | $MEDIUM_COUNT |" >> security-dashboard.md
    echo "| 🟢 Low | $LOW_COUNT |" >> security-dashboard.md

- name: Comment security dashboard on PR
  if: github.event_name == 'pull_request'
  uses: actions/github-script@v6
  with:
    script: |
      const fs = require('fs');
      const dashboard = fs.readFileSync('security-dashboard.md', 'utf8');
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: dashboard
      });
```

### 挑戰 3：安全掃描快取

優化安全掃描速度：

```yaml
- name: Cache CodeQL database
  uses: actions/cache@v3
  with:
    path: |
      /home/runner/work/_temp/codeql_databases
    key: codeql-${{ runner.os }}-${{ github.sha }}
    restore-keys: |
      codeql-${{ runner.os }}-

- name: Cache bandit cache
  uses: actions/cache@v3
  with:
    path: ~/.cache/bandit
    key: bandit-${{ runner.os }}-${{ hashFiles('app/**/*.py') }}
```

### 挑戰 4：自動安全修復

整合 AI 自動修復建議：

```yaml
- name: Generate security fix suggestions
  if: steps.bandit.outputs.high_issues > 0
  run: |
    echo "## 🤖 AI Security Fix Suggestions" > fix-suggestions.md
    echo "" >> fix-suggestions.md

    # 讀取 bandit 報告並生成修復建議
    python scripts/generate_fix_suggestions.py bandit-report.json >> fix-suggestions.md

- name: Comment fix suggestions
  if: github.event_name == 'pull_request' && steps.bandit.outputs.high_issues > 0
  uses: actions/github-script@v6
  with:
    script: |
      const fs = require('fs');
      const suggestions = fs.readFileSync('fix-suggestions.md', 'utf8');
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: suggestions
      });
```

---

## 📖 知識回顧

完成這個情境題後，你應該學會：

### 核心概念
- ✅ 靜態安全分析的重要性（SAST）
- ✅ CodeQL 和 bandit 的工作原理
- ✅ 常見 Python 安全漏洞類型
- ✅ 漏洞嚴重等級分類

### 實戰技能
- ✅ 在 CI/CD 中整合安全掃描
- ✅ 配置安全掃描工具
- ✅ 理解和修復安全漏洞
- ✅ 設定安全檢查的失敗條件

### 最佳實踐
- ✅ 安全左移（Shift Security Left）
- ✅ 自動化安全檢查
- ✅ 漏洞修復的優先級管理
- ✅ 安全報告的可視化

### 進階概念
- ✅ 多層安全掃描策略
- ✅ 安全掃描結果的 CI/CD 整合
- ✅ 自動化安全修復流程

---

## 📝 學習筆記範本

```markdown
## B03 學習筆記

### 完成時間
[填寫]

### 安全工具理解
- **CodeQL**：[你的理解]
- **bandit**：[你的理解]
- **Semgrep**：[你的理解]

### 漏洞類型掌握
1. **SQL 注入**：[原理和防護方法]
2. **命令注入**：[原理和防護方法]
3. **弱加密**：[問題和改進方案]
4. **硬編碼密鑰**：[風險和解決方案]

### 遇到的問題
1. [問題描述]
   - 解決方案：[...]
2. [問題描述]
   - 解決方案：[...]

### 關鍵學習點
1. 安全左移的重要性：[...]
2. 自動化安全檢查的價值：[...]
3. 漏洞修復的系統化方法：[...]

### 應用到實際專案的計畫
- [ ] 為現有專案加入安全掃描
- [ ] 建立安全漏洞修復流程
- [ ] 培訓團隊安全意識

### 下一步
- [ ] 完成挑戰 1
- [ ] 進入 B04
```

---

**恭喜完成 B03！** 你已經掌握靜態安全分析的核心技能。接下來前往 `B04_建立Docker構建流程.md`，學習容器化部署的自動化流程。