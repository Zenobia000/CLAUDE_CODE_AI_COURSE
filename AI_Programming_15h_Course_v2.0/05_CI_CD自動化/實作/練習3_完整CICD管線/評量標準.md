# 評量標準：練習 3 - 完整 CI/CD 管線（端到端）

## 📊 總分：100 分

---

## 評分結構

| 項目 | 配分 | 說明 |
|------|------|------|
| CI 管線整合 | 25 分 | 持續整合的完整性 |
| CD 管線實現 | 30 分 | 持續部署的正確性 |
| 部署驗證 | 15 分 | 健康檢查與煙霧測試 |
| 回退機制 | 15 分 | 災難恢復能力 |
| 系統可靠性 | 10 分 | 整體穩定性與最佳實踐 |
| 文檔完整性 | 5 分 | 部署指南與運維文檔 |

---

## 📋 詳細評分標準

### 一、CI 管線整合（25 分）

#### 1.1 完整的測試管線（8 分）

**✅ 滿分標準（8 分）**：
- [ ] Lint、Test、Security 三個 jobs 並行執行（3 分）
- [ ] 所有檢查通過才能繼續（2 分）
- [ ] 測試覆蓋率 ≥ 80%（2 分）
- [ ] 執行時間優化（< 8 分鐘）（1 分）

**評分細則**：
- **並行執行**：
  - 使用獨立的 jobs
  - 不應串行執行（浪費時間）
  - Cache 配置正確

- **門檻控制**：
  - Build job 使用 `needs: [lint, test, security]`
  - 任一失敗則停止後續步驟

**⚠️ 常見扣分**：
- Jobs 串行執行：-3 分
- 無 needs 依賴：-2 分
- 執行時間 > 10 分鐘：-1 分

---

#### 1.2 安全掃描集成（8 分）

**✅ 滿分標準（8 分）**：
- [ ] CodeQL 靜態分析（3 分）
- [ ] 依賴漏洞掃描（3 分）
- [ ] 容器映像掃描 Trivy（2 分）

**評分細則**：
- **三層防護**：
  - Layer 1: CodeQL（代碼層）
  - Layer 2: Snyk/Dependabot（依賴層）
  - Layer 3: Trivy（容器層）

- **容器掃描**（重點）：
  - 掃描構建的 Docker 映像
  - 檢測基礎映像漏洞
  - High/Critical 漏洞時失敗

**範例 Trivy 配置**：
```yaml
- name: Run Trivy scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'ghcr.io/${{ github.repository }}:${{ github.sha }}'
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH'
    exit-code: '1'  # 發現漏洞時失敗
```

---

#### 1.3 Docker 構建與推送（9 分）

**✅ 滿分標準（9 分）**：
- [ ] 成功構建 Docker 映像（3 分）
- [ ] 映像標記策略正確（3 分）
- [ ] 推送到 Registry（3 分）

**映像標記策略**（重要）：
```yaml
# ✅ 正確的標記策略
tags: |
  ghcr.io/${{ github.repository }}:${{ github.sha }}
  ghcr.io/${{ github.repository }}:latest
  ghcr.io/${{ github.repository }}:v1.0.0  # 如果是 release
```

**評分細則**：
- **標記正確性**（3 分）：
  - 必須包含 git SHA（便於追蹤）
  - 可以包含 `latest`
  - Release 應包含版本號

- **Registry 選擇**：
  - GitHub Container Registry（推薦）
  - Docker Hub
  - 其他私有 Registry

**⚠️ 常見錯誤**：
- 只使用 `latest` 標記：-2 分（無法追蹤版本）
- 未推送到 Registry：-3 分
- 認證配置錯誤：-2 分

---

### 二、CD 管線實現（30 分）

#### 2.1 多環境配置（8 分）

**✅ 滿分標準（8 分）**：
- [ ] 開發環境配置完整（2 分）
- [ ] 測試環境配置完整（3 分）
- [ ] 生產環境配置完整（3 分）

**每個環境應包含**：
1. `docker-compose.yml` 或 K8s 配置
2. `.env.example` 環境變數範本
3. 資源配置（CPU、Memory 限制）
4. 健康檢查配置
5. 重啟策略

**環境差異範例**：
```yaml
# development
services:
  app:
    build: .
    volumes:
      - .:/app  # 掛載本地代碼（熱重載）
    environment:
      - DEBUG=true

# production
services:
  app:
    image: ghcr.io/user/repo:${VERSION}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
      restart_policy:
        condition: on-failure
    environment:
      - DEBUG=false
```

**評分細則**：
- **配置完整性**：所有環境都有完整配置
- **環境差異**：體現不同環境的特性
- **安全性**：生產環境無調試模式

---

#### 2.2 自動化部署流程（12 分）

**✅ 滿分標準（12 分）**：
- [ ] 開發環境自動部署（3 分）
- [ ] 測試環境自動部署（4 分）
- [ ] 生產環境需審批後部署（5 分）

**部署流程設計**：
```yaml
name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # 部署到開發環境

  deploy-staging:
    needs: deploy-dev
    # 部署到測試環境

  deploy-production:
    needs: deploy-staging
    environment:
      name: production
      url: https://prod.example.com
    # 需要審批，部署到生產環境
```

**評分細則**：
- **觸發條件**（2 分）：
  - CI 成功後自動觸發
  - 只在 main 分支

- **環境保護**（5 分）：
  - 生產環境配置 required reviewers
  - 審批後才能部署
  - 部署 URL 正確設置

- **部署方法**（5 分）：
  - SSH 到遠端伺服器 或
  - 使用雲端服務 API 或
  - 使用 K8s 部署

**部署方法範例**：

**方式 1：Docker Compose（適合小型專案）**
```yaml
- name: Deploy to production
  uses: appleboy/ssh-action@master
  with:
    host: ${{ secrets.PROD_HOST }}
    username: ${{ secrets.PROD_USER }}
    key: ${{ secrets.SSH_KEY }}
    script: |
      cd /app
      docker-compose pull
      docker-compose up -d
```

**方式 2：雲端服務（推薦）**
- Railway
- Render
- Fly.io
- AWS ECS/Fargate

---

#### 2.3 部署策略實現（10 分）

**✅ 滿分標準（10 分）**：

**基礎部署**（6 分）：
- [ ] 直接部署或滾動更新（6 分）

**進階部署**（10 分，擇一實現）：
- [ ] **藍綠部署**（10 分）
  - 同時運行兩個環境
  - 流量切換機制
  - 快速回退能力

- [ ] **金絲雀發布**（10 分）
  - 漸進式流量切換（10% → 50% → 100%）
  - 監控指標驗證
  - 自動回退機制

**藍綠部署範例**：
```yaml
- name: Deploy to blue environment
  run: |
    docker-compose -f docker-compose.blue.yml up -d

- name: Health check blue
  run: ./scripts/health-check.sh http://blue.example.com

- name: Switch traffic to blue
  run: |
    # 更新 load balancer 或 nginx 配置
    ./scripts/switch-to-blue.sh

- name: Stop green environment
  run: docker-compose -f docker-compose.green.yml down
```

**評分細則**：
- **基礎部署**（6 分）：
  - 能夠成功部署
  - 服務正常啟動
  - 基本的健康檢查

- **藍綠部署**（10 分）：
  - 零停機時間
  - 流量切換成功
  - 舊版本保留可回退

- **金絲雀發布**（10 分）：
  - 漸進式發布
  - 監控指標驗證
  - 異常自動回退

---

### 三、部署驗證（15 分）

#### 3.1 健康檢查（8 分）

**✅ 滿分標準（8 分）**：
- [ ] 健康檢查端點實現（3 分）
- [ ] 部署後自動執行健康檢查（3 分）
- [ ] 健康檢查失敗時處理（2 分）

**健康檢查端點要求**：
```python
# app/health.py
from fastapi import APIRouter, HTTPException
import time

router = APIRouter()

@router.get("/health")
async def health_check():
    """
    健康檢查端點
    檢查：應用狀態、資料庫連線、外部依賴
    """
    checks = {}

    # 檢查資料庫
    try:
        # db.execute("SELECT 1")
        checks["database"] = "ok"
    except Exception as e:
        checks["database"] = f"error: {str(e)}"

    # 檢查外部 API（如果有）
    # checks["external_api"] = "ok"

    # 判斷整體健康狀態
    is_healthy = all(v == "ok" for v in checks.values())

    response = {
        "status": "healthy" if is_healthy else "unhealthy",
        "version": "1.0.0",
        "checks": checks,
        "timestamp": time.time()
    }

    if not is_healthy:
        raise HTTPException(status_code=503, detail=response)

    return response
```

**Workflow 健康檢查**：
```yaml
- name: Wait for deployment
  run: sleep 30

- name: Health check
  run: |
    for i in {1..10}; do
      if curl -f https://prod.example.com/health; then
        echo "Health check passed"
        exit 0
      fi
      echo "Attempt $i failed, retrying..."
      sleep 10
    done
    echo "Health check failed"
    exit 1
```

**評分細則**：
- **端點實現**（3 分）：
  - 檢查應用狀態
  - 檢查資料庫連線
  - 檢查外部依賴（如果有）
  - 返回詳細資訊

- **自動執行**（3 分）：
  - 部署後自動檢查
  - 重試機制（最多 N 次）
  - 超時設置

- **失敗處理**（2 分）：
  - 失敗時終止部署
  - 觸發告警
  - 自動回退（進階）

---

#### 3.2 煙霧測試（7 分）

**✅ 滿分標準（7 分）**：
- [ ] 煙霧測試腳本實現（4 分）
- [ ] 測試覆蓋關鍵路徑（2 分）
- [ ] 測試失敗時處理（1 分）

**煙霧測試腳本**：
```bash
#!/bin/bash
# scripts/smoke-test.sh

set -e

API_URL="${API_URL:-http://localhost:8000}"
TIMEOUT=30

echo "Running smoke tests against $API_URL"

# 測試 1：健康檢查
echo "Test 1: Health check"
response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health")
if [ "$response" -ne 200 ]; then
    echo "❌ Health check failed (HTTP $response)"
    exit 1
fi
echo "✅ Health check passed"

# 測試 2：主頁
echo "Test 2: Homepage"
response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/")
if [ "$response" -ne 200 ]; then
    echo "❌ Homepage failed (HTTP $response)"
    exit 1
fi
echo "✅ Homepage passed"

# 測試 3：API 端點
echo "Test 3: API endpoint"
response=$(curl -s "$API_URL/api/items/1")
if ! echo "$response" | jq -e '.id' > /dev/null; then
    echo "❌ API endpoint failed"
    exit 1
fi
echo "✅ API endpoint passed"

# 測試 4：回應時間
echo "Test 4: Response time"
time=$(curl -o /dev/null -s -w '%{time_total}\n' "$API_URL/")
if (( $(echo "$time > 1.0" | bc -l) )); then
    echo "⚠️  Response time slow: ${time}s"
else
    echo "✅ Response time ok: ${time}s"
fi

echo ""
echo "🎉 All smoke tests passed!"
```

**評分細則**：
- **測試完整性**（4 分）：
  - 健康檢查端點
  - 主要 API 端點
  - 資料庫讀寫（如果有）
  - 回應時間檢查

- **關鍵路徑**（2 分）：
  - 測試最重要的功能
  - 不需要測試所有端點
  - 重點是快速驗證部署成功

- **失敗處理**（1 分）：
  - 返回非零狀態碼
  - 清晰的錯誤訊息

---

### 四、回退機制（15 分）

#### 4.1 回退 Workflow（8 分）

**✅ 滿分標準（8 分）**：
- [ ] 回退 workflow 可手動觸發（3 分）
- [ ] 支援回退到任意版本（3 分）
- [ ] 回退後自動驗證（2 分）

**Workflow 配置**：
```yaml
name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '要回退的環境'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: '目標版本（Docker 映像 tag）'
        required: true
        type: string
      reason:
        description: '回退原因'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Validate version exists
        run: |
          # 檢查 Docker 映像是否存在
          docker manifest inspect ghcr.io/${{ github.repository }}:${{ inputs.version }}

      - name: Rollback to ${{ inputs.version }}
        run: |
          # 部署指定版本
          ./scripts/deploy.sh ${{ inputs.environment }} ${{ inputs.version }}

      - name: Health check
        run: ./scripts/health-check.sh

      - name: Smoke test
        run: ./scripts/smoke-test.sh

      - name: Notify team
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "🔄 Rollback completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Rollback to v${{ inputs.version }}*\nEnvironment: ${{ inputs.environment }}\nReason: ${{ inputs.reason }}"
                  }
                }
              ]
            }
```

**評分細則**：
- **觸發機制**（3 分）：
  - `workflow_dispatch` 手動觸發
  - 輸入參數：環境、版本、原因
  - 參數驗證

- **版本控制**（3 分）：
  - 驗證目標版本存在
  - 支援任意歷史版本
  - 版本號格式正確

- **自動驗證**（2 分）：
  - 回退後執行健康檢查
  - 執行煙霧測試
  - 通知團隊

---

#### 4.2 自動回退機制（7 分，進階）

**✅ 滿分標準（7 分）**：
- [ ] 健康檢查失敗自動觸發回退（4 分）
- [ ] 保留上一版本資訊（2 分）
- [ ] 回退日誌記錄（1 分）

**自動回退邏輯**：
```yaml
- name: Deploy new version
  id: deploy
  run: ./scripts/deploy.sh production ${{ github.sha }}

- name: Health check with retry
  id: health_check
  run: |
    if ! ./scripts/health-check.sh; then
      echo "Health check failed, triggering rollback"
      echo "rollback_needed=true" >> $GITHUB_OUTPUT
    fi

- name: Auto rollback
  if: steps.health_check.outputs.rollback_needed == 'true'
  run: |
    echo "Rolling back to previous version: ${{ env.PREVIOUS_VERSION }}"
    ./scripts/rollback.sh production ${{ env.PREVIOUS_VERSION }}

- name: Verify rollback
  if: steps.health_check.outputs.rollback_needed == 'true'
  run: ./scripts/health-check.sh
```

**評分細則**：
- **自動觸發**（4 分）：
  - 健康檢查失敗自動回退
  - 無需人工介入
  - 回退邏輯可靠

- **版本管理**（2 分）：
  - 記錄當前版本
  - 保留前一版本資訊
  - 支援多次回退

- **日誌記錄**（1 分）：
  - 記錄回退事件
  - 記錄回退原因
  - 可追蹤

**注意**：自動回退為進階功能，基礎要求是手動回退（8 分）

---

### 五、系統可靠性（10 分）

#### 5.1 錯誤處理與重試（5 分）

**✅ 滿分標準（5 分）**：
- [ ] 關鍵步驟有重試機制（3 分）
- [ ] 超時設置合理（1 分）
- [ ] 錯誤訊息清晰（1 分）

**重試機制範例**：
```yaml
- name: Deploy with retry
  uses: nick-invision/retry@v2
  with:
    timeout_minutes: 10
    max_attempts: 3
    retry_wait_seconds: 30
    command: ./scripts/deploy.sh production
```

**評分細則**：
- 部署失敗重試（最多 3 次）
- 健康檢查重試（最多 10 次）
- 網路請求超時設置
- 錯誤訊息包含足夠調試資訊

---

#### 5.2 監控與通知（5 分）

**✅ 滿分標準（5 分）**：
- [ ] 部署狀態通知（Slack/Email）（3 分）
- [ ] 失敗告警（2 分）

**Slack 通知範例**：
```yaml
- name: Notify deployment start
  uses: slackapi/slack-github-action@v1
  with:
    payload: |
      {
        "text": "🚀 Deployment started",
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "*Deployment to Production*\nVersion: `${{ github.sha }}`\nTriggered by: @${{ github.actor }}"
            }
          }
        ]
      }

- name: Notify on success
  if: success()
  # 發送成功通知

- name: Notify on failure
  if: failure()
  # 發送失敗告警
```

**評分細則**：
- **通知時機**（3 分）：
  - 部署開始
  - 部署成功
  - 部署失敗
  - 回退發生

- **告警**（2 分）：
  - 失敗時立即告警
  - 包含錯誤詳情
  - 提供相關連結

---

### 六、文檔完整性（5 分）

#### 6.1 部署指南（3 分）

**✅ 滿分標準（3 分）**：
- [ ] 本地開發指南（1 分）
- [ ] 部署流程說明（1 分）
- [ ] 故障排除指南（1 分）

**必要內容**：
```markdown
# 部署指南

## 本地開發
1. 環境準備
2. 安裝依賴
3. 運行應用
4. 執行測試

## CI/CD 流程
### CI 階段
- Lint → Test → Security → Build

### CD 階段
- Deploy to Dev → Staging → Production

## 環境配置
### 開發環境
- URL: http://localhost:8000
- 配置: development.env

### 生產環境
- URL: https://prod.example.com
- 配置: 使用 GitHub Secrets

## 回退流程
1. 前往 Actions → Rollback
2. 選擇環境和目標版本
3. 填寫回退原因
4. 執行回退

## 常見問題
- 部署失敗？檢查健康檢查端點
- 測試失敗？查看測試日誌
- 回退失敗？確認目標版本存在
```

---

#### 6.2 架構圖與流程圖（2 分）

**✅ 滿分標準（2 分）**：
- [ ] CI/CD 流程圖（1 分）
- [ ] 部署架構圖（1 分）

**範例**（可使用 Mermaid 或圖片）：
```markdown
## CI/CD 流程

flowchart LR
    A[Push Code] --> B[Lint]
    A --> C[Test]
    A --> D[Security]
    B --> E[Build Docker]
    C --> E
    D --> E
    E --> F[Deploy Dev]
    F --> G[Deploy Staging]
    G --> H{Approve?}
    H -->|Yes| I[Deploy Prod]
    H -->|No| J[End]
    I --> K[Health Check]
    K --> L{Healthy?}
    L -->|Yes| M[Success]
    L -->|No| N[Rollback]
```

---

## 🚫 常見扣分項

### 嚴重問題（直接不及格）

1. **生產環境部署無審批機制**：0 分（安全風險）
2. **無健康檢查直接上線**：0 分（可靠性風險）
3. **無回退機制**：0 分（運維風險）
4. **抄襲或直接複製答案**：0 分

### 重大缺陷（-20 分以上）

1. **部署失敗無告警**：-20 分
2. **健康檢查失敗仍繼續部署**：-20 分
3. **多環境配置混亂**：-15 分

### 一般問題（-10 分以下）

1. **無並行執行優化**：-8 分
2. **執行時間過長**（> 15 分鐘）：-5 分
3. **文檔不完整**：-5 分
4. **無監控通知**：-5 分

---

## ✅ 優秀作品標準（90 分以上）

要獲得 90 分以上，需要滿足：

### 必要條件
- [ ] 完整的 CI 管線（23+ 分）
- [ ] 多環境自動化部署（28+ 分）
- [ ] 完善的健康檢查和煙霧測試（14+ 分）
- [ ] 可靠的回退機制（13+ 分）
- [ ] 監控和通知系統（8+ 分）
- [ ] 完整的文檔（5 分）

### 進階特徵（至少滿足 2 項）
- [ ] 藍綠部署或金絲雀發布
- [ ] 自動回退機制
- [ ] 完善的監控面板
- [ ] 詳細的部署指標追蹤

### 企業級標準（100+ 分，加分項）
- [ ] Kubernetes 部署（+5 分）
- [ ] 完整的可觀測性（日誌、指標、追蹤）（+5 分）
- [ ] 自動化效能測試（+3 分）
- [ ] 災難恢復演練腳本（+2 分）

---

## 📝 自評表

| 項目 | 自評分數 | 說明 |
|------|---------|------|
| **CI 管線整合** | | |
| ├─ 測試管線 | /8 | |
| ├─ 安全掃描 | /8 | |
| └─ Docker 構建 | /9 | |
| **CD 管線實現** | | |
| ├─ 多環境配置 | /8 | |
| ├─ 自動化部署 | /12 | |
| └─ 部署策略 | /10 | |
| **部署驗證** | | |
| ├─ 健康檢查 | /8 | |
| └─ 煙霧測試 | /7 | |
| **回退機制** | | |
| ├─ 回退 Workflow | /8 | |
| └─ 自動回退 | /7 | |
| **系統可靠性** | | |
| ├─ 錯誤處理 | /5 | |
| └─ 監控通知 | /5 | |
| **文檔完整性** | | |
| ├─ 部署指南 | /3 | |
| └─ 架構圖 | /2 | |
| **總分** | **/100** | |
| **加分項** | | 最多 +15 |

---

## 🎯 達成建議

### 要獲得 70 分（及格）
- 完整的 CI 管線（測試 + 掃描 + 構建）
- 基本的多環境部署（至少 2 個環境）
- 健康檢查機制
- 手動回退能力

### 要獲得 85 分（良好）
- 在及格基礎上：
- 三個環境完整配置
- 自動化部署流程
- 煙霧測試
- 監控通知
- 完整文檔

### 要獲得 95+ 分（優秀）
- 在良好基礎上：
- 藍綠部署或金絲雀發布
- 自動回退機制
- 完善的監控系統
- 企業級文檔
- 至少 1 項加分功能

---

## 💡 評量重點提示

評量時重點關注：

1. **可靠性 > 功能豐富**
   - 簡單但穩定 > 複雜但不穩定
   - 有效的回退 > 炫技的部署策略

2. **自動化程度**
   - 從提交到部署全自動
   - 問題發現自動化
   - 回退自動化（進階）

3. **運維友好**
   - 清晰的錯誤訊息
   - 完整的文檔
   - 便捷的操作流程

4. **安全與審批**
   - 生產環境必須有審批
   - 敏感操作必須記錄
   - 符合最佳實踐

---

**記住**：完整的 CI/CD 管線是現代軟體工程的基石。

這不只是自動化部署，更是建立可靠、快速、安全的發布流程！🚀
