# 評量標準：練習 2 - 安全掃描自動化

## 📊 總分：100 分

---

## 評分結構

| 項目 | 配分 | 說明 |
|------|------|------|
| 安全掃描配置 | 40 分 | 多層次掃描實現 |
| 漏洞修復品質 | 35 分 | 漏洞修復的正確性和完整性 |
| AI 協作能力 | 10 分 | 有效利用 AI 工具 |
| 安全意識 | 10 分 | 安全最佳實踐 |
| 文檔與報告 | 5 分 | 修復報告和文檔 |

---

## 📋 詳細評分標準

### 一、安全掃描配置（40 分）

#### 1.1 Layer 1：靜態代碼分析 - CodeQL（15 分）

**✅ 滿分標準（15 分）**：
- [ ] CodeQL workflow 正確配置（5 分）
- [ ] 掃描結果上傳到 GitHub Security（3 分）
- [ ] 發現所有預期的代碼漏洞（4 分）
  - SQL 注入
  - XSS 漏洞
  - 不安全的輸入處理
- [ ] 配置觸發條件合理（3 分）
  - push 到 main
  - pull request
  - 定時掃描（每週）

**評分細則**：
- **配置正確性**：
  - 語言設定正確（Python）
  - 查詢套件使用 `security-and-quality`
  - 掃描路徑正確

- **結果上傳**：
  - SARIF 格式上傳到 GitHub
  - Security tab 可以看到 alerts

- **漏洞發現**：
  - SQL 注入：至少發現 2 個（在 database.py）
  - XSS：至少發現 1 個（在 main.py）
  - 不安全輸入：至少發現 1 個

**⚠️ 部分分數**：
- 只發現部分漏洞：按比例給分
- 掃描結果未上傳：-3 分
- 觸發條件不完整：-2 分

**❌ 零分情況**：
- CodeQL 完全未配置
- 配置錯誤無法執行
- 掃描結果完全錯誤

---

#### 1.2 Layer 2：依賴漏洞掃描 - Snyk/Dependabot（12 分）

**✅ 滿分標準（12 分）**：
- [ ] 依賴掃描工具正確配置（4 分）
- [ ] 發現 requirements.txt 中的已知漏洞（4 分）
- [ ] 配置漏洞嚴重性閾值（2 分）
  - High/Critical 漏洞導致 workflow 失敗
- [ ] 產生可讀的掃描報告（2 分）

**評分細則**：
- **工具選擇**（擇一即可）：
  - Snyk（推薦）
  - Dependabot
  - Safety
  - pip-audit

- **漏洞發現**：
  - 至少發現 3 個有漏洞的依賴
  - 正確識別漏洞等級（Critical/High/Medium）

- **失敗機制**：
  - 配置 `fail-on` 參數
  - High 以上漏洞時 workflow 失敗
  - 錯誤訊息清晰

**⚠️ 部分分數**：
- 只掃描但不處理結果：-4 分
- 無失敗機制：-2 分
- 報告不清晰：-2 分

**❌ 零分情況**：
- 完全未配置依賴掃描
- 掃描工具配置錯誤

---

#### 1.3 Layer 3：密鑰掃描 - Gitleaks（8 分）

**✅ 滿分標準（8 分）**：
- [ ] Gitleaks 正確配置（3 分）
- [ ] 發現硬編碼的 API keys（3 分）
- [ ] 發現硬編碼的密碼（如果有）（2 分）

**評分細則**：
- **掃描範圍**：
  - 掃描所有檔案
  - 包括歷史提交（進階）

- **發現能力**：
  - 在 `auth.py` 發現硬編碼 secret
  - 正確識別密鑰類型

- **報告**：
  - 明確指出密鑰位置（檔案和行號）
  - 提供修復建議

**⚠️ 部分分數**：
- 只掃描部分檔案：-2 分
- 漏報密鑰：-3 分

**❌ 零分情況**：
- 完全未配置密鑰掃描
- 配置錯誤無法執行

---

#### 1.4 掃描整合與自動化（5 分）

**✅ 滿分標準（5 分）**：
- [ ] 三層掃描並行執行（2 分）
- [ ] 任一掃描失敗時阻止 PR 合併（2 分）
- [ ] 掃描結果集中呈現（1 分）

**評分細則**：
- **並行執行**：
  - 使用 `needs` 或獨立 jobs
  - 不應串行執行（浪費時間）

- **阻止合併**：
  - 設定 required checks
  - 或配置 branch protection rules

- **結果呈現**：
  - GitHub Security tab 集中顯示
  - 或產生統一報告

---

### 二、漏洞修復品質（35 分）

#### 2.1 SQL 注入修復（15 分）

**✅ 滿分標準（15 分）**：
- [ ] 正確使用參數化查詢（10 分）
- [ ] 修復所有 SQL 注入點（3 分）
- [ ] 手動驗證修復有效（2 分）

**修復範例**：

```python
# ❌ 錯誤（有 SQL 注入風險）
def get_user(user_id):
    query = f"SELECT * FROM users WHERE id = {user_id}"
    return db.execute(query)

# ✅ 正確（使用參數化查詢）
def get_user(user_id):
    query = "SELECT * FROM users WHERE id = ?"
    return db.execute(query, (user_id,))
```

**評分細則**：
- **修復方法正確性**（10 分）：
  - 使用參數化查詢（如 `?` 佔位符）
  - 或使用 ORM（如 SQLAlchemy）
  - 絕不使用字串拼接

- **修復完整性**（3 分）：
  - database.py 所有函數都修復
  - 無遺漏的 SQL 注入點

- **驗證**（2 分）：
  - 提供驗證步驟
  - 證明攻擊已無效

**⚠️ 常見錯誤**：
- 使用輸入驗證代替參數化查詢：-8 分（治標不治本）
- 只修復部分漏洞：按比例扣分
- 修復後引入新問題：-5 分

**❌ 零分情況**：
- 未修復 SQL 注入
- 修復方法完全錯誤
- 修復後功能損壞

---

#### 2.2 XSS 漏洞修復（8 分）

**✅ 滿分標準（8 分）**：
- [ ] 正確的輸出編碼（5 分）
- [ ] 使用安全的模板引擎或函式庫（2 分）
- [ ] 驗證修復有效（1 分）

**修復範例**：

```python
# ❌ 錯誤（有 XSS 風險）
@app.get("/user/{name}")
def get_user(name: str):
    return HTMLResponse(f"<h1>Hello {name}</h1>")

# ✅ 正確（使用安全的模板）
from fastapi.templating import Jinja2Templates
templates = Jinja2Templates(directory="templates")

@app.get("/user/{name}")
def get_user(name: str, request: Request):
    return templates.TemplateResponse("user.html", {
        "request": request,
        "name": name  # Jinja2 自動轉義
    })

# 或使用 escape
from html import escape

@app.get("/user/{name}")
def get_user(name: str):
    safe_name = escape(name)
    return HTMLResponse(f"<h1>Hello {safe_name}</h1>")
```

**評分細則**：
- **修復方法**（5 分）：
  - 使用 `html.escape()` 或
  - 使用 Jinja2 自動轉義 或
  - 使用 `bleach` 或 `MarkupSafe`

- **函式庫選擇**（2 分）：
  - 使用成熟的安全函式庫
  - 不自己實現轉義邏輯

**⚠️ 常見錯誤**：
- 只驗證輸入，不編碼輸出：-3 分
- 使用不完整的轉義（如只轉義 `<` `>`）：-4 分

---

#### 2.3 依賴漏洞修復（8 分）

**✅ 滿分標準（8 分）**：
- [ ] 識別所有有漏洞的依賴（3 分）
- [ ] 正確升級到安全版本（4 分）
- [ ] 驗證升級後功能正常（1 分）

**評分細則**：
- **識別能力**（3 分）：
  - 列出所有有漏洞的套件
  - 說明漏洞類型和 CVE 編號
  - 評估風險等級

- **升級策略**（4 分）：
  - Critical/High：必須升級（3 分）
  - Medium：評估後決定（1 分）
  - 檢查 breaking changes
  - 更新 requirements.txt

- **回歸測試**（1 分）：
  - 升級後執行測試
  - 確保功能無損

**⚠️ 常見錯誤**：
- 盲目升級未檢查相容性：-2 分
- 只升級部分依賴：按比例扣分
- 升級後未測試：-1 分

**示例報告**：
```markdown
## 依賴漏洞修復報告

### 發現的漏洞
1. requests 2.25.0
   - CVE-2021-33503
   - 風險：High
   - 影響：可能導致 ReDoS 攻擊
   - 修復：升級到 2.31.0

2. pillow 8.0.0
   - CVE-2021-23437
   - 風險：Critical
   - 影響：遠端代碼執行
   - 修復：升級到 10.0.0

### 升級結果
- ✅ 所有測試通過
- ✅ 功能正常運作
- ✅ 無 breaking changes
```

---

#### 2.4 密鑰移除與環境變數配置（4 分）

**✅ 滿分標準（4 分）**：
- [ ] 移除所有硬編碼密鑰（2 分）
- [ ] 改用環境變數（1 分）
- [ ] 提供 `.env.example`（1 分）

**修復範例**：

```python
# ❌ 錯誤（硬編碼）
API_KEY = "sk_live_1234567890abcdef"

# ✅ 正確（環境變數）
import os
from dotenv import load_dotenv

load_dotenv()
API_KEY = os.getenv("API_KEY")

if not API_KEY:
    raise ValueError("API_KEY environment variable not set")
```

**必要檔案**：

`.env.example`：
```bash
# API Configuration
API_KEY=your_api_key_here
DATABASE_URL=postgresql://user:pass@localhost/db
```

`.gitignore`：
```
.env
*.env
```

**⚠️ 常見錯誤**：
- 只移除密鑰但不提供替代方案：-2 分
- `.env` 檔案被提交到 git：-4 分（嚴重）
- 無 `.env.example`：-1 分

---

### 三、AI 協作能力（10 分）

#### 3.1 有效使用 AI 工具（7 分）

**✅ 滿分標準（7 分）**：
- [ ] 使用 Claude Code 分析漏洞（3 分）
- [ ] 使用 AI 生成修復方案（2 分）
- [ ] 驗證 AI 提供的修復（2 分）

**評分細則**：
- **分析漏洞**（3 分）：
  - 提示詞清晰明確
  - 讓 AI 解釋漏洞原理
  - 要求 AI 提供修復建議

- **生成修復**（2 分）：
  - 使用 AI 生成修復代碼
  - 不是完全手寫

- **驗證修復**（2 分）：
  - **關鍵**：不盲目信任 AI
  - 理解修復邏輯
  - 手動測試驗證

**優秀提示詞範例**：
```
我的代碼被 CodeQL 標記為 SQL 注入漏洞：

[貼上代碼]

請幫我：
1. 解釋為什麼這是 SQL 注入漏洞
2. 說明可能的攻擊場景
3. 提供安全的修復方案（使用參數化查詢）
4. 提供修復後的完整代碼
5. 說明如何驗證修復是否有效
```

**⚠️ 常見問題**：
- 盲目複製 AI 代碼未驗證：-2 分
- 提示詞不清晰導致錯誤修復：-2 分
- 完全不使用 AI 工具：-3 分

---

#### 3.2 使用 GitHub Copilot Autofix（3 分，選做）

**✅ 滿分標準（3 分）**：
- [ ] 使用 Copilot Autofix 功能（2 分）
- [ ] 檢視並驗證自動修復（1 分）

**評分細則**：
- 在 GitHub Security tab 使用 "Fix with Copilot"
- 檢查自動生成的 PR
- 驗證修復正確性
- 合併或調整修復

**注意**：此項為選做，如果未使用不扣分

---

### 四、安全意識（10 分）

#### 4.1 安全最佳實踐（6 分）

**✅ 滿分標準（6 分）**：
- [ ] 遵循「無掃描，不合併」原則（2 分）
- [ ] 配置 branch protection rules（2 分）
- [ ] 定時掃描配置（1 分）
- [ ] 安全政策文件（1 分，選做）

**評分細則**：
- **Branch Protection**：
  - 要求 status checks 通過
  - 包含安全掃描 checks
  - PR review 要求（進階）

- **定時掃描**：
  - 配置 cron schedule
  - 建議：每週掃描一次
  - 發現問題時通知

- **安全政策**（選做）：
  - 建立 `SECURITY.md`
  - 說明漏洞回報流程

---

#### 4.2 風險評估與優先級（4 分）

**✅ 滿分標準（4 分）**：
- [ ] 正確評估漏洞嚴重性（2 分）
- [ ] 合理安排修復優先級（2 分）

**評分細則**：
- **嚴重性評估**：
  - Critical/High → 立即修復
  - Medium → 計劃修復（1-2 週）
  - Low → 評估後決定

- **優先級排序**（考量因素）：
  - 漏洞嚴重性
  - 可利用性
  - 影響範圍
  - 修復成本

**範例評估**：
```markdown
## 漏洞優先級排序

### P0（立即修復）
1. SQL 注入（Critical）- 可遠端執行任意 SQL
2. pillow CVE-2021-23437（Critical）- RCE

### P1（本週修復）
3. XSS 漏洞（High）- 可竊取用戶資料
4. requests CVE（High）- ReDoS

### P2（計劃修復）
5. 過時的 lint 工具（Low）- 功能影響小
```

---

### 五、文檔與報告（5 分）

#### 5.1 漏洞修復報告（3 分）

**✅ 滿分標準（3 分）**：
- [ ] 列出發現的所有漏洞（1 分）
- [ ] 說明每個漏洞的修復方法（1 分）
- [ ] 提供驗證步驟（1 分）

**報告範本**：
```markdown
# 安全漏洞修復報告

## 掃描發現

### 靜態代碼分析（CodeQL）
- SQL 注入：2 個（database.py:15, 28）
- XSS：1 個（main.py:45）

### 依賴掃描（Snyk）
- Critical：1 個（pillow）
- High：2 個（requests, urllib3）

### 密鑰掃描（Gitleaks）
- API Key：1 個（auth.py:10）

## 修復詳情

### 1. SQL 注入修復
**位置**：database.py:15
**原代碼**：[...]
**修復方法**：使用參數化查詢
**修復後**：[...]
**驗證**：測試 SQL 注入攻擊已無效

[其他漏洞...]

## 驗證結果
- ✅ 所有安全掃描通過
- ✅ 功能測試通過
- ✅ 無新增漏洞
```

---

#### 5.2 README 更新（2 分）

**✅ 滿分標準（2 分）**：
- [ ] 說明安全掃描流程（1 分）
- [ ] 加入安全徽章（1 分）

**範例**：
```markdown
## 安全性

本專案實施多層次安全掃描：

- **靜態分析**：CodeQL 掃描代碼漏洞
- **依賴掃描**：Snyk 檢測第三方套件漏洞
- **密鑰掃描**：Gitleaks 防止密鑰洩漏

![Security](https://github.com/.../workflows/Security/badge.svg)
```

---

## 🚫 常見扣分項

### 嚴重問題（直接不及格）

1. **提交包含未修復的 Critical 漏洞**：0 分
2. **修復方法完全錯誤**（如用輸入驗證代替參數化查詢）：0 分
3. **抄襲或直接複製答案**：0 分

### 重大缺陷（-15 分以上）

1. **安全掃描失敗但忽略**：-20 分
2. **修復引入新的安全問題**：-15 分
3. **盲目信任 AI 未驗證修復**：-15 分

### 一般問題（-10 分以下）

1. **只修復部分漏洞**：-10 分
2. **掃描配置不完整**：-8 分
3. **無修復報告**：-5 分
4. **未使用 AI 工具**：-3 分

---

## ✅ 優秀作品標準（90 分以上）

要獲得 90 分以上，需要滿足：

### 必要條件
- [ ] 三層安全掃描完整實現（40 分）
- [ ] 所有漏洞正確修復（33+ 分）
- [ ] 有效使用 AI 工具（8+ 分）
- [ ] 遵循安全最佳實踐（9+ 分）
- [ ] 完整的修復報告（5 分）

### 優秀特徵
- [ ] 修復方法專業且安全
- [ ] AI 提示詞設計優秀
- [ ] 風險評估準確合理
- [ ] 文檔詳細且有幫助
- [ ] 展現優秀的安全意識

---

## 📝 自評表

| 項目 | 自評分數 | 說明 |
|------|---------|------|
| CodeQL 掃描 | /15 | |
| 依賴掃描 | /12 | |
| 密鑰掃描 | /8 | |
| 掃描整合 | /5 | |
| SQL 注入修復 | /15 | |
| XSS 修復 | /8 | |
| 依賴升級 | /8 | |
| 密鑰移除 | /4 | |
| AI 工具使用 | /7 | |
| Copilot Autofix | /3 | |
| 安全最佳實踐 | /6 | |
| 風險評估 | /4 | |
| 修復報告 | /3 | |
| README 更新 | /2 | |
| **總分** | **/100** | |

---

## 🎯 重點提示

### 核心原則

1. **安全優先**
   - 所有 Critical/High 漏洞必須修復
   - 不能因為「功能正常」就忽略安全問題

2. **驗證為王**
   - 不盲目信任掃描工具
   - 不盲目信任 AI 修復
   - 手動驗證每個修復

3. **深入理解**
   - 不只是修復，更要理解「為什麼」
   - 理解漏洞原理和攻擊場景
   - 理解修復方法的安全性

---

**記住**：在 AI 時代，40% 的生成代碼包含安全問題。

建立自動化安全掃描不是選項，而是必須！🔒
