# B04ï¼šåº«å­˜ç®¡ç†èšåˆè¨­è¨ˆ

## ğŸ“‹ æƒ…å¢ƒèƒŒæ™¯

**å…¬å¸**: E-Commerce Giant Inc.
**å°ˆæ¡ˆ**: åº«å­˜ç®¡ç†ç³»çµ±ï¼ˆInventory Management Systemï¼‰
**åœ˜éšŠè¦æ¨¡**: 4 äººé–‹ç™¼åœ˜éšŠ
**ç•¶å‰éšæ®µ**: æ ¸å¿ƒé ˜åŸŸå»ºæ¨¡éšæ®µ

### æ¥­å‹™èƒŒæ™¯

å…¬å¸é›»å•†å¹³å°åœ¨å¤§ä¿ƒæœŸé–“ï¼ˆå¦‚é›™11ã€é»‘è‰²æ˜ŸæœŸäº”ï¼‰ç¶“å¸¸å‡ºç¾è¶…è³£å•é¡Œï¼Œå°è‡´å®¢æˆ¶æŠ•è¨´å’Œé€€æ¬¾ã€‚æŠ€è¡“åœ˜éšŠæ±ºå®šé‡æ§‹åº«å­˜ç®¡ç†ç³»çµ±ï¼Œä½¿ç”¨ DDD è¨­è¨ˆä¸€å€‹å¯é çš„åº«å­˜ç®¡ç†é ˜åŸŸæ¨¡å‹ã€‚

**æ ¸å¿ƒæŒ‘æˆ°**ï¼š
- é«˜ä¸¦ç™¼å ´æ™¯ä¸‹çš„åº«å­˜æ‰£æ¸›ï¼ˆæ¯ç§’ä¸Šè¬ç­†è¨‚å–®ï¼‰
- é˜²æ­¢è¶…è³£ï¼ˆåº«å­˜ä¸è¶³æ™‚æ‹’çµ•è¨‚å–®ï¼‰
- åº«å­˜é ç•™æ©Ÿåˆ¶ï¼ˆè¨‚å–®å‰µå»ºæ™‚é ç•™ï¼Œæ”¯ä»˜æˆåŠŸæ™‚ç¢ºèªæ‰£æ¸›ï¼‰
- å¤šå€‰åº«ç®¡ç†ï¼ˆåŒä¸€å•†å“åœ¨ä¸åŒå€‰åº«æœ‰åº«å­˜ï¼‰

**ä½ çš„ä»»å‹™**ï¼šç‚ºåº«å­˜ä¸Šä¸‹æ–‡ï¼ˆInventory Contextï¼‰å»ºç«‹ DDD é ˜åŸŸæ¨¡å‹ï¼Œé‡é»è§£æ±ºä½µç™¼æ§åˆ¶å•é¡Œã€‚

---

## ğŸ¯ ä»»å‹™ç›®æ¨™

ä½¿ç”¨ AI è¼”åŠ©å®Œæˆä»¥ä¸‹ç”¢å‡ºï¼š

- [ ] é€šç”¨èªè¨€è©å½™è¡¨
- [ ] äº‹ä»¶é¢¨æš´åœ–ï¼ˆMermaidï¼‰
- [ ] èšåˆè¨­è¨ˆï¼ˆé‡é»ï¼šInventoryItem èšåˆï¼‰
- [ ] ä½µç™¼æ§åˆ¶æ–¹æ¡ˆè¨­è¨ˆï¼ˆæ¨‚è§€é– vs æ‚²è§€é–ï¼‰
- [ ] Python ç¨‹å¼ç¢¼å¯¦ç¾

---

## ğŸ“ æ¥­å‹™éœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. åº«å­˜ç®¡ç†
- å•†å“å…¥åº«ï¼ˆå¢åŠ åº«å­˜ï¼‰
- å•†å“å‡ºåº«ï¼ˆæ‰£æ¸›åº«å­˜ï¼‰
- åº«å­˜ç›¤é»ï¼ˆä¿®æ­£å¯¦éš›åº«å­˜èˆ‡ç³»çµ±åº«å­˜å·®ç•°ï¼‰
- åº«å­˜èª¿æ’¥ï¼ˆå€‰åº«ä¹‹é–“è½‰ç§»åº«å­˜ï¼‰
- å®‰å…¨åº«å­˜é è­¦ï¼ˆåº«å­˜ä½æ–¼å®‰å…¨ç·šæ™‚å‘Šè­¦ï¼‰

#### 2. åº«å­˜é ç•™æ©Ÿåˆ¶
**æ¥­å‹™æµç¨‹**ï¼š
1. å®¢æˆ¶ä¸‹å–®æ™‚ï¼Œç³»çµ±**é ç•™**åº«å­˜ï¼ˆç‹€æ…‹ï¼šå¯ç”¨åº«å­˜æ¸›å°‘ï¼Œé ç•™åº«å­˜å¢åŠ ï¼‰
2. å¦‚æœ 30 åˆ†é˜å…§æœªæ”¯ä»˜ï¼Œ**é‡‹æ”¾**é ç•™åº«å­˜
3. æ”¯ä»˜æˆåŠŸå¾Œï¼Œ**ç¢ºèªæ‰£æ¸›**åº«å­˜ï¼ˆé ç•™åº«å­˜è½‰ç‚ºå·²éŠ·å”®ï¼‰
4. è¨‚å–®å–æ¶ˆæ™‚ï¼Œ**é‡‹æ”¾**é ç•™åº«å­˜

**é—œéµæ¦‚å¿µ**ï¼š
- **ç¸½åº«å­˜ï¼ˆTotalï¼‰**: å€‰åº«å¯¦éš›æ“æœ‰çš„å•†å“æ•¸é‡
- **å¯ç”¨åº«å­˜ï¼ˆAvailableï¼‰**: å¯ä»¥è¢«é ç•™çš„æ•¸é‡ = ç¸½åº«å­˜ - é ç•™åº«å­˜ - å·²éŠ·å”®
- **é ç•™åº«å­˜ï¼ˆReservedï¼‰**: å·²è¢«è¨‚å–®é ç•™ä½†æœªç¢ºèªæ‰£æ¸›çš„æ•¸é‡
- **å·²éŠ·å”®ï¼ˆSoldï¼‰**: å·²ç¢ºèªæ‰£æ¸›çš„æ•¸é‡

**ä¸è®Šå¼**ï¼š
```
ç¸½åº«å­˜ = å¯ç”¨åº«å­˜ + é ç•™åº«å­˜ + å·²éŠ·å”®
```

#### 3. å¤šå€‰åº«ç®¡ç†
- åŒä¸€å•†å“ï¼ˆSKUï¼‰åœ¨å¤šå€‹å€‰åº«æœ‰åº«å­˜
- ä¸‹å–®æ™‚é¸æ“‡å°±è¿‘å€‰åº«
- åº«å­˜ä¸è¶³æ™‚å¯ä»¥å¾å…¶ä»–å€‰åº«èª¿æ’¥

#### 4. ä½µç™¼æ§åˆ¶
- æ”¯æ´é«˜ä¸¦ç™¼çš„åº«å­˜æ‰£æ¸›ï¼ˆç§’æ®ºå ´æ™¯ï¼‰
- é˜²æ­¢è¶…è³£ï¼ˆæ¨‚è§€é– or æ‚²è§€é–ï¼‰
- åŸå­æ€§æ“ä½œï¼ˆæ‰£æ¸›æ“ä½œä¸å¯åˆ†å‰²ï¼‰

---

### æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° |
|---------|------|
| BR-001 | å¯ç”¨åº«å­˜ >= 0ï¼ˆä¸èƒ½ç‚ºè² æ•¸ï¼‰|
| BR-002 | é ç•™æ•¸é‡ä¸èƒ½è¶…éå¯ç”¨åº«å­˜ |
| BR-003 | é ç•™åº«å­˜ 30 åˆ†é˜æœªç¢ºèªè‡ªå‹•é‡‹æ”¾ |
| BR-004 | ç¸½åº«å­˜ = å¯ç”¨åº«å­˜ + é ç•™åº«å­˜ + å·²éŠ·å”®ï¼ˆä¸è®Šå¼ï¼‰|
| BR-005 | åº«å­˜ä½æ–¼å®‰å…¨åº«å­˜æ™‚è§¸ç™¼è£œè²¨å‘Šè­¦ |
| BR-006 | åŒä¸€è¨‚å–®ä¸èƒ½é‡è¤‡æ‰£æ¸›åº«å­˜ |
| BR-007 | ç›¤é»æ™‚éœ€è¦é–å®šåº«å­˜ï¼Œç¦æ­¢æ‰£æ¸› |

---

### ä½µç™¼å ´æ™¯

**å ´æ™¯ 1ï¼šç§’æ®ºå ´æ™¯**
```
æ™‚é–“è»¸ï¼š
T1: å•†å“åº«å­˜ 100 ä»¶
T2: 1000 å€‹è«‹æ±‚åŒæ™‚åˆ°é”ï¼Œæ¯å€‹è«‹æ±‚è³¼è²· 1 ä»¶
T3: ç³»çµ±æ‡‰è©²åªå…è¨±å‰ 100 å€‹è«‹æ±‚æˆåŠŸï¼Œå¾Œ 900 å€‹è«‹æ±‚å¤±æ•—
```

**å ´æ™¯ 2ï¼šé ç•™è¶…æ™‚é‡‹æ”¾**
```
æ™‚é–“è»¸ï¼š
T1: ç”¨æˆ¶ A ä¸‹å–®ï¼Œé ç•™ 5 ä»¶ï¼ˆå¯ç”¨: 95, é ç•™: 5ï¼‰
T2: 30 åˆ†é˜å¾Œæœªæ”¯ä»˜
T3: ç³»çµ±è‡ªå‹•é‡‹æ”¾é ç•™ï¼ˆå¯ç”¨: 100, é ç•™: 0ï¼‰
```

**å ´æ™¯ 3ï¼šä¸¦ç™¼é ç•™åŒä¸€å•†å“**
```
ç”¨æˆ¶ A: é ç•™ 3 ä»¶
ç”¨æˆ¶ B: é ç•™ 5 ä»¶
ç•¶å‰åº«å­˜: å¯ç”¨ 6 ä»¶

æ­£ç¢ºçµæœ: ç”¨æˆ¶ A æˆåŠŸï¼Œç”¨æˆ¶ B å¤±æ•—ï¼ˆå‰©é¤˜ 3 ä»¶ä¸è¶³ï¼‰
éŒ¯èª¤çµæœ: å…©è€…éƒ½æˆåŠŸï¼ˆè¶…è³£ï¼‰
```

---

### ä½¿ç”¨è€…æ•…äº‹

**Story 1: ä¸‹å–®é ç•™åº«å­˜**
```
ä½œç‚ºè¨‚å–®ç³»çµ±
ç•¶ç”¨æˆ¶ä¸‹å–®æ™‚ï¼Œæˆ‘éœ€è¦é ç•™åº«å­˜
ä»¥ä¾¿é˜²æ­¢è¶…è³£
```

**Story 2: æ”¯ä»˜ç¢ºèªæ‰£æ¸›**
```
ä½œç‚ºè¨‚å–®ç³»çµ±
ç•¶ç”¨æˆ¶æ”¯ä»˜æˆåŠŸæ™‚ï¼Œæˆ‘éœ€è¦ç¢ºèªæ‰£æ¸›é ç•™çš„åº«å­˜
ä»¥ä¾¿æ›´æ–°åº«å­˜ç‹€æ…‹
```

**Story 3: å–æ¶ˆè¨‚å–®é‡‹æ”¾åº«å­˜**
```
ä½œç‚ºè¨‚å–®ç³»çµ±
ç•¶è¨‚å–®å–æ¶ˆæ™‚ï¼Œæˆ‘éœ€è¦é‡‹æ”¾é ç•™çš„åº«å­˜
ä»¥ä¾¿å…¶ä»–ç”¨æˆ¶å¯ä»¥è³¼è²·
```

**Story 4: åº«å­˜ç›¤é»**
```
ä½œç‚ºå€‰åº«ç®¡ç†å“¡
æˆ‘éœ€è¦å®šæœŸç›¤é»åº«å­˜
ä¸¦ä¿®æ­£ç³»çµ±è¨˜éŒ„èˆ‡å¯¦éš›åº«å­˜çš„å·®ç•°
```

---

## ğŸ”§ æŠ€è¡“è¦æ±‚

- **èªè¨€**: Python 3.11+
- **è¼¸å‡ºæ ¼å¼**:
  - é€šç”¨èªè¨€è©å½™è¡¨: Markdown
  - äº‹ä»¶é¢¨æš´åœ–: Mermaid Flowchart
  - é ˜åŸŸæ¨¡å‹é¡åœ–: Mermaid Class Diagram
  - ç¨‹å¼ç¢¼: Pythonï¼ˆä½¿ç”¨ dataclassesã€type hintsï¼‰
  - ä½µç™¼æ§åˆ¶: èªªæ˜æ¨‚è§€é–å¯¦ç¾åŸç†

---

## ğŸ“š å­¸ç¿’é‡é»

æœ¬æƒ…å¢ƒé‡é»å­¸ç¿’ï¼š

### 1. èšåˆè¨­è¨ˆçš„ä½µç™¼è€ƒé‡
- InventoryItem èšåˆå¦‚ä½•è¨­è¨ˆä»¥æ”¯æ´é«˜ä¸¦ç™¼ï¼Ÿ
- èšåˆæ ¹çš„ä¸è®Šå¼å¦‚ä½•åœ¨ä½µç™¼ä¸‹ä¿æŒï¼Ÿ

### 2. æ¨‚è§€é– vs æ‚²è§€é–
- ä»€éº¼å ´æ™¯ä½¿ç”¨æ¨‚è§€é–ï¼Ÿ
- ä»€éº¼å ´æ™¯ä½¿ç”¨æ‚²è§€é–ï¼Ÿ
- DDD é ˜åŸŸæ¨¡å‹ä¸­å¦‚ä½•å¯¦ç¾æ¨‚è§€é–ï¼Ÿ

### 3. é ˜åŸŸäº‹ä»¶
- `InventoryReserved`: åº«å­˜å·²é ç•™
- `InventoryDeducted`: åº«å­˜å·²æ‰£æ¸›
- `InventoryReleased`: åº«å­˜å·²é‡‹æ”¾
- `LowStockAlertTriggered`: ä½åº«å­˜å‘Šè­¦

### 4. æ¥­å‹™ä¸è®Šå¼
- å¦‚ä½•åœ¨ç¨‹å¼ç¢¼ä¸­å¼·åˆ¶åŸ·è¡Œä¸è®Šå¼ï¼Ÿ
- ä¸¦ç™¼æƒ…æ³ä¸‹å¦‚ä½•ä¿è­‰ä¸è®Šå¼ï¼Ÿ

---

## â±ï¸ æ™‚é–“å®‰æ’

å»ºè­°æ™‚é–“åˆ†é…ï¼š

- **éšæ®µ 1**: é€šç”¨èªè¨€æå–ï¼ˆ10 åˆ†é˜ï¼‰
- **éšæ®µ 2**: äº‹ä»¶é¢¨æš´ï¼ˆ10 åˆ†é˜ï¼‰
- **éšæ®µ 3**: èšåˆè¨­è¨ˆèˆ‡ä½µç™¼æ–¹æ¡ˆï¼ˆ15 åˆ†é˜ï¼‰
- **éšæ®µ 4**: ç¨‹å¼ç¢¼å¯¦ç¾ï¼ˆ10 åˆ†é˜ï¼‰

**ç¸½è¨ˆ**: 45 åˆ†é˜

---

## âœ… æª¢æŸ¥é»

### éšæ®µ 1: é€šç”¨èªè¨€è©å½™è¡¨
- [ ] è­˜åˆ¥æ ¸å¿ƒé ˜åŸŸæ¦‚å¿µï¼ˆInventoryItem, Reservation, Stockï¼‰
- [ ] å®šç¾©ç¸½åº«å­˜ã€å¯ç”¨åº«å­˜ã€é ç•™åº«å­˜çš„é—œä¿‚
- [ ] æå–æ¥­å‹™ä¸è®Šå¼

### éšæ®µ 2: äº‹ä»¶é¢¨æš´
- [ ] è­˜åˆ¥é ç•™-ç¢ºèª-é‡‹æ”¾çš„å®Œæ•´æµç¨‹
- [ ] æ¨™è¨˜ä½µç™¼è¡çªé»
- [ ] è¨­è¨ˆé ç•™è¶…æ™‚æ©Ÿåˆ¶

### éšæ®µ 3: èšåˆè¨­è¨ˆ
- [ ] è¨­è¨ˆ InventoryItem èšåˆæ ¹
- [ ] ç¢ºå®šæ¨‚è§€é–å¯¦ç¾æ–¹å¼ï¼ˆç‰ˆæœ¬è™Ÿï¼‰
- [ ] è¨­è¨ˆé ç•™è¨˜éŒ„çš„ç®¡ç†

### éšæ®µ 4: ç¨‹å¼ç¢¼å¯¦ç¾
- [ ] å¯¦ç¾ InventoryItem èšåˆæ ¹
- [ ] å¯¦ç¾æ¨‚è§€é–ç‰ˆæœ¬è™Ÿæ©Ÿåˆ¶
- [ ] å¯¦ç¾é ç•™ã€ç¢ºèªã€é‡‹æ”¾æ–¹æ³•
- [ ] å¯¦ç¾ä¸è®Šå¼æª¢æŸ¥

---

## ğŸ’¡ æç¤º

### æç¤º 1: æ¨‚è§€é–å¯¦ç¾

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šä½¿ç”¨ç‰ˆæœ¬è™Ÿï¼ˆVersion Numberï¼‰æª¢æ¸¬ä½µç™¼è¡çª

```python
@dataclass
class InventoryItem:
    """åº«å­˜é …èšåˆæ ¹"""
    sku: str
    total_quantity: int  # ç¸½åº«å­˜
    available_quantity: int  # å¯ç”¨åº«å­˜
    reserved_quantity: int  # é ç•™åº«å­˜
    version: int  # æ¨‚è§€é–ç‰ˆæœ¬è™Ÿ

    def reserve(self, quantity: int, order_id: str) -> None:
        """é ç•™åº«å­˜"""
        # æ¥­å‹™è¦å‰‡æª¢æŸ¥
        if quantity > self.available_quantity:
            raise InsufficientStockError(
                f"åº«å­˜ä¸è¶³ï¼Œéœ€è¦ {quantity}ï¼Œå¯ç”¨ {self.available_quantity}"
            )

        # æ›´æ–°åº«å­˜
        self.available_quantity -= quantity
        self.reserved_quantity += quantity

        # å¢åŠ ç‰ˆæœ¬è™Ÿï¼ˆæ¨‚è§€é–ï¼‰
        self.version += 1

        # ç™¼å¸ƒäº‹ä»¶
        self._add_domain_event(InventoryReserved(...))
```

**æŒä¹…åŒ–å±¤**ï¼ˆRepositoryï¼‰ä½¿ç”¨æ¨‚è§€é–ï¼š
```python
class InventoryRepository:
    def save(self, inventory: InventoryItem) -> None:
        """ä¿å­˜æ™‚æª¢æŸ¥ç‰ˆæœ¬è™Ÿ"""
        sql = """
        UPDATE inventory
        SET available_quantity = ?,
            reserved_quantity = ?,
            version = version + 1
        WHERE sku = ?
          AND version = ?  -- æ¨‚è§€é–æª¢æŸ¥
        """
        result = self.db.execute(sql, (
            inventory.available_quantity,
            inventory.reserved_quantity,
            inventory.sku,
            inventory.version  # ä½¿ç”¨èˆŠç‰ˆæœ¬è™Ÿ
        ))

        if result.rowcount == 0:
            # ç‰ˆæœ¬è™Ÿä¸åŒ¹é… = ä½µç™¼è¡çª
            raise ConcurrentModificationError("åº«å­˜å·²è¢«å…¶ä»–äº‹å‹™ä¿®æ”¹ï¼Œè«‹é‡è©¦")
```

---

### æç¤º 2: é ç•™è¨˜éŒ„çš„ç®¡ç†

**æ–¹æ¡ˆ A**: é ç•™è¨˜éŒ„åœ¨èšåˆå…§
```python
@dataclass
class Reservation:
    """é ç•™è¨˜éŒ„ï¼ˆå¯¦é«”ï¼‰"""
    reservation_id: str
    order_id: str
    quantity: int
    reserved_at: datetime
    expires_at: datetime
    status: ReservationStatus  # ACTIVE, CONFIRMED, RELEASED

@dataclass
class InventoryItem:
    sku: str
    total_quantity: int
    reservations: List[Reservation]  # é ç•™è¨˜éŒ„åˆ—è¡¨

    @property
    def reserved_quantity(self) -> int:
        """è¨ˆç®—é ç•™æ•¸é‡"""
        return sum(r.quantity for r in self.reservations
                  if r.status == ReservationStatus.ACTIVE)

    def reserve(self, quantity: int, order_id: str) -> None:
        if quantity > self.available_quantity:
            raise InsufficientStockError()

        reservation = Reservation(
            reservation_id=uuid4(),
            order_id=order_id,
            quantity=quantity,
            reserved_at=datetime.now(),
            expires_at=datetime.now() + timedelta(minutes=30),
            status=ReservationStatus.ACTIVE
        )
        self.reservations.append(reservation)

    def confirm_reservation(self, order_id: str) -> None:
        """ç¢ºèªé ç•™ï¼ˆæ”¯ä»˜æˆåŠŸï¼‰"""
        reservation = self._find_reservation(order_id)
        if not reservation:
            raise ReservationNotFoundError()

        reservation.status = ReservationStatus.CONFIRMED
        # å¾ç¸½åº«å­˜ä¸­çœŸæ­£æ‰£æ¸›
        self.total_quantity -= reservation.quantity
```

**å„ªé»**: å¯ä»¥è¿½è¹¤æ¯å€‹è¨‚å–®çš„é ç•™è¨˜éŒ„ï¼Œæ”¯æ´éƒ¨åˆ†é‡‹æ”¾
**ç¼ºé»**: èšåˆè¼ƒå¤§ï¼ŒæŸ¥è©¢é ç•™è¨˜éŒ„å¯èƒ½å½±éŸ¿æ€§èƒ½

---

**æ–¹æ¡ˆ B**: åªè¨˜éŒ„é ç•™ç¸½æ•¸ï¼ˆç°¡åŒ–ç‰ˆï¼‰
```python
@dataclass
class InventoryItem:
    sku: str
    total_quantity: int
    available_quantity: int
    reserved_quantity: int  # åªè¨˜éŒ„ç¸½æ•¸

    def reserve(self, quantity: int) -> None:
        if quantity > self.available_quantity:
            raise InsufficientStockError()

        self.available_quantity -= quantity
        self.reserved_quantity += quantity

    def confirm(self, quantity: int) -> None:
        """ç¢ºèªæ‰£æ¸›"""
        if quantity > self.reserved_quantity:
            raise InvalidOperationError()

        self.reserved_quantity -= quantity
        self.total_quantity -= quantity
```

**å„ªé»**: èšåˆç°¡å–®ï¼Œæ€§èƒ½å¥½
**ç¼ºé»**: ç„¡æ³•è¿½è¹¤å…·é«”æ˜¯å“ªå€‹è¨‚å–®çš„é ç•™

**æ¨è–¦**: æ–¹æ¡ˆ Aï¼ˆæ¥­å‹™éœ€è¦è¿½è¹¤ï¼‰

---

### æç¤º 3: ä¸è®Šå¼æª¢æŸ¥

**åœ¨æ¯æ¬¡ç‹€æ…‹è®Šæ›´å¾Œæª¢æŸ¥ä¸è®Šå¼**ï¼š

```python
class InventoryItem:
    def _check_invariants(self) -> None:
        """æª¢æŸ¥æ¥­å‹™ä¸è®Šå¼"""
        # ä¸è®Šå¼ 1: å¯ç”¨åº«å­˜ä¸èƒ½ç‚ºè² 
        if self.available_quantity < 0:
            raise InvariantViolationError(
                f"å¯ç”¨åº«å­˜ä¸èƒ½ç‚ºè² : {self.available_quantity}"
            )

        # ä¸è®Šå¼ 2: é ç•™åº«å­˜ä¸èƒ½ç‚ºè² 
        if self.reserved_quantity < 0:
            raise InvariantViolationError(
                f"é ç•™åº«å­˜ä¸èƒ½ç‚ºè² : {self.reserved_quantity}"
            )

        # ä¸è®Šå¼ 3: ç¸½åº«å­˜ = å¯ç”¨ + é ç•™ + å·²éŠ·å”®
        expected_total = (self.available_quantity +
                         self.reserved_quantity +
                         self.sold_quantity)
        if self.total_quantity != expected_total:
            raise InvariantViolationError(
                f"åº«å­˜æ•¸é‡ä¸ä¸€è‡´: total={self.total_quantity}, "
                f"expected={expected_total}"
            )

    def reserve(self, quantity: int, order_id: str) -> None:
        # æ¥­å‹™é‚è¼¯...
        self.available_quantity -= quantity
        self.reserved_quantity += quantity

        # æ¯æ¬¡ä¿®æ”¹å¾Œæª¢æŸ¥ä¸è®Šå¼
        self._check_invariants()
```

---

### æç¤º 4: ä½µç™¼è¡çªè™•ç†

**æ‡‰ç”¨å±¤ï¼ˆApplication Serviceï¼‰é‡è©¦æ©Ÿåˆ¶**ï¼š

```python
class InventoryApplicationService:
    def reserve_inventory(self, sku: str, quantity: int,
                         order_id: str, max_retries: int = 3) -> None:
        """é ç•™åº«å­˜ï¼ˆå«é‡è©¦ï¼‰"""
        for attempt in range(max_retries):
            try:
                # 1. å¾å€‰å„²åŠ è¼‰èšåˆ
                inventory = self.inventory_repo.find_by_sku(sku)

                # 2. åŸ·è¡Œé ˜åŸŸé‚è¼¯
                inventory.reserve(quantity, order_id)

                # 3. ä¿å­˜èšåˆï¼ˆæ¨‚è§€é–æª¢æŸ¥ï¼‰
                self.inventory_repo.save(inventory)

                # 4. ç™¼å¸ƒé ˜åŸŸäº‹ä»¶
                self.event_publisher.publish(inventory.get_domain_events())

                # æˆåŠŸï¼Œè¿”å›
                return

            except ConcurrentModificationError:
                # æ¨‚è§€é–è¡çªï¼Œé‡è©¦
                if attempt == max_retries - 1:
                    # æœ€å¾Œä¸€æ¬¡å˜—è©¦å¤±æ•—
                    raise InventoryReservationFailedError("ä½µç™¼è¡çªï¼Œè«‹ç¨å¾Œé‡è©¦")
                # ç­‰å¾…éš¨æ©Ÿæ™‚é–“å¾Œé‡è©¦ï¼ˆé¿å…æ´»é–ï¼‰
                time.sleep(random.uniform(0.01, 0.1))

            except InsufficientStockError:
                # åº«å­˜ä¸è¶³ï¼Œä¸é‡è©¦
                raise
```

---

## ğŸ“– åƒè€ƒè§£ç­”

<details>
<summary>é»æ“ŠæŸ¥çœ‹åƒè€ƒè§£ç­”ï¼ˆå»ºè­°å…ˆç¨ç«‹å®Œæˆï¼‰</summary>

### æ ¸å¿ƒè¨­è¨ˆæ±ºç­–

1. **èšåˆè¨­è¨ˆ**:
   - `InventoryItem` èšåˆï¼šä¸€å€‹ SKU çš„åº«å­˜é …
   - åŒ…å«é ç•™è¨˜éŒ„åˆ—è¡¨ï¼ˆæ–¹æ¡ˆ Aï¼‰

2. **ä½µç™¼æ§åˆ¶**:
   - ä½¿ç”¨**æ¨‚è§€é–**ï¼ˆversion å­—æ®µï¼‰
   - æ‡‰ç”¨å±¤å¯¦ç¾é‡è©¦æ©Ÿåˆ¶

3. **ä¸è®Šå¼**:
   - `total_quantity = available_quantity + reserved_quantity + sold_quantity`
   - `available_quantity >= 0`

4. **é ˜åŸŸäº‹ä»¶**:
   - `InventoryReserved`: åº«å­˜å·²é ç•™
   - `InventoryDeducted`: åº«å­˜å·²ç¢ºèªæ‰£æ¸›
   - `InventoryReleased`: é ç•™å·²é‡‹æ”¾
   - `LowStockAlert`: ä½åº«å­˜å‘Šè­¦

### InventoryItem èšåˆè¨­è¨ˆ

```mermaid
classDiagram
    class InventoryItem {
        <<Aggregate Root>>
        +str sku
        +int total_quantity
        +int available_quantity
        +int reserved_quantity
        +int sold_quantity
        +int version
        +List~Reservation~ reservations
        +reserve(quantity, order_id)
        +confirm(order_id)
        +release(order_id)
        +adjust(new_quantity)
        -_check_invariants()
    }

    class Reservation {
        <<Entity>>
        +str reservation_id
        +str order_id
        +int quantity
        +datetime reserved_at
        +datetime expires_at
        +ReservationStatus status
    }

    InventoryItem *-- Reservation
```

### å®Œæ•´ç¨‹å¼ç¢¼å¯¦ç¾

æ ¸å¿ƒé‚è¼¯åƒè€ƒæç¤ºéƒ¨åˆ†çš„ç¨‹å¼ç¢¼ç‰‡æ®µçµ„åˆå¯¦ç¾ã€‚

</details>

---

## ğŸ¤” åæ€å•é¡Œ

å®Œæˆå¾Œæ€è€ƒï¼š

1. **æ¨‚è§€é– vs æ‚²è§€é–**:
   - ç‚ºä»€éº¼åº«å­˜å ´æ™¯æ¨è–¦æ¨‚è§€é–ï¼Ÿ
   - ä»€éº¼æƒ…æ³ä¸‹æ‚²è§€é–æ›´åˆé©ï¼Ÿ

2. **èšåˆé‚Šç•Œ**:
   - ç‚ºä»€éº¼ Reservation æ‡‰è©²åœ¨ InventoryItem èšåˆå…§ï¼Ÿ
   - å¦‚æœç³»çµ±æœ‰ 1 å„„å€‹é ç•™è¨˜éŒ„ï¼Œè¨­è¨ˆå¦‚ä½•èª¿æ•´ï¼Ÿ

3. **ä½µç™¼æ€§èƒ½**:
   - æ¨‚è§€é–çš„é‡è©¦æ©Ÿåˆ¶å°æ€§èƒ½æœ‰ä½•å½±éŸ¿ï¼Ÿ
   - å¦‚ä½•é€²ä¸€æ­¥å„ªåŒ–é«˜ä¸¦ç™¼å ´æ™¯ï¼ˆå¦‚ï¼šåˆ†ä½ˆå¼é–ã€å‰Šå³°ï¼‰ï¼Ÿ

4. **æ¥­å‹™ä¸€è‡´æ€§**:
   - é ç•™é‡‹æ”¾æ‡‰è©²åŒæ­¥é‚„æ˜¯ç•°æ­¥ï¼Ÿ
   - å¦‚æœé‡‹æ”¾å¤±æ•—ï¼ˆç³»çµ±å´©æ½°ï¼‰ï¼Œå¦‚ä½•ä¿è­‰æœ€çµ‚ä¸€è‡´æ€§ï¼Ÿ

---

**æƒ…å¢ƒç‰ˆæœ¬**: v1.0
**é›£åº¦**: ä¸­ç­‰
**é ä¼°æ™‚é–“**: 30-45 åˆ†é˜
**æ ¸å¿ƒæŠ€èƒ½**: ä½µç™¼æ§åˆ¶ã€æ¨‚è§€é–ã€æ¥­å‹™ä¸è®Šå¼ã€èšåˆè¨­è¨ˆ
