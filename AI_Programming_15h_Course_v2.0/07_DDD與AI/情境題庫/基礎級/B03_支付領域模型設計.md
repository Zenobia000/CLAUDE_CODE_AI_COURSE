# B03ï¼šæ”¯ä»˜é ˜åŸŸæ¨¡å‹è¨­è¨ˆ

## ğŸ“‹ æƒ…å¢ƒèƒŒæ™¯

**å…¬å¸**: PayFast Technologies
**å°ˆæ¡ˆ**: çµ±ä¸€æ”¯ä»˜ç¶²é—œç³»çµ±ï¼ˆPayment Gatewayï¼‰
**åœ˜éšŠè¦æ¨¡**: 6 äººé–‹ç™¼åœ˜éšŠ
**ç•¶å‰éšæ®µ**: é ˜åŸŸå»ºæ¨¡éšæ®µ

### æ¥­å‹™èƒŒæ™¯

å…¬å¸æ­£åœ¨é–‹ç™¼ä¸€å€‹çµ±ä¸€æ”¯ä»˜ç¶²é—œï¼Œéœ€è¦æ•´åˆå¤šç¨®æ”¯ä»˜æ–¹å¼ï¼ˆä¿¡ç”¨å¡ã€è¡Œå‹•æ”¯ä»˜ã€éŠ€è¡Œè½‰å¸³ç­‰ï¼‰ï¼Œä¸¦ç‚ºå¤šå€‹æ¥­å‹™ç³»çµ±ï¼ˆé›»å•†ã€è¨‚é–±æœå‹™ã€ç·šä¸‹é›¶å”®ï¼‰æä¾›æ”¯ä»˜èƒ½åŠ›ã€‚

ç³»çµ±éœ€è¦è™•ç†ï¼š
- å¤šç¨®æ”¯ä»˜æ–¹å¼çš„çµ±ä¸€æŠ½è±¡
- æ”¯ä»˜ç‹€æ…‹è¿½è¹¤
- é€€æ¬¾è™•ç†
- å°å¸³èˆ‡æ¸…ç®—
- æ”¯ä»˜å®‰å…¨ï¼ˆPCI DSS åˆè¦ï¼‰

**ä½ çš„ä»»å‹™**ï¼šç‚ºæ”¯ä»˜ä¸Šä¸‹æ–‡ï¼ˆPayment Contextï¼‰å»ºç«‹ DDD é ˜åŸŸæ¨¡å‹ã€‚

---

## ğŸ¯ ä»»å‹™ç›®æ¨™

ä½¿ç”¨ AI è¼”åŠ©å®Œæˆä»¥ä¸‹ç”¢å‡ºï¼š

- [ ] é€šç”¨èªè¨€è©å½™è¡¨
- [ ] äº‹ä»¶é¢¨æš´åœ–ï¼ˆMermaidï¼‰
- [ ] èšåˆè¨­è¨ˆï¼ˆé‡é»ï¼šPayment èšåˆèˆ‡ Refund èšåˆï¼‰
- [ ] ç‹€æ…‹æ©Ÿè¨­è¨ˆï¼ˆæ”¯ä»˜ç‹€æ…‹æµè½‰ï¼‰
- [ ] Python ç¨‹å¼ç¢¼å¯¦ç¾

---

## ğŸ“ æ¥­å‹™éœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. æ”¯ä»˜æ–¹å¼ç®¡ç†
æ”¯æ´å¤šç¨®æ”¯ä»˜æ–¹å¼ï¼š
- **ä¿¡ç”¨å¡æ”¯ä»˜**ï¼ˆVisaã€MasterCardã€JCBï¼‰
- **è¡Œå‹•æ”¯ä»˜**ï¼ˆApple Payã€Google Payã€LINE Payï¼‰
- **ç¬¬ä¸‰æ–¹æ”¯ä»˜**ï¼ˆæ”¯ä»˜å¯¶ã€å¾®ä¿¡æ”¯ä»˜ã€PayPalï¼‰
- **éŠ€è¡Œè½‰å¸³**ï¼ˆATM è½‰å¸³ã€ç¶²è·¯éŠ€è¡Œï¼‰
- **è²¨åˆ°ä»˜æ¬¾**ï¼ˆCOD - Cash on Deliveryï¼‰

æ¯ç¨®æ”¯ä»˜æ–¹å¼éœ€è¦ä¸åŒçš„æ†‘è­‰ä¿¡æ¯ï¼š
- ä¿¡ç”¨å¡ï¼šå¡è™Ÿã€åˆ°æœŸæ—¥ã€CVVã€æŒå¡äººå§“å
- è¡Œå‹•æ”¯ä»˜ï¼šæˆæ¬Š Token
- éŠ€è¡Œè½‰å¸³ï¼šè½‰å¸³å¸³è™Ÿã€è½‰å¸³ç¢¼

#### 2. æ”¯ä»˜æµç¨‹
**æ¨™æº–æ”¯ä»˜æµç¨‹**ï¼š
1. å‰µå»ºæ”¯ä»˜è¨‚å–®ï¼ˆé—œè¯æ¥­å‹™è¨‚å–® IDã€é‡‘é¡ã€å¹£ç¨®ï¼‰
2. é¸æ“‡æ”¯ä»˜æ–¹å¼
3. ç™¼èµ·æ”¯ä»˜è«‹æ±‚ï¼ˆèª¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ APIï¼‰
4. ç­‰å¾…æ”¯ä»˜çµæœï¼ˆåŒæ­¥æˆ–ç•°æ­¥å›èª¿ï¼‰
5. æ›´æ–°æ”¯ä»˜ç‹€æ…‹
6. é€šçŸ¥æ¥­å‹™ç³»çµ±

**ç‰¹æ®Šæƒ…æ³**ï¼š
- éƒ¨åˆ†é‡‘é¡æ”¯ä»˜ï¼ˆå¦‚ï¼šè¨‚å–® 100 å…ƒï¼Œå…ˆæ”¯ä»˜ 50 å…ƒï¼‰
- è¶…é¡æ”¯ä»˜è™•ç†ï¼ˆå¦‚ï¼šè¨‚å–® 100 å…ƒï¼Œæ”¯ä»˜ 120 å…ƒï¼‰
- æ”¯ä»˜è¶…æ™‚è‡ªå‹•å–æ¶ˆï¼ˆ30 åˆ†é˜ï¼‰

#### 3. é€€æ¬¾ç®¡ç†
- å…¨é¡é€€æ¬¾
- éƒ¨åˆ†é€€æ¬¾ï¼ˆå¤šæ¬¡éƒ¨åˆ†é€€æ¬¾ï¼Œç¸½é¡ä¸è¶…éæ”¯ä»˜é‡‘é¡ï¼‰
- é€€æ¬¾åŸå› è¨˜éŒ„
- é€€æ¬¾ç‹€æ…‹è¿½è¹¤ï¼ˆé€€æ¬¾ä¸­ã€é€€æ¬¾æˆåŠŸã€é€€æ¬¾å¤±æ•—ï¼‰
- é€€æ¬¾åˆ°åŸæ”¯ä»˜æ–¹å¼

#### 4. å°å¸³èˆ‡æ¸…ç®—
- æ¯æ—¥å°å¸³ï¼ˆç³»çµ±è¨˜éŒ„ vs ç¬¬ä¸‰æ–¹å¹³å°è¨˜éŒ„ï¼‰
- æ¸…ç®—å ±è¡¨ç”Ÿæˆ
- ç•°å¸¸äº¤æ˜“æ¨™è¨˜
- æ‰‹çºŒè²»è¨ˆç®—ï¼ˆä¸åŒæ”¯ä»˜æ–¹å¼æ‰‹çºŒè²»ä¸åŒï¼‰

#### 5. å®‰å…¨èˆ‡åˆè¦
- ä¿¡ç”¨å¡è³‡è¨ŠåŠ å¯†å­˜å„²ï¼ˆPCI DSS åˆè¦ï¼‰
- æ”¯ä»˜å¯†ç¢¼é©—è­‰ï¼ˆéƒ¨åˆ†æ”¯ä»˜æ–¹å¼ï¼‰
- é¢¨éšªæ§åˆ¶ï¼ˆå¦‚ï¼šå–®ç­†é™é¡ã€æ—¥é™é¡ã€ç•°å¸¸äº¤æ˜“æª¢æ¸¬ï¼‰
- å¯©è¨ˆæ—¥èªŒ

---

### æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° |
|---------|------|
| BR-001 | æ”¯ä»˜é‡‘é¡å¿…é ˆ > 0 |
| BR-002 | é€€æ¬¾ç¸½é‡‘é¡ä¸èƒ½è¶…éå·²æ”¯ä»˜é‡‘é¡ |
| BR-003 | åªæœ‰æ”¯ä»˜æˆåŠŸçš„è¨‚å–®æ‰èƒ½é€€æ¬¾ |
| BR-004 | æ”¯ä»˜è¨‚å–® 30 åˆ†é˜æœªå®Œæˆè‡ªå‹•å–æ¶ˆ |
| BR-005 | ä¿¡ç”¨å¡æ”¯ä»˜éœ€è¦ 3D é©—è­‰ï¼ˆé‡‘é¡ > 1000 å…ƒï¼‰|
| BR-006 | åŒä¸€ç­†æ¥­å‹™è¨‚å–®ä¸èƒ½å‰µå»ºå¤šå€‹å¾…æ”¯ä»˜çš„æ”¯ä»˜è¨‚å–® |
| BR-007 | é€€æ¬¾ç”³è«‹éœ€è¦äººå·¥å¯©æ ¸ï¼ˆé‡‘é¡ > 5000 å…ƒï¼‰|
| BR-008 | è²¨åˆ°ä»˜æ¬¾ä¸æ”¯æ´ç·šä¸Šé€€æ¬¾ |

---

### æ”¯ä»˜ç‹€æ…‹æ©Ÿ

```
CREATED (å·²å‰µå»º)
    â†“
PENDING (å¾…æ”¯ä»˜) â”€â”€â”€â”€â”€â”€â†’ CANCELLED (å·²å–æ¶ˆ)
    â†“                      â†‘
PROCESSING (è™•ç†ä¸­)        â”‚
    â†“                      â”‚
PAID (å·²æ”¯ä»˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (è¶…æ™‚å–æ¶ˆ)
    â†“
REFUNDING (é€€æ¬¾ä¸­)
    â†“
REFUNDED (å·²é€€æ¬¾)
```

---

### ä½¿ç”¨è€…æ•…äº‹

**Story 1: å‰µå»ºæ”¯ä»˜è¨‚å–®**
```
ä½œç‚ºæ¥­å‹™ç³»çµ±ï¼ˆå¦‚è¨‚å–®ç³»çµ±ï¼‰
æˆ‘æƒ³è¦ç‚ºè¨‚å–®å‰µå»ºæ”¯ä»˜è«‹æ±‚
ä»¥ä¾¿å®¢æˆ¶å¯ä»¥æ”¯ä»˜
```

**Story 2: ä¿¡ç”¨å¡æ”¯ä»˜**
```
ä½œç‚ºå®¢æˆ¶
æˆ‘æƒ³è¦ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜è¨‚å–®
ä¸¦æ¥æ”¶æ”¯ä»˜çµæœé€šçŸ¥
```

**Story 3: ç”³è«‹é€€æ¬¾**
```
ä½œç‚ºå®¢æˆ¶æœå‹™äººå“¡
æˆ‘æƒ³è¦ç‚ºå®¢æˆ¶ç”³è«‹é€€æ¬¾
ä¸¦è¿½è¹¤é€€æ¬¾ç‹€æ…‹
```

**Story 4: æ¯æ—¥å°å¸³**
```
ä½œç‚ºè²¡å‹™äººå“¡
æˆ‘éœ€è¦æ¯æ—¥è‡ªå‹•å°å¸³
ä¸¦ç”Ÿæˆå·®ç•°å ±è¡¨
```

**Story 5: ç•°å¸¸äº¤æ˜“è™•ç†**
```
ä½œç‚ºé¢¨æ§ç³»çµ±
æˆ‘éœ€è¦æª¢æ¸¬ç•°å¸¸äº¤æ˜“ï¼ˆå¦‚ï¼šçŸ­æ™‚é–“å…§å¤šæ¬¡æ”¯ä»˜ï¼‰
ä¸¦è‡ªå‹•å‡çµå¯ç–‘æ”¯ä»˜
```

---

## ğŸ”§ æŠ€è¡“è¦æ±‚

- **èªè¨€**: Python 3.11+
- **è¼¸å‡ºæ ¼å¼**:
  - é€šç”¨èªè¨€è©å½™è¡¨: Markdown
  - äº‹ä»¶é¢¨æš´åœ–: Mermaid Flowchart
  - ç‹€æ…‹æ©Ÿåœ–: Mermaid State Diagram
  - é ˜åŸŸæ¨¡å‹é¡åœ–: Mermaid Class Diagram
  - ç¨‹å¼ç¢¼: Pythonï¼ˆä½¿ç”¨ dataclassesã€type hintsï¼‰

---

## ğŸ“š å­¸ç¿’é‡é»

æœ¬æƒ…å¢ƒé‡é»å­¸ç¿’ï¼š

### 1. å€¼å°è±¡çš„é«˜ç´šæ‡‰ç”¨
- **Moneyï¼ˆé‡‘é¡ï¼‰**: é‡‘é¡ + å¹£ç¨®ï¼Œæ”¯æ´é‹ç®—
- **PaymentMethodï¼ˆæ”¯ä»˜æ–¹å¼ï¼‰**: å°è£ä¸åŒæ”¯ä»˜æ–¹å¼çš„å·®ç•°
- **CardNumberï¼ˆå¡è™Ÿï¼‰**: æ•æ„Ÿä¿¡æ¯çš„å€¼å°è±¡è¨­è¨ˆ

### 2. èšåˆè¨­è¨ˆ
- **Payment èšåˆ**: æ”¯ä»˜è¨‚å–®çš„å®Œæ•´ç”Ÿå‘½é€±æœŸ
- **Refund èšåˆ**: é€€æ¬¾æ˜¯å¦æ‡‰è©²ç¨ç«‹èšåˆï¼Ÿé‚„æ˜¯ Payment çš„ä¸€éƒ¨åˆ†ï¼Ÿ

### 3. ç‹€æ…‹æ¨¡å¼
- æ”¯ä»˜ç‹€æ…‹æ©Ÿçš„å¯¦ç¾
- ç‹€æ…‹è½‰æ›çš„æ¥­å‹™è¦å‰‡

### 4. é ˜åŸŸäº‹ä»¶
- `PaymentCreated`: æ”¯ä»˜è¨‚å–®å‰µå»º
- `PaymentCompleted`: æ”¯ä»˜æˆåŠŸ
- `PaymentFailed`: æ”¯ä»˜å¤±æ•—
- `RefundRequested`: é€€æ¬¾ç”³è«‹
- `RefundCompleted`: é€€æ¬¾å®Œæˆ

---

## â±ï¸ æ™‚é–“å®‰æ’

å»ºè­°æ™‚é–“åˆ†é…ï¼š

- **éšæ®µ 1**: é€šç”¨èªè¨€æå–ï¼ˆ10 åˆ†é˜ï¼‰
- **éšæ®µ 2**: äº‹ä»¶é¢¨æš´ï¼ˆ10 åˆ†é˜ï¼‰
- **éšæ®µ 3**: èšåˆè¨­è¨ˆèˆ‡ç‹€æ…‹æ©Ÿï¼ˆ10 åˆ†é˜ï¼‰
- **éšæ®µ 4**: é ˜åŸŸæ¨¡å‹è¨­è¨ˆï¼ˆ5 åˆ†é˜ï¼‰
- **éšæ®µ 5**: ç¨‹å¼ç¢¼å¯¦ç¾ï¼ˆ10 åˆ†é˜ï¼‰

**ç¸½è¨ˆ**: 45 åˆ†é˜

---

## âœ… æª¢æŸ¥é»

### éšæ®µ 1: é€šç”¨èªè¨€è©å½™è¡¨
- [ ] è­˜åˆ¥æ ¸å¿ƒé ˜åŸŸæ¦‚å¿µï¼ˆPayment, Refund, PaymentMethod, Moneyï¼‰
- [ ] å€åˆ†å¯¦é«”èˆ‡å€¼å°è±¡
- [ ] æå–æ”¯ä»˜ç‹€æ…‹èˆ‡æ¥­å‹™è¦å‰‡

### éšæ®µ 2: äº‹ä»¶é¢¨æš´
- [ ] è­˜åˆ¥æ”¯ä»˜å®Œæ•´æµç¨‹çš„æ‰€æœ‰äº‹ä»¶
- [ ] è­˜åˆ¥é€€æ¬¾æµç¨‹çš„æ‰€æœ‰äº‹ä»¶
- [ ] æ¨™è¨˜ç•°å¸¸æƒ…æ³ï¼ˆæ”¯ä»˜å¤±æ•—ã€è¶…æ™‚å–æ¶ˆï¼‰

### éšæ®µ 3: èšåˆè¨­è¨ˆ
- [ ] ç¢ºå®š Payment èšåˆçš„é‚Šç•Œ
- [ ] æ±ºå®š Refund æ˜¯å¦ç¨ç«‹èšåˆ
- [ ] è¨­è¨ˆæ”¯ä»˜ç‹€æ…‹æ©Ÿ

### éšæ®µ 4: é ˜åŸŸæ¨¡å‹è¨­è¨ˆ
- [ ] ç¹ªè£½ Payment èšåˆé¡åœ–
- [ ] è¨­è¨ˆ Moneyã€PaymentMethod ç­‰å€¼å°è±¡
- [ ] è¨­è¨ˆé ˜åŸŸäº‹ä»¶

### éšæ®µ 5: ç¨‹å¼ç¢¼å¯¦ç¾
- [ ] å¯¦ç¾ Payment èšåˆæ ¹
- [ ] å¯¦ç¾ Money å€¼å°è±¡ï¼ˆå«é‹ç®—ï¼‰
- [ ] å¯¦ç¾æ”¯ä»˜ç‹€æ…‹æ©Ÿ
- [ ] å¯¦ç¾é ˜åŸŸäº‹ä»¶

---

## ğŸ’¡ æç¤º

### æç¤º 1: Money å€¼å°è±¡è¨­è¨ˆ

**ç‚ºä»€éº¼éœ€è¦ Money å€¼å°è±¡ï¼Ÿ**

âŒ **éŒ¯èª¤åšæ³•**ï¼š
```python
class Payment:
    amount: Decimal  # åªæœ‰é‡‘é¡ï¼Œæ²’æœ‰å¹£ç¨®

# å•é¡Œï¼š100 TWD vs 100 USD ç„¡æ³•å€åˆ†
```

âœ… **æ­£ç¢ºåšæ³•**ï¼š
```python
@dataclass(frozen=True)
class Money:
    amount: Decimal
    currency: Currency

    def add(self, other: Money) -> Money:
        if self.currency != other.currency:
            raise ValueError("ä¸åŒå¹£ç¨®ç„¡æ³•ç›¸åŠ ")
        return Money(self.amount + other.amount, self.currency)

    def subtract(self, other: Money) -> Money:
        if self.currency != other.currency:
            raise ValueError("ä¸åŒå¹£ç¨®ç„¡æ³•ç›¸æ¸›")
        if self.amount < other.amount:
            raise ValueError("é‡‘é¡ä¸è¶³")
        return Money(self.amount - other.amount, self.currency)

# ä½¿ç”¨ç¯„ä¾‹
total = Money(Decimal('100'), Currency.TWD)
refund = Money(Decimal('30'), Currency.TWD)
remaining = total.subtract(refund)  # Money(70, TWD)
```

---

### æç¤º 2: Refund æ‡‰è©²æ˜¯ç¨ç«‹èšåˆé‚„æ˜¯ Payment çš„ä¸€éƒ¨åˆ†ï¼Ÿ

**æ–¹æ¡ˆ A**: Refund åœ¨ Payment èšåˆå…§
```python
class Payment:
    payment_id: PaymentId
    amount: Money
    status: PaymentStatus
    refunds: List[RefundRecord]  # é€€æ¬¾è¨˜éŒ„åˆ—è¡¨

    def request_refund(self, amount: Money) -> None:
        # æ¥­å‹™è¦å‰‡æª¢æŸ¥
        total_refunded = sum(r.amount for r in self.refunds)
        if total_refunded + amount > self.amount:
            raise ValueError("é€€æ¬¾ç¸½é¡è¶…éæ”¯ä»˜é‡‘é¡")

        self.refunds.append(RefundRecord(...))
```

**å„ªé»**: å¯ä»¥ä¿è­‰äº‹å‹™ä¸€è‡´æ€§ï¼ˆé€€æ¬¾ç¸½é¡ä¸è¶…éæ”¯ä»˜é‡‘é¡ï¼‰
**ç¼ºé»**: èšåˆè·è²¬éé‡ï¼Œé«˜ä¸¦ç™¼é€€æ¬¾å¯èƒ½æœ‰æ€§èƒ½å•é¡Œ

---

**æ–¹æ¡ˆ B**: Refund ç¨ç«‹èšåˆ
```python
class Payment:
    payment_id: PaymentId
    amount: Money
    status: PaymentStatus

class Refund:
    refund_id: RefundId
    payment_id: PaymentId  # å¼•ç”¨ Payment
    amount: Money
    status: RefundStatus
```

**å„ªé»**: è·è²¬åˆ†é›¢ï¼Œæ€§èƒ½æ›´å¥½
**ç¼ºé»**: éœ€è¦é¡å¤–æ©Ÿåˆ¶ä¿è­‰é€€æ¬¾ç¸½é¡ä¸è¶…éæ”¯ä»˜é‡‘é¡

**æ¨è–¦**: æ–¹æ¡ˆ Aï¼ˆé€€æ¬¾é€šå¸¸ä¸æœƒé«˜ä¸¦ç™¼ï¼Œä¸€è‡´æ€§æ›´é‡è¦ï¼‰

---

### æç¤º 3: æ”¯ä»˜ç‹€æ…‹æ©Ÿå¯¦ç¾

**ä½¿ç”¨æšèˆ‰ + ç‹€æ…‹è½‰æ›æ–¹æ³•**ï¼š

```python
class PaymentStatus(str, Enum):
    CREATED = "CREATED"
    PENDING = "PENDING"
    PROCESSING = "PROCESSING"
    PAID = "PAID"
    CANCELLED = "CANCELLED"
    REFUNDED = "REFUNDED"

class Payment:
    def __init__(self):
        self.status = PaymentStatus.CREATED

    def start_payment(self) -> None:
        """é–‹å§‹æ”¯ä»˜"""
        if self.status != PaymentStatus.CREATED:
            raise ValueError(f"åªæœ‰å·²å‰µå»ºçš„æ”¯ä»˜å¯ä»¥é–‹å§‹ï¼Œç•¶å‰ç‹€æ…‹: {self.status}")
        self.status = PaymentStatus.PENDING
        self._add_domain_event(PaymentStarted(...))

    def mark_as_processing(self) -> None:
        """æ¨™è¨˜ç‚ºè™•ç†ä¸­"""
        if self.status != PaymentStatus.PENDING:
            raise ValueError(f"åªæœ‰å¾…æ”¯ä»˜çš„è¨‚å–®å¯ä»¥è™•ç†ï¼Œç•¶å‰ç‹€æ…‹: {self.status}")
        self.status = PaymentStatus.PROCESSING

    def complete(self, transaction_id: str) -> None:
        """æ”¯ä»˜æˆåŠŸ"""
        if self.status != PaymentStatus.PROCESSING:
            raise ValueError(f"åªæœ‰è™•ç†ä¸­çš„æ”¯ä»˜å¯ä»¥å®Œæˆï¼Œç•¶å‰ç‹€æ…‹: {self.status}")
        self.status = PaymentStatus.PAID
        self.transaction_id = transaction_id
        self.paid_at = datetime.now()
        self._add_domain_event(PaymentCompleted(...))

    def cancel(self, reason: str) -> None:
        """å–æ¶ˆæ”¯ä»˜"""
        if self.status not in [PaymentStatus.CREATED, PaymentStatus.PENDING]:
            raise ValueError(f"ç•¶å‰ç‹€æ…‹ç„¡æ³•å–æ¶ˆ: {self.status}")
        self.status = PaymentStatus.CANCELLED
        self._add_domain_event(PaymentCancelled(...))
```

---

### æç¤º 4: æ•æ„Ÿä¿¡æ¯è™•ç†

**ä¿¡ç”¨å¡è™Ÿçš„å€¼å°è±¡è¨­è¨ˆ**ï¼š

```python
@dataclass(frozen=True)
class CardNumber:
    """ä¿¡ç”¨å¡è™Ÿï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰"""
    encrypted_value: str  # åŠ å¯†å¾Œçš„å€¼
    last_four_digits: str  # æœ€å¾Œ4ä½ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰

    @classmethod
    def from_plain(cls, plain_number: str, encryption_service) -> 'CardNumber':
        """å¾æ˜æ–‡å¡è™Ÿå‰µå»º"""
        cls._validate(plain_number)
        encrypted = encryption_service.encrypt(plain_number)
        return cls(
            encrypted_value=encrypted,
            last_four_digits=plain_number[-4:]
        )

    @staticmethod
    def _validate(card_number: str) -> None:
        """é©—è­‰å¡è™Ÿï¼ˆLuhn ç®—æ³•ï¼‰"""
        if not card_number.isdigit():
            raise ValueError("å¡è™Ÿå¿…é ˆå…¨ç‚ºæ•¸å­—")
        if len(card_number) not in [15, 16]:
            raise ValueError("å¡è™Ÿé•·åº¦ä¸æ­£ç¢º")
        # Luhn ç®—æ³•é©—è­‰...

    def masked_number(self) -> str:
        """è„«æ•é¡¯ç¤ºï¼š**** **** **** 1234"""
        return f"**** **** **** {self.last_four_digits}"
```

---

## ğŸ“– åƒè€ƒè§£ç­”

<details>
<summary>é»æ“ŠæŸ¥çœ‹åƒè€ƒè§£ç­”ï¼ˆå»ºè­°å…ˆç¨ç«‹å®Œæˆï¼‰</summary>

### æ ¸å¿ƒè¨­è¨ˆæ±ºç­–

1. **èšåˆåŠƒåˆ†**:
   - `Payment` èšåˆï¼šæ”¯ä»˜è¨‚å–® + é€€æ¬¾è¨˜éŒ„ï¼ˆä¸€èµ·ç®¡ç†ï¼Œä¿è­‰ä¸€è‡´æ€§ï¼‰
   - ä¸å°‡ Refund ç¨ç«‹ï¼Œå› ç‚ºéœ€è¦å¼·ä¸€è‡´æ€§ä¿è­‰

2. **é—œéµå€¼å°è±¡**:
   - `Money`: é‡‘é¡ + å¹£ç¨®ï¼Œæ”¯æ´é‹ç®—
   - `PaymentMethod`: æ”¯ä»˜æ–¹å¼æŠ½è±¡
   - `CardNumber`: æ•æ„Ÿä¿¡æ¯å°è£
   - `PaymentId`: æ”¯ä»˜è¨‚å–®å”¯ä¸€æ¨™è­˜

3. **é ˜åŸŸäº‹ä»¶**:
   - `PaymentCreated`: æ”¯ä»˜è¨‚å–®å‰µå»º
   - `PaymentCompleted`: æ”¯ä»˜æˆåŠŸ
   - `PaymentFailed`: æ”¯ä»˜å¤±æ•—
   - `PaymentCancelled`: æ”¯ä»˜å–æ¶ˆ
   - `RefundRequested`: é€€æ¬¾ç”³è«‹
   - `RefundCompleted`: é€€æ¬¾å®Œæˆ

### ç‹€æ…‹æ©Ÿåœ–

```mermaid
stateDiagram-v2
    [*] --> CREATED
    CREATED --> PENDING : start_payment()
    PENDING --> PROCESSING : process()
    PENDING --> CANCELLED : cancel() / timeout
    PROCESSING --> PAID : complete()
    PROCESSING --> FAILED : fail()
    FAILED --> PENDING : retry()
    PAID --> REFUNDING : request_refund()
    REFUNDING --> REFUNDED : complete_refund()
    REFUNDED --> [*]
    CANCELLED --> [*]
```

### Payment èšåˆè¨­è¨ˆ

```mermaid
classDiagram
    class Payment {
        <<Aggregate Root>>
        +PaymentId payment_id
        +OrderId order_id
        +Money amount
        +PaymentStatus status
        +PaymentMethod method
        +List~RefundRecord~ refunds
        +start_payment()
        +complete()
        +cancel()
        +request_refund()
    }

    class Money {
        <<Value Object>>
        +Decimal amount
        +Currency currency
        +add(Money)
        +subtract(Money)
    }

    class PaymentMethod {
        <<Value Object>>
        +MethodType type
        +Map~str,str~ credentials
    }

    class RefundRecord {
        <<Entity>>
        +RefundId refund_id
        +Money amount
        +RefundStatus status
        +str reason
    }

    Payment *-- Money
    Payment *-- PaymentMethod
    Payment *-- RefundRecord
```

</details>

---

## ğŸ¤” åæ€å•é¡Œ

å®Œæˆå¾Œæ€è€ƒï¼š

1. **Money å€¼å°è±¡**:
   - ç‚ºä»€éº¼ Money å¿…é ˆæ˜¯å€¼å°è±¡è€Œä¸èƒ½æ˜¯ç°¡å–®çš„ Decimalï¼Ÿ
   - å¦‚æœéœ€è¦æ”¯æ´åŒ¯ç‡è½‰æ›ï¼ŒMoney å¦‚ä½•è¨­è¨ˆï¼Ÿ

2. **èšåˆé‚Šç•Œ**:
   - Refund ç‚ºä»€éº¼å»ºè­°æ”¾åœ¨ Payment èšåˆå…§ï¼Ÿ
   - å¦‚æœé€€æ¬¾æµç¨‹éå¸¸è¤‡é›œï¼ˆéœ€è¦å¯©æ‰¹æµï¼‰ï¼Œè¨­è¨ˆå¦‚ä½•èª¿æ•´ï¼Ÿ

3. **ç‹€æ…‹æ©Ÿ**:
   - æ”¯ä»˜ç‹€æ…‹æ©Ÿä¸­å“ªäº›ç‹€æ…‹è½‰æ›æ˜¯å¯é€†çš„ï¼Ÿ
   - å¦‚ä½•é˜²æ­¢ä¸¦ç™¼æƒ…æ³ä¸‹çš„ç‹€æ…‹ä¸ä¸€è‡´ï¼Ÿ

4. **å®‰å…¨æ€§**:
   - ä¿¡ç”¨å¡è™Ÿæ‡‰è©²å­˜å„²å—ï¼Ÿå¦‚ä½•å­˜å„²ï¼Ÿ
   - PCI DSS åˆè¦å°é ˜åŸŸæ¨¡å‹æœ‰ä½•å½±éŸ¿ï¼Ÿ

---

**æƒ…å¢ƒç‰ˆæœ¬**: v1.0
**é›£åº¦**: ä¸­ç­‰
**é ä¼°æ™‚é–“**: 30-45 åˆ†é˜
**æ ¸å¿ƒæŠ€èƒ½**: å€¼å°è±¡è¨­è¨ˆã€ç‹€æ…‹æ©Ÿã€èšåˆé‚Šç•Œåˆ¤æ–·
