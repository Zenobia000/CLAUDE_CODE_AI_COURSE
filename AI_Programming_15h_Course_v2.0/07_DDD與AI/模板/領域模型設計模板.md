# [ç³»çµ±åç¨±] - é ˜åŸŸæ¨¡å‹è¨­è¨ˆæ¨¡æ¿ï¼ˆDomain Model Designï¼‰

## ğŸ“‹ ä½¿ç”¨èªªæ˜

æœ¬æ¨¡æ¿æä¾›é ˜åŸŸæ¨¡å‹è¨­è¨ˆçš„æ¨™æº–çµæ§‹ï¼ŒåŒ…å«é¡åœ–è¨­è¨ˆå’Œ Python ç¨‹å¼ç¢¼éª¨æ¶ã€‚

**æœ€å¾Œæ›´æ–°**: YYYY-MM-DD
**é©ç”¨ç¯„åœ**: [é™ç•Œä¸Šä¸‹æ–‡åç¨±] Context

---

## ğŸ¨ é ˜åŸŸæ¨¡å‹é¡åœ–ï¼ˆMermaidï¼‰

```mermaid
%% [èšåˆåç¨±] é ˜åŸŸæ¨¡å‹é¡åœ–

classDiagram
    %% ========================================
    %% èšåˆæ ¹ï¼ˆAggregate Rootï¼‰
    %% ========================================

    class AggregateRoot {
        <<Aggregate Root>>
        +AggregateId aggregate_id
        +ValueObject1 value_object_1
        +ValueObject2 value_object_2
        +EntityStatus status
        +datetime created_at
        +datetime updated_at
        +List~Entity1~ entities
        +List~DomainEvent~ _domain_events

        %% å·¥å» æ–¹æ³•
        +create(params) AggregateRoot

        %% å‘½ä»¤æ–¹æ³•
        +command_method_1(params) void
        +command_method_2(params) void

        %% æŸ¥è©¢æ–¹æ³•
        +query_method_1() ReturnType
        +is_valid() bool

        %% é ˜åŸŸäº‹ä»¶ç®¡ç†
        -_add_domain_event(event) void
        +get_domain_events() List~DomainEvent~
        +clear_domain_events() void

        %% ä¸è®Šå¼æª¢æŸ¥
        -_check_invariants() void
    }

    %% ========================================
    %% å¯¦é«”ï¼ˆEntityï¼‰
    %% ========================================

    class Entity1 {
        <<Entity>>
        +EntityId entity_id
        +str attribute_1
        +int attribute_2
        +update_attribute(value) void
    }

    %% ========================================
    %% å€¼å°è±¡ï¼ˆValue Objectï¼‰
    %% ========================================

    class ValueObject1 {
        <<Value Object>>
        +str value
        +validate() void
        +__eq__(other) bool
        +__hash__() int
    }

    class ValueObject2 {
        <<Value Object>>
        +Decimal amount
        +Currency currency
        +add(other) ValueObject2
        +subtract(other) ValueObject2
    }

    %% ========================================
    %% é ˜åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰
    %% ========================================

    class DomainEvent {
        <<Domain Event>>
        +UUID event_id
        +datetime occurred_at
    }

    class Event1 {
        <<Domain Event>>
        +aggregate_id: str
        +event_data: dict
    }

    %% ========================================
    %% é—œä¿‚ï¼ˆRelationshipsï¼‰
    %% ========================================

    AggregateRoot *-- Entity1 : contains
    AggregateRoot *-- ValueObject1 : has
    AggregateRoot *-- ValueObject2 : has
    AggregateRoot ..> DomainEvent : publishes
    Event1 --|> DomainEvent : inherits

    %% ========================================
    %% æ¨£å¼å®šç¾©
    %% ========================================

    %% èšåˆæ ¹æ¨£å¼
    style AggregateRoot fill:#2ecc71,stroke:#27ae60,stroke-width:4px,color:#fff

    %% å¯¦é«”æ¨£å¼
    style Entity1 fill:#3498db,stroke:#2980b9,stroke-width:2px,color:#fff

    %% å€¼å°è±¡æ¨£å¼
    style ValueObject1 fill:#f39c12,stroke:#e67e22,stroke-width:2px,color:#fff
    style ValueObject2 fill:#f39c12,stroke:#e67e22,stroke-width:2px,color:#fff

    %% é ˜åŸŸäº‹ä»¶æ¨£å¼
    style DomainEvent fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff
    style Event1 fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff
```

---

## ğŸ’» Python ç¨‹å¼ç¢¼éª¨æ¶

### 1. é ˜åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰

```python
"""
é ˜åŸŸäº‹ä»¶å®šç¾©
"""

from dataclasses import dataclass, field
from datetime import datetime
from uuid import UUID, uuid4


@dataclass(frozen=True)
class DomainEvent:
    """Base class for all domain events"""
    event_id: UUID = field(default_factory=uuid4)
    occurred_at: datetime = field(default_factory=datetime.now)


@dataclass(frozen=True)
class Event1(DomainEvent):
    """[äº‹ä»¶èªªæ˜]"""
    aggregate_id: str
    # æ·»åŠ äº‹ä»¶ç‰¹å®šçš„å­—æ®µ
    field1: str
    field2: int


@dataclass(frozen=True)
class Event2(DomainEvent):
    """[äº‹ä»¶èªªæ˜]"""
    aggregate_id: str
    # æ·»åŠ äº‹ä»¶ç‰¹å®šçš„å­—æ®µ
```

---

### 2. æšèˆ‰ï¼ˆEnumsï¼‰

```python
"""
æšèˆ‰å®šç¾©
"""

from enum import Enum


class EntityStatus(str, Enum):
    """[èšåˆç‹€æ…‹]"""
    STATUS_1 = "STATUS_1"
    STATUS_2 = "STATUS_2"
    STATUS_3 = "STATUS_3"


class SomeCategory(str, Enum):
    """[åˆ†é¡æšèˆ‰]"""
    CATEGORY_A = "CATEGORY_A"
    CATEGORY_B = "CATEGORY_B"
```

---

### 3. å€¼å°è±¡ï¼ˆValue Objectsï¼‰

```python
"""
å€¼å°è±¡å®šç¾©
"""

from dataclasses import dataclass
from decimal import Decimal


@dataclass(frozen=True)
class ValueObject1:
    """
    [å€¼å°è±¡èªªæ˜]

    ä¸è®Šæ€§åŸå‰‡ï¼š
    - å€¼å°è±¡æ˜¯ä¸å¯è®Šçš„ï¼ˆfrozen=Trueï¼‰
    - æ‰€æœ‰æ“ä½œè¿”å›æ–°å°è±¡ï¼Œè€Œéä¿®æ”¹ç•¶å‰å°è±¡
    - å…©å€‹å±¬æ€§å®Œå…¨ç›¸åŒçš„å°è±¡æ˜¯å¯äº’æ›çš„
    """
    value: str

    def __post_init__(self):
        """é©—è­‰æ¥­å‹™è¦å‰‡"""
        self._validate()

    def _validate(self) -> None:
        """é©—è­‰é‚è¼¯"""
        if not self.value:
            raise ValueError("valueä¸èƒ½ç‚ºç©º")
        # æ·»åŠ æ›´å¤šé©—è­‰...

    def __str__(self) -> str:
        return self.value


@dataclass(frozen=True)
class ValueObject2:
    """
    [å€¼å°è±¡èªªæ˜ï¼Œå¦‚ï¼šMoney]

    æ”¯æ´é‹ç®—çš„å€¼å°è±¡ç¯„ä¾‹
    """
    amount: Decimal
    currency: str

    def __post_init__(self):
        """é©—è­‰æ¥­å‹™è¦å‰‡"""
        if self.amount < 0:
            raise ValueError("é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸")

        # Ensure amount has at most 2 decimal places
        quantized = self.amount.quantize(Decimal('0.01'))
        object.__setattr__(self, 'amount', quantized)

    def add(self, other: 'ValueObject2') -> 'ValueObject2':
        """åŠ æ³•é‹ç®— - è¿”å›æ–°å°è±¡"""
        if self.currency != other.currency:
            raise ValueError(f"ä¸åŒå¹£ç¨®ç„¡æ³•ç›¸åŠ ")
        return ValueObject2(self.amount + other.amount, self.currency)

    def subtract(self, other: 'ValueObject2') -> 'ValueObject2':
        """æ¸›æ³•é‹ç®— - è¿”å›æ–°å°è±¡"""
        if self.currency != other.currency:
            raise ValueError(f"ä¸åŒå¹£ç¨®ç„¡æ³•ç›¸æ¸›")
        if self.amount < other.amount:
            raise ValueError("é‡‘é¡ä¸è¶³")
        return ValueObject2(self.amount - other.amount, self.currency)

    def __str__(self) -> str:
        return f"{self.currency} {self.amount:.2f}"
```

---

### 4. å¯¦é«”ï¼ˆEntityï¼‰

```python
"""
å¯¦é«”å®šç¾©
"""

from dataclasses import dataclass
from uuid import UUID, uuid4


@dataclass
class Entity1:
    """
    [å¯¦é«”èªªæ˜]

    ç‚ºä»€éº¼æ˜¯å¯¦é«”è€Œéå€¼å°è±¡ï¼š
    - æœ‰å”¯ä¸€æ¨™è­˜ï¼ˆentity_idï¼‰
    - å¯ä»¥å–®ç¨ä¿®æ”¹å±¬æ€§
    - å³ä½¿å±¬æ€§ç›¸åŒï¼Œä¸åŒIDçš„å¯¦é«”ä¸ç›¸ç­‰
    """
    entity_id: UUID
    attribute_1: str
    attribute_2: int

    def __post_init__(self):
        """é©—è­‰æ¥­å‹™è¦å‰‡"""
        if self.attribute_2 < 0:
            raise ValueError("attribute_2 å¿…é ˆ >= 0")

    def update_attribute(self, new_value: str) -> None:
        """æ›´æ–°å±¬æ€§ï¼ˆå¯¦é«”å¯è®Šï¼‰"""
        if not new_value:
            raise ValueError("æ–°å€¼ä¸èƒ½ç‚ºç©º")
        self.attribute_1 = new_value

    def __eq__(self, other: object) -> bool:
        """å¯¦é«”ç›¸ç­‰æ€§ï¼šåŸºæ–¼ ID"""
        if not isinstance(other, Entity1):
            return False
        return self.entity_id == other.entity_id

    def __hash__(self) -> int:
        """åŸºæ–¼ ID çš„å“ˆå¸Œ"""
        return hash(self.entity_id)
```

---

### 5. èšåˆæ ¹ï¼ˆAggregate Rootï¼‰

```python
"""
èšåˆæ ¹å®šç¾©
"""

from dataclasses import dataclass, field
from datetime import datetime
from typing import List, Optional
from uuid import UUID, uuid4


@dataclass
class AggregateRoot:
    """
    [èšåˆæ ¹èªªæ˜]

    è·è²¬ï¼š
    - ç¶­è­·èšåˆç”Ÿå‘½é€±æœŸ
    - ä¿è­·æ¥­å‹™ä¸è®Šå¼
    - ç™¼å¸ƒé ˜åŸŸäº‹ä»¶
    - æ§åˆ¶èšåˆé‚Šç•Œ

    ä¸è®Šå¼ï¼ˆInvariantsï¼‰ï¼š
    - [ä¸è®Šå¼1]
    - [ä¸è®Šå¼2]
    """
    aggregate_id: str
    value_object_1: ValueObject1
    value_object_2: ValueObject2
    status: EntityStatus
    created_at: datetime
    updated_at: datetime
    entities: List[Entity1]

    # é ˜åŸŸäº‹ä»¶åˆ—è¡¨
    _domain_events: List[DomainEvent] = field(
        default_factory=list,
        init=False,
        repr=False
    )

    # å¯é¸å­—æ®µ
    optional_field: Optional[str] = None

    def __post_init__(self):
        """é©—è­‰èšåˆä¸è®Šå¼"""
        self._check_invariants()

    def _check_invariants(self) -> None:
        """é©—è­‰æ¥­å‹™ä¸è®Šå¼"""
        if not self.entities:
            raise ValueError("[èšåˆ]è‡³å°‘éœ€è¦ä¸€å€‹[å¯¦é«”]")

        # æ·»åŠ æ›´å¤šä¸è®Šå¼æª¢æŸ¥...

    # ========================================================================
    # å·¥å» æ–¹æ³•ï¼ˆFactory Methodï¼‰
    # ========================================================================

    @classmethod
    def create(cls, param1: str, param2: int) -> 'AggregateRoot':
        """
        å·¥å» æ–¹æ³•ï¼šå‰µå»ºæ–°èšåˆ

        é€™æ˜¯èšåˆçš„å”¯ä¸€å‰µå»ºå…¥å£ï¼Œç¢ºä¿ï¼š
        - ç”Ÿæˆå”¯ä¸€èšåˆID
        - åˆå§‹åŒ–ç‹€æ…‹
        - ç™¼å¸ƒå‰µå»ºäº‹ä»¶
        """
        now = datetime.now()
        aggregate = cls(
            aggregate_id=str(uuid4()),
            value_object_1=ValueObject1(value=param1),
            value_object_2=ValueObject2(amount=Decimal(param2), currency="TWD"),
            status=EntityStatus.STATUS_1,
            created_at=now,
            updated_at=now,
            entities=[]
        )

        # Publish domain event
        aggregate._add_domain_event(Event1(
            aggregate_id=aggregate.aggregate_id,
            field1=param1,
            field2=param2
        ))

        return aggregate

    # ========================================================================
    # å‘½ä»¤æ–¹æ³•ï¼ˆCommand Methodsï¼‰
    # ========================================================================

    def command_method_1(self, param: str) -> None:
        """
        [å‘½ä»¤èªªæ˜]

        å‰ç½®æ¢ä»¶ï¼š
        - [æ¢ä»¶1]
        - [æ¢ä»¶2]

        å¾Œç½®æ¢ä»¶ï¼š
        - [çµæœ1]
        - [çµæœ2]
        """
        # Check preconditions
        if self.status != EntityStatus.STATUS_1:
            raise ValueError(f"ç•¶å‰ç‹€æ…‹ç„¡æ³•åŸ·è¡Œæ­¤æ“ä½œ: {self.status}")

        # Update state
        self.status = EntityStatus.STATUS_2
        self.updated_at = datetime.now()

        # Check invariants
        self._check_invariants()

        # Publish event
        self._add_domain_event(Event2(
            aggregate_id=self.aggregate_id,
            # ... event data
        ))

    def command_method_2(self, entity: Entity1) -> None:
        """[å‘½ä»¤èªªæ˜]"""
        # Business logic...
        self.entities.append(entity)
        self._check_invariants()

    # ========================================================================
    # æŸ¥è©¢æ–¹æ³•ï¼ˆQuery Methodsï¼‰
    # ========================================================================

    def is_valid(self) -> bool:
        """æª¢æŸ¥èšåˆæ˜¯å¦æœ‰æ•ˆ"""
        try:
            self._check_invariants()
            return True
        except ValueError:
            return False

    def query_method_1(self) -> int:
        """[æŸ¥è©¢èªªæ˜]"""
        return len(self.entities)

    # ========================================================================
    # é ˜åŸŸäº‹ä»¶ç®¡ç†
    # ========================================================================

    def _add_domain_event(self, event: DomainEvent) -> None:
        """æ·»åŠ é ˜åŸŸäº‹ä»¶"""
        self._domain_events.append(event)

    def get_domain_events(self) -> List[DomainEvent]:
        """ç²å–æ‰€æœ‰é ˜åŸŸäº‹ä»¶"""
        return self._domain_events.copy()

    def clear_domain_events(self) -> None:
        """æ¸…é™¤é ˜åŸŸäº‹ä»¶ï¼ˆé€šå¸¸åœ¨äº‹ä»¶ç™¼å¸ƒå¾Œèª¿ç”¨ï¼‰"""
        self._domain_events.clear()
```

---

### 6. é ˜åŸŸæœå‹™ï¼ˆDomain Servicesï¼‰

```python
"""
é ˜åŸŸæœå‹™å®šç¾©
"""


class DomainService1:
    """
    [é ˜åŸŸæœå‹™èªªæ˜]

    ç‚ºä»€éº¼éœ€è¦é ˜åŸŸæœå‹™ï¼š
    - æ¥­å‹™é‚è¼¯æ¶‰åŠå¤šå€‹èšåˆ
    - ä¸å±¬æ–¼ä»»ä½•å–®ä¸€èšåˆçš„è·è²¬
    - éœ€è¦èª¿ç”¨å¤–éƒ¨ä¸Šä¸‹æ–‡
    """

    @staticmethod
    def service_method(aggregate: AggregateRoot, param: str) -> None:
        """
        [æœå‹™æ–¹æ³•èªªæ˜]

        åƒæ•¸ï¼š
        - aggregate: [èªªæ˜]
        - param: [èªªæ˜]
        """
        # Business logic...
        pass


class DomainService2:
    """
    [é ˜åŸŸæœå‹™èªªæ˜]
    """

    def __init__(self, external_service):
        """ä¾è³´æ³¨å…¥å¤–éƒ¨æœå‹™"""
        self.external_service = external_service

    def complex_operation(self, aggregate1: AggregateRoot,
                         aggregate2: AggregateRoot) -> None:
        """
        [è¤‡é›œæ“ä½œèªªæ˜]

        è·¨èšåˆçš„æ¥­å‹™é‚è¼¯
        """
        # Business logic...
        pass
```

---

## ğŸ”– æ¨¡æ¿ä½¿ç”¨æŒ‡å—

### æ­¥é©Ÿ 1ï¼šè¨­è¨ˆé¡åœ–

1. **è­˜åˆ¥èšåˆæ ¹**ï¼š
   - ä»€éº¼æ˜¯èšåˆçš„å…¥å£ï¼Ÿ
   - ä»€éº¼éœ€è¦ä¿è­·ä¸è®Šå¼ï¼Ÿ

2. **è­˜åˆ¥å¯¦é«”èˆ‡å€¼å°è±¡**ï¼š
   - æœ‰å”¯ä¸€æ¨™è­˜ â†’ å¯¦é«”
   - å¯äº’æ› + ä¸å¯è®Š â†’ å€¼å°è±¡

3. **è¨­è¨ˆé ˜åŸŸäº‹ä»¶**ï¼š
   - ä»€éº¼æ™‚å€™ç™¼å¸ƒäº‹ä»¶ï¼Ÿ
   - äº‹ä»¶åŒ…å«å“ªäº›æ•¸æ“šï¼Ÿ

4. **ç¹ªè£½é¡åœ–**ï¼š
   - ä½¿ç”¨ Mermaid ç¹ªè£½
   - æ¨™è¨»é—œä¿‚ï¼ˆåŒ…å«ã€ç¹¼æ‰¿ã€ç™¼å¸ƒï¼‰

### æ­¥é©Ÿ 2ï¼šå¯¦ç¾ç¨‹å¼ç¢¼

1. **å¾å€¼å°è±¡é–‹å§‹**ï¼š
   - å€¼å°è±¡æœ€ç°¡å–®ï¼Œå…ˆå¯¦ç¾
   - ç¢ºä¿ä¸å¯è®Šæ€§å’Œé©—è­‰é‚è¼¯

2. **å¯¦ç¾å¯¦é«”**ï¼š
   - æ·»åŠ å”¯ä¸€æ¨™è­˜
   - å¯¦ç¾ç›¸ç­‰æ€§æ¯”è¼ƒ

3. **å¯¦ç¾èšåˆæ ¹**ï¼š
   - å¯¦ç¾å·¥å» æ–¹æ³•
   - å¯¦ç¾å‘½ä»¤æ–¹æ³•
   - æ·»åŠ ä¸è®Šå¼æª¢æŸ¥
   - ç™¼å¸ƒé ˜åŸŸäº‹ä»¶

4. **å¯¦ç¾é ˜åŸŸæœå‹™**ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
   - è·¨èšåˆçš„æ¥­å‹™é‚è¼¯
   - ä¾è³´å¤–éƒ¨æœå‹™çš„é‚è¼¯

### æ­¥é©Ÿ 3ï¼šæ¸¬è©¦

1. **å€¼å°è±¡æ¸¬è©¦**ï¼š
   - æ¸¬è©¦é©—è­‰é‚è¼¯
   - æ¸¬è©¦ä¸å¯è®Šæ€§
   - æ¸¬è©¦é‹ç®—ï¼ˆå¦‚æœ‰ï¼‰

2. **èšåˆæ ¹æ¸¬è©¦**ï¼š
   - æ¸¬è©¦å·¥å» æ–¹æ³•
   - æ¸¬è©¦å‘½ä»¤æ–¹æ³•
   - æ¸¬è©¦ä¸è®Šå¼ä¿è­·
   - æ¸¬è©¦é ˜åŸŸäº‹ä»¶ç™¼å¸ƒ

---

## âœ… å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] é¡åœ–å®Œæ•´ï¼ˆèšåˆæ ¹ã€å¯¦é«”ã€å€¼å°è±¡ã€äº‹ä»¶ï¼‰
- [ ] å€¼å°è±¡æ˜¯ä¸å¯è®Šçš„ï¼ˆfrozen=Trueï¼‰
- [ ] å¯¦é«”æœ‰å”¯ä¸€æ¨™è­˜å’Œç›¸ç­‰æ€§æ¯”è¼ƒ
- [ ] èšåˆæ ¹æœ‰å·¥å» æ–¹æ³•
- [ ] å‘½ä»¤æ–¹æ³•æœ‰å‰ç½®æ¢ä»¶æª¢æŸ¥
- [ ] ä¸è®Šå¼åœ¨æ¯æ¬¡ä¿®æ”¹å¾Œæª¢æŸ¥
- [ ] é ˜åŸŸäº‹ä»¶æ­£ç¢ºç™¼å¸ƒ
- [ ] ç¨‹å¼ç¢¼æœ‰ type hints
- [ ] ç¨‹å¼ç¢¼æœ‰æ–‡æª”å­—ä¸²

---

## ğŸ“š åƒè€ƒè³‡æº

- **å®Œæ•´ç¯„ä¾‹**ï¼š`ç¯„ä¾‹æ¨¡å‹/è¨‚å–®ç³»çµ±/domain-model.py`
- **DDD æ¨¡å¼**ï¼šEric Evansã€Šé ˜åŸŸé©…å‹•è¨­è¨ˆã€‹
- **Python å¯¦ç¾**ï¼šVaughn Vernonã€Šå¯¦ä½œé ˜åŸŸé©…å‹•è¨­è¨ˆã€‹

---

## ğŸ’¡ è¨­è¨ˆåŸå‰‡

1. **Rich Domain Modelï¼ˆè±å¯Œé ˜åŸŸæ¨¡å‹ï¼‰**ï¼š
   - æ¥­å‹™é‚è¼¯æ”¾åœ¨é ˜åŸŸæ¨¡å‹ä¸­ï¼Œä¸æ˜¯æœå‹™å±¤
   - èšåˆæ ¹æ‡‰è©²æœ‰è±å¯Œçš„æ¥­å‹™æ–¹æ³•

2. **Tell, Don't Askï¼ˆå‘Šè¨´ï¼Œä¸è¦è©¢å•ï¼‰**ï¼š
   - èª¿ç”¨èšåˆçš„å‘½ä»¤æ–¹æ³•ï¼Œè€Œä¸æ˜¯å–å‡ºæ•¸æ“šè‡ªå·±è™•ç†
   - ä¾‹å¦‚ï¼š`order.pay()` è€Œé `order.set_status(PAID)`

3. **Persistence Ignoranceï¼ˆæŒä¹…åŒ–ç„¡é—œï¼‰**ï¼š
   - é ˜åŸŸæ¨¡å‹ä¸ä¾è³´æŒä¹…åŒ–æ©Ÿåˆ¶
   - ä¸ä½¿ç”¨ ORM è¨»è§£æ±¡æŸ“é ˜åŸŸæ¨¡å‹

4. **Ubiquitous Languageï¼ˆé€šç”¨èªè¨€ï¼‰**ï¼š
   - é¡åã€æ–¹æ³•åä½¿ç”¨æ¥­å‹™è¡“èª
   - èˆ‡æ¥­å‹™å°ˆå®¶çš„èªè¨€ä¸€è‡´

---

**æç¤º**ï¼šé ˜åŸŸæ¨¡å‹æ˜¯ DDD çš„æ ¸å¿ƒï¼Œæ‡‰è©²åæ˜ æ¥­å‹™é‚è¼¯ï¼Œè€ŒéæŠ€è¡“å¯¦ç¾ã€‚
