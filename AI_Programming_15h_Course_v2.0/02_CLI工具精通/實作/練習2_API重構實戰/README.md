# 練習 2：API 重構實戰

## 📋 練習概述

**練習時長**：90 分鐘
**難度**：⭐⭐⭐⭐ (高級)
**前置條件**：完成練習 1 + 理解 EPCV 工作流程

**學習目標**：
- 掌握完整的 EPCV (Explore-Plan-Code-Verify) 工作流程
- 學會大型重構的系統性方法
- 實踐程式碼分析與重構技巧
- 建立可驗證的重構計劃

---

## 🎯 練習情境

### 背景描述

你的團隊決定將**電商 API 從 v1 升級到 v2**，主要變更包括：

1. **認證方式**：從 Basic Auth 升級到 JWT
2. **回應格式**：統一採用 JSON:API 規範
3. **錯誤處理**：標準化錯誤碼和訊息
4. **版本管理**：支援向後兼容
5. **速率限制**：添加 API 限流機制

**挑戰**：
- 涉及 15+ API 端點
- 需要保持向後兼容
- 必須確保線上服務不中斷
- 需要完整的測試覆蓋

---

## 🚀 練習步驟

### 階段 1：Explore - 探索現況 (25 分鐘)

#### 1.1 載入並分析 v1 API
```bash
cd 練習2_API重構實戰/

# 載入 v1 API 程式碼
claude --add-dir ./api_v1_source
```

#### 1.2 深度探索分析
進行全面的現況分析：

```
請深度分析這個 v1 API：

【架構分析】
1. 有哪些端點？各自的職責？
2. 當前的認證機制如何實作？
3. 回應格式有什麼模式？
4. 錯誤處理是否一致？
5. 有哪些依賴關係？

【品質評估】
1. 程式碼品質如何？
2. 有哪些重複程式碼？
3. 安全問題？
4. 效能瓶頸？
5. 測試覆蓋率？

【重構風險】
1. 哪些變更風險最高？
2. 客戶端依賴哪些特定行為？
3. 有哪些隱含的假設？
```

#### 1.3 目標架構研究
```bash
# 載入 v2 目標架構
--add-dir ./api_v2_target
```

對比分析：
```
對比 v1 與 v2 架構：
1. 主要差異點？
2. 向後兼容的挑戰？
3. 需要新增哪些功能？
4. 需要棄用哪些功能？
5. 資料遷移需求？
```

**檢查點 1**：
- [ ] 完整理解 v1 API 架構
- [ ] 識別所有端點和功能
- [ ] 理解 v2 的目標架構
- [ ] 評估重構複雜度和風險

---

### 階段 2：Plan - 制定計劃 (25 分鐘)

#### 2.1 制定重構策略
基於探索結果，制定詳細計劃：

```
制定 v1 → v2 遷移計劃：

【總體策略】
1. 遷移順序（哪些端點先改？）
2. 向後兼容策略
3. 部署策略（藍綠部署？金絲雀？）
4. 回退方案

【技術實作】
1. 需要修改的檔案清單
2. 每個檔案的具體變更
3. 新增的檔案和功能
4. 需要棄用的程式碼

【測試計劃】
1. 單元測試策略
2. 整合測試需求
3. 向後兼容測試
4. 效能測試

【風險管控】
1. 高風險變更識別
2. 風險緩解措施
3. 監控和警告
4. 緊急回退程序
```

#### 2.2 創建實作清單
生成可執行的任務清單：

```
生成詳細的實作清單：

【階段 1：基礎設施】
- [ ] JWT 認證系統實作
- [ ] JSON:API 回應格式中間件
- [ ] 統一錯誤處理機制
- [ ] 速率限制中間件

【階段 2：端點遷移】
- [ ] /auth 端點群組
- [ ] /users 端點群組
- [ ] /products 端點群組
- [ ] /orders 端點群組

【階段 3：整合與測試】
- [ ] 向後兼容層
- [ ] 完整測試套件
- [ ] 效能驗證
- [ ] 文檔更新
```

**檢查點 2**：
- [ ] 有明確的遷移策略
- [ ] 有詳細的實作清單
- [ ] 有風險評估和緩解計劃
- [ ] 有測試和驗證策略

---

### 階段 3：Code - 執行重構 (30 分鐘)

#### 3.1 建立工作環境
```bash
# 建立重構工作目錄
mkdir api_v2_implementation
cd api_v2_implementation

# 複製 v1 程式碼作為起點
cp -r ../api_v1_source/* ./
```

#### 3.2 按計劃執行重構
**重要**：按照制定的計劃，分批次進行重構

**Batch 1：基礎設施 (10 分鐘)**
```
請實作基礎設施：

1. JWT 認證中間件
   - 生成和驗證 JWT token
   - 向後兼容 Basic Auth（標記為 deprecated）

2. JSON:API 回應格式
   - 統一回應結構
   - 錯誤格式標準化

實作要求：
- 遵循現有程式碼風格
- 添加充分的註釋
- 考慮錯誤處理
- 保持向後兼容
```

**Batch 2：核心端點重構 (15 分鐘)**
```
重構核心 API 端點：

優先處理：
1. /api/v2/auth/* （登入、登出、令牌刷新）
2. /api/v2/users/* （用戶管理）
3. /api/v2/products/* （商品查詢）

每個端點需要：
- 新的 v2 路由
- 保留 v1 路由（標記 deprecated）
- 統一的回應格式
- 適當的速率限制
- 完整的錯誤處理
```

**Batch 3：整合與驗證 (5 分鐘)**
```
完成整合：

1. 確保所有 v2 端點正常運作
2. 驗證 v1 端點仍然可用
3. 檢查錯誤處理一致性
4. 驗證效能沒有退化
```

**檢查點 3**：
- [ ] 成功實作基礎設施組件
- [ ] 完成關鍵端點的重構
- [ ] 保持向後兼容性
- [ ] 程式碼品質符合標準

---

### 階段 4：Verify - 驗證與測試 (10 分鐘)

#### 4.1 功能驗證
```
生成全面的測試計劃：

【單元測試】
1. JWT 認證功能測試
2. JSON:API 格式驗證
3. 錯誤處理測試
4. 速率限制測試

【整合測試】
1. v2 端點完整流程測試
2. v1 向後兼容測試
3. 認證流程測試
4. 錯誤場景測試

【效能測試】
1. 回應時間比較（v1 vs v2）
2. 並發處理能力
3. 記憶體使用評估

請實際生成可執行的測試程式碼。
```

#### 4.2 部署準備
```
準備部署方案：

1. 環境配置
   - 需要哪些環境變數？
   - 資料庫遷移腳本
   - 快取配置調整

2. 監控設置
   - 關鍵指標監控
   - 錯誤率警告
   - 效能指標追蹤

3. 回退計劃
   - 如何快速回到 v1？
   - 資料一致性保證
   - 客戶端通知機制
```

**檢查點 4**：
- [ ] 通過所有功能測試
- [ ] 效能符合預期
- [ ] 有完整的部署方案
- [ ] 有可執行的回退計劃

---

## 📊 評分標準

### 基本要求 (60 分)
- [ ] 理解 v1 API 現況
- [ ] 制定基本的重構計劃
- [ ] 完成部分端點重構
- [ ] 生成基本測試

### 良好表現 (80 分)
- [ ] 深入分析現況和目標架構
- [ ] 制定詳細且可執行的計劃
- [ ] 成功重構多個關鍵端點
- [ ] 保持向後兼容性
- [ ] 有完整的測試覆蓋

### 優秀表現 (100 分)
- [ ] 系統性地應用 EPCV 工作流程
- [ ] 制定專業級的遷移策略
- [ ] 高品質的程式碼重構
- [ ] 完整的測試和驗證
- [ ] 考慮生產環境的部署挑戰
- [ ] 提供創新的解決方案

---

## 💡 進階技巧

### EPCV 工作流程最佳實踐

**Explore 階段**
```bash
# 分層探索
1. 先看整體架構：載入主要檔案
2. 再看詳細實作：載入具體模組
3. 最後看依賴：載入配置和工具

# 有效的分析問題
- 「這個系統的資料流向是什麼？」
- 「最常修改的檔案是哪些？」
- 「有哪些隱含的業務規則？」
```

**Plan 階段**
```bash
# 結構化計劃
1. 使用 Markdown 表格組織任務
2. 估算每個任務的時間和風險
3. 定義明確的驗收標準
4. 考慮依賴關係和順序
```

**Code 階段**
```bash
# 漸進式重構
1. 每次只改變一個概念
2. 頻繁提交，小步快跑
3. 持續執行測試
4. 及時記錄重要決策
```

**Verify 階段**
```bash
# 多層次驗證
1. 單元測試：個別功能正確性
2. 整合測試：系統協作正確性
3. 效能測試：非功能需求
4. 使用者驗收：業務價值實現
```

---

## 🔍 故障排除

### 常見挑戰

**Q: 重構計劃太複雜，不知道從哪開始？**
A:
1. 先識別「最小可行變更」(MVP)
2. 優先處理低風險、高價值的變更
3. 建立回歸測試基線
4. 使用特性開關 (Feature Flag)

**Q: 如何確保向後兼容？**
A:
1. 保留 v1 端點，標記為 deprecated
2. 使用適配器模式轉換格式
3. 建立詳細的相容性測試
4. 提供遷移指南給客戶端

**Q: 程式碼量太大，上下文不夠？**
A:
1. 分模組進行重構
2. 使用 /memory 記錄重要決策
3. 每完成一個模組就 /compact
4. 重要的相依性寫入 CLAUDE.md

---

## 📚 延伸學習

完成練習後，可以探索：

1. **微服務重構**：將單體 API 拆分為微服務
2. **GraphQL 遷移**：從 REST 遷移到 GraphQL
3. **效能優化**：資料庫查詢優化、快取策略
4. **安全強化**：OAuth 2.0、RBAC 權限控制

---

## 📖 參考資料

- [模組 2.4：EPCV 工作流程深度解析](../理論/2.4_EPCV工作流程深度解析.md)
- [組合級情境：C02 API版本遷移](../情境題庫/組合級/C02_API版本遷移.md)
- [記憶卡：D類 工作流程與自動化](../記憶卡庫/02_CLI工具記憶卡.md#d-工作流程與自動化6張)

**記住**：重構就像建築改造 - 要有詳細設計圖，確保結構穩固，一步一步來！ 🏗️