# C10ï¼šéŒ¯èª¤è™•ç†å¢å¼·ï¼ˆçµ„åˆç´šï¼‰

## æƒ…å¢ƒè³‡è¨Š

**ç·¨è™Ÿ**ï¼šC10
**é›£åº¦**ï¼šâ­â­â­â˜†â˜†ï¼ˆçµ„åˆç´šï¼‰
**é è¨ˆæ™‚é–“**ï¼š1.5 å°æ™‚
**å­¸ç¿’ç›®æ¨™**ï¼š
- æŒæ¡ä½¿ç”¨ /grep æŸ¥æ‰¾éŒ¯èª¤è™•ç†å•é¡Œ
- å­¸æœƒç³»çµ±åŒ–æ”¹é€²ç•°å¸¸è™•ç†
- ç·´ç¿’å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ¶æ§‹
- å»ºç«‹éŒ¯èª¤è™•ç†æœ€ä½³å¯¦è¸æ¸…å–®

**é©ç”¨å°è±¡**ï¼š
- å®Œæˆæ¨¡çµ„ 2 åŸºç¤ç†è«–
- ç†Ÿæ‚‰ Python ç•°å¸¸è™•ç†æ©Ÿåˆ¶
- éœ€è¦æ”¹é€²ä»£ç¢¼å¥å£¯æ€§

---

## æƒ…å¢ƒæè¿°

### èƒŒæ™¯

ä½ åœ¨ä¸€å®¶é‡‘èç§‘æŠ€å…¬å¸è² è²¬æ”¯ä»˜ç³»çµ±çš„ç¶­è­·ã€‚æœ€è¿‘ä¸€å€‹æœˆï¼Œç”Ÿç”¢ç’°å¢ƒé »ç¹å‡ºç¾ç¥ç§˜çš„éŒ¯èª¤ï¼š

- **ç”¨æˆ¶æŠ•è¨´**ï¼šæ”¯ä»˜å¤±æ•—ä½†ä¸çŸ¥é“åŸå› ï¼ˆåªé¡¯ç¤º"ç³»çµ±éŒ¯èª¤"ï¼‰
- **é‹ç¶­å›°æ“¾**ï¼šæ—¥èªŒç¼ºå¤±é—œéµä¿¡æ¯ï¼Œé›£ä»¥å®šä½å•é¡Œ
- **æ•¸æ“šä¸ä¸€è‡´**ï¼šæŸäº›éŒ¯èª¤å°è‡´è¨‚å–®ç‹€æ…‹ç•°å¸¸
- **å®‰å…¨éš±æ‚£**ï¼šéŒ¯èª¤ä¿¡æ¯æ´©æ¼æ•æ„Ÿæ•¸æ“š

æ˜¨å¤©ç™¼ç”Ÿäº†ä¸€èµ·åš´é‡äº‹æ•…ï¼šæ”¯ä»˜æ¥å£ç•°å¸¸ï¼Œä½†éŒ¯èª¤æ²’æœ‰è¢«æ­£ç¢ºæ•ç²ï¼Œå°è‡´ 500 å€‹è¨‚å–®ç‹€æ…‹ä¸ä¸€è‡´ã€‚è€é—†è¦æ±‚ä½ åœ¨ä¸€é€±å…§ç³»çµ±åŒ–åœ°æ”¹é€²æ‰€æœ‰éŒ¯èª¤è™•ç†ã€‚

### ç¾æœ‰ä»£ç¢¼å•é¡Œ

```python
# apps/payments/services.py

import requests
from decimal import Decimal
from .models import Payment, Transaction

class PaymentService:
    """æ”¯ä»˜æœå‹™ - å……æ»¿éŒ¯èª¤è™•ç†å•é¡Œ"""

    def process_payment(self, order_id, amount, payment_method):
        """è™•ç†æ”¯ä»˜ - å•é¡Œ 1ï¼šè£¸ exceptï¼Œåæ‰æ‰€æœ‰ç•°å¸¸"""
        try:
            # å‰µå»ºæ”¯ä»˜è¨˜éŒ„
            payment = Payment.objects.create(
                order_id=order_id,
                amount=amount,
                payment_method=payment_method,
                status='pending'
            )

            # èª¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ API
            result = self._call_payment_gateway(payment)

            # æ›´æ–°æ”¯ä»˜ç‹€æ…‹
            payment.status = 'completed'
            payment.transaction_id = result['transaction_id']
            payment.save()

            return True
        except:  # âŒ è£¸ exceptï¼Œæ•ç²æ‰€æœ‰ç•°å¸¸åŒ…æ‹¬ KeyboardInterrupt
            return False  # âŒ åªè¿”å› Falseï¼Œä¸çŸ¥é“å¤±æ•—åŸå› 


    def _call_payment_gateway(self, payment):
        """èª¿ç”¨æ”¯ä»˜ç¶²é—œ - å•é¡Œ 2ï¼šæœªè™•ç†ç¶²çµ¡ç•°å¸¸"""
        url = "https://api.payment-gateway.com/charge"
        data = {
            "amount": payment.amount,
            "currency": "USD",
            "payment_method": payment.payment_method
        }

        # âŒ æ²’æœ‰è™•ç† requests.exceptionsï¼ˆè¶…æ™‚ã€ç¶²çµ¡éŒ¯èª¤ç­‰ï¼‰
        response = requests.post(url, json=data)

        # âŒ æ²’æœ‰æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
        return response.json()


    def refund_payment(self, payment_id, reason):
        """é€€æ¬¾ - å•é¡Œ 3ï¼šéŒ¯èª¤ä¿¡æ¯æ´©æ¼æ•æ„Ÿæ•¸æ“š"""
        payment = Payment.objects.get(id=payment_id)

        # âŒ å¦‚æœ payment ä¸å­˜åœ¨ï¼Œæ‹‹å‡ºç•°å¸¸ï¼Œæš´éœ²æ•¸æ“šåº«çµæ§‹
        if payment.status != 'completed':
            raise Exception(f"Cannot refund payment {payment_id} with status {payment.status}")
            # âŒ ä½¿ç”¨é€šç”¨ Exceptionï¼Œé›£ä»¥æ•ç²ç‰¹å®šéŒ¯èª¤

        try:
            result = self._call_refund_api(payment)
            payment.status = 'refunded'
            payment.save()
            return True
        except Exception as e:
            # âŒ éŒ¯èª¤ä¿¡æ¯å¯èƒ½åŒ…å«æ•æ„Ÿæ•¸æ“š
            print(f"Refund failed: {e}")  # âŒ ä½¿ç”¨ printï¼Œæ—¥èªŒä¸å®Œæ•´
            return False


    def check_payment_status(self, order_id):
        """æª¢æŸ¥æ”¯ä»˜ç‹€æ…‹ - å•é¡Œ 4ï¼šè¿”å›å€¼ä¸ä¸€è‡´"""
        payment = Payment.objects.filter(order_id=order_id).first()

        if not payment:
            return None  # âŒ æœ‰æ™‚è¿”å› None

        if payment.status == 'completed':
            return True  # âŒ æœ‰æ™‚è¿”å› True
        else:
            return False  # âŒ æœ‰æ™‚è¿”å› False
            # âŒ è¿”å›é¡å‹ä¸ä¸€è‡´ï¼Œå‘¼å«æ–¹é›£ä»¥è™•ç†


# apps/orders/services.py

class OrderService:
    """è¨‚å–®æœå‹™"""

    def create_order(self, user_id, items):
        """å‰µå»ºè¨‚å–® - å•é¡Œ 5ï¼šç¼ºå°‘äº‹å‹™æ§åˆ¶"""
        # å‰µå»ºè¨‚å–®
        order = Order.objects.create(
            user_id=user_id,
            status='pending'
        )

        # å‰µå»ºè¨‚å–®é …
        for item in items:
            OrderItem.objects.create(
                order=order,
                product_id=item['product_id'],
                quantity=item['quantity']
            )
            # âŒ å¦‚æœä¸­é€”å¤±æ•—ï¼Œå‰é¢çš„ OrderItem å·²ç¶“å‰µå»ºï¼Œæ•¸æ“šä¸ä¸€è‡´

        # æ‰£æ¸›åº«å­˜
        for item in items:
            product = Product.objects.get(id=item['product_id'])
            # âŒ å¦‚æœ product ä¸å­˜åœ¨ï¼Œæ‹‹å‡ºç•°å¸¸ï¼Œè¨‚å–®å·²å‰µå»ºä½†åº«å­˜æœªæ‰£
            product.stock -= item['quantity']
            if product.stock < 0:
                # âŒ æ‹‹å‡ºç•°å¸¸ï¼Œä½†è¨‚å–®å’Œè¨‚å–®é …å·²å‰µå»º
                raise ValueError("Insufficient stock")
            product.save()

        return order


    def cancel_order(self, order_id):
        """å–æ¶ˆè¨‚å–® - å•é¡Œ 6ï¼šéŒ¯èª¤è™•ç†ä¸å®Œæ•´"""
        order = Order.objects.get(id=order_id)
        # âŒ å¦‚æœè¨‚å–®ä¸å­˜åœ¨ï¼Œæ‹‹å‡º DoesNotExist ç•°å¸¸ï¼Œæ²’æœ‰è™•ç†

        if order.status == 'cancelled':
            # âŒ é‡è¤‡å–æ¶ˆï¼Œä½†æ²’æœ‰æ˜ç¢ºçš„éŒ¯èª¤è™•ç†
            return

        # å›æ»¾åº«å­˜
        for item in order.items.all():
            product = item.product
            product.stock += item.quantity
            product.save()
            # âŒ å¦‚æœ save() å¤±æ•—ï¼Œå‰é¢çš„å·²ç¶“æ›´æ–°ï¼Œæ•¸æ“šä¸ä¸€è‡´

        order.status = 'cancelled'
        order.save()


# apps/api/views.py

from rest_framework.views import APIView
from rest_framework.response import Response

class PaymentAPIView(APIView):
    """æ”¯ä»˜ API - å•é¡Œ 7ï¼šAPI éŒ¯èª¤è™•ç†ä¸çµ±ä¸€"""

    def post(self, request):
        order_id = request.data.get('order_id')
        amount = request.data.get('amount')

        # âŒ æ²’æœ‰åƒæ•¸é©—è­‰
        if not order_id:
            return Response({'error': 'Missing order_id'}, status=400)
            # âŒ éŒ¯èª¤æ ¼å¼ä¸çµ±ä¸€

        try:
            service = PaymentService()
            result = service.process_payment(order_id, amount, 'credit_card')

            if result:
                return Response({'success': True})
            else:
                # âŒ ä¸çŸ¥é“å¤±æ•—åŸå› ï¼Œç”¨æˆ¶åªçœ‹åˆ° "å¤±æ•—"
                return Response({'error': 'Payment failed'}, status=500)

        except Exception as e:
            # âŒ è¿”å›åŸå§‹ç•°å¸¸ä¿¡æ¯ï¼Œå¯èƒ½æ´©æ¼æ•æ„Ÿæ•¸æ“š
            return Response({'error': str(e)}, status=500)


# apps/utils/logger.py

import logging

logger = logging.getLogger(__name__)

def log_error(message):
    """è¨˜éŒ„éŒ¯èª¤ - å•é¡Œ 8ï¼šæ—¥èªŒä¿¡æ¯ä¸å®Œæ•´"""
    logger.error(message)  # âŒ æ²’æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨æˆ¶ã€è«‹æ±‚ã€å †ç–Šï¼‰


# å•é¡Œ 9ï¼šæ²’æœ‰çµ±ä¸€çš„ç•°å¸¸é¡é«”ç³»

# å•é¡Œ 10ï¼šæ²’æœ‰éŒ¯èª¤ç›£æ§å’Œå‘Šè­¦
```

### å…¸å‹éŒ¯èª¤å ´æ™¯

**å ´æ™¯ 1ï¼šæ”¯ä»˜å¤±æ•—ï¼Œæ•¸æ“šä¸ä¸€è‡´**

```python
# å‰µå»ºäº† Payment è¨˜éŒ„ï¼ˆstatus='pending'ï¼‰
payment = Payment.objects.create(...)

# èª¿ç”¨æ”¯ä»˜ API å¤±æ•—ï¼ˆç¶²çµ¡è¶…æ™‚ï¼‰
result = self._call_payment_gateway(payment)  # æ‹‹å‡ºç•°å¸¸

# âŒ ç•°å¸¸è¢«è£¸ except åæ‰ï¼Œè¿”å› False
# âŒ Payment è¨˜éŒ„ç‹€æ…‹ä»æ˜¯ 'pending'ï¼Œä½†æ”¯ä»˜å¯¦éš›å¤±æ•—
# âŒ è¨‚å–®ç³»çµ±ä»¥ç‚ºæ”¯ä»˜æ­£åœ¨è™•ç†
```

**å ´æ™¯ 2ï¼šå‰µå»ºè¨‚å–®å¤±æ•—ï¼Œåº«å­˜å·²æ‰£**

```python
# å‰µå»ºè¨‚å–®æˆåŠŸ
order = Order.objects.create(...)

# å‰µå»ºç¬¬ 1 å€‹è¨‚å–®é …æˆåŠŸ
OrderItem.objects.create(...)

# å‰µå»ºç¬¬ 2 å€‹è¨‚å–®é …æ™‚ï¼Œå•†å“ä¸å­˜åœ¨
OrderItem.objects.create(product_id='NOT_EXIST')  # æ‹‹å‡ºç•°å¸¸

# âŒ ç•°å¸¸æœªè™•ç†ï¼Œè¨‚å–®å’Œç¬¬ 1 å€‹è¨‚å–®é …å·²å‰µå»º
# âŒ å¦‚æœå·²ç¶“æ‰£åº«å­˜ï¼Œåº«å­˜ä¹Ÿç„¡æ³•å›æ»¾
```

**å ´æ™¯ 3ï¼šéŒ¯èª¤ä¿¡æ¯æ´©æ¼**

```python
# ç”¨æˆ¶è«‹æ±‚é€€æ¬¾ï¼Œä½†æ”¯ä»˜ ID éŒ¯èª¤
refund_payment('invalid_id', 'reason')

# æ‹‹å‡ºç•°å¸¸ï¼š
# Exception: Payment matching query does not exist.

# âŒ éŒ¯èª¤è¿”å›çµ¦å‰ç«¯ï¼Œæ´©æ¼äº†æ•¸æ“šåº«æ¨¡å‹ä¿¡æ¯
# âŒ æ”»æ“Šè€…å¯ä»¥æ¨æ¸¬æ•¸æ“šåº«çµæ§‹
```

### ä½ çš„ä»»å‹™

ç³»çµ±åŒ–åœ°æ”¹é€²éŒ¯èª¤è™•ç†ï¼š

1. **è­˜åˆ¥å•é¡Œ**ï¼šæ‰¾å‡ºæ‰€æœ‰éŒ¯èª¤è™•ç†å•é¡Œ
2. **è¨­è¨ˆæ¶æ§‹**ï¼šå»ºç«‹çµ±ä¸€çš„ç•°å¸¸é¡å’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶
3. **é‡æ§‹ä»£ç¢¼**ï¼š
   - æ›¿æ›è£¸ except
   - æ·»åŠ äº‹å‹™æ§åˆ¶
   - çµ±ä¸€ API éŒ¯èª¤æ ¼å¼
   - å®Œå–„æ—¥èªŒè¨˜éŒ„
4. **å»ºç«‹ç›£æ§**ï¼šå¯¦ç¾éŒ¯èª¤è¿½è¹¤å’Œå‘Šè­¦

---

## å­¸ç¿’é‡é»

### ç›®æ¨™ 1ï¼šä½¿ç”¨ /grep æŸ¥æ‰¾éŒ¯èª¤è™•ç†å•é¡Œ

å­¸æœƒè­˜åˆ¥å¸¸è¦‹éŒ¯èª¤è™•ç†åæ¨¡å¼ï¼š
- è£¸ except å­å¥
- è¿”å›å€¼ä¸ä¸€è‡´
- ç¼ºå°‘æ—¥èªŒè¨˜éŒ„
- éŒ¯èª¤ä¿¡æ¯æ´©æ¼
- ç¼ºå°‘äº‹å‹™æ§åˆ¶

### ç›®æ¨™ 2ï¼šè¨­è¨ˆç•°å¸¸è™•ç†æ¶æ§‹

å»ºç«‹å®Œå–„çš„ç•°å¸¸é«”ç³»ï¼š
- è‡ªå®šç¾©ç•°å¸¸é¡å±¤ç´š
- ç•°å¸¸è™•ç†ä¸­é–“ä»¶
- çµ±ä¸€éŒ¯èª¤éŸ¿æ‡‰æ ¼å¼
- éŒ¯èª¤ç¢¼è¨­è¨ˆ

### ç›®æ¨™ 3ï¼šäº‹å‹™æ§åˆ¶èˆ‡æ•¸æ“šä¸€è‡´æ€§

æŒæ¡æ•¸æ“šä¸€è‡´æ€§ä¿éšœï¼š
- æ•¸æ“šåº«äº‹å‹™ï¼ˆatomicï¼‰
- è£œå„Ÿæ©Ÿåˆ¶ï¼ˆSagaï¼‰
- å†ªç­‰æ€§è¨­è¨ˆ
- åˆ†ä½ˆå¼äº‹å‹™

### ç›®æ¨™ 4ï¼šæ—¥èªŒèˆ‡ç›£æ§

å»ºç«‹å®Œå–„çš„éŒ¯èª¤è¿½è¹¤ï¼š
- çµæ§‹åŒ–æ—¥èªŒ
- ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨æˆ¶ã€è«‹æ±‚ã€å †ç–Šï¼‰
- éŒ¯èª¤èšåˆå’Œå‘Šè­¦ï¼ˆSentryï¼‰
- å¯è§€æ¸¬æ€§

---

## å»ºè­°è§£æ±ºæµç¨‹

### éšæ®µä¸€ï¼šè­˜åˆ¥éŒ¯èª¤è™•ç†å•é¡Œï¼ˆ20 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šæ‰¾å‡ºæ‰€æœ‰éŒ¯èª¤è™•ç†å•é¡Œ

#### æ­¥é©Ÿ 1ï¼šæŸ¥æ‰¾è£¸ except

```bash
/grep "except:" --type py -C 3

æç¤ºè©ï¼š
è«‹æ‰¾å‡ºæ‰€æœ‰è£¸ except å­å¥ï¼ˆexcept: è€Œä¸æ˜¯ except Exception:ï¼‰ï¼š

1. çµ±è¨ˆæ•¸é‡å’Œä½ç½®
2. åˆ†ææ¯å€‹ except çš„å•é¡Œ
3. è©•ä¼°å½±éŸ¿ï¼ˆå¯èƒ½éš±è—å“ªäº›ç•°å¸¸ï¼Ÿï¼‰
4. æä¾›ä¿®å¾©æ–¹æ¡ˆ

å°æ–¼æ¯å€‹è£¸ exceptï¼Œèªªæ˜æ‡‰è©²æ•ç²å“ªäº›å…·é«”ç•°å¸¸ã€‚
```

**é æœŸè¼¸å‡º**ï¼š

```markdown
## è£¸ Except å•é¡Œæ¸…å–®

### å•é¡Œ 1ï¼šæ”¯ä»˜è™•ç†çš„è£¸ exceptï¼ˆé«˜é¢¨éšªï¼‰

**ä½ç½®**ï¼šapps/payments/services.py:25

```python
try:
    # ... æ”¯ä»˜é‚è¼¯ ...
    payment.save()
    return True
except:  # âŒ è£¸ except
    return False
```

**å•é¡Œ**ï¼š
- æ•ç²æ‰€æœ‰ç•°å¸¸ï¼ŒåŒ…æ‹¬ SystemExit, KeyboardInterrupt
- æ•¸æ“šåº«éŒ¯èª¤ã€ç¶²çµ¡éŒ¯èª¤ã€æ¥­å‹™éŒ¯èª¤å…¨éƒ¨è¢«åæ‰
- åªè¿”å› Falseï¼Œä¸çŸ¥é“å¤±æ•—åŸå› 
- Payment è¨˜éŒ„å¯èƒ½è™•æ–¼ä¸ä¸€è‡´ç‹€æ…‹

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
```python
try:
    # ... æ”¯ä»˜é‚è¼¯ ...
    payment.save()
    return payment
except PaymentGatewayError as e:
    # æ”¯ä»˜ç¶²é—œéŒ¯èª¤
    logger.error(f"Payment gateway error: {e}", exc_info=True)
    payment.status = 'failed'
    payment.error_message = str(e)
    payment.save()
    raise
except requests.exceptions.RequestException as e:
    # ç¶²çµ¡éŒ¯èª¤
    logger.error(f"Network error during payment: {e}", exc_info=True)
    raise PaymentNetworkError("Payment service unavailable") from e
except Exception as e:
    # å…¶ä»–éŒ¯èª¤
    logger.critical(f"Unexpected payment error: {e}", exc_info=True)
    raise
```

---

### ç¸½è¨ˆï¼šæ‰¾åˆ° **8 å€‹è£¸ except**

| ä½ç½® | é¢¨éšªç­‰ç´š | å½±éŸ¿ |
|------|---------|------|
| payments/services.py:25 | é«˜ | æ•¸æ“šä¸ä¸€è‡´ |
| orders/services.py:45 | é«˜ | åº«å­˜éŒ¯èª¤ |
| api/views.py:67 | ä¸­ | ç”¨æˆ¶é«”é©—å·® |
| utils/helpers.py:12 | ä½ | æ—¥èªŒç¼ºå¤± |
```

**æª¢æŸ¥é»**ï¼š
- [ ] æ‰¾å‡ºæ‰€æœ‰è£¸ except
- [ ] è©•ä¼°äº†é¢¨éšª
- [ ] æä¾›äº†ä¿®å¾©æ–¹æ¡ˆ

---

#### æ­¥é©Ÿ 2ï¼šæŸ¥æ‰¾è¿”å›å€¼ä¸ä¸€è‡´

```bash
/grep "return None\|return True\|return False" --type py -C 2

æç¤ºè©ï¼š
è«‹æ‰¾å‡ºè¿”å›å€¼é¡å‹ä¸ä¸€è‡´çš„å‡½æ•¸ï¼š

1. æœ‰æ™‚è¿”å› Noneï¼Œæœ‰æ™‚è¿”å›å°è±¡
2. æœ‰æ™‚è¿”å› True/Falseï¼Œæœ‰æ™‚è¿”å›å°è±¡
3. æœ‰æ™‚è¿”å›æ•¸æ“šï¼Œæœ‰æ™‚è¿”å›éŒ¯èª¤ä¿¡æ¯

å°æ¯å€‹å‡½æ•¸æä¾›çµ±ä¸€çš„è¿”å›å€¼è¨­è¨ˆã€‚
```

**é æœŸè¼¸å‡º**ï¼š

```markdown
## è¿”å›å€¼ä¸ä¸€è‡´å•é¡Œ

### å•é¡Œ 1ï¼šcheck_payment_status è¿”å›é¡å‹ä¸ä¸€è‡´

**ä½ç½®**ï¼šapps/payments/services.py:78

```python
def check_payment_status(self, order_id):
    payment = Payment.objects.filter(order_id=order_id).first()

    if not payment:
        return None  # âŒ è¿”å› None

    if payment.status == 'completed':
        return True  # âŒ è¿”å› True
    else:
        return False  # âŒ è¿”å› False
```

**å•é¡Œ**ï¼š
- è¿”å›é¡å‹ï¼šNone | bool
- å‘¼å«æ–¹éœ€è¦åˆ¤æ–·é¡å‹ï¼š`if result is None` vs `if result`
- å®¹æ˜“å‡ºéŒ¯

**ä¿®å¾©æ–¹æ¡ˆ 1ï¼šçµ±ä¸€è¿”å›å°è±¡**
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class PaymentStatus:
    exists: bool
    is_completed: bool
    status: Optional[str]

def check_payment_status(self, order_id) -> PaymentStatus:
    payment = Payment.objects.filter(order_id=order_id).first()

    if not payment:
        return PaymentStatus(exists=False, is_completed=False, status=None)

    return PaymentStatus(
        exists=True,
        is_completed=(payment.status == 'completed'),
        status=payment.status
    )
```

**ä¿®å¾©æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç•°å¸¸è¡¨ç¤ºéŒ¯èª¤**
```python
def check_payment_status(self, order_id) -> str:
    """è¿”å›æ”¯ä»˜ç‹€æ…‹ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡æ‹‹å‡ºç•°å¸¸"""
    payment = Payment.objects.filter(order_id=order_id).first()

    if not payment:
        raise PaymentNotFoundError(f"Payment for order {order_id} not found")

    return payment.status
```

---

### ç¸½è¨ˆï¼šæ‰¾åˆ° **12 å€‹è¿”å›å€¼ä¸ä¸€è‡´çš„å‡½æ•¸**
```

**æª¢æŸ¥é»**ï¼š
- [ ] æ‰¾å‡ºè¿”å›å€¼ä¸ä¸€è‡´çš„å‡½æ•¸
- [ ] æä¾›äº†çµ±ä¸€çš„è¨­è¨ˆæ–¹æ¡ˆ

---

#### æ­¥é©Ÿ 3ï¼šæŸ¥æ‰¾ç¼ºå°‘äº‹å‹™æ§åˆ¶

```bash
/grep "\.save\(\)" --type py -C 5

æç¤ºè©ï¼š
è«‹æ‰¾å‡ºç¼ºå°‘äº‹å‹™æ§åˆ¶çš„å¤šæ­¥é©Ÿæ“ä½œï¼š

1. å¤šå€‹ .save() æ“ä½œ
2. å¤šå€‹ .create() æ“ä½œ
3. æ¶‰åŠå¤šå€‹æ¨¡å‹çš„æ›´æ–°
4. ä¸­é€”å¯èƒ½å¤±æ•—çš„æ“ä½œ

å°æ¯å€‹å ´æ™¯èªªæ˜ç‚ºä»€éº¼éœ€è¦äº‹å‹™ï¼Œä»¥åŠå¦‚ä½•æ·»åŠ ã€‚
```

**é æœŸè¼¸å‡º**ï¼š

```markdown
## ç¼ºå°‘äº‹å‹™æ§åˆ¶å•é¡Œ

### å•é¡Œ 1ï¼šå‰µå»ºè¨‚å–®ç¼ºå°‘äº‹å‹™ï¼ˆåš´é‡ï¼‰

**ä½ç½®**ï¼šapps/orders/services.py:23

```python
def create_order(self, user_id, items):
    # Step 1: å‰µå»ºè¨‚å–®
    order = Order.objects.create(...)  # âœ“ æˆåŠŸ

    # Step 2: å‰µå»ºè¨‚å–®é …
    for item in items:
        OrderItem.objects.create(...)  # âœ“ æˆåŠŸ 2 å€‹
        # âŒ ç¬¬ 3 å€‹å¤±æ•—ï¼Œå‰ 2 å€‹å·²ç¶“å‰µå»º

    # Step 3: æ‰£æ¸›åº«å­˜
    for item in items:
        product.stock -= item['quantity']
        product.save()  # âŒ é‚„æ²’åŸ·è¡Œ
```

**å•é¡Œ**ï¼š
- 3 æ­¥æ“ä½œæ²’æœ‰äº‹å‹™ä¿è­·
- ä»»ä½•ä¸€æ­¥å¤±æ•—ï¼Œå‰é¢çš„å·²ç¶“æäº¤
- æ•¸æ“šä¸ä¸€è‡´ï¼šè¨‚å–®å‰µå»ºä½†è¨‚å–®é …ç¼ºå¤±

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
```python
from django.db import transaction

@transaction.atomic
def create_order(self, user_id, items):
    """ä½¿ç”¨ atomic è£é£¾å™¨ï¼Œè‡ªå‹•å›æ»¾"""
    # Step 1: å‰µå»ºè¨‚å–®
    order = Order.objects.create(
        user_id=user_id,
        status='pending'
    )

    # Step 2: å‰µå»ºè¨‚å–®é …
    for item in items:
        OrderItem.objects.create(
            order=order,
            product_id=item['product_id'],
            quantity=item['quantity']
        )

    # Step 3: æ‰£æ¸›åº«å­˜
    for item in items:
        product = Product.objects.select_for_update().get(
            id=item['product_id']
        )  # è¡Œé–ï¼Œé˜²æ­¢ä½µç™¼
        if product.stock < item['quantity']:
            raise InsufficientStockError(
                f"Product {product.name} has insufficient stock"
            )
        product.stock -= item['quantity']
        product.save()

    return order

# å¦‚æœä»»ä½•æ­¥é©Ÿæ‹‹å‡ºç•°å¸¸ï¼Œæ•´å€‹äº‹å‹™å›æ»¾
```

---

### ç¸½è¨ˆï¼šæ‰¾åˆ° **5 å€‹ç¼ºå°‘äº‹å‹™æ§åˆ¶çš„æ“ä½œ**
```

**æª¢æŸ¥é»**ï¼š
- [ ] æ‰¾å‡ºç¼ºå°‘äº‹å‹™çš„æ“ä½œ
- [ ] ç†è§£äº†äº‹å‹™çš„é‡è¦æ€§
- [ ] æä¾›äº†ä¿®å¾©æ–¹æ¡ˆ

---

### éšæ®µäºŒï¼šè¨­è¨ˆéŒ¯èª¤è™•ç†æ¶æ§‹ï¼ˆ25 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šå»ºç«‹çµ±ä¸€çš„ç•°å¸¸é«”ç³»å’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶

#### æ­¥é©Ÿ 1ï¼šè¨­è¨ˆç•°å¸¸é¡å±¤ç´š

```bash
æç¤ºè©ï¼š
è«‹ç‚ºæ”¯ä»˜ç³»çµ±è¨­è¨ˆå®Œæ•´çš„ç•°å¸¸é¡é«”ç³»ï¼š

1. åŸºç¤ç•°å¸¸é¡
2. æ¥­å‹™ç•°å¸¸ï¼ˆæ”¯ä»˜å¤±æ•—ã€åº«å­˜ä¸è¶³ç­‰ï¼‰
3. æŠ€è¡“ç•°å¸¸ï¼ˆç¶²çµ¡éŒ¯èª¤ã€æ•¸æ“šåº«éŒ¯èª¤ç­‰ï¼‰
4. æ¯å€‹ç•°å¸¸åŒ…å«ï¼šéŒ¯èª¤ç¢¼ã€ç”¨æˆ¶æ¶ˆæ¯ã€é–‹ç™¼è€…æ¶ˆæ¯

è¦æ±‚ï¼š
- æ¸…æ™°çš„å±¤ç´šçµæ§‹
- æ˜“æ–¼æ“´å±•
- åŒ…å«å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
```

**è¨­è¨ˆæ–¹æ¡ˆ**ï¼š

```python
# apps/core/exceptions.py

class AppException(Exception):
    """æ‡‰ç”¨ç•°å¸¸åŸºé¡"""

    def __init__(
        self,
        message: str,
        error_code: str = None,
        user_message: str = None,
        status_code: int = 500,
        details: dict = None
    ):
        self.message = message  # é–‹ç™¼è€…çœ‹çš„è©³ç´°ä¿¡æ¯
        self.error_code = error_code or 'UNKNOWN_ERROR'
        self.user_message = user_message or 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦'
        self.status_code = status_code
        self.details = details or {}
        super().__init__(message)

    def to_dict(self):
        """è½‰æ›ç‚º API éŸ¿æ‡‰æ ¼å¼"""
        return {
            'error_code': self.error_code,
            'message': self.user_message,
            'details': self.details
        }


# æ¥­å‹™ç•°å¸¸ï¼ˆ400-499ï¼‰

class BusinessException(AppException):
    """æ¥­å‹™ç•°å¸¸åŸºé¡"""
    def __init__(self, message, error_code, user_message, details=None):
        super().__init__(
            message=message,
            error_code=error_code,
            user_message=user_message,
            status_code=400,
            details=details
        )


class ValidationError(BusinessException):
    """é©—è­‰éŒ¯èª¤"""
    def __init__(self, message, field=None):
        super().__init__(
            message=message,
            error_code='VALIDATION_ERROR',
            user_message='è¼¸å…¥ä¿¡æ¯ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥',
            details={'field': field} if field else {}
        )


class InsufficientStockError(BusinessException):
    """åº«å­˜ä¸è¶³"""
    def __init__(self, product_name, available, requested):
        super().__init__(
            message=f"Insufficient stock for {product_name}",
            error_code='INSUFFICIENT_STOCK',
            user_message=f'å•†å“ {product_name} åº«å­˜ä¸è¶³',
            details={
                'available': available,
                'requested': requested
            }
        )


class PaymentFailedError(BusinessException):
    """æ”¯ä»˜å¤±æ•—"""
    def __init__(self, reason, transaction_id=None):
        super().__init__(
            message=f"Payment failed: {reason}",
            error_code='PAYMENT_FAILED',
            user_message='æ”¯ä»˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ”¯ä»˜ä¿¡æ¯æˆ–ç¨å¾Œé‡è©¦',
            details={'transaction_id': transaction_id}
        )


# è³‡æºç•°å¸¸ï¼ˆ404ï¼‰

class ResourceNotFoundException(AppException):
    """è³‡æºæœªæ‰¾åˆ°"""
    def __init__(self, resource_type, resource_id):
        super().__init__(
            message=f"{resource_type} {resource_id} not found",
            error_code='RESOURCE_NOT_FOUND',
            user_message=f'{resource_type}ä¸å­˜åœ¨',
            status_code=404,
            details={'resource_type': resource_type, 'resource_id': resource_id}
        )


class OrderNotFoundError(ResourceNotFoundException):
    """è¨‚å–®æœªæ‰¾åˆ°"""
    def __init__(self, order_id):
        super().__init__('Order', order_id)


class PaymentNotFoundError(ResourceNotFoundException):
    """æ”¯ä»˜æœªæ‰¾åˆ°"""
    def __init__(self, payment_id):
        super().__init__('Payment', payment_id)


# æŠ€è¡“ç•°å¸¸ï¼ˆ500-599ï¼‰

class TechnicalException(AppException):
    """æŠ€è¡“ç•°å¸¸åŸºé¡"""
    def __init__(self, message, error_code, details=None):
        super().__init__(
            message=message,
            error_code=error_code,
            user_message='ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œé‡è©¦',
            status_code=500,
            details=details
        )


class PaymentGatewayError(TechnicalException):
    """æ”¯ä»˜ç¶²é—œéŒ¯èª¤"""
    def __init__(self, gateway_message, gateway_code=None):
        super().__init__(
            message=f"Payment gateway error: {gateway_message}",
            error_code='PAYMENT_GATEWAY_ERROR',
            details={
                'gateway_message': gateway_message,
                'gateway_code': gateway_code
            }
        )


class PaymentNetworkError(TechnicalException):
    """æ”¯ä»˜ç¶²çµ¡éŒ¯èª¤"""
    def __init__(self, message):
        super().__init__(
            message=f"Network error: {message}",
            error_code='PAYMENT_NETWORK_ERROR'
        )


class DatabaseError(TechnicalException):
    """æ•¸æ“šåº«éŒ¯èª¤"""
    def __init__(self, operation, message):
        super().__init__(
            message=f"Database {operation} error: {message}",
            error_code='DATABASE_ERROR',
            details={'operation': operation}
        )


# æ¬Šé™ç•°å¸¸ï¼ˆ401, 403ï¼‰

class PermissionDeniedError(AppException):
    """æ¬Šé™ä¸è¶³"""
    def __init__(self, action, resource):
        super().__init__(
            message=f"Permission denied for {action} on {resource}",
            error_code='PERMISSION_DENIED',
            user_message='æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ',
            status_code=403,
            details={'action': action, 'resource': resource}
        )
```

#### æ­¥é©Ÿ 2ï¼šå¯¦ç¾çµ±ä¸€çš„éŒ¯èª¤è™•ç†ä¸­é–“ä»¶

```python
# apps/core/middleware.py

import logging
import traceback
from django.http import JsonResponse
from .exceptions import AppException

logger = logging.getLogger(__name__)

class ErrorHandlingMiddleware:
    """çµ±ä¸€éŒ¯èª¤è™•ç†ä¸­é–“ä»¶"""

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            response = self.get_response(request)
            return response
        except AppException as e:
            # æ¥­å‹™ç•°å¸¸ï¼šè¨˜éŒ„è­¦å‘Š
            logger.warning(
                f"Business exception: {e.error_code}",
                extra={
                    'error_code': e.error_code,
                    'user_id': getattr(request.user, 'id', None),
                    'path': request.path,
                    'details': e.details
                }
            )
            return JsonResponse(e.to_dict(), status=e.status_code)

        except Exception as e:
            # æœªé æœŸçš„ç•°å¸¸ï¼šè¨˜éŒ„éŒ¯èª¤
            logger.error(
                f"Unexpected error: {str(e)}",
                exc_info=True,
                extra={
                    'user_id': getattr(request.user, 'id', None),
                    'path': request.path,
                    'method': request.method
                }
            )

            # ç”Ÿç”¢ç’°å¢ƒä¸æš´éœ²è©³ç´°éŒ¯èª¤
            return JsonResponse({
                'error_code': 'INTERNAL_ERROR',
                'message': 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹è¯ç¹«å®¢æœ',
                'details': {}
            }, status=500)

    def process_exception(self, request, exception):
        """Django æœƒèª¿ç”¨é€™å€‹æ–¹æ³•è™•ç†è¦–åœ–ä¸­çš„ç•°å¸¸"""
        # å·²ç¶“åœ¨ __call__ ä¸­è™•ç†ï¼Œé€™è£¡è¿”å› None
        return None
```

#### æ­¥é©Ÿ 3ï¼šå¯¦ç¾çµæ§‹åŒ–æ—¥èªŒ

```python
# apps/core/logging.py

import logging
import json
from datetime import datetime

class StructuredLogger:
    """çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„å™¨"""

    def __init__(self, name):
        self.logger = logging.getLogger(name)

    def log_error(
        self,
        message,
        error_code=None,
        user_id=None,
        order_id=None,
        payment_id=None,
        exception=None,
        **extra
    ):
        """è¨˜éŒ„éŒ¯èª¤ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡"""
        log_data = {
            'timestamp': datetime.utcnow().isoformat(),
            'level': 'ERROR',
            'message': message,
            'error_code': error_code,
            'context': {
                'user_id': user_id,
                'order_id': order_id,
                'payment_id': payment_id,
                **extra
            }
        }

        if exception:
            log_data['exception'] = {
                'type': type(exception).__name__,
                'message': str(exception),
                'traceback': traceback.format_exc()
            }

        self.logger.error(json.dumps(log_data))

    def log_business_event(
        self,
        event_type,
        user_id=None,
        order_id=None,
        **extra
    ):
        """è¨˜éŒ„æ¥­å‹™äº‹ä»¶"""
        log_data = {
            'timestamp': datetime.utcnow().isoformat(),
            'level': 'INFO',
            'event_type': event_type,
            'context': {
                'user_id': user_id,
                'order_id': order_id,
                **extra
            }
        }

        self.logger.info(json.dumps(log_data))
```

**æª¢æŸ¥é»**ï¼š
- [ ] è¨­è¨ˆäº†ç•°å¸¸é¡å±¤ç´š
- [ ] å¯¦ç¾äº†çµ±ä¸€éŒ¯èª¤è™•ç†
- [ ] å»ºç«‹äº†çµæ§‹åŒ–æ—¥èªŒ

---

### éšæ®µä¸‰ï¼šé‡æ§‹ç¾æœ‰ä»£ç¢¼ï¼ˆ35 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šæ‡‰ç”¨æ–°çš„éŒ¯èª¤è™•ç†æ¶æ§‹

#### æ­¥é©Ÿ 1ï¼šé‡æ§‹æ”¯ä»˜æœå‹™

```python
# apps/payments/services.pyï¼ˆé‡æ§‹å¾Œï¼‰

import requests
from django.db import transaction
from apps.core.exceptions import (
    PaymentFailedError,
    PaymentGatewayError,
    PaymentNetworkError,
    PaymentNotFoundError
)
from apps.core.logging import StructuredLogger

logger = StructuredLogger(__name__)

class PaymentService:
    """æ”¯ä»˜æœå‹™ï¼ˆé‡æ§‹å¾Œï¼‰"""

    @transaction.atomic
    def process_payment(self, order_id, amount, payment_method):
        """
        è™•ç†æ”¯ä»˜

        Args:
            order_id: è¨‚å–® ID
            amount: æ”¯ä»˜é‡‘é¡
            payment_method: æ”¯ä»˜æ–¹å¼

        Returns:
            Payment: æ”¯ä»˜è¨˜éŒ„

        Raises:
            PaymentFailedError: æ”¯ä»˜å¤±æ•—
            PaymentGatewayError: æ”¯ä»˜ç¶²é—œéŒ¯èª¤
            PaymentNetworkError: ç¶²çµ¡éŒ¯èª¤
        """
        # å‰µå»ºæ”¯ä»˜è¨˜éŒ„
        payment = Payment.objects.create(
            order_id=order_id,
            amount=amount,
            payment_method=payment_method,
            status='pending'
        )

        try:
            # èª¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ API
            result = self._call_payment_gateway(payment)

            # æ›´æ–°æ”¯ä»˜ç‹€æ…‹
            payment.status = 'completed'
            payment.transaction_id = result['transaction_id']
            payment.save()

            # è¨˜éŒ„æ¥­å‹™äº‹ä»¶
            logger.log_business_event(
                event_type='payment_completed',
                order_id=order_id,
                payment_id=payment.id,
                amount=float(amount),
                method=payment_method
            )

            return payment

        except PaymentGatewayError as e:
            # æ”¯ä»˜ç¶²é—œéŒ¯èª¤
            payment.status = 'failed'
            payment.error_message = str(e)
            payment.save()

            logger.log_error(
                message="Payment gateway error",
                error_code='PAYMENT_GATEWAY_ERROR',
                order_id=order_id,
                payment_id=payment.id,
                exception=e
            )

            raise

        except requests.exceptions.Timeout as e:
            # ç¶²çµ¡è¶…æ™‚
            payment.status = 'timeout'
            payment.save()

            logger.log_error(
                message="Payment gateway timeout",
                error_code='PAYMENT_TIMEOUT',
                order_id=order_id,
                payment_id=payment.id,
                exception=e
            )

            raise PaymentNetworkError("æ”¯ä»˜æœå‹™è¶…æ™‚") from e

        except requests.exceptions.RequestException as e:
            # å…¶ä»–ç¶²çµ¡éŒ¯èª¤
            logger.log_error(
                message="Payment network error",
                error_code='PAYMENT_NETWORK_ERROR',
                order_id=order_id,
                payment_id=payment.id,
                exception=e
            )

            raise PaymentNetworkError("æ”¯ä»˜æœå‹™ä¸å¯ç”¨") from e

        except Exception as e:
            # æœªé æœŸçš„éŒ¯èª¤
            logger.log_error(
                message="Unexpected payment error",
                error_code='PAYMENT_UNEXPECTED_ERROR',
                order_id=order_id,
                payment_id=payment.id,
                exception=e
            )

            raise


    def _call_payment_gateway(self, payment):
        """
        èª¿ç”¨æ”¯ä»˜ç¶²é—œ

        Raises:
            PaymentGatewayError: æ”¯ä»˜ç¶²é—œè¿”å›éŒ¯èª¤
            requests.exceptions.RequestException: ç¶²çµ¡éŒ¯èª¤
        """
        url = "https://api.payment-gateway.com/charge"
        data = {
            "amount": float(payment.amount),
            "currency": "USD",
            "payment_method": payment.payment_method
        }

        try:
            response = requests.post(
                url,
                json=data,
                timeout=10  # 10 ç§’è¶…æ™‚
            )

            # æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
            response.raise_for_status()

            result = response.json()

            # æª¢æŸ¥æ¥­å‹™ç‹€æ…‹
            if result.get('status') != 'success':
                raise PaymentGatewayError(
                    gateway_message=result.get('message', 'Unknown error'),
                    gateway_code=result.get('code')
                )

            return result

        except requests.exceptions.HTTPError as e:
            # HTTP éŒ¯èª¤ï¼ˆ4xx, 5xxï¼‰
            raise PaymentGatewayError(
                gateway_message=f"HTTP {e.response.status_code}",
                gateway_code=str(e.response.status_code)
            ) from e


    def refund_payment(self, payment_id, reason):
        """
        é€€æ¬¾

        Args:
            payment_id: æ”¯ä»˜ ID
            reason: é€€æ¬¾åŸå› 

        Returns:
            Payment: æ›´æ–°å¾Œçš„æ”¯ä»˜è¨˜éŒ„

        Raises:
            PaymentNotFoundError: æ”¯ä»˜ä¸å­˜åœ¨
            PaymentFailedError: é€€æ¬¾å¤±æ•—ï¼ˆæ”¯ä»˜ç‹€æ…‹ä¸å…è¨±é€€æ¬¾ï¼‰
        """
        # æŸ¥è©¢æ”¯ä»˜è¨˜éŒ„
        try:
            payment = Payment.objects.get(id=payment_id)
        except Payment.DoesNotExist:
            raise PaymentNotFoundError(payment_id)

        # æª¢æŸ¥æ”¯ä»˜ç‹€æ…‹
        if payment.status != 'completed':
            raise PaymentFailedError(
                reason=f"Cannot refund payment with status {payment.status}",
                transaction_id=payment.transaction_id
            )

        # èª¿ç”¨é€€æ¬¾ API
        try:
            result = self._call_refund_api(payment, reason)

            payment.status = 'refunded'
            payment.refund_reason = reason
            payment.save()

            logger.log_business_event(
                event_type='payment_refunded',
                payment_id=payment.id,
                reason=reason
            )

            return payment

        except Exception as e:
            logger.log_error(
                message="Refund failed",
                error_code='REFUND_ERROR',
                payment_id=payment.id,
                exception=e
            )
            raise
```

**æª¢æŸ¥é»**ï¼š
- [ ] æ›¿æ›äº†è£¸ except
- [ ] æ·»åŠ äº†äº‹å‹™æ§åˆ¶
- [ ] ä½¿ç”¨äº†è‡ªå®šç¾©ç•°å¸¸
- [ ] å®Œå–„äº†æ—¥èªŒè¨˜éŒ„

---

#### æ­¥é©Ÿ 2ï¼šé‡æ§‹è¨‚å–®æœå‹™

```python
# apps/orders/services.pyï¼ˆé‡æ§‹å¾Œï¼‰

from django.db import transaction
from apps.core.exceptions import (
    InsufficientStockError,
    OrderNotFoundError
)

class OrderService:
    """è¨‚å–®æœå‹™ï¼ˆé‡æ§‹å¾Œï¼‰"""

    @transaction.atomic
    def create_order(self, user_id, items):
        """
        å‰µå»ºè¨‚å–®ï¼ˆä½¿ç”¨äº‹å‹™ä¿è­‰ä¸€è‡´æ€§ï¼‰

        Args:
            user_id: ç”¨æˆ¶ ID
            items: è¨‚å–®é …åˆ—è¡¨

        Returns:
            Order: å‰µå»ºçš„è¨‚å–®

        Raises:
            InsufficientStockError: åº«å­˜ä¸è¶³
            ValidationError: åƒæ•¸é©—è­‰å¤±æ•—
        """
        # å‰µå»ºè¨‚å–®
        order = Order.objects.create(
            user_id=user_id,
            status='pending'
        )

        # å‰µå»ºè¨‚å–®é …ä¸¦æª¢æŸ¥åº«å­˜
        for item in items:
            # è¡Œé–ï¼Œé˜²æ­¢ä½µç™¼å•é¡Œ
            product = Product.objects.select_for_update().get(
                id=item['product_id']
            )

            # æª¢æŸ¥åº«å­˜
            if product.stock < item['quantity']:
                raise InsufficientStockError(
                    product_name=product.name,
                    available=product.stock,
                    requested=item['quantity']
                )

            # å‰µå»ºè¨‚å–®é …
            OrderItem.objects.create(
                order=order,
                product=product,
                quantity=item['quantity'],
                price=product.price
            )

            # æ‰£æ¸›åº«å­˜
            product.stock -= item['quantity']
            product.save()

        logger.log_business_event(
            event_type='order_created',
            user_id=user_id,
            order_id=order.id,
            item_count=len(items)
        )

        return order
        # å¦‚æœä»»ä½•æ­¥é©Ÿå¤±æ•—ï¼Œäº‹å‹™è‡ªå‹•å›æ»¾


    @transaction.atomic
    def cancel_order(self, order_id):
        """
        å–æ¶ˆè¨‚å–®ï¼ˆä½¿ç”¨äº‹å‹™ä¿è­‰åº«å­˜æ­£ç¢ºå›æ»¾ï¼‰

        Args:
            order_id: è¨‚å–® ID

        Raises:
            OrderNotFoundError: è¨‚å–®ä¸å­˜åœ¨
            ValidationError: è¨‚å–®ç‹€æ…‹ä¸å…è¨±å–æ¶ˆ
        """
        try:
            order = Order.objects.select_for_update().get(id=order_id)
        except Order.DoesNotExist:
            raise OrderNotFoundError(order_id)

        # æª¢æŸ¥è¨‚å–®ç‹€æ…‹
        if order.status == 'cancelled':
            logger.log_business_event(
                event_type='order_already_cancelled',
                order_id=order_id
            )
            return order  # å†ªç­‰ï¼šå·²å–æ¶ˆï¼Œç›´æ¥è¿”å›

        if order.status not in ['pending', 'confirmed']:
            raise ValidationError(
                f"Cannot cancel order with status {order.status}",
                field='status'
            )

        # å›æ»¾åº«å­˜
        for item in order.items.all():
            product = Product.objects.select_for_update().get(id=item.product_id)
            product.stock += item.quantity
            product.save()

        # æ›´æ–°è¨‚å–®ç‹€æ…‹
        order.status = 'cancelled'
        order.save()

        logger.log_business_event(
            event_type='order_cancelled',
            order_id=order_id
        )

        return order
```

**æª¢æŸ¥é»**ï¼š
- [ ] æ·»åŠ äº†äº‹å‹™æ§åˆ¶
- [ ] ä½¿ç”¨äº†è¡Œé–é˜²æ­¢ä½µç™¼
- [ ] è™•ç†äº†å†ªç­‰æ€§
- [ ] å®Œå–„äº†ç•°å¸¸è™•ç†

---

### éšæ®µå››ï¼šå»ºç«‹ç›£æ§ï¼ˆ10 åˆ†é˜ï¼‰

**ç›®æ¨™**ï¼šå¯¦ç¾éŒ¯èª¤è¿½è¹¤å’Œå‘Šè­¦

#### æ•´åˆ Sentry

```python
# settings.py

import sentry_sdk
from sentry_sdk.integrations.django import DjangoIntegration

sentry_sdk.init(
    dsn="YOUR_SENTRY_DSN",
    integrations=[DjangoIntegration()],
    environment="production",
    traces_sample_rate=0.1,  # 10% çš„è«‹æ±‚è¿½è¹¤æ€§èƒ½
    send_default_pii=False,   # ä¸ç™¼é€å€‹äººä¿¡æ¯
    before_send=filter_sensitive_data  # éæ¿¾æ•æ„Ÿæ•¸æ“š
)

def filter_sensitive_data(event, hint):
    """éæ¿¾æ•æ„Ÿæ•¸æ“š"""
    # ç§»é™¤ä¿¡ç”¨å¡è™Ÿç­‰æ•æ„Ÿä¿¡æ¯
    if 'request' in event and 'data' in event['request']:
        data = event['request']['data']
        if 'card_number' in data:
            data['card_number'] = '****'
        if 'cvv' in data:
            data['cvv'] = '***'
    return event
```

#### æ²‰æ¾±ç¶“é©—

```bash
/memory save

ä¸»é¡Œï¼šéŒ¯èª¤è™•ç†èˆ‡ç•°å¸¸è¨­è¨ˆæœ€ä½³å¯¦è¸

æ ¸å¿ƒåŸå‰‡ï¼š
1. çµ•ä¸ä½¿ç”¨è£¸ except
   - å§‹çµ‚æŒ‡å®šå…·é«”ç•°å¸¸é¡å‹
   - æˆ–ä½¿ç”¨ except Exceptionï¼ˆä¸æ•ç² SystemExitï¼‰
   - è¨˜éŒ„ç•°å¸¸ä¸Šä¸‹æ–‡ï¼ˆexc_info=Trueï¼‰

2. è¨­è¨ˆæ¸…æ™°çš„ç•°å¸¸å±¤ç´š
   - æ¥­å‹™ç•°å¸¸ï¼ˆ400ï¼‰ï¼šç”¨æˆ¶éŒ¯èª¤ï¼Œå¯æ¢å¾©
   - æŠ€è¡“ç•°å¸¸ï¼ˆ500ï¼‰ï¼šç³»çµ±éŒ¯èª¤ï¼Œä¸å¯æ¢å¾©
   - è³‡æºç•°å¸¸ï¼ˆ404ï¼‰ï¼šè³‡æºæœªæ‰¾åˆ°
   - æ¬Šé™ç•°å¸¸ï¼ˆ403ï¼‰ï¼šæ¬Šé™ä¸è¶³

3. ç•°å¸¸ä¿¡æ¯åˆ†é›¢
   - é–‹ç™¼è€…ä¿¡æ¯ï¼šè©³ç´°çš„æŠ€è¡“ç´°ç¯€ï¼ˆæ—¥èªŒï¼‰
   - ç”¨æˆ¶ä¿¡æ¯ï¼šå‹å¥½çš„æç¤ºï¼ˆAPI éŸ¿æ‡‰ï¼‰
   - çµ•ä¸å‘ç”¨æˆ¶æš´éœ²æŠ€è¡“ç´°ç¯€

4. äº‹å‹™æ§åˆ¶
   - å¤šæ­¥é©Ÿæ“ä½œå¿…é ˆä½¿ç”¨ @transaction.atomic
   - æ¶‰åŠå¤šå€‹æ¨¡å‹æ›´æ–°çš„æ“ä½œ
   - ä½¿ç”¨ select_for_update() é˜²æ­¢ä½µç™¼
   - è€ƒæ…®å†ªç­‰æ€§è¨­è¨ˆ

5. çµæ§‹åŒ–æ—¥èªŒ
   - ä½¿ç”¨ JSON æ ¼å¼
   - åŒ…å«ä¸Šä¸‹æ–‡ï¼šuser_id, order_id, request_id
   - è¨˜éŒ„å †ç–Šä¿¡æ¯ï¼šexc_info=True
   - å€åˆ†éŒ¯èª¤ç´šåˆ¥ï¼šerror, warning, info

æŸ¥æ‰¾æ¨¡å¼ï¼š
- è£¸ exceptï¼š/grep "except:" --type py -C 3
- è¿”å›å€¼ä¸ä¸€è‡´ï¼š/grep "return None\|return True" --type py
- ç¼ºå°‘äº‹å‹™ï¼š/grep "\.save\(\)" --type py -C 5
- éŒ¯èª¤æ—¥èªŒï¼š/grep "print\|logger\.error" --type py

ç•°å¸¸è¨­è¨ˆæ¨¡å¼ï¼š
```python
class AppException(Exception):
    error_code: str
    user_message: str
    status_code: int
    details: dict
```

äº‹å‹™æ¨¡å¼ï¼š
```python
from django.db import transaction

@transaction.atomic
def multi_step_operation():
    # Step 1
    # Step 2
    # Step 3
    # ä»»ä½•ç•°å¸¸è‡ªå‹•å›æ»¾
```

æ—¥èªŒæ¨¡å¼ï¼š
```python
logger.error(
    "Operation failed",
    exc_info=True,
    extra={
        'user_id': user_id,
        'operation': 'payment',
        'context': {...}
    }
)
```

éŒ¯èª¤éŸ¿æ‡‰æ ¼å¼ï¼š
```json
{
  "error_code": "PAYMENT_FAILED",
  "message": "æ”¯ä»˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ”¯ä»˜ä¿¡æ¯",
  "details": {"field": "card_number"}
}
```

ç›£æ§å·¥å…·ï¼šSentry, Datadog, ELK Stack
ç›¸é—œæŒ‡ä»¤ï¼š/grepï¼ˆæŸ¥æ‰¾éŒ¯èª¤è™•ç†å•é¡Œï¼‰ï¼Œ/readï¼ˆç†è§£ç•°å¸¸æµç¨‹ï¼‰
```

**æª¢æŸ¥é»**ï¼š
- [ ] æ•´åˆäº† Sentry
- [ ] æ²‰æ¾±äº†ç¶“é©—åˆ° /memory
- [ ] å»ºç«‹äº†éŒ¯èª¤è™•ç†æª¢æŸ¥æ¸…å–®

---

## é©—è­‰æ¨™æº–

### å¿…é ˆé”æˆ âœ…

- [ ] æ›¿æ›äº†æ‰€æœ‰è£¸ except
- [ ] è¨­è¨ˆäº†ç•°å¸¸é¡å±¤ç´šï¼ˆè‡³å°‘ 3 å±¤ï¼‰
- [ ] ç‚ºé—œéµæ“ä½œæ·»åŠ äº†äº‹å‹™æ§åˆ¶
- [ ] å¯¦ç¾äº†çµ±ä¸€çš„éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
- [ ] å»ºç«‹äº†çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„
- [ ] æ•´åˆäº†éŒ¯èª¤ç›£æ§ï¼ˆSentryï¼‰
- [ ] ä½¿ç”¨ /memory æ²‰æ¾±äº†ç¶“é©—

### é¡å¤–æˆå°± ğŸŒŸ

- [ ] å¯¦ç¾äº†éŒ¯èª¤é‡è©¦æ©Ÿåˆ¶
- [ ] è¨­è¨ˆäº†è£œå„Ÿäº‹å‹™ï¼ˆSagaï¼‰
- [ ] å»ºç«‹äº†éŒ¯èª¤çµ±è¨ˆå’Œåˆ†æ
- [ ] ç·¨å¯«äº†éŒ¯èª¤è™•ç†æ–‡æª”
- [ ] å¯¦ç¾äº†å‘Šè­¦ç³»çµ±ï¼ˆé‡˜é‡˜/Slackï¼‰
- [ ] æ‰€æœ‰ API è¿”å›çµ±ä¸€çš„éŒ¯èª¤æ ¼å¼

---

## å­¸ç¿’åæ€

### åæ€å•é¡Œ

1. **è£¸ except çš„å±å®³**ï¼š
   - ç‚ºä»€éº¼çµ•ä¸èƒ½ä½¿ç”¨è£¸ exceptï¼Ÿ
   - å¯èƒ½éš±è—å“ªäº›é—œéµç•°å¸¸ï¼Ÿ
   - å¦‚ä½•æ­£ç¢ºæ•ç²ç•°å¸¸ï¼Ÿ

2. **äº‹å‹™çš„é‡è¦æ€§**ï¼š
   - ä»€éº¼æ™‚å€™éœ€è¦äº‹å‹™ï¼Ÿ
   - @transaction.atomic çš„å·¥ä½œåŸç†ï¼Ÿ
   - å¦‚ä½•è™•ç†åˆ†ä½ˆå¼äº‹å‹™ï¼Ÿ

3. **éŒ¯èª¤ä¿¡æ¯è¨­è¨ˆ**ï¼š
   - å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œå¯ç”¨æ€§ï¼Ÿ
   - ç”¨æˆ¶æ¶ˆæ¯å’Œé–‹ç™¼è€…æ¶ˆæ¯çš„å€åˆ¥ï¼Ÿ
   - å¦‚ä½•é¿å…ä¿¡æ¯æ´©æ¼ï¼Ÿ

4. **ç›£æ§èˆ‡å‘Šè­¦**ï¼š
   - Sentry å¦‚ä½•å¹«åŠ©å®šä½å•é¡Œï¼Ÿ
   - å¦‚ä½•è¨­ç½®åˆç†çš„å‘Šè­¦é–¾å€¼ï¼Ÿ
   - éŒ¯èª¤èšåˆçš„åƒ¹å€¼æ˜¯ä»€éº¼ï¼Ÿ

### å»¶ä¼¸ç·´ç¿’

1. **å¯¦ç¾é‡è©¦æ©Ÿåˆ¶**ï¼š
   - å°ç¶²çµ¡éŒ¯èª¤è‡ªå‹•é‡è©¦
   - æŒ‡æ•¸é€€é¿ç­–ç•¥
   - æœ€å¤§é‡è©¦æ¬¡æ•¸

2. **å¯¦ç¾ç†”æ–·å™¨æ¨¡å¼**ï¼š
   - ç•¶ç¬¬ä¸‰æ–¹æœå‹™ä¸å¯ç”¨æ™‚è‡ªå‹•ç†”æ–·
   - é¿å…é›ªå´©æ•ˆæ‡‰
   - è‡ªå‹•æ¢å¾©

3. **å¯¦ç¾ Saga æ¨¡å¼**ï¼š
   - é•·äº‹å‹™çš„è£œå„Ÿæ©Ÿåˆ¶
   - åˆ†ä½ˆå¼äº‹å‹™ä¸€è‡´æ€§
   - ç‹€æ…‹æ©Ÿè¨­è¨ˆ

---

## ç›¸é—œè³‡æº

### ä¸‹ä¸€æ­¥å­¸ç¿’

- **æ¨¡çµ„ 3**ï¼šTDD/BDD - æ¸¬è©¦é©…å‹•é–‹ç™¼
- **æ¨¡çµ„ 4**ï¼šåˆ†ä½ˆå¼ç³»çµ± - åˆ†ä½ˆå¼äº‹å‹™
- **æ¨¡çµ„ 5**ï¼šå¯è§€æ¸¬æ€§ - æ—¥èªŒã€ç›£æ§ã€è¿½è¹¤

### å·¥å…·åƒè€ƒ

- **Sentry**ï¼šéŒ¯èª¤è¿½è¹¤å’Œç›£æ§
- **ELK Stack**ï¼šæ—¥èªŒèšåˆåˆ†æ
- **Datadog**ï¼šæ‡‰ç”¨æ€§èƒ½ç›£æ§
- **PagerDuty**ï¼šå‘Šè­¦å’Œäº‹ä»¶ç®¡ç†

### å­¸ç¿’è³‡æº

- **ã€ŠEffective Pythonã€‹** - Exception Handling
- **Django æ–‡æª”** - Database Transactions
- **ã€ŠRelease It!ã€‹** - Stability Patterns
- **Sentry æœ€ä½³å¯¦è¸**

---

**å»ºè­°å®Œæˆæ™‚é–“**ï¼š1.5-2 å°æ™‚
**é›£åº¦è©•ä¼°**ï¼š3.5/5
**é‡è¦åº¦**ï¼š5/5ï¼ˆéŒ¯èª¤è™•ç†æ˜¯ç³»çµ±å¥å£¯æ€§çš„åŸºç¤ï¼‰
**å¯è¤‡ç”¨æ€§**ï¼š5/5ï¼ˆç•°å¸¸è¨­è¨ˆå¯æ‡‰ç”¨åˆ°ä»»ä½•é …ç›®ï¼‰
