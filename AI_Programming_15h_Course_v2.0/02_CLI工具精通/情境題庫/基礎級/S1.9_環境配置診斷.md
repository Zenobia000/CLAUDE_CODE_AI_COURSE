# S1.9：環境配置診斷

## 📋 情境資訊

- **難度**：⭐
- **預估時間**：30 分鐘
- **核心學習**：`/doctor` 指令、環境診斷、問題排查
- **前置知識**：Claude Code 基本操作、系統環境概念

---

## 🎯 情境背景

你剛換了一台新電腦，重新安裝了 Claude Code 和開發環境。雖然基本安裝完成了，但在使用過程中遇到了一些奇怪的問題：有時候回應很慢，有些指令似乎不太正常，API 調用偶爾會失敗。你懷疑可能是環境配置有問題，決定使用 Claude Code 的診斷功能來全面檢查和解決這些問題。

**遇到的問題**:
- Claude Code 回應時間不穩定，有時很慢
- `/bash` 指令偶爾執行失敗
- API 調用間歇性錯誤
- 檔案讀取權限問題
- 記憶體使用量異常高
- 網路連線不穩定

**環境資訊**:
- 作業系統：macOS 14.0 / Windows 11 / Ubuntu 22.04
- Claude Code 剛安裝完成
- 多個 Python 版本共存
- 使用公司 VPN 和防火牆
- 磁碟空間充足但可能有權限問題

**你的任務**:
1. 使用診斷工具全面檢查環境
2. 識別配置問題和效能瓶頸
3. 解決發現的問題
4. 優化 Claude Code 效能
5. 建立環境監控和維護機制

---

## 🎓 學習目標

完成本情境後，你將能夠：

- ✅ 熟練使用 `/doctor` 等診斷指令
- ✅ 系統性排查 Claude Code 環境問題
- ✅ 理解常見配置問題及解決方法
- ✅ 優化 Claude Code 的執行效能
- ✅ 建立環境健康監控機制
- ✅ 預防和快速修復環境問題

---

## 📝 任務描述

### 階段 1: 環境診斷與問題發現 (8 分鐘)

#### 任務 1.1: 執行全面診斷

**Linux 類比**: 像使用 `top`, `df`, `ps` 檢查系統狀態，但 `/doctor` 提供 Claude Code 專用的診斷。

```bash
# 1. 啟動 Claude Code
claude
```

**全面診斷對話**:
```
我的 Claude Code 環境似乎有些問題，請幫我進行全面診斷。

/doctor

請詳細說明診斷結果中的每個項目：
1. 系統環境檢查結果
2. API 連線狀態
3. 效能指標
4. 配置問題
5. 潛在風險

對於任何異常項目，請說明：
- 問題的具體影響
- 可能的原因
- 建議的解決方法
```

#### 任務 1.2: 系統資源檢查

```
請幫我檢查系統資源使用情況：

/bash ps aux | grep claude
/bash df -h
/bash free -m  # Linux
/bash top -l 1 | grep "CPU usage"  # macOS

分析：
1. Claude Code 的記憶體使用是否正常？
2. 磁碟空間是否充足？
3. CPU 使用率是否合理？
4. 是否有其他程序干擾？

請提供資源優化建議。
```

#### 任務 1.3: 網路連線診斷

```
請檢查網路連線和 API 存取：

/bash ping -c 3 api.anthropic.com
/bash nslookup api.anthropic.com
/bash curl -I https://api.anthropic.com

檢查：
1. 網路連線是否穩定？
2. DNS 解析是否正常？
3. API 端點是否可達？
4. 是否有防火牆或代理問題？
5. SSL 憑證是否有效？

如果發現問題，請提供解決方案。
```

**檢查點 1**:
- [ ] 完成全面環境診斷
- [ ] 檢查系統資源使用狀況
- [ ] 驗證網路連線和 API 存取

---

### 階段 2: 配置問題排查與修復 (10 分鐘)

#### 任務 2.1: API Key 和認證檢查

```
請檢查 API Key 配置：

/bash echo $ANTHROPIC_API_KEY | head -c 20
/bash ls -la ~/.claude/
/bash cat ~/.claude/config.json  # 如果存在

驗證：
1. API Key 是否正確設定？
2. 配置檔案權限是否安全？
3. 環境變數是否正確載入？
4. 是否有配置衝突？

如果發現問題，請提供修復步驟。
```

#### 任務 2.2: 權限和路徑問題檢查

```
請檢查檔案權限和路徑配置：

/bash whoami
/bash pwd
/bash ls -la . | head -10
/bash which claude

檢查項目：
1. 當前用戶權限是否足夠？
2. 工作目錄是否有讀寫權限？
3. Claude Code 執行路徑是否正確？
4. 是否有路徑衝突？

請修復發現的權限問題。
```

#### 任務 2.3: Python 環境檢查

```
請檢查 Python 環境配置：

/bash python --version
/bash python3 --version
/bash which python
/bash pip list | grep -E "(anthropic|claude)"

分析：
1. Python 版本是否相容？
2. 是否有多個 Python 版本衝突？
3. 相關套件是否正確安裝？
4. 虛擬環境是否正確設定？

請解決 Python 環境問題。
```

**檢查點 2**:
- [ ] 修復 API Key 和認證問題
- [ ] 解決權限和路徑問題
- [ ] 修復 Python 環境配置

---

### 階段 3: 效能優化與調整 (8 分鐘)

#### 任務 3.1: 記憶體和效能優化

```
請幫我優化 Claude Code 的效能：

基於診斷結果，請提供：
1. 記憶體使用優化建議
2. 回應速度改善方法
3. 快取配置優化
4. 同時連線數調整
5. 超時設定優化

請提供具體的配置調整指令。
```

#### 任務 3.2: 網路和代理優化

```
請優化網路配置：

如果使用公司網路，請幫我配置：
1. HTTP/HTTPS 代理設定
2. DNS 伺服器優化
3. 連線重試機制
4. 超時參數調整
5. SSL 憑證處理

提供對應的環境變數或配置檔案設定。
```

#### 任務 3.3: 快取和儲存優化

```
請優化快取和儲存配置：

/bash du -sh ~/.claude*
/bash df -h .

優化建議：
1. 快取目錄大小和清理策略
2. 暫存檔案管理
3. 日誌檔案輪轉
4. 配置檔案備份
5. 磁碟空間監控

請提供維護腳本範例。
```

**檢查點 3**:
- [ ] 完成記憶體和效能優化
- [ ] 配置網路和代理優化
- [ ] 設定快取和儲存優化

---

### 階段 4: 監控機制建立 (4 分鐘)

#### 任務 4.1: 建立健康檢查腳本

```
請建立 Claude Code 環境健康檢查腳本：

腳本功能：
1. 檢查 API 連線狀態
2. 驗證配置檔案完整性
3. 監控資源使用情況
4. 檢查權限和路徑
5. 記錄檢查結果

請提供可執行的 bash 腳本範例：

```bash
#!/bin/bash
# claude-health-check.sh

echo "Claude Code 環境健康檢查"
echo "========================"

# 檢查項目...
```
```

#### 任務 4.2: 建立問題排查指南

```
請建立常見問題的快速排查指南：

格式：
```markdown
# Claude Code 問題排查指南

## 常見問題清單

### 問題1：回應速度慢
**症狀**：...
**可能原因**：...
**解決步驟**：...

### 問題2：API 調用失敗
**症狀**：...
**可能原因**：...
**解決步驟**：...

...
```

請涵蓋今天遇到的所有問題類型。
```

#### 任務 4.3: 設定定期維護

```
請設計定期維護計劃：

包含：
1. **每日檢查**：API 連線、基本功能
2. **每週檢查**：效能指標、快取清理
3. **每月檢查**：配置更新、安全檢查
4. **年度檢查**：全面環境重新設定

提供：
- crontab 設定範例
- 維護檢查清單
- 緊急問題處理流程
```

**最終檢查點**:
- [ ] 建立環境健康檢查機制
- [ ] 建立問題排查指南
- [ ] 設定定期維護計劃

---

## ✅ 檢查點

### 基礎檢查點 (必須完成)

- [ ] **診斷執行**: 成功使用 `/doctor` 進行全面診斷
- [ ] **問題識別**: 準確識別環境配置問題
- [ ] **問題修復**: 解決主要的配置和效能問題
- [ ] **功能驗證**: 確認 Claude Code 正常運作
- [ ] **效能改善**: 明顯提升回應速度和穩定性

### 進階檢查點 (建議完成)

- [ ] **監控建立**: 建立持續的環境監控機制
- [ ] **預防措施**: 設定問題預防和早期發現
- [ ] **文檔完善**: 建立完整的排查和維護文檔
- [ ] **自動化**: 實現部分診斷和修復的自動化
- [ ] **團隊分享**: 建立團隊共用的環境最佳實踐

---

## 🎯 自然學到的指令

通過本情境，你應該自然學會以下指令和診斷技巧：

### 診斷指令

| 指令 | 用途 | 何時使用 |
|------|------|----------|
| `/doctor` | 全面環境診斷 | 遇到不明問題時 |
| `/doctor --verbose` | 詳細診斷報告 | 需要深入分析時 |
| `/doctor --fix` | 自動修復問題 | 發現可修復問題時 |
| `/bash ps aux \| grep claude` | 檢查程序狀態 | 效能問題排查 |

### 系統檢查組合

| 檢查類型 | 指令組合 | 目標 |
|----------|----------|------|
| **資源使用** | `ps`, `top`, `free`, `df` | 系統負載分析 |
| **網路連線** | `ping`, `curl`, `nslookup` | 連線問題診斷 |
| **檔案權限** | `ls -la`, `whoami`, `chmod` | 權限問題修復 |
| **環境變數** | `echo $VAR`, `env`, `export` | 配置檢查設定 |

### 問題排查流程

**流程 1: 系統性診斷**
```
/doctor → 系統檢查 → 網路檢查 → 配置檢查 → 問題定位
```

**流程 2: 效能問題排查**
```
資源監控 → 瓶頸識別 → 配置調整 → 效果驗證
```

**流程 3: 連線問題排查**
```
基本連線 → DNS 解析 → 代理設定 → API 測試
```

---

## ❓ 常見問題

### Q1: `/doctor` 顯示多個問題，不知道先解決哪個

**優先級原則**: 按影響程度和修復難度排序

**解決方法**:
```
請幫我分析這些診斷問題的優先級：

[貼上 /doctor 的輸出]

請按照以下標準排序：
1. 影響基本功能的關鍵問題
2. 影響效能的重要問題
3. 安全相關問題
4. 未來可能導致問題的風險

為每個問題提供：修復難度、預估時間、修復步驟
```

---

### Q2: 修復一個問題後出現新問題

**回復策略**: 建立修復前的環境快照

**解決方法**:
```bash
# 修復前備份重要配置
cp ~/.claude/config.json ~/.claude/config.json.backup
env | grep ANTHROPIC > env_backup.txt

# 如果出現問題，回復到修復前狀態
cp ~/.claude/config.json.backup ~/.claude/config.json

# 然後請 Claude 幫助分析
請幫我分析為什麼修復 [問題A] 後出現了 [問題B]？
可能的關聯性是什麼？如何安全地修復？
```

---

### Q3: 診斷結果顯示正常但仍有問題

**深入診斷**: 使用更詳細的檢查方法

**解決方法**:
```
/doctor 顯示正常，但我仍遇到以下問題：
[具體描述問題和症狀]

請幫我進行更深入的診斷：
1. 檢查 Claude Code 的詳細日誌
2. 分析特定操作的執行過程
3. 檢查可能被忽略的配置項目
4. 測試邊界條件和特殊情況

請提供具體的深度檢查指令。
```

---

### Q4: 公司網路環境限制很多，如何配置

**企業環境配置**: 處理代理、防火牆、憑證問題

**解決方法**:
```
請幫我配置企業網路環境下的 Claude Code：

環境限制：
- 必須使用公司代理
- 防火牆限制特定端口
- 自簽名 SSL 憑證
- 無法修改系統設定

請提供：
1. 代理配置方法
2. 憑證信任設定
3. 防火牆穿透策略
4. 權限受限下的解決方案
```

---

## 🚀 延伸挑戰

### 挑戰 1: 自動化環境維護系統

**任務**: 建立完全自動化的 Claude Code 環境維護

**系統功能**:
- 定期健康檢查
- 自動問題修復
- 效能監控告警
- 配置自動更新

**實作範例**:
```bash
#!/bin/bash
# auto-maintenance.sh

# 每日健康檢查
run_daily_check() {
    if ! claude /doctor; then
        send_alert "Claude Code 健康檢查失敗"
        attempt_auto_fix
    fi
}

# 自動修復
attempt_auto_fix() {
    # 嘗試常見修復操作
    restart_claude_service
    clear_cache
    reset_permissions
}

# 設定 crontab
# 0 9 * * * /path/to/auto-maintenance.sh
```

---

### 挑戰 2: 效能基準測試系統

**任務**: 建立 Claude Code 效能基準測試

**測試項目**:
- 回應時間測量
- 記憶體使用監控
- 並發處理能力
- 不同檔案大小的處理效能

**測試腳本範例**:
```python
import time
import psutil
import subprocess

class ClaudePerformanceTest:
    def test_response_time(self):
        """測試回應時間"""
        start = time.time()
        result = subprocess.run(['claude', '/doctor'], capture_output=True)
        end = time.time()

        return {
            'response_time': end - start,
            'success': result.returncode == 0
        }

    def test_memory_usage(self):
        """測試記憶體使用"""
        # 監控 Claude Code 程序的記憶體使用
        pass
```

---

### 挑戰 3: 團隊環境標準化

**任務**: 建立團隊統一的 Claude Code 環境標準

**標準化內容**:
- 標準配置模板
- 自動化安裝腳本
- 問題排查手冊
- 效能基準要求

**配置管理**:
```yaml
# claude-team-config.yml
team_standards:
  claude_version: ">=1.2.0"
  python_version: ">=3.8"
  memory_limit: "2GB"
  response_timeout: "30s"

required_checks:
  - api_connectivity
  - file_permissions
  - network_latency
  - resource_availability

auto_fixes:
  - clear_cache_if_full
  - restart_on_memory_leak
  - update_api_key_if_expired
```

---

## 📚 相關資源

### 診斷工具對照表

| 問題類型 | 診斷指令 | 系統工具對應 |
|----------|----------|--------------|
| **整體健康** | `/doctor` | `systemctl status` |
| **效能問題** | `ps aux \| grep claude` | `top`, `htop` |
| **網路問題** | `ping api.anthropic.com` | `netstat`, `ss` |
| **磁碟問題** | `df -h` | `du`, `lsof` |

### 課程資源

- **理論**: `2.8_環境診斷與維護.md`
- **下一步**: Module 2.5 進階指令整合應用

### 維護最佳實踐

| 維護類型 | 頻率 | 檢查項目 |
|----------|------|----------|
| **日常** | 每日 | API 連線、基本功能 |
| **定期** | 每週 | 效能指標、快取清理 |
| **深度** | 每月 | 配置檢查、安全更新 |
| **全面** | 每季 | 環境重新評估 |

---

## 📝 反思問題

完成情境後，思考以下問題：

1. **診斷效率**: `/doctor` 指令在問題排查中的價值如何？

2. **預防勝於治療**: 如何設計預防性維護策略？

3. **自動化程度**: 哪些診斷和修復工作可以自動化？

4. **團隊協作**: 如何讓團隊成員都能有效進行環境診斷？

5. **持續改善**: 如何建立環境問題的學習和改善機制？

---

**情境版本**: v1.0
**最後更新**: 2025-01-30
**預估完成率**: 85% 學員能在 30 分鐘內完成基本環境診斷
**常見卡點**: 網路配置問題 (20%), 權限設定 (15%)