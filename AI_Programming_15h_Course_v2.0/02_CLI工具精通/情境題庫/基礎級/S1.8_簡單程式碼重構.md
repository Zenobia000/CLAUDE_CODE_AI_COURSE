# S1.8：簡單程式碼重構

## 📋 情境資訊

- **難度**：⭐
- **預估時間**：45 分鐘
- **核心學習**：程式碼分析、重構建議、程式碼品質改善
- **前置知識**：Claude Code 基本操作、程式設計基礎概念

---

## 🎯 情境背景

你在整理個人專案時發現了一個幾個月前寫的 Python 腳本，這個腳本用來處理 CSV 檔案並生成報表。雖然功能正常，但程式碼寫得比較匆忙，存在許多可以改善的地方：函數過長、變數命名不清楚、邏輯重複、缺乏錯誤處理等。現在你想利用 Claude Code 來協助重構這個程式碼。

**程式碼現況**:
- 單一檔案約 150 行程式碼
- 主要功能：讀取 CSV、資料清洗、統計計算、生成報表
- 問題：函數過長、邏輯混雜、缺乏模組化
- 目標：提升可讀性、可維護性、可重複使用性

**典型問題程式碼範例**:
```python
def process_data(file_path):
    # 讀取資料
    import pandas as pd
    import numpy as np
    df = pd.read_csv(file_path)

    # 清洗資料
    df = df.dropna()
    df['date'] = pd.to_datetime(df['date'])
    df['amount'] = df['amount'].astype(float)

    # 計算統計
    total = df['amount'].sum()
    avg = df['amount'].mean()
    count = len(df)

    # 生成報表
    report = f"總計: {total}, 平均: {avg}, 筆數: {count}"

    # 儲存結果
    with open('report.txt', 'w') as f:
        f.write(report)

    return df, total, avg, count
```

**你的任務**:
1. 分析程式碼問題和改善機會
2. 設計更好的程式碼結構
3. 重構函數和改善命名
4. 增加錯誤處理和健壯性
5. 提升程式碼的可重複使用性

---

## 🎓 學習目標

完成本情境後，你將能夠：

- ✅ 使用 Claude Code 分析程式碼品質問題
- ✅ 學習程式碼重構的最佳實踐
- ✅ 改善函數設計和模組化
- ✅ 提升程式碼的可讀性和維護性
- ✅ 增加適當的錯誤處理機制
- ✅ 建立重構前後的對比和測試

---

## 📝 任務描述

### 階段 1: 程式碼分析與問題識別 (10 分鐘)

#### 任務 1.1: 程式碼問題分析

**Linux 類比**: 像使用程式碼檢查工具找出問題，但 Claude Code 提供更深入的分析。

假設問題程式碼位於 `~/projects/data-processor/processor.py`：

```bash
# 1. 進入專案目錄
cd ~/projects/data-processor/

# 2. 啟動 Claude Code
claude
```

**分析對話**:
```
我有一個需要重構的 Python 腳本，請幫我分析程式碼品質問題。

/read processor.py

請從以下角度分析：
1. 函數設計問題（長度、職責分離）
2. 變數命名和可讀性
3. 程式碼結構和組織
4. 錯誤處理和健壯性
5. 可重複使用性和擴展性
6. 效能和最佳實踐

請為每個問題提供具體的改善建議。
```

#### 任務 1.2: 重構優先級排序

```
基於分析結果，請幫我制定重構計劃：

請按照以下優先級排序改善項目：
1. **關鍵問題**：影響功能正確性的問題
2. **重要改善**：顯著提升可維護性的改善
3. **品質提升**：提升程式碼品質的優化
4. **未來優化**：為未來擴展準備的改善

為每個項目提供：
- 改善的具體內容
- 預估的工作量
- 改善後的預期效果
```

#### 任務 1.3: 設計目標架構

```
請為重構後的程式碼設計更好的架構：

考慮因素：
- 單一職責原則
- 函數和類別的合理分工
- 配置和參數管理
- 錯誤處理策略
- 可測試性

請提供：
1. 建議的模組結構
2. 主要類別和函數設計
3. 資料流向和處理流程
4. 配置檔案格式
```

**檢查點 1**:
- [ ] 識別出主要程式碼問題
- [ ] 制定重構優先級計劃
- [ ] 設計目標架構結構

---

### 階段 2: 函數重構與模組化 (15 分鐘)

#### 任務 2.1: 資料讀取函數重構

```
讓我們從資料讀取部分開始重構：

請重構資料讀取邏輯，改善：
1. 函數職責單一化
2. 參數彈性和配置
3. 錯誤處理和驗證
4. 回傳值的一致性

原始程式碼：
```python
# 現有的資料讀取邏輯
df = pd.read_csv(file_path)
df = df.dropna()
df['date'] = pd.to_datetime(df['date'])
```

請提供重構後的版本，包含：
- 專門的資料讀取函數
- 資料驗證機制
- 靈活的配置選項
- 適當的異常處理
```

#### 任務 2.2: 資料處理函數重構

```
請重構資料處理和統計計算部分：

改善目標：
1. 分離不同類型的處理邏輯
2. 建立可重複使用的計算函數
3. 支援不同的統計需求
4. 易於擴展新的計算功能

原始邏輯：
```python
# 清洗和統計計算
total = df['amount'].sum()
avg = df['amount'].mean()
count = len(df)
```

請提供：
- 資料清洗函數
- 統計計算函數
- 配置驅動的處理流程
- 可擴展的計算框架
```

#### 任務 2.3: 報表生成函數重構

```
請重構報表生成部分：

改善重點：
1. 支援多種輸出格式
2. 模板化報表內容
3. 靈活的檔案路徑管理
4. 錯誤處理和回滾機制

原始程式碼：
```python
# 簡單的報表生成
report = f"總計: {total}, 平均: {avg}, 筆數: {count}"
with open('report.txt', 'w') as f:
    f.write(report)
```

請設計：
- 通用的報表生成器
- 支援 TXT, CSV, JSON 等格式
- 模板系統
- 安全的檔案操作
```

**檢查點 2**:
- [ ] 重構資料讀取函數
- [ ] 重構資料處理邏輯
- [ ] 重構報表生成功能

---

### 階段 3: 結構重組與品質改善 (15 分鐘)

#### 任務 3.1: 建立主控制邏輯

```
請建立乾淨的主控制流程：

設計要求：
1. 清晰的處理步驟
2. 配置驅動的行為
3. 適當的錯誤處理
4. 日誌記錄機制

請建立：
- 主函數 (main) 設計
- 配置檔案結構
- 命令列參數處理
- 日誌和錯誤報告系統

格式範例：
```python
def main():
    """主程式入口點"""
    try:
        # 載入配置
        config = load_config()

        # 處理資料
        data = process_pipeline(config)

        # 生成報表
        generate_reports(data, config)

    except Exception as e:
        logger.error(f"處理失敗: {e}")
        raise
```
```

#### 任務 3.2: 增加配置管理

```
請建立靈活的配置管理系統：

配置內容：
1. 輸入檔案設定
2. 資料處理參數
3. 輸出格式選項
4. 日誌級別設定

請設計：
- YAML 或 JSON 配置檔案格式
- 配置驗證機制
- 預設值和覆蓋邏輯
- 環境變數支援

範例配置結構：
```yaml
input:
  file_path: "data.csv"
  encoding: "utf-8"

processing:
  drop_na: true
  date_format: "%Y-%m-%d"

output:
  formats: ["txt", "json"]
  directory: "reports/"
```
```

#### 任務 3.3: 建立測試友善的設計

```
請改善程式碼的可測試性：

考慮因素：
1. 純函數設計（輸入輸出明確）
2. 依賴注入（資料庫、檔案系統等）
3. 模擬友善的介面
4. 邊界條件處理

請提供：
- 可測試的函數簽名
- 測試資料準備方法
- 基本的單元測試範例
- 整合測試策略

範例測試設計：
```python
def test_data_processor():
    """測試資料處理函數"""
    # 準備測試資料
    test_data = create_test_dataframe()

    # 執行處理
    result = process_data(test_data)

    # 驗證結果
    assert result['total'] == 1000
    assert result['count'] == 10
```
```

**檢查點 3**:
- [ ] 建立清晰的主控制邏輯
- [ ] 建立靈活的配置系統
- [ ] 改善程式碼可測試性

---

### 階段 4: 最終整合與驗證 (5 分鐘)

#### 任務 4.1: 生成完整重構版本

```
請將所有改善整合成完整的重構版本：

輸出要求：
1. 重構後的完整程式碼
2. 配置檔案範例
3. 使用說明文件
4. 測試程式碼範例

確保：
- 程式碼結構清晰
- 函數職責單一
- 錯誤處理完善
- 文檔註解充分
- 易於維護和擴展
```

#### 任務 4.2: 重構對比和驗證

```
請生成重構前後的對比分析：

對比維度：
1. **程式碼行數**：重構前後的程式碼量變化
2. **函數數量**：函數分解和組織改善
3. **圈複雜度**：程式碼複雜度降低情況
4. **可讀性**：命名和結構改善
5. **可維護性**：未來修改的難易度
6. **功能完整性**：確保功能無損失

格式化為清楚的對比表格。
```

#### 任務 4.3: 建立遷移指南

```
請建立從舊版本到新版本的遷移指南：

內容包括：
1. **步驟化遷移流程**
2. **配置檔案設定**
3. **測試驗證方法**
4. **常見問題解決**
5. **回滾計劃**

幫助其他開發者順利採用重構後的版本。
```

**最終檢查點**:
- [ ] 完成完整的重構版本
- [ ] 生成詳細的對比分析
- [ ] 建立實用的遷移指南

---

## ✅ 檢查點

### 基礎檢查點 (必須完成)

- [ ] **問題識別**: 準確識別程式碼的主要問題
- [ ] **函數重構**: 成功分解長函數並改善職責分離
- [ ] **結構改善**: 建立更清晰的程式碼組織結構
- [ ] **功能保持**: 重構後功能完全保持一致
- [ ] **可讀性提升**: 程式碼明顯更易讀和理解

### 進階檢查點 (建議完成)

- [ ] **健壯性**: 增加適當的錯誤處理和邊界條件檢查
- [ ] **可擴展性**: 設計支援未來功能擴展
- [ ] **可測試性**: 程式碼易於編寫和執行測試
- [ ] **配置化**: 支援彈性的配置和參數調整
- [ ] **文檔化**: 建立完善的使用和維護文檔

---

## 🎯 自然學到的指令

通過本情境，你應該自然學會以下指令和概念：

### 程式碼分析指令

| 指令 | 用途 | 何時使用 |
|------|------|----------|
| `/read file.py` | 讀取待重構程式碼 | 分析現有程式碼結構 |
| `/grep "def \|class "` | 找出函數和類別 | 分析程式碼組織 |
| `/grep "TODO\|FIXME"` | 找出待改善項目 | 識別已知問題 |
| `/grep "import"` | 分析依賴關係 | 理解模組使用情況 |

### 重構分析模式

| 分析面向 | 關注重點 | 改善方向 |
|----------|----------|----------|
| **函數設計** | 長度、職責、參數 | 分解、單一職責 |
| **變數命名** | 可讀性、一致性 | 描述性命名 |
| **錯誤處理** | 異常捕獲、回復 | 健壯性提升 |
| **程式碼結構** | 組織、依賴關係 | 模組化設計 |

### 重構最佳實踐

**原則 1: 小步快跑**
```
1. 識別一個小問題
2. 進行單一改善
3. 測試驗證功能
4. 提交版本控制
5. 繼續下一個改善
```

**原則 2: 功能保持**
```
# 重構前後行為一致
原始功能 → 重構 → 相同結果
```

**原則 3: 測試驅動**
```
編寫測試 → 執行重構 → 驗證測試通過
```

---

## ❓ 常見問題

### Q1: 重構範圍太大，不知道從哪裡開始

**策略**: 從最簡單和風險最低的改善開始

**解決方法**:
```
請幫我確定重構的起始點：

1. 哪些改善風險最低？
2. 哪些改善效果最明顯？
3. 如何確保每步改善都是安全的？
4. 建議的重構順序是什麼？

請提供具體的步驟化建議。
```

---

### Q2: 重構後程式碼變得更複雜了

**原因**: 過度設計或架構不適合問題規模

**解決方法**:
```
請評估我的重構是否合適：

[提供重構後程式碼]

請檢查：
1. 是否存在過度設計？
2. 複雜度是否與問題規模匹配？
3. 如何簡化設計但保持優點？
4. 哪些部分可以進一步簡化？
```

---

### Q3: 如何確保重構不破壞現有功能

**策略**: 建立完整的測試和驗證機制

**解決方法**:
```
請幫我建立重構安全網：

1. 如何為現有程式碼建立測試？
2. 重構過程中如何持續驗證？
3. 如何設計回歸測試？
4. 出現問題時如何快速回復？

請提供具體的安全措施。
```

---

### Q4: 團隊其他成員不熟悉重構後的程式碼

**解決策略**: 建立知識轉移和文檔計劃

**解決方法**:
```
請幫我設計重構後的知識轉移計劃：

1. 如何寫出清楚的架構文檔？
2. 需要什麼樣的程式碼註解？
3. 如何設計程式碼演示和培訓？
4. 怎樣讓團隊逐步熟悉新結構？
```

---

## 🚀 延伸挑戰

### 挑戰 1: 自動化重構工具

**任務**: 建立可重複使用的程式碼重構檢查和建議工具

**功能特色**:
- 靜態程式碼分析
- 重構建議生成
- 風險評估
- 自動化測試生成

**實作範例**:
```python
class CodeRefactorAnalyzer:
    """程式碼重構分析器"""

    def analyze_file(self, file_path):
        """分析檔案並生成重構建議"""
        issues = []

        # 檢查函數長度
        if self.check_function_length():
            issues.append("Functions too long")

        # 檢查複雜度
        if self.check_complexity():
            issues.append("High complexity")

        return self.generate_suggestions(issues)
```

---

### 挑戰 2: 重構模式庫

**任務**: 建立常見重構模式的範例庫

**模式分類**:
- 函數提取模式
- 類別分解模式
- 設計模式應用
- 資料結構優化

**範例格式**:
```markdown
## 重構模式：長函數分解

### 問題描述
函數超過 50 行，職責不明確

### 重構前
```python
def process_everything():
    # 100 lines of mixed logic
```

### 重構後
```python
def load_data(): ...
def process_data(): ...
def save_results(): ...
```

### 適用情況
- 函數長度 > 30 行
- 包含多個邏輯區塊
- 難以測試和維護
```

---

### 挑戰 3: 重構影響分析

**任務**: 建立重構對系統影響的分析工具

**分析維度**:
- 效能影響評估
- 記憶體使用變化
- 依賴關係影響
- 向後相容性

**分析報告範例**:
```
重構影響分析報告

效能變化：
- 執行時間：改善 15%
- 記憶體使用：減少 8%

相容性：
- API 介面：無變化
- 配置格式：需要遷移

風險評估：
- 低風險：核心邏輯不變
- 中風險：配置檔案格式變更
```

---

## 📚 相關資源

### 重構原則和模式

| 重構類型 | 常見模式 | 使用時機 |
|----------|----------|----------|
| **函數重構** | 提取函數、分解長函數 | 函數過長、職責不清 |
| **類別重構** | 提取類別、分解大類 | 類別職責過多 |
| **資料重構** | 封裝欄位、提取資料類 | 資料結構混亂 |
| **演算法重構** | 替換演算法、優化邏輯 | 效能問題、邏輯複雜 |

### 課程資源

- **理論**: `2.7_程式碼重構與優化.md`
- **下一步**: `S1.9_環境配置診斷.md`

### 重構工具

| 工具 | 語言 | 功能 |
|------|------|------|
| **Black** | Python | 程式碼格式化 |
| **Pylint** | Python | 程式碼品質檢查 |
| **Rope** | Python | 重構工具 |
| **SonarQube** | 多語言 | 程式碼品質分析 |

---

## 📝 反思問題

完成情境後，思考以下問題：

1. **重構價值**: 這次重構帶來的主要改善是什麼？

2. **學習收穫**: 你學到了哪些重構的原則和技巧？

3. **工具效果**: Claude Code 在重構過程中最有幫助的地方是什麼？

4. **未來應用**: 如何將這些重構經驗應用到其他專案？

5. **團隊推廣**: 如何在團隊中推廣良好的重構實踐？

---

**情境版本**: v1.0
**最後更新**: 2025-01-30
**預估完成率**: 80% 學員能在 45 分鐘內完成基本重構
**常見卡點**: 架構設計 (25%), 測試設計 (20%)