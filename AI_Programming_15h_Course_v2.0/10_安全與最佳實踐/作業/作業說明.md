# 模組 10 作業：安全與最佳實踐

> **作業目標**: 建立完整的安全防護體系，並通過實戰演練驗證安全意識

---

## 作業概述

**完成時間**: 2-3 小時
**難度等級**: ⭐⭐⭐ (中等)
**前置要求**: 完成模組 10 理論學習與情境題庫

---

## 作業 #1: 安全工具鏈設置 (1 小時)

### 目標

在你的專案中建立完整的自動化安全檢查工具鏈

### 任務

#### Task 1.1: 設置 git-secrets (15 分鐘)

```bash
# 1. 安裝 git-secrets
# macOS: brew install git-secrets
# Linux: 參考 https://github.com/awslabs/git-secrets

# 2. 在專案中啟用
cd your-project
git secrets --install

# 3. 註冊常見憑證模式
git secrets --register-aws
git secrets --add 'sk-[a-zA-Z0-9]{32,}'  # OpenAI
git secrets --add 'ghp_[a-zA-Z0-9]{36}'  # GitHub PAT

# 4. 掃描現有倉庫
git secrets --scan-history
```

**交付物**: 截圖顯示 `git secrets --scan-history` 的執行結果

---

#### Task 1.2: 設置 pre-commit hooks (20 分鐘)

```bash
# 1. 安裝 pre-commit
pip install pre-commit detect-secrets bandit

# 2. 創建 .pre-commit-config.yaml
# 參考: 學習資源/工具整合實戰.md

# 3. 安裝 hooks
pre-commit install

# 4. 執行檢查
pre-commit run --all-files
```

**交付物**:
- `.pre-commit-config.yaml` 檔案
- 執行 `pre-commit run --all-files` 的截圖

---

#### Task 1.3: 設置 Semgrep (15 分鐘)

```bash
# 1. 安裝 Semgrep
pip install semgrep

# 2. 創建自定義規則
# 創建 .semgrep.yml 包含至少 3 個安全規則

# 3. 執行掃描
semgrep --config .semgrep.yml .
semgrep --config "p/owasp-top-ten" .
```

**交付物**:
- `.semgrep.yml` 檔案 (至少 3 個規則)
- Semgrep 掃描報告截圖

---

#### Task 1.4: 測試防護有效性 (10 分鐘)

創建測試文件驗證工具是否能攔截：

```python
# test_security.py
# 應該被工具攔截的代碼

# Test 1: 硬編碼憑證
api_key = "sk-proj-test123456789..."

# Test 2: SQL 注入
def unsafe_query(user_input):
    return f"SELECT * FROM users WHERE name = '{user_input}'"

# Test 3: 路徑遍歷
def unsafe_file(filename):
    return open(f"/uploads/{filename}", 'r')
```

嘗試 commit 這個文件，應該被阻止。

**交付物**: 截圖顯示 commit 被阻止的錯誤訊息

---

## 作業 #2: 代碼安全審查 (45 分鐘)

### 目標

審查一段 AI 生成的代碼，識別並修復所有安全漏洞

### 待審查代碼

```python
# app.py - Flask API (AI 生成)
from flask import Flask, request, send_file
import sqlite3
import pickle

app = Flask(__name__)

# Database configuration
DB_CONFIG = "postgresql://admin:Admin123@10.0.1.5:5432/production"

# OpenAI API key
API_KEY = "sk-proj-abc123def456789ghijklmnop"

@app.route('/search')
def search():
    keyword = request.args.get('q')
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    query = f"SELECT * FROM users WHERE name LIKE '%{keyword}%'"
    results = cursor.execute(query).fetchall()
    conn.close()
    return {'results': results}

@app.route('/download/<path:filename>')
def download(filename):
    file_path = f"/var/uploads/{filename}"
    return send_file(file_path, as_attachment=True)

@app.route('/load_config', methods=['POST'])
def load_config():
    data = request.data
    config = pickle.loads(data)
    return {'config': config}

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=80)
```

### 任務

#### Task 2.1: 識別安全漏洞 (15 分鐘)

列出這段代碼中的所有安全問題 (至少 7 個)

**交付格式**:
```markdown
## 安全漏洞清單

1. **硬編碼憑證**
   - 位置: 第 7 行
   - 問題: 資料庫密碼硬編碼
   - 風險等級: 高

2. ...
```

---

#### Task 2.2: 修復代碼 (20 分鐘)

創建 `app_secure.py`，修復所有安全問題

**必須修復的問題**:
- 硬編碼憑證 → 環境變數
- SQL 注入 → 參數化查詢
- 路徑遍歷 → pathlib 驗證
- 不安全反序列化 → 使用 JSON
- Debug 模式 → 關閉
- 監聽所有介面 → 限制監聽
- 使用特權端口 → 改用非特權端口

---

#### Task 2.3: 撰寫安全審查報告 (10 分鐘)

**交付格式**:
```markdown
## 代碼安全審查報告

**審查日期**: YYYY-MM-DD
**審查者**: [Your Name]

### 發現的問題

#### 高風險 (Critical)
- [ ] 硬編碼資料庫憑證
- [ ] SQL 注入漏洞
- ...

#### 中風險 (High)
- [ ] 路徑遍歷漏洞
- ...

#### 低風險 (Medium)
- [ ] Debug 模式開啟
- ...

### 修復建議

[詳細說明每個問題的修復方法]

### 修復後驗證

- [ ] 所有 API 功能正常運作
- [ ] Semgrep 掃描通過
- [ ] Bandit 掃描通過
```

---

## 作業 #3: 應急演練 (30 分鐘)

### 目標

模擬 API key 洩漏事件，演練完整應急處理流程

### 任務

#### Task 3.1: 創建洩漏場景 (5 分鐘)

```bash
# 1. 創建包含 "API key" 的測試文件
echo 'API_KEY = "sk-test-fake-key-for-drill-12345678901234567890"' > leaked.py

# 2. Commit 到 Git
git add leaked.py
git commit -m "Add API integration (INTENTIONAL LEAK FOR DRILL)"

# 3. 不要推送到遠程！這只是演練
```

---

#### Task 3.2: 執行應急處理 (20 分鐘)

按照「學習資源/應急處理手冊.md」的 15 分鐘流程執行：

1. **撤銷 key** (模擬)
   - 記錄你會訪問哪個服務的 dashboard
   - 截圖說明撤銷步驟

2. **生成新 key** (模擬)
   - 說明如何安全存放新 key

3. **更新配置** (實際操作)
   - 創建 `.env` 文件存放 key
   - 更新代碼使用 `os.getenv()`

4. **清理 Git 歷史** (實際操作)
   ```bash
   # 使用 BFG 或 git filter-branch 移除 leaked.py
   git filter-branch --force --index-filter \
     "git rm --cached --ignore-unmatch leaked.py" \
     --prune-empty --tag-name-filter cat -- --all
   ```

---

#### Task 3.3: 撰寫事件報告 (5 分鐘)

**交付格式**:
```markdown
## 洩漏事件應急演練報告

**演練日期**: YYYY-MM-DD
**總耗時**: [X] 分鐘

### 時間軸

- 00:00 - 發現洩漏
- 00:02 - 撤銷 key (模擬)
- 00:05 - 生成新 key (模擬)
- 00:10 - 更新配置完成
- 00:15 - Git 歷史清理完成

### 學到的教訓

[你從這次演練中學到什麼？]

### 改進建議

[如何避免未來發生真實洩漏？]
```

---

## 作業 #4: 建立團隊安全規範 (15 分鐘)

### 目標

為你的團隊創建一份簡潔實用的安全 Checklist

### 任務

創建 `SECURITY_CHECKLIST.md`，包含：

1. **開發階段** - commit 前必做的 3 件事
2. **Code Review** - 審查時必問的 5 個問題
3. **部署前** - 上線前必查的項目
4. **緊急聯絡** - 安全事件聯絡人清單

**範本**:
參考「學習資源/安全檢查Checklist.md」調整為你團隊適用的版本

---

## 交付清單

### 必交項目

- [ ] **作業 #1**:
  - [ ] git-secrets 執行截圖
  - [ ] `.pre-commit-config.yaml` 檔案
  - [ ] `.semgrep.yml` 檔案
  - [ ] 工具攔截測試截圖

- [ ] **作業 #2**:
  - [ ] 安全漏洞清單
  - [ ] `app_secure.py` (修復後的代碼)
  - [ ] 安全審查報告

- [ ] **作業 #3**:
  - [ ] 應急演練報告
  - [ ] Git 歷史清理截圖

- [ ] **作業 #4**:
  - [ ] `SECURITY_CHECKLIST.md`

---

## 評分標準

| 項目 | 配分 | 評分標準 |
|------|------|----------|
| **工具設置** | 30% | 所有工具正確安裝並能攔截測試 |
| **代碼審查** | 35% | 識別 7+ 個漏洞，修復代碼通過掃描 |
| **應急演練** | 25% | 完整執行流程，報告詳實 |
| **團隊規範** | 10% | Checklist 實用且符合團隊需求 |

---

## 加分項

- [ ] 設置 CI/CD 自動安全掃描 (GitHub Actions / GitLab CI)
- [ ] 使用 Snyk 或其他 SaaS 工具掃描依賴漏洞
- [ ] 創建 pre-push hook 進行額外檢查
- [ ] 撰寫團隊安全培訓簡報 (5-10 分鐘)

---

## 參考資源

- **理論**: `理論/10.1_AI生成代碼安全風險.md`, `理論/10.2_隱私與合規實踐.md`
- **工具**: `學習資源/工具整合實戰.md`
- **應急**: `學習資源/應急處理手冊.md`
- **範例**: `情境題庫/` 所有情境

---

## 提交方式

1. 創建 `module10_submission/` 目錄
2. 將所有交付物放入該目錄
3. 創建 `README.md` 說明各檔案用途
4. 壓縮為 `module10_[你的名字].zip`

---

**記住**：

> **「這不只是作業，而是建立終身受用的安全習慣」**

完成這份作業後，你將擁有一套完整的安全防護體系。
