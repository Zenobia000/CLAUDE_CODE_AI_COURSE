# 🚨 安全事件應急模板

> **使用時機**: 發現憑證洩漏、敏感資訊洩露時
>
> **目標**: 在最短時間內控制損害,防止進一步洩漏
>
> **重要**: 時間就是金錢,每一秒都很關鍵

---

## ⏱️ 時間線參考

```
0-5 分鐘:   撤銷憑證 (最高優先)
5-15 分鐘:  評估影響範圍
15-60 分鐘: 清理 Git 歷史
1-24 小時:  建立防護機制
```

---

## 🔴 第一階段: 立即行動 (0-5 分鐘)

### ✅ 任務 1: 撤銷洩漏的憑證

**目標**: 讓洩漏的憑證失效

#### AWS Credentials

```bash
# 1. 列出 access keys
aws iam list-access-keys --user-name USERNAME

# 2. 停用洩漏的 key
aws iam update-access-key \
    --access-key-id AKIA... \
    --status Inactive \
    --user-name USERNAME

# 3. 刪除 key
aws iam delete-access-key \
    --access-key-id AKIA... \
    --user-name USERNAME

# 4. 檢查是否有異常活動
aws cloudtrail lookup-events \
    --lookup-attributes AttributeKey=Username,AttributeValue=USERNAME \
    --max-results 50
```

---

#### GitHub Personal Access Token

```bash
# 方法 1: 透過 Web UI
# 1. 前往 https://github.com/settings/tokens
# 2. 找到洩漏的 token
# 3. 點擊 "Delete"

# 方法 2: 透過 API
gh api -X DELETE /user/tokens/{token_id}

# 3. 檢查 audit log
# Settings → Security log
# 搜尋最近 24 小時的活動
```

---

#### OpenAI API Key

```bash
# 1. 前往 https://platform.openai.com/api-keys
# 2. 找到洩漏的 key
# 3. 點擊 "Revoke"

# 4. 檢查使用紀錄
# https://platform.openai.com/usage
# 查看是否有異常的 API 調用
```

---

#### Stripe API Key

```bash
# 1. 前往 https://dashboard.stripe.com/apikeys
# 2. 點擊洩漏的 key 旁的 "Roll key"
# 3. 確認 roll (舊 key 立即失效)

# 4. 檢查支付活動
# Dashboard → Payments
# 過濾最近 24 小時的交易
```

---

#### Database Passwords

```sql
-- PostgreSQL
ALTER USER app_user WITH PASSWORD 'new_secure_password';

-- MySQL
ALTER USER 'app_user'@'localhost' IDENTIFIED BY 'new_secure_password';

-- 立即強制斷開現有連接
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE usename = 'app_user';
```

---

### ✅ 任務 2: 通知相關人員 (並行執行)

**通知清單**:

- [ ] 直屬主管
- [ ] 安全團隊 (如有)
- [ ] DevOps/SRE 團隊
- [ ] 專案負責人

**通知範本**:

```
【緊急】憑證洩漏事件通知

事件類型: [AWS Key / GitHub Token / Database Password]
發現時間: [YYYY-MM-DD HH:MM]
洩漏範圍: [Git commit / AI chat history / Slack message]

已執行動作:
✅ 洩漏的憑證已撤銷 ([HH:MM] 完成)
🔄 正在評估影響範圍

需要協助:
- 檢查相關系統是否有異常活動
- 確認是否需要通知客戶

後續更新: 每 30 分鐘更新一次
```

---

## 🟡 第二階段: 損害評估 (5-15 分鐘)

### ✅ 任務 3: 評估影響範圍

**檢查清單**:

#### Git 歷史檢查

```bash
# 1. 檢查憑證在哪些 commits 中出現
git log -S "sk-proj-" --all --oneline

# 2. 檢查是否已推送到遠端
git log origin/main..HEAD

# 3. 檢查倉庫是否公開
gh repo view --json isPrivate

# 4. 檢查 commit 時間 (評估暴露時長)
git log --format="%h %ad %s" --date=iso
```

---

#### 系統活動檢查

```bash
# 1. 檢查 AWS CloudTrail (如適用)
aws cloudtrail lookup-events \
    --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
    --max-results 100

# 2. 檢查資料庫存取日誌
# (根據你的資料庫系統調整)
tail -f /var/log/postgresql/postgresql.log | grep "authentication failed\|connection authorized"

# 3. 檢查應用日誌
grep -i "401\|403\|error" /var/log/app.log | tail -50
```

---

#### 評估嚴重程度

| 指標 | 低風險 | 中風險 | 高風險 |
|------|--------|--------|--------|
| **暴露時長** | <1 小時 | 1-24 小時 | >24 小時 |
| **倉庫可見性** | 私有 | 團隊私有 | 公開 |
| **憑證權限** | 唯讀 | 讀寫 | Admin |
| **異常活動** | 無 | 可疑 | 確認濫用 |

---

### ✅ 任務 4: 記錄事件時間線

建立事件記錄檔案 `incident-YYYYMMDD.md`:

```markdown
# 憑證洩漏事件記錄

## 基本資訊
- **事件 ID**: INC-2024-001
- **發現時間**: 2024-01-15 10:23:45
- **洩漏類型**: AWS Access Key
- **發現方式**: [Pre-commit hook / Manual review / Automated scan]

## 時間線

### 10:23 - 發現洩漏
- Commit hash: abc1234
- 洩漏的憑證: AKIA... (部分)
- 檔案路徑: src/config.py

### 10:25 - 撤銷憑證
- AWS key 已停用並刪除
- 通知主管和安全團隊

### 10:30 - 評估影響
- Commit 未推送到遠端 ✅
- 倉庫為私有 ✅
- CloudTrail 無異常活動 ✅

### 10:40 - 清理 Git 歷史
- 使用 git reset 移除包含憑證的 commit
- 驗證清理成功

## 影響範圍
- **暴露時長**: ~15 分鐘 (從 commit 到發現)
- **系統**: 無影響
- **數據**: 無洩漏
- **客戶**: 無影響

## 根本原因
- 開發者手動複製 AWS key 到代碼中進行測試
- 忘記在 commit 前移除
- Pre-commit hook 未設置

## 預防措施
- [ ] 設置 git-secrets
- [ ] 設置 pre-commit hooks
- [ ] 團隊培訓: 永不硬編碼憑證
```

---

## 🟠 第三階段: 清理善後 (15-60 分鐘)

### ✅ 任務 5: 清理 Git 歷史

#### 情境 A: 還沒推送到遠端

```bash
# 方法 1: Amend 最後一次 commit
git add <fixed-file>
git commit --amend --no-edit

# 方法 2: Reset 到安全的 commit
git log --oneline  # 找到安全的 commit
git reset --hard <safe-commit-hash>

# 驗證
git log -p | grep -i "password\|api.key\|secret"
```

---

#### 情境 B: 已推送,倉庫是私有的

```bash
# 1. 使用 BFG Repo-Cleaner (推薦)
# 下載 BFG
wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar

# 建立替換清單
echo "sk-proj-abc123 => <REDACTED>" > passwords.txt

# 執行清理
java -jar bfg-1.14.0.jar --replace-text passwords.txt /path/to/repo

# 清理 reflog
cd /path/to/repo
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 強制推送 (謹慎!)
git push --force --all
git push --force --tags

# 2. 通知團隊成員重新 clone
```

---

#### 情境 C: 已推送,倉庫是公開的

```bash
# ⚠️ 假設憑證已被洩漏

# 1. 立即撤銷憑證 (如果還沒做)
# 2. 清理 Git 歷史 (同情境 B)
# 3. 考慮刪除並重建倉庫 (極端情況)

# 4. 監控異常活動
# - 設置 CloudTrail 警報
# - 每小時檢查一次日誌 (24 小時)

# 5. 通知安全團隊評估是否需要:
# - 客戶通知
# - 公開聲明
# - 法律諮詢
```

---

### ✅ 任務 6: 生成新憑證

```bash
# 1. 生成新的安全憑證

# AWS
aws iam create-access-key --user-name USERNAME

# GitHub
gh auth token

# 隨機密碼 (Linux/macOS)
openssl rand -base64 32

# 2. 更新 .env 檔案
echo "NEW_API_KEY=<new-key>" >> .env

# 3. 驗證 .env 在 .gitignore 中
grep ".env" .gitignore || echo ".env" >> .gitignore

# 4. 測試新憑證
python -c "import os; from dotenv import load_dotenv; load_dotenv(); print('✅ API Key loaded' if os.getenv('API_KEY') else '❌ Failed')"
```

---

### ✅ 任務 7: 更新應用配置

```bash
# 1. 本地開發環境
cp .env.example .env
# 手動填入新憑證

# 2. 生產環境 (根據部署方式調整)

# Heroku
heroku config:set API_KEY=new_key_here

# AWS Elastic Beanstalk
aws elasticbeanstalk update-environment \
    --environment-name prod \
    --option-settings Namespace=aws:elasticbeanstalk:application:environment,OptionName=API_KEY,Value=new_key

# Kubernetes
kubectl create secret generic api-credentials \
    --from-literal=api-key=new_key_here \
    --dry-run=client -o yaml | kubectl apply -f -

# 3. 驗證應用正常運行
curl https://your-app.com/health
```

---

## 🟢 第四階段: 建立防護 (1-24 小時)

### ✅ 任務 8: 設置自動化防護

#### git-secrets 設置

```bash
# 1. 安裝 git-secrets
# macOS
brew install git-secrets

# Linux
git clone https://github.com/awslabs/git-secrets.git
cd git-secrets
sudo make install

# 2. 在專案中啟用
cd /path/to/project
git secrets --install
git secrets --register-aws

# 3. 添加自訂規則
git secrets --add 'password\s*=\s*["\'][^"\']+["\']'
git secrets --add 'api[_-]?key\s*=\s*["\'][^"\']+["\']'
git secrets --add 'sk-[a-zA-Z0-9]{20,}'  # OpenAI keys

# 4. 測試
echo "password = 'test123'" > test.txt
git add test.txt
git commit -m "test"  # 應該被阻止

# 5. 掃描歷史 commits
git secrets --scan-history
```

---

#### pre-commit hooks 設置

```bash
# 1. 安裝 pre-commit
pip install pre-commit

# 2. 建立配置檔案
cat > .pre-commit-config.yaml << 'EOF'
repos:
  # 檢測憑證
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']

  # 基本檢查
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-added-large-files
      - id: check-json
      - id: check-yaml
      - id: detect-private-key
      - id: end-of-file-fixer
      - id: trailing-whitespace

  # Python 安全掃描
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        args: ['-r', 'src/']
EOF

# 3. 安裝 hooks
pre-commit install

# 4. 測試所有檔案
pre-commit run --all-files

# 5. 建立 baseline
detect-secrets scan > .secrets.baseline
```

---

### ✅ 任務 9: 團隊溝通與培訓

**立即行動**:

```markdown
# 發送團隊郵件

主題: [重要] 憑證洩漏事件與新安全措施

團隊成員你好,

今天發生了一起憑證洩漏事件 (已控制,無實際損害),這提醒我們需要
加強安全實踐。

**事件摘要**:
- 類型: [AWS Key / GitHub Token / etc.]
- 發現時間: [時間]
- 影響: 無 (及時發現並撤銷)

**新安全措施** (立即生效):
1. 所有專案必須設置 git-secrets
2. 所有專案必須設置 pre-commit hooks
3. 絕不在代碼中硬編碼憑證

**必須行動** (本週內完成):
- [ ] 在你的專案中執行 `git secrets --install`
- [ ] 在你的專案中執行 `pre-commit install`
- [ ] 檢查現有代碼是否有硬編碼憑證
- [ ] 閱讀更新的安全指南: [連結]

**培訓**:
安全培訓會議將於 [日期] 舉行,請務必參加。

如有任何問題,請聯繫安全團隊。

謝謝大家的配合!
```

---

**安排培訓** (1-2 週內):

- [ ] 準備培訓材料
- [ ] 分享本次事件的經驗教訓
- [ ] 演示安全工具使用
- [ ] Q&A 環節

---

### ✅ 任務 10: 事後檢討

**檢討會議議程** (1 小時):

```markdown
# 憑證洩漏事件檢討會議

## 1. 事件回顧 (15 分鐘)
- 時間線
- 影響範圍
- 處理過程

## 2. 根本原因分析 (15 分鐘)
- 為什麼會發生?
- 哪些防護措施失效了?
- 人為因素 vs 流程問題

## 3. 改進措施 (20 分鐘)
- 技術層面: 自動化工具
- 流程層面: Code review 流程
- 文化層面: 安全意識培訓

## 4. 行動計劃 (10 分鐘)
- 短期 (本週): 緊急防護措施
- 中期 (本月): 流程改進
- 長期 (本季): 文化建設

## 5. 經驗分享 (5 分鐘)
- 哪些做得好?
- 哪些可以改進?
```

---

**記錄經驗教訓**:

```markdown
# 經驗教訓

## 做得好的地方
- ✅ 及時發現 (15 分鐘內)
- ✅ 快速撤銷憑證 (5 分鐘內)
- ✅ 完整的事件記錄
- ✅ 立即通知相關人員

## 需要改進
- ❌ 事前沒有 pre-commit hook
- ❌ 缺乏安全意識培訓
- ❌ 應急流程不清晰

## 長期行動
- 將安全工具納入專案 template
- 定期 (每季) 安全審計
- 建立安全冠軍 (Security Champions) 計劃
```

---

## 📊 防護措施檢查清單

**完成以下所有項目,才算事件完整處理**:

### 技術防護
- [ ] git-secrets 已設置並測試
- [ ] pre-commit hooks 已設置並測試
- [ ] .env 檔案已加入 .gitignore
- [ ] CI/CD 中集成安全掃描
- [ ] 密碼管理器已部署

### 流程防護
- [ ] 更新 Code Review 檢查清單
- [ ] 更新 Git Commit 指南
- [ ] 建立應急聯絡清單
- [ ] 定期安全審計排程

### 文化防護
- [ ] 團隊安全培訓完成
- [ ] 安全指南文檔更新
- [ ] 事件經驗分享完成
- [ ] 定期安全意識提醒

---

## 📞 緊急聯絡資訊

**內部團隊** (填寫你的組織資訊):

- **安全團隊**: security@company.com
- **DevOps 團隊**: devops@company.com
- **On-call**: +1-xxx-xxx-xxxx

**外部資源**:

- **AWS Support**: https://console.aws.amazon.com/support
- **GitHub Security**: https://github.com/contact
- **OpenAI Support**: https://help.openai.com

---

## 💡 預防勝於治療

**記住**: 最好的應急處理,是永遠不需要應急處理。

**日常實踐**:
- 永不硬編碼憑證
- 每次 commit 前過一遍檢查清單
- 定期更新憑證
- 使用密碼管理器
- 啟用 2FA

---

**版本**: v1.0
**最後更新**: 2024-01-15
**下次演練**: [設定日期,建議每季度一次]
