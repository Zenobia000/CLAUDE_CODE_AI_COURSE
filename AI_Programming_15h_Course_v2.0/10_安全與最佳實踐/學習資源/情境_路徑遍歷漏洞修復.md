# æƒ…å¢ƒï¼šè·¯å¾‘éæ­·æ¼æ´ä¿®å¾©

> **å­¸ç¿’ç›®æ¨™**: é€éçœŸå¯¦å ´æ™¯å­¸ç¿’è­˜åˆ¥ä¸¦ä¿®å¾©æ–‡ä»¶æ“ä½œä¸­çš„è·¯å¾‘éæ­·æ¼æ´

---

## æƒ…å¢ƒèƒŒæ™¯

ä½ æ­£åœ¨é–‹ç™¼æ–‡ä»¶ä¸‹è¼‰åŠŸèƒ½ï¼Œå‘ Claude è©¢å•ï¼š

**ä½ çš„æå•**:
> "å¹«æˆ‘å¯«ä¸€å€‹ Flask APIï¼Œå…è¨±ç”¨æˆ¶ä¸‹è¼‰ä¸Šå‚³çš„æ–‡ä»¶"

**Claude å›è¦†çš„ä»£ç¢¼**:
```python
from flask import Flask, send_file, request

app = Flask(__name__)

@app.route('/download/<filename>')
def download_file(filename):
    file_path = f"/uploads/{filename}"
    return send_file(file_path, as_attachment=True)

if __name__ == '__main__':
    app.run(debug=True)
```

çœ‹èµ·ä¾†å¾ˆç°¡å–®ï¼Œä½ æ¸¬è©¦æ­£å¸¸æ–‡ä»¶åï¼ˆå¦‚ `document.pdf`ï¼‰ä¹Ÿèƒ½æ­£å¸¸ä¸‹è¼‰...

---

## ğŸš¨ å•é¡Œè­˜åˆ¥

### å±éšªä¿¡è™Ÿ

```python
file_path = f"/uploads/{filename}"  # âš ï¸ è·¯å¾‘éæ­·é¢¨éšªï¼
return send_file(file_path)  # æ²’æœ‰é©—è­‰è·¯å¾‘åˆæ³•æ€§
```

### æ”»æ“Šç¯„ä¾‹

```bash
# æ­£å¸¸ä½¿ç”¨
GET /download/document.pdf
# â†’ è®€å– /uploads/document.pdf âœ…

# æƒ¡æ„è¼¸å…¥ #1: è¨ªå•ä¸Šå±¤ç›®éŒ„
GET /download/../../etc/passwd
# â†’ è®€å– /etc/passwd âŒ

# æƒ¡æ„è¼¸å…¥ #2: è¨ªå•æ•æ„Ÿé…ç½®
GET /download/../../app/config.py
# â†’ è®€å–æ‡‰ç”¨é…ç½®ï¼ˆå¯èƒ½åŒ…å«æ•¸æ“šåº«å¯†ç¢¼ï¼‰âŒ

# æƒ¡æ„è¼¸å…¥ #3: è¨ªå•å…¶ä»–ç”¨æˆ¶æ–‡ä»¶
GET /download/../../other_user/private.doc
# â†’ è®€å–å…¶ä»–ç”¨æˆ¶çš„ç§äººæ–‡ä»¶ âŒ
```

---

## ğŸ”§ ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆ #1: ä½¿ç”¨ `pathlib` é©—è­‰è·¯å¾‘ (æ¨è–¦)

```python
# âœ… å®‰å…¨åšæ³•
from flask import Flask, send_file, abort
from pathlib import Path

app = Flask(__name__)

# å®šç¾©å…è¨±çš„ä¸Šå‚³ç›®éŒ„
UPLOAD_DIR = Path("/uploads").resolve()  # å–å¾—çµ•å°è·¯å¾‘

@app.route('/download/<filename>')
def download_file(filename):
    # 1. ç¦æ­¢è·¯å¾‘åˆ†éš”ç¬¦
    if '/' in filename or '\\' in filename:
        abort(400, "Invalid filename: path separators not allowed")

    # 2. æ§‹é€ å®Œæ•´è·¯å¾‘
    file_path = (UPLOAD_DIR / filename).resolve()

    # 3. é©—è­‰è·¯å¾‘åœ¨å…è¨±çš„ç›®éŒ„å…§
    try:
        file_path.relative_to(UPLOAD_DIR)
    except ValueError:
        abort(403, "Access denied: path traversal detected")

    # 4. é©—è­‰æ–‡ä»¶å­˜åœ¨
    if not file_path.exists():
        abort(404, "File not found")

    # 5. é©—è­‰æ˜¯æ–‡ä»¶è€Œéç›®éŒ„
    if not file_path.is_file():
        abort(400, "Invalid file")

    return send_file(file_path, as_attachment=True)
```

**ç‚ºä»€éº¼å®‰å…¨ï¼Ÿ**
1. **è¼¸å…¥é©—è­‰**: ç¦æ­¢è·¯å¾‘åˆ†éš”ç¬¦ `/` å’Œ `\\`
2. **è·¯å¾‘è§£æ**: `.resolve()` å–å¾—çµ•å°è·¯å¾‘ï¼Œè§£ææ‰€æœ‰ `..`
3. **é‚Šç•Œæª¢æŸ¥**: `.relative_to()` ç¢ºä¿è·¯å¾‘åœ¨å…è¨±ç¯„åœå…§
4. **å­˜åœ¨æ€§æª¢æŸ¥**: é˜²æ­¢éŒ¯èª¤è¨Šæ¯æ´©æ¼ç›®éŒ„çµæ§‹

---

### æ–¹æ¡ˆ #2: ä½¿ç”¨ç™½åå–®é©—è­‰

```python
# âœ… ç™½åå–®é©—è­‰
import os
from flask import Flask, send_file, abort

app = Flask(__name__)

UPLOAD_DIR = "/uploads"
ALLOWED_FILES = {
    "document.pdf",
    "report.xlsx",
    "image.png"
}

@app.route('/download/<filename>')
def download_file(filename):
    # åªå…è¨±ç™½åå–®ä¸­çš„æ–‡ä»¶
    if filename not in ALLOWED_FILES:
        abort(403, "File not allowed")

    file_path = os.path.join(UPLOAD_DIR, filename)

    # é›™é‡æª¢æŸ¥è·¯å¾‘
    if not os.path.realpath(file_path).startswith(os.path.realpath(UPLOAD_DIR)):
        abort(403, "Access denied")

    if not os.path.isfile(file_path):
        abort(404, "File not found")

    return send_file(file_path, as_attachment=True)
```

---

### æ–¹æ¡ˆ #3: ä½¿ç”¨æ–‡ä»¶ ID è€Œéæ–‡ä»¶å

```python
# âœ… æœ€å®‰å…¨åšæ³•ï¼šä½¿ç”¨æ•¸æ“šåº« ID
from flask import Flask, send_file, abort
from pathlib import Path
import sqlite3

app = Flask(__name__)
UPLOAD_DIR = Path("/uploads")

def get_file_path_by_id(file_id):
    """å¾æ•¸æ“šåº«æŸ¥è©¢æ–‡ä»¶è·¯å¾‘"""
    conn = sqlite3.connect('files.db')
    cursor = conn.cursor()
    cursor.execute("SELECT filename FROM files WHERE id = ?", (file_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else None

@app.route('/download/<int:file_id>')  # åªæ¥å—æ•´æ•¸ ID
def download_file(file_id):
    # å¾æ•¸æ“šåº«æŸ¥è©¢çœŸå¯¦æ–‡ä»¶å
    filename = get_file_path_by_id(file_id)
    if not filename:
        abort(404, "File not found")

    file_path = (UPLOAD_DIR / filename).resolve()

    # é©—è­‰è·¯å¾‘
    try:
        file_path.relative_to(UPLOAD_DIR)
    except ValueError:
        abort(403, "Access denied")

    if not file_path.is_file():
        abort(404, "File not found")

    return send_file(file_path, as_attachment=True)
```

**å„ªå‹¢**:
- ç”¨æˆ¶ç„¡æ³•çŒœæ¸¬æ–‡ä»¶å
- å¯ä»¥æ§åˆ¶è¨ªå•æ¬Šé™ (åœ¨æ•¸æ“šåº«ä¸­æª¢æŸ¥ç”¨æˆ¶æ¬Šé™)
- é¿å…æ´©æ¼æ–‡ä»¶å‘½åè¦å‰‡

---

## ğŸ›¡ï¸ é é˜²æªæ–½

### é˜²ç·š #1: ä½¿ç”¨ Semgrep æƒæ

**Semgrep è¦å‰‡** (`.semgrep.yml`):
```yaml
rules:
  - id: path-traversal-open
    pattern: open($USER_INPUT, ...)
    message: "Possible path traversal using user input"
    severity: WARNING
    languages: [python]

  - id: path-traversal-send-file
    pattern: send_file(f".../{$VAR}")
    message: "Possible path traversal in send_file()"
    severity: ERROR
    languages: [python]
```

```bash
semgrep --config .semgrep.yml .
```

---

### é˜²ç·š #2: ä»£ç¢¼å¯©æŸ¥æª¢æŸ¥æ¸…å–®

```
è·¯å¾‘éæ­·é¢¨éšªæª¢æŸ¥:

[ ] æ˜¯å¦ç›´æ¥ä½¿ç”¨ç”¨æˆ¶è¼¸å…¥æ§‹é€ æ–‡ä»¶è·¯å¾‘ï¼Ÿ
    f"/path/{user_input}"  â†’ âŒ å±éšª

[ ] æ˜¯å¦é©—è­‰è·¯å¾‘åˆ†éš”ç¬¦ï¼Ÿ
    æª¢æŸ¥ '/' å’Œ '\\'  â†’ âœ… éœ€è¦

[ ] æ˜¯å¦é©—è­‰ '..' (ä¸Šå±¤ç›®éŒ„)ï¼Ÿ
    ä½¿ç”¨ .resolve() + .relative_to()  â†’ âœ… éœ€è¦

[ ] æ˜¯å¦ä½¿ç”¨çµ•å°è·¯å¾‘ï¼Ÿ
    ä½¿ç”¨ Path.resolve()  â†’ âœ… éœ€è¦

[ ] æ˜¯å¦é©—è­‰æ–‡ä»¶åœ¨å…è¨±ç¯„åœå…§ï¼Ÿ
    ä½¿ç”¨ .relative_to() æˆ– .startswith()  â†’ âœ… éœ€è¦
```

---

## ğŸ“š è‡ªç„¶å­¸åˆ°çš„æŒ‡ä»¤èˆ‡å·¥å…·

### Python pathlib ä½¿ç”¨

```python
from pathlib import Path

# å–å¾—çµ•å°è·¯å¾‘
path = Path("/uploads/file.txt").resolve()

# é©—è­‰è·¯å¾‘åœ¨å…è¨±ç¯„åœå…§
try:
    path.relative_to(Path("/uploads"))
except ValueError:
    print("Path is outside allowed directory")

# æª¢æŸ¥è·¯å¾‘é¡å‹
path.exists()  # æ˜¯å¦å­˜åœ¨
path.is_file()  # æ˜¯å¦ç‚ºæ–‡ä»¶
path.is_dir()  # æ˜¯å¦ç‚ºç›®éŒ„
```

### å®‰å…¨æª¢æ¸¬å·¥å…·

```bash
# Semgrep æƒæè·¯å¾‘éæ­·
semgrep --config "p/path-traversal" .

# æ‰‹å‹•æœå°‹å¯ç–‘ä»£ç¢¼
grep -rn "open(.*request\." --include="*.py" .
grep -rn "send_file(f\"" --include="*.py" .
```

---

## ğŸ¯ æƒ…å¢ƒå»¶ä¼¸

### æŒ‘æˆ°: ä¿®å¾©ç¾æœ‰ä»£ç¢¼

å‡è¨­ä½ çš„å°ˆæ¡ˆä¸­æœ‰ä»¥ä¸‹ä»£ç¢¼ï¼Œå¦‚ä½•ä¿®å¾©ï¼Ÿ

```python
# âŒ ä¸å®‰å…¨çš„ä»£ç¢¼
@app.route('/static/<path:filename>')
def serve_static(filename):
    return send_file(f"static/{filename}")
```

**ä¿®å¾©æ­¥é©Ÿ**:
1. å®šç¾© `STATIC_DIR = Path("static").resolve()`
2. é©—è­‰ `filename` ä¸åŒ…å«è·¯å¾‘åˆ†éš”ç¬¦
3. æ§‹é€ è·¯å¾‘: `file_path = (STATIC_DIR / filename).resolve()`
4. é©—è­‰: `file_path.relative_to(STATIC_DIR)`
5. æª¢æŸ¥: `file_path.is_file()`

---

## âœ… å­¸ç¿’é©—è­‰

å®Œæˆæ­¤æƒ…å¢ƒå¾Œï¼Œä½ æ‡‰è©²èƒ½å¤ ï¼š

- [ ] è­˜åˆ¥ç›´æ¥ä½¿ç”¨ç”¨æˆ¶è¼¸å…¥æ§‹é€ è·¯å¾‘çš„ä»£ç¢¼
- [ ] ä½¿ç”¨ `pathlib` çš„ `.resolve()` å’Œ `.relative_to()` æ–¹æ³•
- [ ] ç†è§£ `..` è·¯å¾‘éæ­·çš„æ”»æ“ŠåŸç†
- [ ] å¯¦ç¾æ–‡ä»¶ä¸‹è¼‰çš„å®‰å…¨æœ€ä½³å¯¦è¸

---

## ğŸ”— å»¶ä¼¸å­¸ç¿’

- **ç†è«–**: `ç†è«–/10.1_AIç”Ÿæˆä»£ç¢¼å®‰å…¨é¢¨éšª.md` - æ·±å…¥äº†è§£è·¯å¾‘éæ­·
- **å¯¦ä½œ**: `æƒ…å¢ƒé¡Œåº«/çµ„åˆç´š/C01_ç¶œåˆå®‰å…¨å¯©è¨ˆ.md` - ç¶œåˆå®‰å…¨å¯©æŸ¥
- **å·¥å…·**: [OWASP Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal)

---

**è¨˜ä½**ï¼š

> **ã€Œç”¨æˆ¶è¼¸å…¥çš„è·¯å¾‘å°±åƒé™Œç”Ÿäººçµ¦çš„åœ°å€ â€” æ°¸é é©—è­‰å®ƒçš„å®‰å…¨æ€§ã€**

ä½¿ç”¨ `pathlib` å’Œé‚Šç•Œæª¢æŸ¥æ˜¯é˜²æ­¢è·¯å¾‘éæ­·çš„æ¨™æº–åšæ³•ã€‚
