# 工具整合實戰

> **學習目標**: 在 15 分鐘內設置自動化安全工具，建立「人會犯錯，工具不會忘記」的防線

---

## 為什麼需要自動化工具？

**真實教訓**: 即使是資深工程師，也會在疲勞時犯低級錯誤

**手動檢查的問題**:
- ❌ 依賴記憶，容易遺漏
- ❌ 時間壓力下會跳過步驟
- ❌ 無法掃描歷史 commits

**自動化工具的優勢**:
- ✅ 每次 commit 自動執行
- ✅ 不會因為趕進度而跳過
- ✅ 可掃描整個專案歷史

---

## 工具選擇決策樹

```
需要什麼類型的保護？
│
├─ 防止憑證洩漏
│  └─ 選擇: git-secrets (AWS專用) 或 TruffleHog (通用)
│
├─ 通用代碼安全掃描
│  └─ 選擇: Semgrep (規則豐富) 或 Bandit (Python專用)
│
├─ 統一管理多個工具
│  └─ 選擇: pre-commit (hook管理框架)
│
└─ 持續監控與報告
   └─ 選擇: Snyk (SaaS) 或 OWASP Dependency-Check (開源)
```

---

## 工具 #1: git-secrets (5 分鐘設置)

### 功能

防止將憑證 commit 到 Git 倉庫

### 快速設置

```bash
# Step 1: 安裝 (選擇適合你系統的方法)
# macOS
brew install git-secrets

# Linux
git clone https://github.com/awslabs/git-secrets.git
cd git-secrets
sudo make install

# Windows (使用 Git Bash)
# 下載並解壓 https://github.com/awslabs/git-secrets/archive/refs/heads/master.zip
# 將 git-secrets 加入 PATH

# Step 2: 在專案中安裝 hooks
cd your-project
git secrets --install

# Step 3: 註冊 AWS 憑證模式
git secrets --register-aws

# Step 4: 添加自定義模式 (可選)
git secrets --add 'password\s*=\s*["\'].*["\']'
git secrets --add 'api_key\s*=\s*["\'].*["\']'

# Step 5: 掃描現有倉庫
git secrets --scan-history
```

### 測試是否有效

```bash
# 創建測試文件
echo 'AWS_SECRET_KEY = "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"' > test.py

# 嘗試 commit
git add test.py
git commit -m "test commit"

# 應該看到錯誤:
# [ERROR] Matched one or more prohibited patterns
# test.py:1:AWS_SECRET_KEY = "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
```

### 自定義規則範例

```bash
# 防止常見的 API keys
git secrets --add 'sk-[a-zA-Z0-9]{32,}'  # OpenAI keys
git secrets --add 'ghp_[a-zA-Z0-9]{36}'  # GitHub Personal Access Tokens
git secrets --add 'AIza[0-9A-Za-z\\-_]{35}'  # Google API keys
```

---

## 工具 #2: pre-commit (10 分鐘設置)

### 功能

Git hook 管理框架，統一執行多個檢查工具

### 快速設置

```bash
# Step 1: 安裝 pre-commit
pip install pre-commit

# Step 2: 在專案根目錄創建 .pre-commit-config.yaml
cat > .pre-commit-config.yaml <<'EOF'
repos:
  # 基礎檢查
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
      - id: detect-private-key
      - id: trailing-whitespace
      - id: end-of-file-fixer

  # Python 代碼格式化
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        language_version: python3

  # Python 安全掃描
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        args: ['-c', 'pyproject.toml']

  # Secrets 檢測
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
EOF

# Step 3: 安裝 hooks
pre-commit install

# Step 4: 創建 secrets baseline (首次執行)
detect-secrets scan > .secrets.baseline

# Step 5: 測試所有 hooks
pre-commit run --all-files
```

### 配置說明

**基礎檢查** (`pre-commit-hooks`):
- `check-yaml`: 驗證 YAML 語法
- `check-json`: 驗證 JSON 語法
- `detect-private-key`: 檢測 SSH 私鑰
- `check-added-large-files`: 防止大文件 commit

**安全工具**:
- `bandit`: Python 安全漏洞掃描
- `detect-secrets`: 憑證洩漏檢測

### 測試是否有效

```bash
# 創建包含私鑰的測試文件
cat > test_key.pem <<'EOF'
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQC...
-----END RSA PRIVATE KEY-----
EOF

# 嘗試 commit
git add test_key.pem
git commit -m "test commit"

# 應該看到錯誤:
# Detect Private Key...........................Failed
```

---

## 工具 #3: Semgrep (15 分鐘設置)

### 功能

靜態代碼分析工具，檢測安全漏洞與反模式

### 快速設置

```bash
# Step 1: 安裝 Semgrep
pip install semgrep

# Step 2: 使用自動配置掃描專案
semgrep --config auto .

# Step 3: 創建自定義規則檔案 .semgrep.yml
cat > .semgrep.yml <<'EOF'
rules:
  - id: hardcoded-password
    pattern: password = "..."
    message: "Hardcoded password detected"
    severity: ERROR
    languages:
      - python

  - id: sql-injection
    pattern: db.execute(f"... {$VAR} ...")
    message: "Possible SQL injection using f-string"
    severity: ERROR
    languages:
      - python

  - id: unsafe-pickle
    pattern: pickle.loads($DATA)
    message: "Unsafe deserialization using pickle.loads()"
    severity: WARNING
    languages:
      - python

  - id: path-traversal
    pattern: open($USER_INPUT, ...)
    message: "Possible path traversal vulnerability"
    severity: WARNING
    languages:
      - python
EOF

# Step 4: 執行自定義規則掃描
semgrep --config .semgrep.yml .

# Step 5: 整合到 pre-commit (可選)
# 在 .pre-commit-config.yaml 添加:
cat >> .pre-commit-config.yaml <<'EOF'

  # Semgrep 安全掃描
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.50.0
    hooks:
      - id: semgrep
        args: ['--config', '.semgrep.yml', '--error']
EOF

pre-commit install
```

### 常用掃描規則集

```bash
# OWASP Top 10 漏洞
semgrep --config "p/owasp-top-ten" .

# SQL 注入專項掃描
semgrep --config "p/sql-injection" .

# 路徑遍歷專項掃描
semgrep --config "p/path-traversal" .

# XSS 專項掃描
semgrep --config "p/xss" .

# 查看所有可用規則集
semgrep --show-supported-languages
semgrep --show-rulesets
```

### 測試是否有效

```python
# test_vulnerable.py
import pickle

def unsafe_function(user_input):
    # 應該觸發 unsafe-pickle 規則
    data = pickle.loads(user_input)

    # 應該觸發 sql-injection 規則
    query = f"SELECT * FROM users WHERE id = {user_input}"
    db.execute(query)

    return data
```

```bash
# 掃描測試文件
semgrep --config .semgrep.yml test_vulnerable.py

# 應該看到兩個警告
```

---

## 完整工作流整合

### 推薦配置: git-secrets + pre-commit + Semgrep

```bash
# 1. 安裝所有工具
pip install pre-commit semgrep detect-secrets
brew install git-secrets  # 或使用其他安裝方法

# 2. 設置 git-secrets
git secrets --install
git secrets --register-aws

# 3. 創建 .pre-commit-config.yaml
cat > .pre-commit-config.yaml <<'EOF'
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: detect-private-key
      - id: check-added-large-files

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets

  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit

  - repo: https://github.com/returntocorp/semgrep
    rev: v1.50.0
    hooks:
      - id: semgrep
        args: ['--config', 'p/owasp-top-ten', '--error']
EOF

# 4. 安裝並測試
pre-commit install
pre-commit run --all-files

# 5. 添加到 .gitignore
cat >> .gitignore <<'EOF'
.secrets.baseline
EOF
```

### 工作流程圖

```
開發者修改代碼
       ↓
   git add .
       ↓
   git commit -m "..."
       ↓
┌──────────────────────┐
│   pre-commit 觸發    │
└──────────────────────┘
       ↓
┌──────────────────────┐
│  1. detect-secrets   │ ← 檢測憑證洩漏
│  2. detect-private-  │ ← 檢測私鑰
│     key               │
│  3. bandit           │ ← Python 安全掃描
│  4. semgrep          │ ← OWASP 漏洞掃描
└──────────────────────┘
       ↓
   全部通過？
    ├─ YES → Commit 成功 ✅
    └─ NO  → Commit 阻止 ❌
              ↓
         修復問題後重試
```

---

## 故障排除指南

### 問題 #1: pre-commit 安裝失敗

**症狀**:
```
ERROR: Could not install packages due to an OSError
```

**解決方法**:
```bash
# 使用虛擬環境安裝
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install pre-commit
```

---

### 問題 #2: git-secrets 無法在 Windows 運行

**症狀**:
```
git-secrets: command not found
```

**解決方法**:
```bash
# 使用 Git Bash 執行
# 或使用 WSL (Windows Subsystem for Linux)

# 替代方案: 只使用 detect-secrets (跨平台)
pip install detect-secrets
# 在 .pre-commit-config.yaml 中配置
```

---

### 問題 #3: Semgrep 掃描太慢

**症狀**:
```
Scanning... (takes forever)
```

**解決方法**:
```bash
# 只掃描變更的文件
semgrep --config auto --diff

# 或在 .pre-commit-config.yaml 中限制範圍
# args: ['--config', 'p/owasp-top-ten', '--error', '--exclude', 'tests/']
```

---

### 問題 #4: 誤報太多

**症狀**:
```
detect-secrets 標記測試數據為真實 secrets
```

**解決方法**:
```bash
# 更新 baseline，將已知的「假陽性」加入白名單
detect-secrets scan --update .secrets.baseline

# 或在代碼中添加忽略標記
# pragma: allowlist secret
password = "test-password"  # pragma: allowlist secret
```

---

## 性能優化建議

### 優化 #1: 只掃描變更的文件

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.50.0
    hooks:
      - id: semgrep
        args: ['--config', 'p/security-audit', '--error']
        # 只掃描 staged files
        stages: [commit]
```

### 優化 #2: 使用快取加速

```bash
# pre-commit 自動快取，手動清理：
pre-commit clean

# Semgrep 使用快取
semgrep --config auto . --use-git-ignore
```

### 優化 #3: CI/CD 中使用平行掃描

```yaml
# .github/workflows/security.yml
name: Security Scan
on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
      - run: |
          pip install semgrep bandit detect-secrets
          semgrep --config auto . &
          bandit -r . -f json &
          detect-secrets scan &
          wait
```

---

## 學習驗證

完成本學習卡後，你應該能夠：

- [ ] 在 5 分鐘內設置 git-secrets
- [ ] 在 10 分鐘內設置 pre-commit framework
- [ ] 在 15 分鐘內設置 Semgrep 並掃描專案
- [ ] 理解工具選擇的決策樹
- [ ] 排除常見的設置問題

---

## 下一步

1. **立即實作**: 在你的專案中設置完整工作流 (git-secrets + pre-commit + Semgrep)
2. **測試驗證**: 創建測試文件驗證工具是否能攔截敏感資訊
3. **深入學習**: 閱讀「快速檢查清單/Pre-Commit安全檢查清單.md」

---

**記住**：

> **「工具不是負擔，而是你的安全網 — 設置一次，受益終身」**

花 15 分鐘設置自動化工具，可以避免未來無數次的安全事件。
