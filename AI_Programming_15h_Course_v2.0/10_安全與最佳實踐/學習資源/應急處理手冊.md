# 應急處理手冊

> **使用場景**: 發現敏感資訊洩漏時的 15 分鐘緊急應對流程

---

## 🚨 緊急情況分類

### 情況 #1: API 金鑰洩漏 (最常見)

**識別信號**:
- 代碼中包含 `api_key = "sk-..."`
- 已 commit 到 Git
- 可能已推送到 GitHub/GitLab

**危險等級**: 🔴 極高
**處理時限**: 15 分鐘內

---

### 情況 #2: 資料庫憑證洩漏

**識別信號**:
- `DATABASE_URL = "postgresql://user:password@host/db"`
- 配置檔案包含明文密碼

**危險等級**: 🔴 極高
**處理時限**: 10 分鐘內

---

### 情況 #3: 用戶個人資料洩漏

**識別信號**:
- 代碼或 commit 訊息包含真實用戶資料
- email、電話、身分證號等

**危險等級**: 🟡 中高
**處理時限**: 1 小時內（需評估法律責任）

---

## ⚡ API 金鑰洩漏：15 分鐘應急流程

### 階段 1: 立即撤銷 (0-3 分鐘)

```bash
# ⏱️ 目標: 3 分鐘內完成撤銷

# Step 1: 登入對應服務
# OpenAI: https://platform.openai.com/api-keys
# AWS: https://console.aws.amazon.com/iam/
# GitHub: https://github.com/settings/tokens
# Google Cloud: https://console.cloud.google.com/apis/credentials

# Step 2: 找到洩漏的 key
# Step 3: 點擊 "Revoke" 或 "Delete" 撤銷
```

**OpenAI 範例**:
1. 訪問 https://platform.openai.com/api-keys
2. 找到對應的 API key (根據 key 前綴 `sk-proj-...`)
3. 點擊 "Revoke"
4. 確認撤銷

**檢查點**: ✅ 洩漏的 key 已無法使用

---

### 階段 2: 生成新憑證 (3-5 分鐘)

```bash
# ⏱️ 目標: 2 分鐘內生成新 key

# Step 1: 在同一個服務頁面
# Step 2: 點擊 "Create new key" 或 "Generate"
# Step 3: 複製新 key (只會顯示一次!)
# Step 4: 安全存放新 key
```

**安全存放方式**:
```bash
# 方法 1: 使用 .env 檔案
echo "OPENAI_API_KEY=新的key" > .env

# 方法 2: 使用系統環境變數 (Linux/Mac)
echo "export OPENAI_API_KEY=新的key" >> ~/.bashrc
source ~/.bashrc

# 方法 3: 使用密鑰管理工具
# 1Password CLI, AWS Secrets Manager, etc.
```

**檢查點**: ✅ 新 key 已生成並安全存放

---

### 階段 3: 更新應用配置 (5-8 分鐘)

```bash
# ⏱️ 目標: 3 分鐘內更新所有使用該 key 的服務

# Step 1: 找出所有使用舊 key 的地方
grep -r "OPENAI_API_KEY" .  # 搜尋環境變數名稱
grep -r "sk-proj-" .  # 搜尋 key 前綴 (小心!)

# Step 2: 更新環境變數
# 開發環境
echo "OPENAI_API_KEY=新的key" > .env

# 生產環境 (根據你的部署方式)
# Heroku
heroku config:set OPENAI_API_KEY=新的key

# AWS Lambda
aws lambda update-function-configuration \
  --function-name my-function \
  --environment Variables="{OPENAI_API_KEY=新的key}"

# Docker Compose
# 更新 docker-compose.yml 或 .env

# Step 3: 重啟應用
systemctl restart myapp  # 或你的重啟方式
```

**檢查點**: ✅ 所有服務使用新 key，運作正常

---

### 階段 4: 清理 Git 歷史 (8-15 分鐘)

```bash
# ⏱️ 目標: 7 分鐘內從 Git 歷史移除敏感資訊

# 方法 1: 使用 git filter-branch (適用小型倉庫)
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch path/to/leaked/file.py" \
  --prune-empty --tag-name-filter cat -- --all

# 方法 2: 使用 BFG Repo-Cleaner (推薦，更快)
# 安裝 BFG
brew install bfg  # macOS
# 或下載 https://rtyley.github.io/bfg-repo-cleaner/

# 創建文本文件包含要替換的字串
echo "sk-proj-洩漏的key" > secrets.txt

# 執行替換
bfg --replace-text secrets.txt .

# 清理
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 強制推送 (⚠️ 謹慎!)
git push origin --force --all
git push origin --force --tags
```

**⚠️ 強制推送注意事項**:
```bash
# 1. 通知團隊成員
# 發送郵件告知即將強制推送

# 2. 確認沒有未合併的重要分支

# 3. 強制推送
git push origin --force --all

# 4. 團隊成員需要重新同步
# 告知成員執行:
git fetch origin
git reset --hard origin/main
```

**檢查點**: ✅ Git 歷史中已無敏感資訊

---

### 階段 5: 事後檢討 (完成後)

```markdown
## 洩漏事件檢討報告

**事件日期**: 2025-11-02
**發現時間**: 14:30
**處理完成**: 14:45 (15 分鐘)

### 洩漏內容
- OpenAI API key: sk-proj-xxx...
- 洩漏位置: src/utils/openai_client.py

### 影響範圍
- [ ] 已推送到 GitHub
- [ ] 可能被掃描機器人發現
- [ ] 尚未發現異常 API 使用

### 處理步驟
1. ✅ 14:32 - 撤銷洩漏的 key
2. ✅ 14:34 - 生成新 key
3. ✅ 14:38 - 更新生產環境配置
4. ✅ 14:45 - 清理 Git 歷史並強制推送

### 根本原因
- 開發者直接複製 AI 生成的代碼，未檢查安全性
- 沒有設置 git-secrets 預防機制
- 代碼審查時未發現硬編碼憑證

### 預防措施
- [ ] 設置 git-secrets 和 pre-commit hooks
- [ ] 團隊培訓: 安全編碼意識
- [ ] 更新開發規範文檔
- [ ] 每季度進行安全審計

### 成本估算
- 開發時間成本: 15 分鐘 + 團隊同步 30 分鐘
- 服務中斷: 無
- 財務損失: 無 (及時發現)
```

---

## 🔧 資料庫憑證洩漏：10 分鐘應急流程

### 快速處理步驟

```bash
# ⏱️ 總時限: 10 分鐘

# Step 1: 立即改密碼 (0-3 分鐘)
# 登入資料庫管理面板
# MySQL
ALTER USER 'username'@'localhost' IDENTIFIED BY '新的強密碼';

# PostgreSQL
ALTER USER username WITH PASSWORD '新的強密碼';

# Step 2: 檢查是否有異常連線 (3-5 分鐘)
# MySQL
SHOW PROCESSLIST;
SELECT * FROM information_schema.processlist;

# PostgreSQL
SELECT * FROM pg_stat_activity;

# Step 3: 更新應用配置 (5-8 分鐘)
echo "DATABASE_URL=postgresql://user:新密碼@host/db" > .env
systemctl restart myapp

# Step 4: 清理 Git 歷史 (8-10 分鐘)
# 參考上述 "清理 Git 歷史" 步驟
```

---

## 📋 敏感資料洩漏應急模板

### 用戶個人資料洩漏處理

```bash
# 1. 評估洩漏範圍 (立即)
# - 洩漏了多少筆資料？
# - 包含哪些欄位？(姓名、email、電話？)
# - 已公開多久？

# 2. 從 Git 移除 (15 分鐘內)
bfg --delete-files sensitive_data.csv .
git push origin --force --all

# 3. 通知法務與合規團隊 (1 小時內)
# - 是否需要通知監管機關？(GDPR 72 小時內)
# - 是否需要通知用戶？

# 4. 撰寫事件報告
# - 洩漏範圍與影響
# - 處理措施
# - 預防計劃
```

---

## 🛠️ 應急工具箱

### 工具 #1: BFG Repo-Cleaner

**用途**: 快速清理 Git 歷史中的敏感資訊

```bash
# 安裝
brew install bfg  # macOS
# 或下載 jar: https://rtyley.github.io/bfg-repo-cleaner/

# 使用範例
# 刪除特定文件
bfg --delete-files passwords.txt .

# 替換文本
echo "secret_key" > secrets.txt
bfg --replace-text secrets.txt .

# 刪除大文件
bfg --strip-blobs-bigger-than 10M .
```

---

### 工具 #2: TruffleHog

**用途**: 掃描 Git 歷史中的憑證洩漏

```bash
# 安裝
pip install trufflehog

# 掃描倉庫
trufflehog git file://. --only-verified

# 掃描特定 commit 範圍
trufflehog git file://. --since-commit abc123

# 輸出 JSON 報告
trufflehog git file://. --json > leak_report.json
```

---

### 工具 #3: GitHub Secret Scanning Alerts

**設置**:
1. 訪問 `https://github.com/user/repo/settings/security_analysis`
2. 啟用 "Secret scanning"
3. 啟用 "Push protection"

**當洩漏發生時**:
- GitHub 會自動檢測並發送 alert
- Push protection 會阻止包含 secrets 的 push
- 可在 Security tab 查看所有 alerts

---

## 📞 緊急聯絡清單模板

```markdown
## 緊急聯絡人

### 技術團隊
- Tech Lead: [姓名] - [電話] - [Email]
- DevOps: [姓名] - [電話] - [Email]
- Security: [姓名] - [電話] - [Email]

### 管理層
- CTO: [姓名] - [電話]
- CEO: [姓名] - [電話] (僅重大事件)

### 外部聯絡
- 雲端服務支援 (AWS/GCP): [支援熱線]
- 法務顧問: [事務所] - [電話]
- 公關顧問: [公司] - [電話]

### 服務提供商
- OpenAI Support: help.openai.com
- GitHub Support: support.github.com
- AWS Security: aws.amazon.com/security
```

---

## ✅ 應急演練檢查清單

**每季度進行一次演練**:

```
[ ] 模擬 API key 洩漏
    - 能在 3 分鐘內撤銷嗎？
    - 能在 15 分鐘內完成全流程嗎？

[ ] 測試 Git 歷史清理
    - BFG 工具是否已安裝？
    - 團隊成員知道如何重新同步嗎？

[ ] 驗證應急聯絡清單
    - 聯絡人資訊是最新的嗎？
    - 能在 5 分鐘內聯繫到關鍵人員嗎？

[ ] 檢查自動化防護
    - git-secrets 是否運作？
    - GitHub secret scanning 是否啟用？
    - pre-commit hooks 是否有效？
```

---

## 🔗 延伸資源

- **理論**: `理論/10.2_隱私與合規實踐.md`
- **工具**: `學習資源/工具整合實戰.md`
- **案例**: `案例分析/真實安全事件.md`
- **GitHub Docs**: https://docs.github.com/en/code-security/secret-scanning

---

**記住**：

> **「最好的應急處理,是永遠不需要應急處理」**

設置自動化防護工具，讓洩漏在發生前就被阻止。
